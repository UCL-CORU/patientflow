
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation website for PatientFlow">
      
      
        <meta name="author" content="Zella King">
      
      
      
        <link rel="prev" href="../LICENSE/">
      
      
        <link rel="next" href="../notebooks/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>API reference - PatientFlow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PatientFlow" class="md-header__button md-logo" aria-label="PatientFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PatientFlow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zmek/patientflow/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zmek/patientflow
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PatientFlow" class="md-nav__button md-logo" aria-label="PatientFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PatientFlow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zmek/patientflow/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zmek/patientflow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PatientFlow: Predicting demand for hospital beds using real-time data
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../LICENSE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MIT License
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#patientflow" class="md-nav__link">
    <span class="md-ellipsis">
      patientflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression" class="md-nav__link">
    <span class="md-ellipsis">
      build_expression
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_expression">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression" class="md-nav__link">
    <span class="md-ellipsis">
      compute_core_expression
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_core_expression">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols" class="md-nav__link">
    <span class="md-ellipsis">
      create_symbols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_symbols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs" class="md-nav__link">
    <span class="md-ellipsis">
      expression_subs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="expression_subs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_prob_dist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_for_prediction_moment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_prob_dist_for_prediction_moment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_without_patient_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_without_patient_snapshots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba" class="md-nav__link">
    <span class="md-ellipsis">
      model_input_to_pred_proba
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_input_to_pred_proba">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted" class="md-nav__link">
    <span class="md-ellipsis">
      pred_proba_to_agg_predicted
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pred_proba_to_agg_predicted">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff" class="md-nav__link">
    <span class="md-ellipsis">
      return_coeff
    </span>
  </a>
  
    <nav class="md-nav" aria-label="return_coeff">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.convert" class="md-nav__link">
    <span class="md-ellipsis">
      convert
    </span>
  </a>
  
    <nav class="md-nav" aria-label="convert">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert--usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.map_consultations_to_types" class="md-nav__link">
    <span class="md-ellipsis">
      map_consultations_to_types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="map_consultations_to_types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.map_consultations_to_types--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.map_consultations_to_types--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.prepare_age_and_dates" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_age_and_dates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_age_and_dates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.prepare_age_and_dates--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.prepare_age_and_dates--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.resample_hours" class="md-nav__link">
    <span class="md-ellipsis">
      resample_hours
    </span>
  </a>
  
    <nav class="md-nav" aria-label="resample_hours">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.resample_hours--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.resample_hours--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.shift_dates_into_future" class="md-nav__link">
    <span class="md-ellipsis">
      shift_dates_into_future
    </span>
  </a>
  
    <nav class="md-nav" aria-label="shift_dates_into_future">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.shift_dates_into_future--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.shift_dates_into_future--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.errors" class="md-nav__link">
    <span class="md-ellipsis">
      errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.errors--classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError" class="md-nav__link">
    <span class="md-ellipsis">
      MissingKeysError
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MissingKeysError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.ModelLoadError" class="md-nav__link">
    <span class="md-ellipsis">
      ModelLoadError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calc_mae_mpe" class="md-nav__link">
    <span class="md-ellipsis">
      calc_mae_mpe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_admission_probs_relative_to_prediction" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_admission_probs_relative_to_prediction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_results" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_weighted_observed" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_weighted_observed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.combine_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      combine_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.create_time_mask" class="md-nav__link">
    <span class="md-ellipsis">
      create_time_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_combined_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_combined_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_six_week_average" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_six_week_average
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.get_arrivals_with_admission_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_arrivals_with_admission_probs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.predict_using_previous_weeks" class="md-nav__link">
    <span class="md-ellipsis">
      predict_using_previous_weeks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.generate" class="md-nav__link">
    <span class="md-ellipsis">
      generate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_finished_visits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_fake_finished_visits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_snapshots
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_fake_snapshots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      data_from_csv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="data_from_csv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols" class="md-nav__link">
    <span class="md-ellipsis">
      get_dict_cols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_dict_cols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_key
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_model_key">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file" class="md-nav__link">
    <span class="md-ellipsis">
      load_config_file
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_config_file">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_saved_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_saved_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.parse_args" class="md-nav__link">
    <span class="md-ellipsis">
      parse_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval" class="md-nav__link">
    <span class="md-ellipsis">
      safe_literal_eval
    </span>
  </a>
  
    <nav class="md-nav" aria-label="safe_literal_eval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names" class="md-nav__link">
    <span class="md-ellipsis">
      set_data_file_names
    </span>
  </a>
  
    <nav class="md-nav" aria-label="set_data_file_names">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_file_paths" class="md-nav__link">
    <span class="md-ellipsis">
      set_file_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_project_root" class="md-nav__link">
    <span class="md-ellipsis">
      set_project_root
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.model_artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      model_artifacts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_artifacts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts--classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.FoldResults" class="md-nav__link">
    <span class="md-ellipsis">
      FoldResults
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FoldResults">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.FoldResults--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.HyperParameterTrial" class="md-nav__link">
    <span class="md-ellipsis">
      HyperParameterTrial
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HyperParameterTrial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.HyperParameterTrial--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainedClassifier" class="md-nav__link">
    <span class="md-ellipsis">
      TrainedClassifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainedClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainedClassifier--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainingResults" class="md-nav__link">
    <span class="md-ellipsis">
      TrainingResults
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainingResults">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainingResults--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      create_predictions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_predictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index" class="md-nav__link">
    <span class="md-ellipsis">
      find_probability_threshold_index
    </span>
  </a>
  
    <nav class="md-nav" aria-label="find_probability_threshold_index">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--this-means-there-is-a-90-probability-of-needing-at-least-5-beds" class="md-nav__link">
    <span class="md-ellipsis">
      This means there is a 90% probability of needing at least 5 beds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_specialty_probs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_specialty_probs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predictors" class="md-nav__link">
    <span class="md-ellipsis">
      predictors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predictors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor--classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor" class="md-nav__link">
    <span class="md-ellipsis">
      SequencePredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequencePredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.fit--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.fit--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.predict--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.predict--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="weighted_poisson_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      WeightedPoissonPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WeightedPoissonPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.filter_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      filter_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.aggregate_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.convolute_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      convolute_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.find_nearest_previous_prediction_time" class="md-nav__link">
    <span class="md-ellipsis">
      find_nearest_previous_prediction_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.poisson_binom_generating_function" class="md-nav__link">
    <span class="md-ellipsis">
      poisson_binom_generating_function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.weighted_poisson_binomial" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_binomial
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.prepare" class="md-nav__link">
    <span class="md-ellipsis">
      prepare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams" class="md-nav__link">
    <span class="md-ellipsis">
      SpecialCategoryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpecialCategoryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__reduce__" class="md-nav__link">
    <span class="md-ellipsis">
      __reduce__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.get_params_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_params_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.opposite_special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      opposite_special_category_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      special_category_func
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.assign_patient_ids" class="md-nav__link">
    <span class="md-ellipsis">
      assign_patient_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects" class="md-nav__link">
    <span class="md-ellipsis">
      create_special_category_objects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_special_category_objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_temporal_splits" class="md-nav__link">
    <span class="md-ellipsis">
      create_temporal_splits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_yta_filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_for_inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_for_inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_group_snapshot_dict" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_group_snapshot_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_patient_snapshots
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_patient_snapshots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      classifiers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="classifiers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.chronological_cross_validation" class="md-nav__link">
    <span class="md-ellipsis">
      chronological_cross_validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_balance_info" class="md-nav__link">
    <span class="md-ellipsis">
      create_balance_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_column_transformer" class="md-nav__link">
    <span class="md-ellipsis">
      create_column_transformer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_dataset_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataset_metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_feature_metadata
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_feature_metadata">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialise_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="initialise_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier" class="md-nav__link">
    <span class="md-ellipsis">
      train_classifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_classifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_multiple_classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      train_multiple_classifiers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      test_real_time_predictions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_real_time_predictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models" class="md-nav__link">
    <span class="md-ellipsis">
      train_all_models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_all_models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits" class="md-nav__link">
    <span class="md-ellipsis">
      get_default_visits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_default_visits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.train_sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_sequence_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="weighted_poisson_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_yta_filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.train_weighted_poisson_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_weighted_poisson_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Notebooks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Notebooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About the notebooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/0_Set_up_your_environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0. Set up your environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/1_Meet_the_users_of_our_predictions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1. Introducing our users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2a_Create_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2a. Create patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2b_Predict_using_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2b. Make predictions using patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2c_Evaluate_patient_snapshot_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2c. Evaluate models trained on patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2d_Explore_the_datasets_provided/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2d. Explore the datasets provided
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3a_Prepare_group_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3a. Prepare group snapshots from patient snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3b_Evaluate_group_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3b. Evaluate group snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3c_Predict_bed_counts_without_using_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3c. Predict bed counts without using patient snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3d_Predict_bed_counts_for_subgroups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3d. Predict bed count distributions for subgroups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4a_Specify_emergency_demand_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4a. Specify requirements for emergency demand prediction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4b_Predict_emergency_demand/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4b. Predict emergency demand
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4c_Evaluate_emergency_demand_predictions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4c. Evaluate predictions of emergency demand
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Src
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Src
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Patientflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Patientflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../src/patientflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PatientFlow: A Python package for converting patient-level predictions into output that is useful for bed managers in hospitals
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#patientflow" class="md-nav__link">
    <span class="md-ellipsis">
      patientflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression" class="md-nav__link">
    <span class="md-ellipsis">
      build_expression
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_expression">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression" class="md-nav__link">
    <span class="md-ellipsis">
      compute_core_expression
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_core_expression">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols" class="md-nav__link">
    <span class="md-ellipsis">
      create_symbols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_symbols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs" class="md-nav__link">
    <span class="md-ellipsis">
      expression_subs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="expression_subs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_prob_dist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_for_prediction_moment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_prob_dist_for_prediction_moment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_without_patient_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_without_patient_snapshots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba" class="md-nav__link">
    <span class="md-ellipsis">
      model_input_to_pred_proba
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_input_to_pred_proba">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted" class="md-nav__link">
    <span class="md-ellipsis">
      pred_proba_to_agg_predicted
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pred_proba_to_agg_predicted">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff" class="md-nav__link">
    <span class="md-ellipsis">
      return_coeff
    </span>
  </a>
  
    <nav class="md-nav" aria-label="return_coeff">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.convert" class="md-nav__link">
    <span class="md-ellipsis">
      convert
    </span>
  </a>
  
    <nav class="md-nav" aria-label="convert">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert--usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.map_consultations_to_types" class="md-nav__link">
    <span class="md-ellipsis">
      map_consultations_to_types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="map_consultations_to_types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.map_consultations_to_types--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.map_consultations_to_types--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.prepare_age_and_dates" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_age_and_dates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_age_and_dates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.prepare_age_and_dates--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.prepare_age_and_dates--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.resample_hours" class="md-nav__link">
    <span class="md-ellipsis">
      resample_hours
    </span>
  </a>
  
    <nav class="md-nav" aria-label="resample_hours">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.resample_hours--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.resample_hours--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.shift_dates_into_future" class="md-nav__link">
    <span class="md-ellipsis">
      shift_dates_into_future
    </span>
  </a>
  
    <nav class="md-nav" aria-label="shift_dates_into_future">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.shift_dates_into_future--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.convert.shift_dates_into_future--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.errors" class="md-nav__link">
    <span class="md-ellipsis">
      errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.errors--classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError" class="md-nav__link">
    <span class="md-ellipsis">
      MissingKeysError
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MissingKeysError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.ModelLoadError" class="md-nav__link">
    <span class="md-ellipsis">
      ModelLoadError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calc_mae_mpe" class="md-nav__link">
    <span class="md-ellipsis">
      calc_mae_mpe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_admission_probs_relative_to_prediction" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_admission_probs_relative_to_prediction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_results" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_weighted_observed" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_weighted_observed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.combine_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      combine_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.create_time_mask" class="md-nav__link">
    <span class="md-ellipsis">
      create_time_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_combined_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_combined_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_six_week_average" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_six_week_average
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.get_arrivals_with_admission_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_arrivals_with_admission_probs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.predict_using_previous_weeks" class="md-nav__link">
    <span class="md-ellipsis">
      predict_using_previous_weeks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.generate" class="md-nav__link">
    <span class="md-ellipsis">
      generate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_finished_visits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_fake_finished_visits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_snapshots
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_fake_snapshots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      data_from_csv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="data_from_csv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols" class="md-nav__link">
    <span class="md-ellipsis">
      get_dict_cols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_dict_cols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_key
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_model_key">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file" class="md-nav__link">
    <span class="md-ellipsis">
      load_config_file
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_config_file">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_saved_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_saved_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_saved_model--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.parse_args" class="md-nav__link">
    <span class="md-ellipsis">
      parse_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval" class="md-nav__link">
    <span class="md-ellipsis">
      safe_literal_eval
    </span>
  </a>
  
    <nav class="md-nav" aria-label="safe_literal_eval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names" class="md-nav__link">
    <span class="md-ellipsis">
      set_data_file_names
    </span>
  </a>
  
    <nav class="md-nav" aria-label="set_data_file_names">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_file_paths" class="md-nav__link">
    <span class="md-ellipsis">
      set_file_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_project_root" class="md-nav__link">
    <span class="md-ellipsis">
      set_project_root
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.model_artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      model_artifacts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_artifacts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts--classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.FoldResults" class="md-nav__link">
    <span class="md-ellipsis">
      FoldResults
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FoldResults">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.FoldResults--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.HyperParameterTrial" class="md-nav__link">
    <span class="md-ellipsis">
      HyperParameterTrial
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HyperParameterTrial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.HyperParameterTrial--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainedClassifier" class="md-nav__link">
    <span class="md-ellipsis">
      TrainedClassifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainedClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainedClassifier--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainingResults" class="md-nav__link">
    <span class="md-ellipsis">
      TrainingResults
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainingResults">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainingResults--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      create_predictions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_predictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index" class="md-nav__link">
    <span class="md-ellipsis">
      find_probability_threshold_index
    </span>
  </a>
  
    <nav class="md-nav" aria-label="find_probability_threshold_index">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index--this-means-there-is-a-90-probability-of-needing-at-least-5-beds" class="md-nav__link">
    <span class="md-ellipsis">
      This means there is a 90% probability of needing at least 5 beds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_specialty_probs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_specialty_probs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predictors" class="md-nav__link">
    <span class="md-ellipsis">
      predictors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predictors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor--classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor" class="md-nav__link">
    <span class="md-ellipsis">
      SequencePredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequencePredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.fit--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.fit--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.predict--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_predictor.SequencePredictor.predict--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="weighted_poisson_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      WeightedPoissonPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WeightedPoissonPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.filter_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      filter_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.aggregate_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.convolute_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      convolute_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.find_nearest_previous_prediction_time" class="md-nav__link">
    <span class="md-ellipsis">
      find_nearest_previous_prediction_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.poisson_binom_generating_function" class="md-nav__link">
    <span class="md-ellipsis">
      poisson_binom_generating_function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.weighted_poisson_predictor.weighted_poisson_binomial" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_binomial
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.prepare" class="md-nav__link">
    <span class="md-ellipsis">
      prepare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare--functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams" class="md-nav__link">
    <span class="md-ellipsis">
      SpecialCategoryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpecialCategoryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__reduce__" class="md-nav__link">
    <span class="md-ellipsis">
      __reduce__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.get_params_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_params_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.opposite_special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      opposite_special_category_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      special_category_func
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.assign_patient_ids" class="md-nav__link">
    <span class="md-ellipsis">
      assign_patient_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects" class="md-nav__link">
    <span class="md-ellipsis">
      create_special_category_objects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_special_category_objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_temporal_splits" class="md-nav__link">
    <span class="md-ellipsis">
      create_temporal_splits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_yta_filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_for_inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_for_inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_for_inference--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_group_snapshot_dict" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_group_snapshot_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_patient_snapshots
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_patient_snapshots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      classifiers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="classifiers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.chronological_cross_validation" class="md-nav__link">
    <span class="md-ellipsis">
      chronological_cross_validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_balance_info" class="md-nav__link">
    <span class="md-ellipsis">
      create_balance_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_column_transformer" class="md-nav__link">
    <span class="md-ellipsis">
      create_column_transformer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_dataset_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataset_metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_feature_metadata
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_feature_metadata">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialise_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="initialise_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier" class="md-nav__link">
    <span class="md-ellipsis">
      train_classifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_classifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_multiple_classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      train_multiple_classifiers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      test_real_time_predictions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="test_real_time_predictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models" class="md-nav__link">
    <span class="md-ellipsis">
      train_all_models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_all_models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits" class="md-nav__link">
    <span class="md-ellipsis">
      get_default_visits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_default_visits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.train_sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_sequence_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="weighted_poisson_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_yta_filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.create_yta_filters--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.weighted_poisson_predictor.train_weighted_poisson_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_weighted_poisson_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/zmek/patientflow/edit/main/docs/api.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="api-reference">API reference</h1>


<div class="doc doc-object doc-module">



<a id="patientflow"></a>
    <div class="doc doc-contents first">

        <p>PatientFlow: A package for predicting short-term hospital bed demand.</p>
<p>This package provides tools and models for analysing patient flow data and
making predictions about emergency demand, elective demand, and hospital discharges.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="patientflow.aggregate" class="doc doc-heading">
            <code>aggregate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Aggregate Prediction From Patient-Level Probabilities</p>
<p>This submodule provides functions to aggregate patient-level predicted probabilities into a probability distribution.
The module uses symbolic mathematics to generate and manipulate expressions, enabling the computation of aggregate probabilities based on individual patient-level predictions.</p>


<details class="dependencies" open>
  <summary>Dependencies</summary>
  <ul>
<li>numpy: For array operations and numerical calculations.</li>
<li>pandas: To handle and manipulate tabular data (DataFrames) for analysis.</li>
<li>sympy: A symbolic mathematics library for building and manipulating symbolic expressions, particularly for calculating probabilities.</li>
</ul>
</details>        <h4 id="patientflow.aggregate--functions">Functions</h4>
<p>create_symbols(n):
    Generates a list of symbolic variables to represent probability terms.</p>
<pre><code>Parameters
----------
n : int
    Number of symbolic variables to generate.

Returns
-------
list of sympy.Symbol
    A list containing n symbolic variables.
</code></pre>
<p>compute_core_expression(ri, s):
    Computes a symbolic expression using symbolic variables and constants.</p>
<pre><code>Parameters
----------
ri : float
    A constant value (often a probability).
s : sympy.Symbol
    A symbolic variable.

Returns
-------
sympy.Mul
    A symbolic expression representing the product of `ri` and `s`.
</code></pre>
<p>build_expression(syms, n):
    Constructs a cumulative product of symbolic expressions using symbolic variables.</p>
<pre><code>Parameters
----------
syms : list of sympy.Symbol
    A list of symbolic variables.
n : int
    The number of terms to include in the cumulative product.

Returns
-------
sympy.Expr
    A symbolic expression representing the cumulative product of `syms`.
</code></pre>
<p>expression_subs(expression, n, predictions):
    Substitutes numeric values into a symbolic expression.</p>
<pre><code>Parameters
----------
expression : sympy.Expr
    A symbolic expression to perform substitution on.
n : int
    The number of variables to substitute.
predictions : array-like
    Numeric values (e.g., predicted probabilities) to substitute into the expression.

Returns
-------
sympy.Expr
    The symbolic expression after substitution.
</code></pre>
<p>return_coeff(expression, i):
    Extracts the coefficient corresponding to a specific term in an expanded symbolic expression.</p>
<pre><code>Parameters
----------
expression : sympy.Expr
    A symbolic expression that has been expanded.
i : int
    The index of the term for which the coefficient is to be extracted.

Returns
-------
float
    The coefficient for the i-th term.
</code></pre>
<p>model_input_to_pred_proba(model_input, model):
    Converts input data into predicted probabilities using the provided model.</p>
<pre><code>Parameters
----------
model_input : array-like
    The input data to feed into the model.
model : object
    A predictive model object that implements a `predict_proba` method.

Returns
-------
array-like
    The predicted probabilities output by the model.
</code></pre>
<p>pred_proba_to_agg_predicted(predictions_proba, weights=None, normal_approx_threshold=30):
    Aggregates individual predicted probabilities into an overall prediction using provided weights.
    Uses a Normal approximation for large datasets (&gt; normal_approx_threshold) for better performance.</p>
<pre><code>Parameters
----------
predictions_proba : DataFrame
    A DataFrame containing the probability predictions; must have a single column named 'pred_proba'.
weights : array-like, optional
    An array of weights, of the same length as the DataFrame rows, to apply to each prediction.
normal_approx_threshold : int, optional (default=30)
    If the number of rows in predictions_proba exceeds this threshold, use a Normal distribution approximation.
    Set to None or a very large number to always use the exact symbolic computation.

Returns
-------
DataFrame
    A DataFrame with a single column 'agg_proba' showing the aggregated probability,
    indexed from 0 to n, where n is the number of predictions.
</code></pre>
<p>get_prob_dist_for_prediction_moment(X_test, model, weights=None, inference_time=False, y_test=None, category_filter=None, normal_approx_threshold=30):
    Computes predicted and observed probabilities for a specific prediction date.</p>
<pre><code>Parameters
----------
X_test : DataFrame or array-like
    Input test data to be passed to the model for prediction.
model : object or TrainedClassifier
    Either a predictive model which provides a `predict_proba` method,
    or a TrainedClassifier object containing a pipeline.
weights : array-like, optional
    Weights for aggregating the predicted probabilities.
inference_time : bool
    Indicates whether the function is used in inference mode (i.e., whether observed data is available).
y_test : array-like
    Observed target values corresponding to the test data (optional for inference).
category_filter : array-like, optional
    Boolean mask indicating which samples belong to the specific outcome category being analyzed.
    Should be the same length as y_test.
normal_approx_threshold : int, optional (default=30)
    If the number of rows in X_test exceeds this threshold, use a Normal distribution approximation.
    Set to None or a very large number to always use the exact symbolic computation.

Returns
-------
dict
    A dictionary containing the predicted and, if applicable, observed probability distributions.
</code></pre>
<p>get_prob_dist(snapshots_dict, X_test, y_test, model, weights=None, verbose=False, category_filter=None, normal_approx_threshold=30):
    Computes probability distributions for multiple snapshot dates.</p>
<pre><code>Parameters
----------
snapshots_dict : dict
    A dictionary where keys are snapshot dates and values are associated metadata (e.g., test data).
X_test : DataFrame or array-like
    Input test data to be passed to the model.
y_test : array-like
    Observed target values.
model : object or TrainedClassifier
    Either a predictive model which provides a `predict_proba` method,
    or a TrainedClassifier object containing a pipeline.
weights : pandas.Series, optional
    A Series containing weights for the test data points, which may influence the prediction,
    by default None. If provided, the weights should be indexed similarly to `X_test` and `y_test`.
verbose : bool, optional (default=False)
    If True, print progress information.
category_filter : array-like, optional
    Boolean mask indicating which samples belong to the specific outcome category being analyzed.
    Should be the same length as y_test.
normal_approx_threshold : int, optional (default=30)
    If the number of rows in a snapshot exceeds this threshold, use a Normal distribution approximation.
    Set to None or a very large number to always use the exact symbolic computation.

Returns
-------
dict
    A dictionary where each key is a snapshot date and the value is the corresponding probability distribution.

Raises
------
ValueError
    If snapshots_dict is not properly formatted or empty.
    If model has no predict_proba method and is not a TrainedClassifier.

Example Usage
-------------
# Assuming a predictive model and test data are available
snapshot_dates = ['2023-01-01', '2023-01-02']
predicted_distribution = get_prob_dist(snapshot_dates, dataset, X_test, y_test, model)
print(predicted_distribution)
</code></pre>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.build_expression" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct a cumulative product expression by combining individual symbolic expressions.</p>
<h5 id="patientflow.aggregate.build_expression--parameters">Parameters</h5>
<p>syms : iterable
    Iterable containing symbols to use in the expressions.
n : int
    The number of terms to include in the cumulative product.</p>
<h5 id="patientflow.aggregate.build_expression--returns">Returns</h5>
<p>Expr
    The cumulative product of the expressions.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a cumulative product expression by combining individual symbolic expressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    syms : iterable</span>
<span class="sd">        Iterable containing symbols to use in the expressions.</span>
<span class="sd">    n : int</span>
<span class="sd">        The number of terms to include in the cumulative product.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Expr</span>
<span class="sd">        The cumulative product of the expressions.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">expression</span> <span class="o">*=</span> <span class="n">compute_core_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expression</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.compute_core_expression" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_core_expression</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute a symbolic expression involving a basic mathematical operation with a symbol and a constant.</p>
<h5 id="patientflow.aggregate.compute_core_expression--parameters">Parameters</h5>
<p>ri : float
    The constant value to substitute into the expression.
s : Symbol
    The symbolic object used in the expression.</p>
<h5 id="patientflow.aggregate.compute_core_expression--returns">Returns</h5>
<p>Expr
    The symbolic expression after substitution.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_core_expression</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a symbolic expression involving a basic mathematical operation with a symbol and a constant.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ri : float</span>
<span class="sd">        The constant value to substitute into the expression.</span>
<span class="sd">    s : Symbol</span>
<span class="sd">        The symbolic object used in the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Expr</span>
<span class="sd">        The symbolic expression after substitution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">core_expression</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">core_expression</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">r</span><span class="p">:</span> <span class="n">ri</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.create_symbols" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a sequence of symbolic objects intended for use in mathematical expressions.</p>
<h5 id="patientflow.aggregate.create_symbols--parameters">Parameters</h5>
<p>n : int
    Number of symbols to create.</p>
<h5 id="patientflow.aggregate.create_symbols--returns">Returns</h5>
<p>tuple
    A tuple containing the generated symbolic objects.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a sequence of symbolic objects intended for use in mathematical expressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of symbols to create.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing the generated symbolic objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">symbols</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;r0:</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.expression_subs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">expression_subs</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Substitute values into a symbolic expression based on a mapping from symbols to predictions.</p>
<h5 id="patientflow.aggregate.expression_subs--parameters">Parameters</h5>
<p>expression : Expr
    The symbolic expression to perform substitution on.
n : int
    Number of symbols and corresponding predictions.
predictions : list
    List of numerical predictions to substitute.</p>
<h5 id="patientflow.aggregate.expression_subs--returns">Returns</h5>
<p>Expr
    The expression after performing the substitution.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">expression_subs</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Substitute values into a symbolic expression based on a mapping from symbols to predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression : Expr</span>
<span class="sd">        The symbolic expression to perform substitution on.</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of symbols and corresponding predictions.</span>
<span class="sd">    predictions : list</span>
<span class="sd">        List of numerical predictions to substitute.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Expr</span>
<span class="sd">        The expression after performing the substitution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">syms</span> <span class="o">=</span> <span class="n">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">substitution</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">predictions</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">substitution</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.get_prob_dist" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prob_dist</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate probability distributions for each snapshot date based on given model predictions.</p>
<h5 id="patientflow.aggregate.get_prob_dist--parameters">Parameters</h5>
<p>snapshots_dict : dict
    A dictionary mapping snapshot dates to indices in <code>X_test</code> and <code>y_test</code>.
    Must have datetime.date objects as keys and lists of indices as values.
X_test : DataFrame or array-like
    Input test data to be passed to the model.
y_test : array-like
    Observed target values.
model : object or TrainedClassifier
    Either a predictive model which provides a <code>predict_proba</code> method,
    or a TrainedClassifier object containing a pipeline.
weights : pandas.Series, optional
    A Series containing weights for the test data points.
verbose : bool, optional (default=False)
    If True, print progress information.
category_filter : array-like, optional
    Boolean mask indicating which samples belong to the specific outcome category being analyzed.
    Should be the same length as y_test.
normal_approx_threshold : int, optional (default=30)
    If the number of rows in a snapshot exceeds this threshold, use a Normal distribution approximation.
    Set to None or a very large number to always use the exact symbolic computation.</p>
<h5 id="patientflow.aggregate.get_prob_dist--returns">Returns</h5>
<p>dict
    A dictionary mapping snapshot dates to probability distributions.</p>
<h5 id="patientflow.aggregate.get_prob_dist--raises">Raises</h5>
<p>ValueError
    If snapshots_dict is not properly formatted or empty.
    If model has no predict_proba method and is not a TrainedClassifier.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prob_dist</span><span class="p">(</span>
    <span class="n">snapshots_dict</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">,</span>
    <span class="n">y_test</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate probability distributions for each snapshot date based on given model predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    snapshots_dict : dict</span>
<span class="sd">        A dictionary mapping snapshot dates to indices in `X_test` and `y_test`.</span>
<span class="sd">        Must have datetime.date objects as keys and lists of indices as values.</span>
<span class="sd">    X_test : DataFrame or array-like</span>
<span class="sd">        Input test data to be passed to the model.</span>
<span class="sd">    y_test : array-like</span>
<span class="sd">        Observed target values.</span>
<span class="sd">    model : object or TrainedClassifier</span>
<span class="sd">        Either a predictive model which provides a `predict_proba` method,</span>
<span class="sd">        or a TrainedClassifier object containing a pipeline.</span>
<span class="sd">    weights : pandas.Series, optional</span>
<span class="sd">        A Series containing weights for the test data points.</span>
<span class="sd">    verbose : bool, optional (default=False)</span>
<span class="sd">        If True, print progress information.</span>
<span class="sd">    category_filter : array-like, optional</span>
<span class="sd">        Boolean mask indicating which samples belong to the specific outcome category being analyzed.</span>
<span class="sd">        Should be the same length as y_test.</span>
<span class="sd">    normal_approx_threshold : int, optional (default=30)</span>
<span class="sd">        If the number of rows in a snapshot exceeds this threshold, use a Normal distribution approximation.</span>
<span class="sd">        Set to None or a very large number to always use the exact symbolic computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping snapshot dates to probability distributions.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If snapshots_dict is not properly formatted or empty.</span>
<span class="sd">        If model has no predict_proba method and is not a TrainedClassifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate snapshots_dict format</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshots_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;snapshots_dict cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">snapshots_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;snapshots_dict keys must be datetime.date objects, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;snapshots_dict values must be lists, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All indices in snapshots_dict must be integers&quot;</span><span class="p">)</span>

    <span class="c1"># Extract pipeline if model is a TrainedClassifier</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pipeline</span>
    <span class="c1"># Validate that model has predict_proba method</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Model must either be a TrainedClassifier or have a predict_proba method&quot;</span>
        <span class="p">)</span>

    <span class="n">prob_dist_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculating probability distributions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This may take a minute or more&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize a counter for notifying the user every 10 snapshot dates processed</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">snapshots_to_include</span> <span class="ow">in</span> <span class="n">snapshots_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_to_include</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Create an empty dictionary for the current snapshot date</span>
            <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;agg_predicted&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;agg_observed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Ensure the lengths of test features and outcomes are equal</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">y_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">]</span>
            <span class="p">),</span> <span class="s2">&quot;Mismatch in lengths of X_test and y_test snapshots.&quot;</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment_weights</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction_moment_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Apply category filter</span>
            <span class="k">if</span> <span class="n">category_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment_category_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction_moment_category_filter</span> <span class="o">=</span> <span class="n">category_filter</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">snapshots_to_include</span>
                <span class="p">]</span>

            <span class="c1"># Pass the normal_approx_threshold to get_prob_dist_for_prediction_moment</span>
            <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_prob_dist_for_prediction_moment</span><span class="p">(</span>
                <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">],</span>
                <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">],</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">prediction_moment_weights</span><span class="p">,</span>
                <span class="n">category_filter</span><span class="o">=</span><span class="n">prediction_moment_category_filter</span><span class="p">,</span>
                <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="n">normal_approx_threshold</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Increment the counter and notify the user every 10 snapshot dates processed</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_dist_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.get_prob_dist_for_prediction_moment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prob_dist_for_prediction_moment</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate both predicted distributions and observed values for a given date using test data.</p>
<h5 id="patientflow.aggregate.get_prob_dist_for_prediction_moment--parameters">Parameters</h5>
<p>X_test : array-like
    Test features for a specific snapshot date.
model : object or TrainedClassifier
    Either a predictive model which provides a <code>predict_proba</code> method,
    or a TrainedClassifier object containing a pipeline.
weights : array-like, optional
    Weights to apply to the predictions for aggregate calculation.
inference_time : bool, optional (default=False)
    If True, do not calculate or return actual aggregate.
y_test : array-like, optional
    Actual outcomes corresponding to the test features. Required if inference_time is False.
category_filter : array-like, optional
    Boolean mask indicating which samples belong to the specific outcome category being analyzed.
    Should be the same length as y_test.
normal_approx_threshold : int, optional (default=30)
    If the number of rows in X_test exceeds this threshold, use a Normal distribution approximation.
    Set to None or a very large number to always use the exact symbolic computation.</p>
<h5 id="patientflow.aggregate.get_prob_dist_for_prediction_moment--returns">Returns</h5>
<p>dict
    A dictionary with keys 'agg_predicted' and, if inference_time is False, 'agg_observed'.</p>
<h5 id="patientflow.aggregate.get_prob_dist_for_prediction_moment--raises">Raises</h5>
<p>ValueError
    If y_test is not provided when inference_time is False.
    If model has no predict_proba method and is not a TrainedClassifier.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prob_dist_for_prediction_moment</span><span class="p">(</span>
    <span class="n">X_test</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate both predicted distributions and observed values for a given date using test data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_test : array-like</span>
<span class="sd">        Test features for a specific snapshot date.</span>
<span class="sd">    model : object or TrainedClassifier</span>
<span class="sd">        Either a predictive model which provides a `predict_proba` method,</span>
<span class="sd">        or a TrainedClassifier object containing a pipeline.</span>
<span class="sd">    weights : array-like, optional</span>
<span class="sd">        Weights to apply to the predictions for aggregate calculation.</span>
<span class="sd">    inference_time : bool, optional (default=False)</span>
<span class="sd">        If True, do not calculate or return actual aggregate.</span>
<span class="sd">    y_test : array-like, optional</span>
<span class="sd">        Actual outcomes corresponding to the test features. Required if inference_time is False.</span>
<span class="sd">    category_filter : array-like, optional</span>
<span class="sd">        Boolean mask indicating which samples belong to the specific outcome category being analyzed.</span>
<span class="sd">        Should be the same length as y_test.</span>
<span class="sd">    normal_approx_threshold : int, optional (default=30)</span>
<span class="sd">        If the number of rows in X_test exceeds this threshold, use a Normal distribution approximation.</span>
<span class="sd">        Set to None or a very large number to always use the exact symbolic computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary with keys &#39;agg_predicted&#39; and, if inference_time is False, &#39;agg_observed&#39;.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If y_test is not provided when inference_time is False.</span>
<span class="sd">        If model has no predict_proba method and is not a TrainedClassifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span> <span class="ow">and</span> <span class="n">y_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;y_test must be provided if inference_time is False.&quot;</span><span class="p">)</span>

    <span class="c1"># Extract pipeline if model is a TrainedClassifier</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pipeline</span>
    <span class="c1"># Validate that model has predict_proba method</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Model must either be a TrainedClassifier or have a predict_proba method&quot;</span>
        <span class="p">)</span>

    <span class="n">prediction_moment_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pred_proba</span> <span class="o">=</span> <span class="n">model_input_to_pred_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">agg_predicted</span> <span class="o">=</span> <span class="n">pred_proba_to_agg_predicted</span><span class="p">(</span>
            <span class="n">pred_proba</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">normal_approx_threshold</span>
        <span class="p">)</span>
        <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_predicted</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span><span class="p">:</span>
            <span class="c1"># Apply category filter when calculating observed sum</span>
            <span class="k">if</span> <span class="n">category_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span> <span class="o">&amp;</span> <span class="n">category_filter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span><span class="p">:</span>
            <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">prediction_moment_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.get_prob_dist_without_patient_snapshots" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prob_dist_without_patient_snapshots</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">snapshot_dates</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">datetime_col</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">max_range</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate probability distributions for yet-to-arrive patients for each category at a specific prediction time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (hour, minute) representing the prediction time</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>categories</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of categories to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-internal" title="WeightedPoissonPredictor (patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor)" href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor">WeightedPoissonPredictor</a>, <span title="scipy.stats.rv_discrete">rv_discrete</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction model (can be WeightedPoissonPredictor or a statistical distribution)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing test set inpatient arrivals</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time window for predictions in minutes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>snapshot_dates</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[date]
List of dates to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
First x-coordinate for curve parameter (required for WeightedPoissonPredictor)</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
First y-coordinate for curve parameter (required for WeightedPoissonPredictor)</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
Second x-coordinate for curve parameter (required for WeightedPoissonPredictor)</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
Second y-coordinate for curve parameter (required for WeightedPoissonPredictor)</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>datetime_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing arrival datetimes (default: 'arrival_datetime')</p>
              </div>
            </td>
            <td>
                  <code>&#39;arrival_datetime&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_range</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of arrivals to consider in probability distribution (default: 20)</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="pandas.DataFrame">DataFrame</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing probability distributions for each category</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prob_dist_without_patient_snapshots</span><span class="p">(</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">categories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WeightedPoissonPredictor</span><span class="p">,</span> <span class="n">rv_discrete</span><span class="p">],</span>
    <span class="n">test_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">snapshot_dates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">date</span><span class="p">],</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Default float value instead of None</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Default float value instead of None</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Default float value instead of None</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Default float value instead of None</span>
    <span class="n">datetime_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">max_range</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate probability distributions for yet-to-arrive patients for each category at a specific prediction time.</span>

<span class="sd">    Args:</span>
<span class="sd">        prediction_time: Tuple of (hour, minute) representing the prediction time</span>
<span class="sd">        categories: List of categories to analyze</span>
<span class="sd">        model: Prediction model (can be WeightedPoissonPredictor or a statistical distribution)</span>
<span class="sd">        test_df: DataFrame containing test set inpatient arrivals</span>
<span class="sd">        prediction_window: Time window for predictions in minutes</span>
<span class="sd">        snapshot_dates: List[date]</span>
<span class="sd">            List of dates to analyze</span>
<span class="sd">        x1: float</span>
<span class="sd">            First x-coordinate for curve parameter (required for WeightedPoissonPredictor)</span>
<span class="sd">        y1: float</span>
<span class="sd">            First y-coordinate for curve parameter (required for WeightedPoissonPredictor)</span>
<span class="sd">        x2: float</span>
<span class="sd">            Second x-coordinate for curve parameter (required for WeightedPoissonPredictor)</span>
<span class="sd">        y2: float</span>
<span class="sd">            Second y-coordinate for curve parameter (required for WeightedPoissonPredictor)</span>
<span class="sd">        datetime_col: Name of the column containing arrival datetimes (default: &#39;arrival_datetime&#39;)</span>
<span class="sd">        max_range: Maximum number of arrivals to consider in probability distribution (default: 20)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing probability distributions for each category</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate prediction_time format</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prediction_time must be a (hour, minute) tuple&quot;</span><span class="p">)</span>

    <span class="c1"># Check if model is WeightedPoissonPredictor</span>
    <span class="n">is_weighted_poisson</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;WeightedPoissonPredictor&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Additional validation for WeightedPoissonPredictor</span>
    <span class="k">if</span> <span class="n">is_weighted_poisson</span><span class="p">:</span>
        <span class="c1"># Validate curve parameters are provided</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">y2</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Meaningful curve parameters (x1, y1, x2, y2) are required for WeightedPoissonPredictor&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate prediction window</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;prediction_window&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">!=</span> <span class="n">prediction_window</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;model.prediction_window (</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2">) does not match provided prediction_window (</span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate categories are subset of model weights keys</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;WeightedPoissonPredictor must have &#39;weights&#39; attribute&quot;</span><span class="p">)</span>
        <span class="n">valid_categories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">invalid_categories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span> <span class="o">-</span> <span class="n">valid_categories</span>
        <span class="k">if</span> <span class="n">invalid_categories</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Categories </span><span class="si">{</span><span class="n">invalid_categories</span><span class="si">}</span><span class="s2"> not found in model weights. Valid categories are </span><span class="si">{</span><span class="n">valid_categories</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Validate datetime_col exists in test_df</span>
    <span class="k">if</span> <span class="n">datetime_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">datetime_col</span><span class="si">}</span><span class="s2">&#39; not found in test_df&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize dictionary to store probability distributions</span>
    <span class="n">prob_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">prediction_time</span>

    <span class="c1"># Loop through each category</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Get predicted distribution</span>
        <span class="k">if</span> <span class="n">is_weighted_poisson</span><span class="p">:</span>
            <span class="n">prediction_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">category</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">:</span> <span class="n">prediction_time</span><span class="p">}}</span>
            <span class="n">agg_predicted_for_prediction_time</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">prediction_context</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
            <span class="p">)[</span><span class="n">category</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume model is a statistical distribution (e.g., from scipy.stats)</span>
            <span class="n">agg_predicted_for_prediction_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_range</span><span class="p">)]},</span>
                <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">max_range</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Calculate distributions for each date</span>
        <span class="k">for</span> <span class="n">date_val</span> <span class="ow">in</span> <span class="n">snapshot_dates</span><span class="p">:</span>
            <span class="n">snapshot_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span>
                <span class="n">date_val</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">),</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
            <span class="p">)</span>
            <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">date_val</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Store predicted distribution</span>
            <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">date_val</span><span class="p">][</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">agg_predicted_for_prediction_time</span>
            <span class="p">)</span>

            <span class="c1"># Calculate observed count of patients who arrived during the prediction window</span>
            <span class="n">observed_patients</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">datetime_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">test_df</span><span class="p">[</span><span class="n">datetime_col</span><span class="p">]</span>
                    <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">specialty</span> <span class="o">==</span> <span class="n">category</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">is_weighted_poisson</span><span class="p">:</span>
                <span class="c1"># Apply weighting for WeightedPoissonPredictor</span>
                <span class="n">hours_til_arrival</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">observed_patients</span><span class="p">[</span><span class="n">datetime_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">snapshot_datetime</span>
                <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
                <span class="n">remaining_hours_in_window</span> <span class="o">=</span> <span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">hours_til_arrival</span>

                <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">date_val</span><span class="p">][</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">remaining_hours_in_window</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">calculate_probability</span><span class="p">(</span>
                            <span class="n">elapsed_los_td_hrs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">prediction_window_hrs</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                            <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span>
                            <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
                            <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span>
                            <span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Simple count for other model types</span>
                <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">date_val</span><span class="p">][</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">observed_patients</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_dist_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.model_input_to_pred_proba" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model_input_to_pred_proba</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Use a predictive model to convert model input data into predicted probabilities.</p>
<h5 id="patientflow.aggregate.model_input_to_pred_proba--parameters">Parameters</h5>
<p>model_input : array-like
    The input data to the model, typically as features used for predictions.
model : object
    A model object with a <code>predict_proba</code> method that computes probability estimates.</p>
<h5 id="patientflow.aggregate.model_input_to_pred_proba--returns">Returns</h5>
<p>DataFrame
    A pandas DataFrame containing the predicted probabilities for the positive class,
    with one column labeled 'pred_proba'.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">model_input_to_pred_proba</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use a predictive model to convert model input data into predicted probabilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_input : array-like</span>
<span class="sd">        The input data to the model, typically as features used for predictions.</span>
<span class="sd">    model : object</span>
<span class="sd">        A model object with a `predict_proba` method that computes probability estimates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">        A pandas DataFrame containing the predicted probabilities for the positive class,</span>
<span class="sd">        with one column labeled &#39;pred_proba&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">model_input</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">model_input</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.pred_proba_to_agg_predicted" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pred_proba_to_agg_predicted</span><span class="p">(</span><span class="n">predictions_proba</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert individual probability predictions into aggregate predicted probability distribution using optional weights.
Uses a Normal approximation for large datasets (&gt; normal_approx_threshold) for better performance.</p>
<h5 id="patientflow.aggregate.pred_proba_to_agg_predicted--parameters">Parameters</h5>
<p>predictions_proba : DataFrame
    A DataFrame containing the probability predictions; must have a single column named 'pred_proba'.
weights : array-like, optional
    An array of weights, of the same length as the DataFrame rows, to apply to each prediction.
normal_approx_threshold : int, optional (default=30)
    If the number of rows in predictions_proba exceeds this threshold, use a Normal distribution approximation.
    Set to None or a very large number to always use the exact symbolic computation.</p>
<h5 id="patientflow.aggregate.pred_proba_to_agg_predicted--returns">Returns</h5>
<p>DataFrame
    A DataFrame with a single column 'agg_proba' showing the aggregated probability,
    indexed from 0 to n, where n is the number of predictions.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pred_proba_to_agg_predicted</span><span class="p">(</span>
    <span class="n">predictions_proba</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert individual probability predictions into aggregate predicted probability distribution using optional weights.</span>
<span class="sd">    Uses a Normal approximation for large datasets (&gt; normal_approx_threshold) for better performance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions_proba : DataFrame</span>
<span class="sd">        A DataFrame containing the probability predictions; must have a single column named &#39;pred_proba&#39;.</span>
<span class="sd">    weights : array-like, optional</span>
<span class="sd">        An array of weights, of the same length as the DataFrame rows, to apply to each prediction.</span>
<span class="sd">    normal_approx_threshold : int, optional (default=30)</span>
<span class="sd">        If the number of rows in predictions_proba exceeds this threshold, use a Normal distribution approximation.</span>
<span class="sd">        Set to None or a very large number to always use the exact symbolic computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">        A DataFrame with a single column &#39;agg_proba&#39; showing the aggregated probability,</span>
<span class="sd">        indexed from 0 to n, where n is the number of predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions_proba</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">normal_approx_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">normal_approx_threshold</span><span class="p">:</span>
        <span class="c1"># Apply a normal approximation for large datasets</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

        <span class="c1"># Apply weights if provided</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">predictions_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">predictions_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Calculate mean and variance for the normal approximation</span>
        <span class="c1"># For a sum of Bernoulli variables, mean = sum of probabilities</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Variance = sum of p_i * (1-p_i)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probs</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Generate probabilities for each possible count using normal approximation</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="c1"># Probability that count = i is the probability that a normal RV falls between i-0.5 and i+0.5</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span>
                    <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">agg_predicted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

        <span class="c1"># Normalize to ensure the probabilities sum to 1</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">agg_predicted_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">agg_predicted_dict</span><span class="p">:</span>
            <span class="n">agg_predicted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use the original symbolic computation for smaller datasets</span>
        <span class="n">local_proba</span> <span class="o">=</span> <span class="n">predictions_proba</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">weights</span>

        <span class="n">syms</span> <span class="o">=</span> <span class="n">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">build_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression_subs</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">local_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">])</span>
        <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">return_coeff</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

    <span class="n">agg_predicted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">agg_predicted_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">agg_predicted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.return_coeff" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">return_coeff</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extract the coefficient of a specified power from an expanded symbolic expression.</p>
<h5 id="patientflow.aggregate.return_coeff--parameters">Parameters</h5>
<p>expression : Expr
    The expression to expand and extract from.
i : int
    The power of the term whose coefficient is to be extracted.</p>
<h5 id="patientflow.aggregate.return_coeff--returns">Returns</h5>
<p>number
    The coefficient of the specified power in the expression.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">return_coeff</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the coefficient of a specified power from an expanded symbolic expression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression : Expr</span>
<span class="sd">        The expression to expand and extract from.</span>
<span class="sd">    i : int</span>
<span class="sd">        The power of the term whose coefficient is to be extracted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    number</span>
<span class="sd">        The coefficient of the specified power in the expression.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expand</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="o">.</span><span class="n">coeff</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.convert" class="doc doc-heading">
            <code>convert</code>


</h2>

    <div class="doc doc-contents ">

        <p>Data Processing and Anonymization for Hospital Visit Records.</p>
<p>This script provides functions to preprocess hospital visit data, including:
- Calculating patient age on arrival and grouping by age ranges.
- Shifting dates forward to anonymize visit data.
- Mapping consultation codes to predefined consultation types.
- Resampling arrival hours in a target dataset based on source data.</p>
<p>The script can be run as a standalone program to adjust arrival hours in a
target dataset using a source dataset's time distribution.</p>
<h4 id="patientflow.convert--functions">Functions</h4>
<ul>
<li>prepare_age_and_dates(df) : Calculates patient age on arrival and categorizes into age groups.</li>
<li>shift_dates_into_future(df, yta, seed_path) : Shifts all date-related fields into the future for anonymization.</li>
<li>map_consultations_to_types(df, name_mapping) : Maps consultation codes to their respective consultation types.</li>
<li>resample_hours(df_source, df_target) : Resamples arrival hours in the target dataset based on the source dataset.</li>
<li>main() : Command-line interface for resampling hours using input CSV files.</li>
</ul>
<h4 id="patientflow.convert--usage">Usage</h4>
<p>To run the script from the command line:
    python3 convert.py --source <source_csv> --target <target_csv> --output <output_csv></p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.convert.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Main function to resample hours from a source dataset to a target dataset.</p>
<p>This function reads input CSV files, resamples arrival times in the target
dataset based on the probability distribution from the source dataset, and
saves the modified target dataset to an output file.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/convert.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function to resample hours from a source dataset to a target dataset.</span>

<span class="sd">    This function reads input CSV files, resamples arrival times in the target</span>
<span class="sd">    dataset based on the probability distribution from the source dataset, and</span>
<span class="sd">    saves the modified target dataset to an output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Resample hours from source arrivals data to target data&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--source&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;data-public/inpatient_arrivals.csv&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Source CSV file with original hour distribution&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--target&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;data-synthetic/inpatient_arrivals.csv&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Target CSV file to modify&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;data-synthetic/inpatient_arrivals_modified.csv&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file path&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">df_source</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">])</span>
    <span class="n">df_target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">])</span>

    <span class="n">df_new</span> <span class="o">=</span> <span class="n">resample_hours</span><span class="p">(</span><span class="n">df_source</span><span class="p">,</span> <span class="n">df_target</span><span class="p">)</span>

    <span class="n">df_new</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modified </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span><span class="si">}</span><span class="s2"> arrival times and saved to </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.convert.map_consultations_to_types" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_consultations_to_types</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name_mapping</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Map consultation codes to their respective types using a predefined mapping.</p>
<h5 id="patientflow.convert.map_consultations_to_types--parameters">Parameters</h5>
<p>df : pandas.DataFrame
    The dataframe containing columns 'consultation_sequence' and 'final_sequence',
    which store lists of consultation codes.
name_mapping : pandas.DataFrame
    A dataframe with 'code' and 'type' columns mapping consultation codes
    to their respective types.</p>
<h5 id="patientflow.convert.map_consultations_to_types--returns">Returns</h5>
<p>pandas.DataFrame
    The modified dataframe with mapped consultation types.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/convert.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_consultations_to_types</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name_mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map consultation codes to their respective types using a predefined mapping.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataframe containing columns &#39;consultation_sequence&#39; and &#39;final_sequence&#39;,</span>
<span class="sd">        which store lists of consultation codes.</span>
<span class="sd">    name_mapping : pandas.DataFrame</span>
<span class="sd">        A dataframe with &#39;code&#39; and &#39;type&#39; columns mapping consultation codes</span>
<span class="sd">        to their respective types.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The modified dataframe with mapped consultation types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code_to_type</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">name_mapping</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span> <span class="n">name_mapping</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_codes_to_types</span><span class="p">(</span><span class="n">codes</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">code_to_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">map_codes_to_types</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;final_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;final_sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">map_codes_to_types</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.convert.prepare_age_and_dates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_age_and_dates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepare age and date-related features in the dataset.</p>
<p>This function calculates the age of individuals on arrival based on their
date of birth and arrival datetime. It also categorizes them into age groups.
If <code>snapshot_datetime</code> exists in the dataframe, it computes the prediction
time, snapshot date, and elapsed length of stay (LOS).</p>
<h5 id="patientflow.convert.prepare_age_and_dates--parameters">Parameters</h5>
<p>df : pandas.DataFrame
    A dataframe containing at least the columns 'date_of_birth' and
    'arrival_datetime'. If 'snapshot_datetime' exists, additional
    computations are performed.</p>
<h5 id="patientflow.convert.prepare_age_and_dates--returns">Returns</h5>
<p>pandas.DataFrame
    The modified dataframe with additional columns:
    - 'age_on_arrival': Numeric representation of age at arrival.
    - 'age_group': Categorical age group.
    - 'prediction_time': Tuple representing the hour and minute of the snapshot.
    - 'snapshot_date': Date extracted from 'snapshot_datetime'.
    - 'elapsed_los': Time in seconds since arrival (if snapshot is available).</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/convert.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_age_and_dates</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare age and date-related features in the dataset.</span>

<span class="sd">    This function calculates the age of individuals on arrival based on their</span>
<span class="sd">    date of birth and arrival datetime. It also categorizes them into age groups.</span>
<span class="sd">    If `snapshot_datetime` exists in the dataframe, it computes the prediction</span>
<span class="sd">    time, snapshot date, and elapsed length of stay (LOS).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A dataframe containing at least the columns &#39;date_of_birth&#39; and</span>
<span class="sd">        &#39;arrival_datetime&#39;. If &#39;snapshot_datetime&#39; exists, additional</span>
<span class="sd">        computations are performed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The modified dataframe with additional columns:</span>
<span class="sd">        - &#39;age_on_arrival&#39;: Numeric representation of age at arrival.</span>
<span class="sd">        - &#39;age_group&#39;: Categorical age group.</span>
<span class="sd">        - &#39;prediction_time&#39;: Tuple representing the hour and minute of the snapshot.</span>
<span class="sd">        - &#39;snapshot_date&#39;: Date extracted from &#39;snapshot_datetime&#39;.</span>
<span class="sd">        - &#39;elapsed_los&#39;: Time in seconds since arrival (if snapshot is available).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date_of_birth&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
        <span class="o">/</span> <span class="mf">365.2425</span>
    <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">102</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0-17&quot;</span><span class="p">,</span> <span class="s2">&quot;18-24&quot;</span><span class="p">,</span> <span class="s2">&quot;25-34&quot;</span><span class="p">,</span> <span class="s2">&quot;35-44&quot;</span><span class="p">,</span> <span class="s2">&quot;45-54&quot;</span><span class="p">,</span> <span class="s2">&quot;55-64&quot;</span><span class="p">,</span> <span class="s2">&quot;65-74&quot;</span><span class="p">,</span> <span class="s2">&quot;75-102&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;snapshot_datetime&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_datetime&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H,%M&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_datetime&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.convert.resample_hours" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resample_hours</span><span class="p">(</span><span class="n">df_source</span><span class="p">,</span> <span class="n">df_target</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Resample arrival hours in <code>df_target</code> based on the probability distribution
of arrival hours from <code>df_source</code>.</p>
<h5 id="patientflow.convert.resample_hours--parameters">Parameters</h5>
<p>df_source : pandas.DataFrame
    Source dataframe with 'arrival_datetime' column to derive the hour distribution.
df_target : pandas.DataFrame
    Target dataframe where arrival hours will be modified.</p>
<h5 id="patientflow.convert.resample_hours--returns">Returns</h5>
<p>pandas.DataFrame
    Modified target dataframe with new arrival hours.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/convert.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resample_hours</span><span class="p">(</span><span class="n">df_source</span><span class="p">,</span> <span class="n">df_target</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample arrival hours in `df_target` based on the probability distribution</span>
<span class="sd">    of arrival hours from `df_source`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_source : pandas.DataFrame</span>
<span class="sd">        Source dataframe with &#39;arrival_datetime&#39; column to derive the hour distribution.</span>
<span class="sd">    df_target : pandas.DataFrame</span>
<span class="sd">        Target dataframe where arrival hours will be modified.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Modified target dataframe with new arrival hours.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arrival_hours</span> <span class="o">=</span> <span class="n">df_source</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">hour_counts</span> <span class="o">=</span> <span class="n">arrival_hours</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">total_arrivals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrival_hours</span><span class="p">)</span>
    <span class="n">hour_probabilities</span> <span class="o">=</span> <span class="n">hour_counts</span> <span class="o">/</span> <span class="n">total_arrivals</span>

    <span class="n">hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hour_probabilities</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hour_probabilities</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">new_hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_target</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">probabilities</span><span class="p">)</span>
    <span class="n">new_datetimes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_target</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">],</span> <span class="n">new_hours</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">df_target</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_datetimes</span>

    <span class="k">return</span> <span class="n">df_target</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.convert.shift_dates_into_future" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shift_dates_into_future</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yta</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Shift all date-related columns into the future to anonymize visit data.</p>
<p>This function reads a random seed from a file, generates a random number
of weeks to shift all date-related columns, and applies this shift.</p>
<h5 id="patientflow.convert.shift_dates_into_future--parameters">Parameters</h5>
<p>df : pandas.DataFrame
    The main dataset containing visit records with date columns.
yta : pandas.DataFrame
    Additional dataset with arrival and departure datetime fields to be shifted.
seed_path : str
    Path to the file containing the seed value.</p>
<h5 id="patientflow.convert.shift_dates_into_future--returns">Returns</h5>
<p>tuple
    A tuple containing the modified <code>df</code> and <code>yta</code> dataframes.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/convert.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">shift_dates_into_future</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yta</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shift all date-related columns into the future to anonymize visit data.</span>

<span class="sd">    This function reads a random seed from a file, generates a random number</span>
<span class="sd">    of weeks to shift all date-related columns, and applies this shift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The main dataset containing visit records with date columns.</span>
<span class="sd">    yta : pandas.DataFrame</span>
<span class="sd">        Additional dataset with arrival and departure datetime fields to be shifted.</span>
<span class="sd">    seed_path : str</span>
<span class="sd">        Path to the file containing the seed value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing the modified `df` and `yta` dataframes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Converting dates to anonymise visits. Current min and max snapshot dates:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seed_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">52</span><span class="p">)</span>  <span class="c1"># Random shift in weeks</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;snapshot_datetime&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;departure_datetime&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New min and max snapshot dates:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">yta</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">yta</span><span class="p">[</span><span class="s2">&quot;departure_datetime&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">yta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.errors" class="doc doc-heading">
            <code>errors</code>


</h2>

    <div class="doc doc-contents ">

        <p>Custom exception classes for model loading and validation.</p>
<p>This module defines specialized exceptions used during model loading,
particularly for handling errors related to missing configuration keys
and general loading failures.</p>
<h4 id="patientflow.errors--classes">Classes</h4>
<p>ModelLoadError
    Raised when a model fails to load due to an unspecified error.</p>
<p>MissingKeysError
    Raised when expected keys are missing from a dictionary of special parameters.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="patientflow.errors.MissingKeysError" class="doc doc-heading">
            <code>MissingKeysError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code></p>


        <p>Exception raised when required keys are missing from special_params.</p>
<h5 id="patientflow.errors.MissingKeysError--parameters">Parameters</h5>
<p>missing_keys : list or set
    The keys that are required but missing from the input dictionary.</p>
<h5 id="patientflow.errors.MissingKeysError--attributes">Attributes</h5>
<p>missing_keys : list or set
    Stores the missing keys that caused the exception.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MissingKeysError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when required keys are missing from special_params.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    missing_keys : list or set</span>
<span class="sd">        The keys that are required but missing from the input dictionary.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    missing_keys : list or set</span>
<span class="sd">        Stores the missing keys that caused the exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">missing_keys</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;special_params is missing required keys: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_keys</span> <span class="o">=</span> <span class="n">missing_keys</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.errors.ModelLoadError" class="doc doc-heading">
            <code>ModelLoadError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#Exception">Exception</a></code></p>


        <p>Exception raised when a model fails to load.</p>
<p>This generic exception can be used to signal a failure during the model
loading process due to unexpected issues such as file corruption,
invalid formats, or unsupported configurations.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ModelLoadError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a model fails to load.</span>

<span class="sd">    This generic exception can be used to signal a failure during the model</span>
<span class="sd">    loading process due to unexpected issues such as file corruption,</span>
<span class="sd">    invalid formats, or unsupported configurations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.evaluate" class="doc doc-heading">
            <code>evaluate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Patient Flow Evaluation Module</p>
<p>This module provides functions for evaluating and comparing different prediction models
for patient admissions in a healthcare setting. It includes utilities for calculating
metrics such as Mean Absolute Error (MAE) and Mean Percentage Error (MPE), as well as
functions for predicting admissions based on historical data and combining different
prediction models.</p>
<p>Key Features:
- Evaluation of probability distribution-based prediction models
- Calculation of observed admissions based on ED targets
- Prediction using historical data from previous weeks
- Combination and evaluation of multiple prediction models</p>
<p>Main Functions:
- calc_mae_mpe: Calculate MAE and MPE for probability distribution predictions
- calculate_weighted_observed: Calculate actual admissions assuming ED targets are met
- predict_using_previous_weeks: Predict admissions using average from previous weeks
- evaluate_six_week_average: Evaluate the six-week average prediction model
- evaluate_combined_model: Evaluate a combined prediction model</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calc_mae_mpe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_mae_mpe</span><span class="p">(</span><span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">use_most_probable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate MAE and MPE for all prediction times in the given probability distribution dictionary.
Results are sorted by prediction time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_most_probable</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the most probable value or expected value. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]: Dictionary of results sorted by prediction time.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_mae_mpe</span><span class="p">(</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">use_most_probable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate MAE and MPE for all prediction times in the given probability distribution dictionary.</span>
<span class="sd">    Results are sorted by prediction time.</span>

<span class="sd">    Args:</span>
<span class="sd">        prob_dist_dict_all (Dict[Any, Dict[Any, Dict[str, Any]]]): Nested dictionary containing probability distributions.</span>
<span class="sd">        use_most_probable (bool, optional): Whether to use the most probable value or expected value. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]: Dictionary of results sorted by prediction time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create temporary results dictionary</span>
    <span class="n">unsorted_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process results as before</span>
    <span class="k">for</span> <span class="n">_prediction_time</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">_prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">preds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">_prediction_time</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span>

            <span class="n">expected_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">use_most_probable</span>
                <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                        <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">observed_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">])</span>

            <span class="n">expected_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expected_value</span><span class="p">)</span>
            <span class="n">observed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_value</span><span class="p">)</span>

        <span class="n">unsorted_results</span><span class="p">[</span><span class="n">_prediction_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_results</span><span class="p">(</span>
            <span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span>
        <span class="p">)</span>

    <span class="c1"># Sort results by prediction time</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_time_value</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Extract time from key (e.g., &#39;admissions_1530&#39; -&gt; 1530)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

    <span class="c1"># Create sorted dictionary</span>
    <span class="n">sorted_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">unsorted_results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_time_value</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">sorted_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calculate_admission_probs_relative_to_prediction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_datetime</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">is_before</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate admission probabilities for arrivals relative to a prediction time window</p>
<p>Parameters:
df: DataFrame containing arrival_datetime column
prediction_datetime: datetime for prediction window start
prediction_window: window length in minutes
x1, y1, x2, y2: parameters for aspirational curve
is_before: boolean indicating if arrivals are before prediction time</p>
<p>Returns:
DataFrame with added probability columns</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">prediction_datetime</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">is_before</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate admission probabilities for arrivals relative to a prediction time window</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df: DataFrame containing arrival_datetime column</span>
<span class="sd">    prediction_datetime: datetime for prediction window start</span>
<span class="sd">    prediction_window: window length in minutes</span>
<span class="sd">    x1, y1, x2, y2: parameters for aspirational curve</span>
<span class="sd">    is_before: boolean indicating if arrivals are before prediction time</span>

<span class="sd">    Returns:</span>
<span class="sd">    DataFrame with added probability columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">is_before</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hours_before_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">prediction_datetime</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;prob_admission_before_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="s2">&quot;hours_before_pred_window&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="s2">&quot;hours_before_pred_window&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">+</span> <span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hours_after_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">prediction_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="s2">&quot;hours_after_pred_window&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calculate_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_results</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate evaluation metrics based on expected and observed values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>expected_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of expected values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>observed_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of observed values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Union[List[Union[int, float]], float]]: Dictionary containing expected values, observed values, MAE, and MPE.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_results</span><span class="p">(</span>
    <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate evaluation metrics based on expected and observed values.</span>

<span class="sd">    Args:</span>
<span class="sd">        expected_values (List[Union[int, float]]): List of expected values.</span>
<span class="sd">        observed_values (List[float]): List of observed values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Union[List[Union[int, float]], float]]: Dictionary containing expected values, observed values, MAE, and MPE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)</span>
    <span class="n">observed_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">observed_values</span><span class="p">)</span>

    <span class="n">absolute_errors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">expected_array</span> <span class="o">-</span> <span class="n">observed_array</span><span class="p">)</span>
    <span class="n">mae</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">absolute_errors</span><span class="p">))</span>

    <span class="n">non_zero_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">observed_array</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">filtered_absolute_errors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">absolute_errors</span><span class="p">[</span><span class="n">non_zero_mask</span><span class="p">]</span>
    <span class="n">filtered_observed_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">observed_array</span><span class="p">[</span><span class="n">non_zero_mask</span><span class="p">]</span>

    <span class="n">percentage_errors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">filtered_absolute_errors</span> <span class="o">/</span> <span class="n">filtered_observed_array</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">)</span>
    <span class="n">mpe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">percentage_errors</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_values</span><span class="p">,</span>
        <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">observed_values</span><span class="p">,</span>
        <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
        <span class="s2">&quot;mpe&quot;</span><span class="p">:</span> <span class="n">mpe</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calculate_weighted_observed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_weighted_observed</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate weighted observed admissions for a specific date and prediction window</p>
<p>Parameters:
df: DataFrame with arrival_datetime column
dt: target date
prediction_window: window length in minutes
x1, y1, x2, y2: parameters for aspirational curve
prediction_time: tuple of (hour, minute)</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_weighted_observed</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate weighted observed admissions for a specific date and prediction window</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df: DataFrame with arrival_datetime column</span>
<span class="sd">    dt: target date</span>
<span class="sd">    prediction_window: window length in minutes</span>
<span class="sd">    x1, y1, x2, y2: parameters for aspirational curve</span>
<span class="sd">    prediction_time: tuple of (hour, minute)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create prediction datetime</span>
    <span class="n">prediction_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="n">hour</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">minute</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Filter for target date and get arrivals with probabilities</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">dt</span><span class="p">]</span>
    <span class="n">arrived_before</span><span class="p">,</span> <span class="n">arrived_after</span> <span class="o">=</span> <span class="n">get_arrivals_with_admission_probs</span><span class="p">(</span>
        <span class="n">filtered_df</span><span class="p">,</span>
        <span class="n">prediction_datetime</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">x1</span><span class="p">,</span>
        <span class="n">y1</span><span class="p">,</span>
        <span class="n">x2</span><span class="p">,</span>
        <span class="n">y2</span><span class="p">,</span>
        <span class="n">target_date</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Calculate weighted sum</span>
    <span class="n">weighted_observed</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">arrived_before</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">arrived_after</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">weighted_observed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.combine_distributions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">combine_distributions</span><span class="p">(</span><span class="n">dist1</span><span class="p">,</span> <span class="n">dist2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Combine two probability distributions using convolution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dist1</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First probability distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dist2</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second probability distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Combined probability distribution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">combine_distributions</span><span class="p">(</span><span class="n">dist1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dist2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine two probability distributions using convolution.</span>

<span class="sd">    Args:</span>
<span class="sd">        dist1 (pd.DataFrame): First probability distribution.</span>
<span class="sd">        dist2 (pd.DataFrame): Second probability distribution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Combined probability distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr1</span> <span class="o">=</span> <span class="n">dist1</span><span class="o">.</span><span class="n">values</span>
    <span class="n">arr2</span> <span class="o">=</span> <span class="n">dist2</span><span class="o">.</span><span class="n">values</span>

    <span class="n">combined</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)</span>
    <span class="n">new_index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>

    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">new_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">])</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">combined_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.create_time_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_time_mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a mask for times before/after a specific hour:minute</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_time_mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mask for times before/after a specific hour:minute&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="n">hour</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">hour</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;</span> <span class="n">minute</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.evaluate_combined_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_combined_model</span><span class="p">(</span><span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">yta_preds</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">use_most_probable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Evaluate the combined prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_preds</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Yet-to-arrive predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code>float), y1 (float), x2 (float), y2 (float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour and minute of prediction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_weeks</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of previous weeks to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_most_probable</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the most probable value or expected value. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]: Evaluation results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_combined_model</span><span class="p">(</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">yta_preds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">num_weeks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_most_probable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the combined prediction model.</span>

<span class="sd">    Args:</span>
<span class="sd">        prob_dist_dict_all (Dict[Any, Dict[Any, Dict[str, Any]]]): Nested dictionary containing probability distributions.</span>
<span class="sd">        df (pd.DataFrame): DataFrame containing patient data.</span>
<span class="sd">        yta_preds (pd.DataFrame): Yet-to-arrive predictions.</span>
<span class="sd">        prediction_window (int): Prediction window in minutes.</span>
<span class="sd">        x1 (float), y1 (float), x2 (float), y2 (float): Parameters for aspirational curve.</span>
<span class="sd">        prediction_time (Tuple[int, int]): Hour and minute of prediction.</span>
<span class="sd">        num_weeks (int): Number of previous weeks to consider.</span>
<span class="sd">        model_name (str): Name of the model.</span>
<span class="sd">        use_most_probable (bool, optional): Whether to use the most probable value or expected value. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]: Evaluation results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">in_ed_preds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">combine_distributions</span><span class="p">(</span><span class="n">yta_preds</span><span class="p">,</span> <span class="n">in_ed_preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">])</span>

        <span class="n">expected_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">use_most_probable</span>
            <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">observed_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">calculate_weighted_observed</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">expected_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expected_value</span><span class="p">)</span>
        <span class="n">observed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_value</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_name</span><span class="p">:</span> <span class="n">calculate_results</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.evaluate_six_week_average" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_six_week_average</span><span class="p">(</span><span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Evaluate the six-week average prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code>float), y1 (float), x2 (float), y2 (float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour and minute of prediction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_weeks</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of previous weeks to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]: Evaluation results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_six_week_average</span><span class="p">(</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">num_weeks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the six-week average prediction model.</span>

<span class="sd">    Args:</span>
<span class="sd">        prob_dist_dict_all (Dict[Any, Dict[Any, Dict[str, Any]]]): Nested dictionary containing probability distributions.</span>
<span class="sd">        df (pd.DataFrame): DataFrame containing patient data.</span>
<span class="sd">        prediction_window (int): Prediction window in minutes.</span>
<span class="sd">        x1 (float), y1 (float), x2 (float), y2 (float): Parameters for aspirational curve.</span>
<span class="sd">        prediction_time (Tuple[int, int]): Hour and minute of prediction.</span>
<span class="sd">        num_weeks (int): Number of previous weeks to consider.</span>
<span class="sd">        model_name (str): Name of the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]: Evaluation results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">expected_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">predict_using_previous_weeks</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">observed_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">calculate_weighted_observed</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">expected_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expected_value</span><span class="p">)</span>
        <span class="n">observed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_value</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_name</span><span class="p">:</span> <span class="n">calculate_results</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.get_arrivals_with_admission_probs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_arrivals_with_admission_probs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_datetime</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">date_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_weekday</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get arrivals before and after prediction time with their admission probabilities</p>
<p>Parameters:
df: DataFrame with arrival_datetime column
prediction_datetime: datetime for prediction window start
prediction_window: window length in minutes
prediction_time: tuple of (hour, minute)
x1, y1, x2, y2: parameters for aspirational curve
date_range: optional tuple of (start_date, end_date)
target_date: optional specific date to analyze
target_weekday: optional specific weekday to filter for</p>
<p>Returns:
tuple of (arrived_before, arrived_after) DataFrames for specified time period</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_arrivals_with_admission_probs</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">prediction_datetime</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">,</span>
    <span class="n">date_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_weekday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get arrivals before and after prediction time with their admission probabilities</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df: DataFrame with arrival_datetime column</span>
<span class="sd">    prediction_datetime: datetime for prediction window start</span>
<span class="sd">    prediction_window: window length in minutes</span>
<span class="sd">    prediction_time: tuple of (hour, minute)</span>
<span class="sd">    x1, y1, x2, y2: parameters for aspirational curve</span>
<span class="sd">    date_range: optional tuple of (start_date, end_date)</span>
<span class="sd">    target_date: optional specific date to analyze</span>
<span class="sd">    target_weekday: optional specific weekday to filter for</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple of (arrived_before, arrived_after) DataFrames for specified time period</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">prediction_time</span>

    <span class="c1"># Create base time masks</span>
    <span class="n">after_mask</span> <span class="o">=</span> <span class="n">create_time_mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span>
    <span class="n">before_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">after_mask</span>

    <span class="c1"># Add date and weekday conditions if specified</span>
    <span class="k">if</span> <span class="n">date_range</span><span class="p">:</span>
        <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">date_range</span>
        <span class="n">date_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">end_date</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">target_weekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_mask</span> <span class="o">&amp;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">==</span> <span class="n">target_weekday</span>

        <span class="n">after_mask</span> <span class="o">&amp;=</span> <span class="n">date_mask</span>
        <span class="n">before_mask</span> <span class="o">&amp;=</span> <span class="n">date_mask</span>

    <span class="k">if</span> <span class="n">target_date</span><span class="p">:</span>
        <span class="n">target_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">target_date</span>
        <span class="n">after_mask</span> <span class="o">&amp;=</span> <span class="n">target_mask</span>
        <span class="n">before_mask</span> <span class="o">&amp;=</span> <span class="n">target_mask</span>

    <span class="c1"># Calculate probabilities for filtered groups</span>
    <span class="n">arrived_before</span> <span class="o">=</span> <span class="n">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">before_mask</span><span class="p">],</span>
        <span class="n">prediction_datetime</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">x1</span><span class="p">,</span>
        <span class="n">y1</span><span class="p">,</span>
        <span class="n">x2</span><span class="p">,</span>
        <span class="n">y2</span><span class="p">,</span>
        <span class="n">is_before</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">arrived_after</span> <span class="o">=</span> <span class="n">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">after_mask</span><span class="p">],</span>
        <span class="n">prediction_datetime</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">x1</span><span class="p">,</span>
        <span class="n">y1</span><span class="p">,</span>
        <span class="n">x2</span><span class="p">,</span>
        <span class="n">y2</span><span class="p">,</span>
        <span class="n">is_before</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">arrived_before</span><span class="p">,</span> <span class="n">arrived_after</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.predict_using_previous_weeks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_using_previous_weeks</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate predicted admissions remaining until midnight.
Args:
    df (pd.DataFrame): DataFrame containing patient data.
    dt (datetime): Date for prediction.
    prediction_time (Tuple[int, int]): Hour and minute of prediction.
    num_weeks (int): Number of previous weeks to consider.
    weighted(bool): Whether to weight the numbers according to aspirational ED targets
Returns:
    float: Predicted number of admissions remaining until midnight.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_using_previous_weeks</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">num_weeks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate predicted admissions remaining until midnight.</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): DataFrame containing patient data.</span>
<span class="sd">        dt (datetime): Date for prediction.</span>
<span class="sd">        prediction_time (Tuple[int, int]): Hour and minute of prediction.</span>
<span class="sd">        num_weeks (int): Number of previous weeks to consider.</span>
<span class="sd">        weighted(bool): Whether to weight the numbers according to aspirational ED targets</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: Predicted number of admissions remaining until midnight.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prediction_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="n">hour</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">minute</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">target_day_of_week</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

    <span class="n">end_date</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="n">num_weeks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weighted</span><span class="p">:</span>
        <span class="c1"># Create mask for historical data</span>
        <span class="n">historical_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">==</span> <span class="n">target_day_of_week</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create explicit copy of filtered data</span>
        <span class="n">historical_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">historical_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Calculate minutes until midnight</span>
        <span class="n">midnight_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">historical_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">historical_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;minutes_to_midnight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">midnight_times</span> <span class="o">-</span> <span class="n">historical_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># Calculate admission probabilities</span>
        <span class="n">historical_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">historical_data</span><span class="p">[</span>
            <span class="s2">&quot;minutes_to_midnight&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

        <span class="c1"># Group by date and calculate average</span>
        <span class="n">historical_daily_sums</span> <span class="o">=</span> <span class="n">historical_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">historical_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="p">)[</span><span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">historical_average</span> <span class="o">=</span> <span class="n">historical_daily_sums</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Create mask for today&#39;s data</span>
        <span class="n">today_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">dt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prediction_datetime</span>
        <span class="p">)</span>

        <span class="c1"># Create explicit copy of today&#39;s filtered data</span>
        <span class="n">today_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">today_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Calculate minutes until midnight for today&#39;s data</span>
        <span class="n">midnight_today</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">today_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;minutes_to_midnight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">midnight_today</span> <span class="o">-</span> <span class="n">today_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># Calculate admission probabilities for today</span>
        <span class="n">today_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_data</span><span class="p">[</span>
            <span class="s2">&quot;minutes_to_midnight&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

        <span class="n">today_sum</span> <span class="o">=</span> <span class="n">today_data</span><span class="p">[</span><span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">still_to_admit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">historical_average</span> <span class="o">-</span> <span class="n">today_sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Original unweighted logic with explicit copies</span>
        <span class="n">historical_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">==</span> <span class="n">target_day_of_week</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">historical_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">historical_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">average_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_df</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_weeks</span>

        <span class="n">target_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">dt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prediction_datetime</span>
        <span class="p">)</span>
        <span class="n">target_date_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_mask</span><span class="p">])</span>

        <span class="n">still_to_admit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">average_count</span> <span class="o">-</span> <span class="n">target_date_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">still_to_admit</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.generate" class="doc doc-heading">
            <code>generate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Fake Emergency Department Visit Generator.</p>
<p>This module provides functions to generate fake datasets for patient visits to an emergency department (ED).
It generates arrival and departure times, triage scores, lab orders, and patient admissions.
The functions are used for illustrative purposes in some of the notebooks.</p>
<h4 id="patientflow.generate--functions">Functions</h4>
<p>create_fake_finished_visits(start_date, end_date, mean_patients_per_day)
    Generate synthetic patient visits, triage observations, and lab orders.</p>
<p>create_fake_snapshots(prediction_times, start_date, end_date, df, observations_df, lab_orders_df, mean_patients_per_day)
    Create patient-level snapshots at specific times with visit, triage, and lab features.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.generate.create_fake_finished_visits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_fake_finished_visits</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">mean_patients_per_day</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate synthetic patient visit data for an emergency department.</p>
<p>This function simulates a realistic distribution of patient arrivals, triage scores, lengths of stay,
admissions, and lab orders over a specified date range. Some patients may have multiple visits.</p>
<h5 id="patientflow.generate.create_fake_finished_visits--parameters">Parameters</h5>
<p>start_date : str or datetime
    The starting date for the simulation (inclusive). Can be a datetime object or a string in 'YYYY-MM-DD' format.
end_date : str or datetime
    The ending date for the simulation (exclusive). Can be a datetime object or a string in 'YYYY-MM-DD' format.
mean_patients_per_day : float
    The average number of patient visits to generate per day.</p>
<h5 id="patientflow.generate.create_fake_finished_visits--returns">Returns</h5>
<p>visits_df : pandas.DataFrame
    DataFrame containing visit records with the following columns:
    - 'visit_number'
    - 'patient_id'
    - 'arrival_datetime'
    - 'departure_datetime'
    - 'is_admitted'
    - 'age'
observations_df : pandas.DataFrame
    DataFrame containing triage score observations with columns:
    - 'visit_number'
    - 'observation_datetime'
    - 'triage_score'
lab_orders_df : pandas.DataFrame
    DataFrame containing lab test orders with columns:
    - 'visit_number'
    - 'order_datetime'
    - 'lab_name'</p>
<h5 id="patientflow.generate.create_fake_finished_visits--notes">Notes</h5>
<ul>
<li>Patients are more likely to arrive during daytime hours.</li>
<li>20% of patients will have more than one visit during the simulation period.</li>
<li>Lab test ordering likelihood depends on the severity of the triage score.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/generate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_fake_finished_visits</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">mean_patients_per_day</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate synthetic patient visit data for an emergency department.</span>

<span class="sd">    This function simulates a realistic distribution of patient arrivals, triage scores, lengths of stay,</span>
<span class="sd">    admissions, and lab orders over a specified date range. Some patients may have multiple visits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_date : str or datetime</span>
<span class="sd">        The starting date for the simulation (inclusive). Can be a datetime object or a string in &#39;YYYY-MM-DD&#39; format.</span>
<span class="sd">    end_date : str or datetime</span>
<span class="sd">        The ending date for the simulation (exclusive). Can be a datetime object or a string in &#39;YYYY-MM-DD&#39; format.</span>
<span class="sd">    mean_patients_per_day : float</span>
<span class="sd">        The average number of patient visits to generate per day.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    visits_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing visit records with the following columns:</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;patient_id&#39;</span>
<span class="sd">        - &#39;arrival_datetime&#39;</span>
<span class="sd">        - &#39;departure_datetime&#39;</span>
<span class="sd">        - &#39;is_admitted&#39;</span>
<span class="sd">        - &#39;age&#39;</span>
<span class="sd">    observations_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing triage score observations with columns:</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;observation_datetime&#39;</span>
<span class="sd">        - &#39;triage_score&#39;</span>
<span class="sd">    lab_orders_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing lab test orders with columns:</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;order_datetime&#39;</span>
<span class="sd">        - &#39;lab_name&#39;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Patients are more likely to arrive during daytime hours.</span>
<span class="sd">    - 20% of patients will have more than one visit during the simulation period.</span>
<span class="sd">    - Lab test ordering likelihood depends on the severity of the triage score.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert string dates to datetime if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set random seed for reproducibility</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># You can change this seed value as needed</span>

    <span class="c1"># Calculate total days in range (changed to exclusive end date)</span>
    <span class="n">days_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="c1"># Generate random number of patients for each day using Poisson distribution</span>
    <span class="n">daily_patients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">mean_patients_per_day</span><span class="p">,</span> <span class="n">days_range</span><span class="p">)</span>

    <span class="c1"># Calculate the total number of visits</span>
    <span class="n">total_visits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">daily_patients</span><span class="p">)</span>

    <span class="c1"># Calculate approximately how many unique patients we need</span>
    <span class="c1"># If 20% of patients have more than one visit (let&#39;s assume they have exactly 2),</span>
    <span class="c1"># then for N total visits, we need approximately N * 0.8 + (N * 0.2) / 2 unique patients</span>
    <span class="c1"># Simplifying: N * (0.8 + 0.1) = N * 0.9 unique patients</span>
    <span class="n">num_unique_patients</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_visits</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>

    <span class="c1"># Create patient ids</span>
    <span class="n">patient_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_unique_patients</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Define admission probabilities based on triage score</span>
    <span class="c1"># Triage 1: 80% admission, Triage 2: 60%, Triage 3: 30%, Triage 4: 10%, Triage 5: 2%</span>
    <span class="n">admission_probabilities</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>  <span class="c1"># Highest severity - highest admission probability</span>
        <span class="mi">2</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>  <span class="c1"># Lowest severity - lowest admission probability</span>
    <span class="p">}</span>

    <span class="c1"># Define triage score distribution</span>
    <span class="c1"># Most common is 3-4, less common are 2 and 5, least common is 1 (most severe)</span>
    <span class="n">triage_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">]</span>  <span class="c1"># For scores 1-5</span>

    <span class="c1"># Define common ED lab tests and their ordering probabilities based on triage score</span>
    <span class="n">lab_tests</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CBC&quot;</span><span class="p">,</span> <span class="s2">&quot;BMP&quot;</span><span class="p">,</span> <span class="s2">&quot;Troponin&quot;</span><span class="p">,</span> <span class="s2">&quot;D-dimer&quot;</span><span class="p">,</span> <span class="s2">&quot;Urinalysis&quot;</span><span class="p">]</span>
    <span class="n">lab_probabilities</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Higher severity -&gt; more likely to get labs</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.70</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.50</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">5</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">visits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lab_orders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visit_number</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Create a dictionary to track number of visits per patient</span>
    <span class="n">patient_visit_count</span> <span class="o">=</span> <span class="p">{</span><span class="n">patient_id</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">}</span>

    <span class="c1"># Create a pool of patients who will have multiple visits (20% of patients)</span>
    <span class="n">multi_visit_patients</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">patient_ids</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">num_unique_patients</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">day_idx</span><span class="p">,</span> <span class="n">num_patients</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">daily_patients</span><span class="p">):</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">day_idx</span><span class="p">)</span>

        <span class="c1"># Generate patients for this day</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patients</span><span class="p">):</span>
            <span class="c1"># Select a patient ID based on our requirements</span>
            <span class="c1"># If we haven&#39;t assigned all patients yet, use a new one</span>
            <span class="c1"># Otherwise, pick from multi-visit patients</span>
            <span class="n">available_new_patients</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">patient_ids</span> <span class="k">if</span> <span class="n">patient_visit_count</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">available_new_patients</span><span class="p">:</span>
                <span class="c1"># Use a new patient</span>
                <span class="n">patient_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_new_patients</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># All patients have at least one visit, now use multi-visit patients</span>
                <span class="n">patient_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">multi_visit_patients</span><span class="p">))</span>

            <span class="c1"># Increment the visit count for this patient</span>
            <span class="n">patient_visit_count</span><span class="p">[</span><span class="n">patient_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Random hour for arrival (more likely during daytime)</span>
            <span class="n">arrival_hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Mean at 1 PM, std dev of 4 hours</span>
            <span class="n">arrival_hour</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">arrival_hour</span><span class="p">)))</span>  <span class="c1"># Clamp between 0-23</span>

            <span class="c1"># Random minutes</span>
            <span class="n">arrival_minute</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

            <span class="c1"># Create arrival datetime</span>
            <span class="n">arrival_datetime</span> <span class="o">=</span> <span class="n">current_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">hour</span><span class="o">=</span><span class="n">arrival_hour</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="n">arrival_minute</span><span class="p">,</span>
                <span class="n">second</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Generate triage score (1-5)</span>
            <span class="n">triage_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="n">triage_probabilities</span><span class="p">)</span>

            <span class="c1"># Generate length of stay (in minutes) - log-normal distribution</span>
            <span class="c1"># Most visits are 2 to 6 hours, but some can be shorter or longer</span>
            <span class="n">length_of_stay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">5.2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">length_of_stay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">30</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1440</span><span class="p">,</span> <span class="n">length_of_stay</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># Between 30 min and 24 hours</span>

            <span class="c1"># Make higher triage scores (more severe) stay longer on average</span>
            <span class="k">if</span> <span class="n">triage_score</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">length_of_stay</span> <span class="o">*=</span> <span class="mf">1.5</span>  <span class="c1"># 50% longer stays for more severe cases</span>

            <span class="c1"># Calculate departure time</span>
            <span class="n">departure_datetime</span> <span class="o">=</span> <span class="n">arrival_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">length_of_stay</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Generate admission status based on triage score</span>
            <span class="n">admission_prob</span> <span class="o">=</span> <span class="n">admission_probabilities</span><span class="p">[</span><span class="n">triage_score</span><span class="p">]</span>
            <span class="n">is_admitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">admission_prob</span><span class="p">,</span> <span class="n">admission_prob</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># For returning patients, use the same age as their first visit</span>
            <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">visits</span><span class="p">]:</span>
                <span class="c1"># Find the age from a previous visit</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">visits</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">patient_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Generate age with a distribution skewed towards older adults</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">3.8</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># Centers around 45 years</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">age</span><span class="p">))</span>  <span class="c1"># Clamp between 0-100 years</span>

            <span class="c1"># Add visit record (without triage score, but with patient_id)</span>
            <span class="n">visits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                    <span class="s2">&quot;visit_number&quot;</span><span class="p">:</span> <span class="n">visit_number</span><span class="p">,</span>
                    <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">:</span> <span class="n">arrival_datetime</span><span class="p">,</span>
                    <span class="s2">&quot;departure_datetime&quot;</span><span class="p">:</span> <span class="n">departure_datetime</span><span class="p">,</span>
                    <span class="s2">&quot;is_admitted&quot;</span><span class="p">:</span> <span class="n">is_admitted</span><span class="p">,</span>
                    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">age</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Generate triage observation within first 10 minutes</span>
            <span class="n">minutes_after_arrival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">observation_datetime</span> <span class="o">=</span> <span class="n">arrival_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">minutes</span><span class="o">=</span><span class="n">minutes_after_arrival</span>
            <span class="p">)</span>

            <span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;visit_number&quot;</span><span class="p">:</span> <span class="n">visit_number</span><span class="p">,</span>
                    <span class="s2">&quot;observation_datetime&quot;</span><span class="p">:</span> <span class="n">observation_datetime</span><span class="p">,</span>
                    <span class="s2">&quot;triage_score&quot;</span><span class="p">:</span> <span class="n">triage_score</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Generate lab orders if visit is longer than 2 hours</span>
            <span class="k">if</span> <span class="n">length_of_stay</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span>
                <span class="c1"># For each lab test, decide if it should be ordered based on triage score</span>
                <span class="k">for</span> <span class="n">lab_test</span> <span class="ow">in</span> <span class="n">lab_tests</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">lab_probabilities</span><span class="p">[</span><span class="n">triage_score</span><span class="p">][</span><span class="n">lab_test</span><span class="p">]:</span>
                        <span class="c1"># Order time is after triage but within first 90 minutes</span>
                        <span class="n">minutes_after_triage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                            <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">minutes_after_arrival</span>
                        <span class="p">)</span>
                        <span class="n">order_datetime</span> <span class="o">=</span> <span class="n">observation_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                            <span class="n">minutes</span><span class="o">=</span><span class="n">minutes_after_triage</span>
                        <span class="p">)</span>

                        <span class="n">lab_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;visit_number&quot;</span><span class="p">:</span> <span class="n">visit_number</span><span class="p">,</span>
                                <span class="s2">&quot;order_datetime&quot;</span><span class="p">:</span> <span class="n">order_datetime</span><span class="p">,</span>
                                <span class="s2">&quot;lab_name&quot;</span><span class="p">:</span> <span class="n">lab_test</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

            <span class="n">visit_number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Create DataFrames and sort by time</span>
    <span class="n">visits_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">visits</span><span class="p">)</span>
    <span class="n">visits_df</span> <span class="o">=</span> <span class="n">visits_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">observations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
    <span class="n">observations_df</span> <span class="o">=</span> <span class="n">observations_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;observation_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">lab_orders_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lab_orders</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lab_orders_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">lab_orders_df</span> <span class="o">=</span> <span class="n">lab_orders_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;order_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">visits_df</span><span class="p">,</span> <span class="n">observations_df</span><span class="p">,</span> <span class="n">lab_orders_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.generate.create_fake_snapshots" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_fake_snapshots</span><span class="p">(</span><span class="n">prediction_times</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">observations_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lab_orders_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_patients_per_day</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate patient-level snapshots at specific times for prediction modeling.</p>
<p>For each specified time on each date in the range, this function returns a snapshot of patients
who are currently in the emergency department, along with their visit features, latest triage score,
and number of lab tests ordered prior to that time.</p>
<h5 id="patientflow.generate.create_fake_snapshots--parameters">Parameters</h5>
<p>prediction_times : list of tuple of int
    A list of (hour, minute) tuples indicating times of day to create snapshots.
start_date : str or datetime
    The starting date for generating snapshots (inclusive).
end_date : str or datetime
    The ending date for generating snapshots (exclusive).
df : pandas.DataFrame, optional
    Patient visit data from <code>create_fake_finished_visits</code>. If None, synthetic data is generated.
observations_df : pandas.DataFrame, optional
    Triage score data from <code>create_fake_finished_visits</code>. If None, synthetic data is generated.
lab_orders_df : pandas.DataFrame, optional
    Lab order data from <code>create_fake_finished_visits</code>. If None, synthetic data is generated.
mean_patients_per_day : float, optional
    Average number of patients per day (used only if synthetic data is generated).</p>
<h5 id="patientflow.generate.create_fake_snapshots--returns">Returns</h5>
<p>final_df : pandas.DataFrame
    A DataFrame with one row per patient visit present at the snapshot time. Columns include:
    - 'snapshot_date'
    - 'prediction_time'
    - 'patient_id'
    - 'visit_number'
    - 'is_admitted'
    - 'age'
    - 'latest_triage_score'
    - One column per lab test: 'num_<lab_name>_orders'</p>
<h5 id="patientflow.generate.create_fake_snapshots--notes">Notes</h5>
<ul>
<li>Only patients present in the ED at the snapshot time are included.</li>
<li>Lab order columns reflect counts of tests ordered before the snapshot time.</li>
<li>If no patients are present at a snapshot time, that snapshot is omitted.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/generate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_fake_snapshots</span><span class="p">(</span>
    <span class="n">prediction_times</span><span class="p">,</span>
    <span class="n">start_date</span><span class="p">,</span>
    <span class="n">end_date</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">observations_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_orders_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mean_patients_per_day</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate patient-level snapshots at specific times for prediction modeling.</span>

<span class="sd">    For each specified time on each date in the range, this function returns a snapshot of patients</span>
<span class="sd">    who are currently in the emergency department, along with their visit features, latest triage score,</span>
<span class="sd">    and number of lab tests ordered prior to that time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_times : list of tuple of int</span>
<span class="sd">        A list of (hour, minute) tuples indicating times of day to create snapshots.</span>
<span class="sd">    start_date : str or datetime</span>
<span class="sd">        The starting date for generating snapshots (inclusive).</span>
<span class="sd">    end_date : str or datetime</span>
<span class="sd">        The ending date for generating snapshots (exclusive).</span>
<span class="sd">    df : pandas.DataFrame, optional</span>
<span class="sd">        Patient visit data from `create_fake_finished_visits`. If None, synthetic data is generated.</span>
<span class="sd">    observations_df : pandas.DataFrame, optional</span>
<span class="sd">        Triage score data from `create_fake_finished_visits`. If None, synthetic data is generated.</span>
<span class="sd">    lab_orders_df : pandas.DataFrame, optional</span>
<span class="sd">        Lab order data from `create_fake_finished_visits`. If None, synthetic data is generated.</span>
<span class="sd">    mean_patients_per_day : float, optional</span>
<span class="sd">        Average number of patients per day (used only if synthetic data is generated).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    final_df : pandas.DataFrame</span>
<span class="sd">        A DataFrame with one row per patient visit present at the snapshot time. Columns include:</span>
<span class="sd">        - &#39;snapshot_date&#39;</span>
<span class="sd">        - &#39;prediction_time&#39;</span>
<span class="sd">        - &#39;patient_id&#39;</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;is_admitted&#39;</span>
<span class="sd">        - &#39;age&#39;</span>
<span class="sd">        - &#39;latest_triage_score&#39;</span>
<span class="sd">        - One column per lab test: &#39;num_&lt;lab_name&gt;_orders&#39;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Only patients present in the ED at the snapshot time are included.</span>
<span class="sd">    - Lab order columns reflect counts of tests ordered before the snapshot time.</span>
<span class="sd">    - If no patients are present at a snapshot time, that snapshot is omitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Generate fake data if not provided</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">observations_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lab_orders_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">observations_df</span><span class="p">,</span> <span class="n">lab_orders_df</span> <span class="o">=</span> <span class="n">create_fake_finished_visits</span><span class="p">(</span>
            <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">mean_patients_per_day</span>
        <span class="p">)</span>

    <span class="c1"># Add date conversion at the start</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="c1"># Create date range (changed to exclusive end date)</span>
    <span class="n">snapshot_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_date</span>
    <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;</span> <span class="n">end_date</span><span class="p">:</span>  <span class="c1"># Changed from &lt;= to &lt;</span>
        <span class="n">snapshot_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_date</span><span class="p">)</span>
        <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get unique lab test names</span>
    <span class="n">lab_tests</span> <span class="o">=</span> <span class="n">lab_orders_df</span><span class="p">[</span><span class="s2">&quot;lab_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">lab_orders_df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># Create empty list to store all results</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># For each combination of date and time</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">snapshot_dates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
            <span class="n">snapshot_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">))</span>

            <span class="c1"># Filter dataframe for this snapshot</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;departure_datetime&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">snapshot_datetime</span>
            <span class="p">)</span>
            <span class="n">snapshot_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Create copy to avoid SettingWithCopyWarning</span>

            <span class="c1"># Skip if no patients at this time</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get triage scores recorded before the snapshot time</span>
            <span class="n">valid_observations</span> <span class="o">=</span> <span class="n">observations_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">observations_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">observations_df</span><span class="p">[</span><span class="s2">&quot;observation_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Keep only the most recent triage score for each visit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">valid_observations</span> <span class="o">=</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="s2">&quot;observation_datetime&quot;</span>
                <span class="p">)</span>
                <span class="n">valid_observations</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">valid_observations</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;visit_number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">valid_observations</span> <span class="o">=</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;triage_score&quot;</span><span class="p">:</span> <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Get lab orders placed before the snapshot time</span>
            <span class="n">valid_orders</span> <span class="o">=</span> <span class="n">lab_orders_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">lab_orders_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lab_orders_df</span><span class="p">[</span><span class="s2">&quot;order_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Initialize lab_counts with zeros for all visits in snapshot_df</span>
            <span class="n">lab_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
                    <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span>
                <span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_orders&quot;</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">lab_tests</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Update counts if there are any valid orders</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_orders</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">order_counts</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">valid_orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;lab_name&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">size</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">order_counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_orders&quot;</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">order_counts</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>
                <span class="c1"># Update the counts in lab_counts where we have orders</span>
                <span class="n">lab_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">order_counts</span><span class="p">)</span>

            <span class="n">lab_counts</span> <span class="o">=</span> <span class="n">lab_counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="c1"># Add snapshot information columns</span>
            <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
            <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">)</span>

            <span class="c1"># Merge with valid observations to get triage scores, handling empty case</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">snapshot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">snapshot_df</span><span class="p">,</span>
                    <span class="n">valid_observations</span><span class="p">[[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">]],</span>
                    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;latest_triage_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">snapshot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Merge with lab counts</span>
            <span class="n">snapshot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">snapshot_df</span><span class="p">,</span> <span class="n">lab_counts</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Fill NA values in lab count columns with 0</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">snapshot_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_orders&quot;</span><span class="p">):</span>
                    <span class="n">snapshot_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Optionally check for all-NA in key columns</span>
                <span class="n">snapshot_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;snapshot_datetime&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="c1"># Only check columns that exist in the DataFrame</span>
                <span class="n">check_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">snapshot_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">snapshot_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_cols</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">snapshot_df</span><span class="p">[</span><span class="n">check_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipping DataFrame with all-NA values in key columns: </span><span class="si">{</span><span class="n">check_cols</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping empty DataFrame&quot;</span><span class="p">)</span>

    <span class="c1"># Combine all results into single dataframe</span>
    <span class="k">if</span> <span class="n">all_results</span><span class="p">:</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Define column order</span>
        <span class="n">snapshot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span>
        <span class="n">visit_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;patient_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">lab_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_orders&quot;</span><span class="p">)]</span>

        <span class="c1"># Ensure all required columns exist</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">visit_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">:</span>
                    <span class="n">final_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Reorder columns</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">snapshot_cols</span> <span class="o">+</span> <span class="n">visit_cols</span> <span class="o">+</span> <span class="n">lab_cols</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create empty dataframe with correct columns if no results found</span>
        <span class="n">lab_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_orders&quot;</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">lab_tests</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">lab_cols</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Name the index snapshot_id before returning</span>
    <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;snapshot_id&quot;</span>
    <span class="k">return</span> <span class="n">final_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.load" class="doc doc-heading">
            <code>load</code>


</h2>

    <div class="doc doc-contents ">

        <p>This module provides functionality for loading configuration files, data from CSV files, and trained machine learning models.</p>
<p>It includes the following features:</p>
<ul>
<li><strong>Loading Configurations</strong>: Parse YAML configuration files and extract necessary parameters for data processing and modeling.</li>
<li><strong>Data Handling</strong>: Load and preprocess data from CSV files, including optional operations like setting an index, sorting, and applying literal evaluation on columns.</li>
<li><strong>Model Management</strong>: Load saved machine learning models, customize model filenames based on time, and categorize DataFrame columns into predefined groups for analysis.</li>
</ul>
<p>The module handles common file and parsing errors, returning appropriate error messages or exceptions.</p>
<h4 id="patientflow.load--functions">Functions</h4>
<p>parse_args:
    Parses command-line arguments for training models.
set_project_root:
    Validates project root path from specified environment variable.
load_config_file:
    Load a YAML configuration file and extract key parameters.
set_file_paths:
    Sets up the file paths based on UCLH-specific or default parameters.
set_data_file_names:
    Set file locations based on UCLH-specific or default data sources.
safe_literal_eval:
    Safely evaluate string literals into Python objects when loading from csv.
load_data:
    Load and preprocess data from a CSV or pickle file.
get_model_key:
    Generate a model name based on the time of day.
load_saved_model:
    Load a machine learning model saved in a joblib file.
get_dict_cols:
    Categorize columns from a DataFrame into predefined groups for analysis.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.load.data_from_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data_from_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Loads data from a CSV file, with optional transformations. LEGACY!</p>
<p>This function loads a CSV file into a pandas DataFrame and provides the following optional features:
- Setting a specified column as the index.
- Sorting the DataFrame by one or more specified columns.
- Applying safe literal evaluation to specified columns to handle string representations of Python objects.</p>
<h5 id="patientflow.load.data_from_csv--parameters">Parameters</h5>
<p>csv_path : str
    The relative or absolute path to the CSV file.
index_column : str, optional
    The column to set as the index of the DataFrame. If not provided, no index column is set.
sort_columns : list of str, optional
    A list of columns by which to sort the DataFrame. If not provided, the DataFrame is not sorted.
eval_columns : list of str, optional
    A list of columns to which <code>safe_literal_eval</code> should be applied. This is useful for columns containing
    string representations of Python data structures (e.g., lists, dictionaries).</p>
<h5 id="patientflow.load.data_from_csv--returns">Returns</h5>
<p>pd.DataFrame
    A pandas DataFrame containing the loaded data with any specified transformations applied.</p>
<h5 id="patientflow.load.data_from_csv--raises">Raises</h5>
<p>SystemExit
    If the file cannot be found or another error occurs during loading or processing.</p>
<h5 id="patientflow.load.data_from_csv--notes">Notes</h5>
<p>The function will terminate the program with a message if the file is not found or if any errors
occur while loading the data. If sorting columns or applying <code>safe_literal_eval</code> fails,
a warning message is printed, but execution continues.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">data_from_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data from a CSV file, with optional transformations. LEGACY!</span>

<span class="sd">    This function loads a CSV file into a pandas DataFrame and provides the following optional features:</span>
<span class="sd">    - Setting a specified column as the index.</span>
<span class="sd">    - Sorting the DataFrame by one or more specified columns.</span>
<span class="sd">    - Applying safe literal evaluation to specified columns to handle string representations of Python objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    csv_path : str</span>
<span class="sd">        The relative or absolute path to the CSV file.</span>
<span class="sd">    index_column : str, optional</span>
<span class="sd">        The column to set as the index of the DataFrame. If not provided, no index column is set.</span>
<span class="sd">    sort_columns : list of str, optional</span>
<span class="sd">        A list of columns by which to sort the DataFrame. If not provided, the DataFrame is not sorted.</span>
<span class="sd">    eval_columns : list of str, optional</span>
<span class="sd">        A list of columns to which `safe_literal_eval` should be applied. This is useful for columns containing</span>
<span class="sd">        string representations of Python data structures (e.g., lists, dictionaries).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing the loaded data with any specified transformations applied.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    SystemExit</span>
<span class="sd">        If the file cannot be found or another error occurs during loading or processing.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function will terminate the program with a message if the file is not found or if any errors</span>
<span class="sd">    occur while loading the data. If sorting columns or applying `safe_literal_eval` fails,</span>
<span class="sd">    a warning message is printed, but execution continues.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="n">csv_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found at path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found at path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index_column</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">index_column</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_column</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index column &#39;</span><span class="si">{</span><span class="n">index_column</span><span class="si">}</span><span class="s2">&#39; not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sort_columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One or more sort columns not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eval_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">eval_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">safe_literal_eval</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying safe_literal_eval to column &#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.get_dict_cols" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dict_cols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Categorize DataFrame columns into predefined groups.</p>
<h5 id="patientflow.load.get_dict_cols--parameters">Parameters</h5>
<p>df : pd.DataFrame
    The DataFrame to categorize.</p>
<h5 id="patientflow.load.get_dict_cols--returns">Returns</h5>
<p>dict
    A dictionary where keys are column group names and values are lists of column names in each group.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dict_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Categorize DataFrame columns into predefined groups.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        The DataFrame to categorize.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary where keys are column group names and values are lists of column names in each group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">not_used_in_training_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;snapshot_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;training_validation_test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;random_number&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">arrival_and_demographic_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;elapsed_los&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age_group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arrival_method&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">summary_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;num_obs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_obs_events&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_obs_types&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_lab_batteries_ordered&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">location_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observations_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labs_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">consults_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;has_consultation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;specialty&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">outcome_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">col</span> <span class="ow">in</span> <span class="n">not_used_in_training_vars</span>
            <span class="ow">or</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">arrival_and_demographic_vars</span>
            <span class="ow">or</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">summary_vars</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="s2">&quot;visited&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;location&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">location_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;num_obs&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;latest_obs&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">observations_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;lab_orders&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;latest_lab_results&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">labs_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">consults_vars</span> <span class="ow">or</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outcome_vars</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Already categorized</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; did not match any predefined group&quot;</span><span class="p">)</span>

    <span class="c1"># Create a list of column groups</span>
    <span class="n">col_group_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;not used in training&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arrival and demographic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">,</span>
        <span class="s2">&quot;location&quot;</span><span class="p">,</span>
        <span class="s2">&quot;observations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lab orders and results&quot;</span><span class="p">,</span>
        <span class="s2">&quot;consults&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outcome&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Create a list of the column names within those groups</span>
    <span class="n">col_groups</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">not_used_in_training_vars</span><span class="p">,</span>
        <span class="n">arrival_and_demographic_vars</span><span class="p">,</span>
        <span class="n">summary_vars</span><span class="p">,</span>
        <span class="n">location_vars</span><span class="p">,</span>
        <span class="n">observations_vars</span><span class="p">,</span>
        <span class="n">labs_vars</span><span class="p">,</span>
        <span class="n">consults_vars</span><span class="p">,</span>
        <span class="n">outcome_vars</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Use dictionary to combine them</span>
    <span class="n">dict_col_groups</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">category</span><span class="p">:</span> <span class="n">var_list</span> <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">var_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">col_group_names</span><span class="p">,</span> <span class="n">col_groups</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dict_col_groups</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.get_model_key" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a model name based on the time of day.</p>
<h5 id="patientflow.load.get_model_key--parameters">Parameters</h5>
<p>model_name : str
    The base name of the model.
prediction_time_ : tuple of int
    A tuple representing the time of day (hour, minute).</p>
<h5 id="patientflow.load.get_model_key--returns">Returns</h5>
<p>str
    A string representing the model name based on the time of day.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a model name based on the time of day.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        The base name of the model.</span>
<span class="sd">    prediction_time_ : tuple of int</span>
<span class="sd">        A tuple representing the time of day (hour, minute).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A string representing the model name based on the time of day.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hour_</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="n">prediction_time</span>
    <span class="n">min_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_</span><span class="si">}</span><span class="s2">0&quot;</span> <span class="k">if</span> <span class="n">min_</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_</span><span class="p">)</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour_</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">min_</span>
    <span class="k">return</span> <span class="n">model_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.load_config_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_config_file</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span> <span class="n">return_start_end_dates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Load configuration from a YAML file.</p>
<h5 id="patientflow.load.load_config_file--parameters">Parameters</h5>
<p>config_file_path : str
    The path to the configuration file.
return_start_end_dates : bool, optional
    If True, return only the start and end dates from the file (default is False).</p>
<h5 id="patientflow.load.load_config_file--returns">Returns</h5>
<p>dict or tuple or None
    If <code>return_start_end_dates</code> is True, returns a tuple of start and end dates (str).
    Otherwise, returns a dictionary containing the configuration parameters.
    Returns None if an error occurs during file reading or parsing.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_config_file</span><span class="p">(</span>
    <span class="n">config_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_start_end_dates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load configuration from a YAML file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_file_path : str</span>
<span class="sd">        The path to the configuration file.</span>
<span class="sd">    return_start_end_dates : bool, optional</span>
<span class="sd">        If True, return only the start and end dates from the file (default is False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or tuple or None</span>
<span class="sd">        If `return_start_end_dates` is True, returns a tuple of start and end dates (str).</span>
<span class="sd">        Otherwise, returns a dictionary containing the configuration parameters.</span>
<span class="sd">        Returns None if an error occurs during file reading or parsing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: The file &#39;</span><span class="si">{</span><span class="n">config_file_path</span><span class="si">}</span><span class="s2">&#39; was not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing YAML file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_start_end_dates</span><span class="p">:</span>
            <span class="c1"># load the dates used in saved data for uclh versions</span>
            <span class="k">if</span> <span class="s2">&quot;file_dates&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;file_dates&quot;</span><span class="p">]:</span>
                <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;file_dates&quot;</span><span class="p">]]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error: &#39;file_dates&#39; key not found or empty in the configuration file.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;prediction_times&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prediction_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_times&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;prediction_times&#39; key not found in the configuration file.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;modelling_dates&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modelling_dates&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_training_set&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_validation_set&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_test_set&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_test_set&quot;</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;modelling_dates&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error: expecting 4 modelling dates and only got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modelling_dates&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prediction_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_window&quot;</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epsilon&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;yta_time_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yta_time_interval&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span>

    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Missing key in the configuration file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Invalid value found in the configuration file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.load_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_data</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">home_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Loads data from CSV or pickle file with optional transformations.</p>
<h5 id="patientflow.load.load_data--parameters">Parameters</h5>
<p>data_file_path : str
    Directory path containing the data file
file_name : str
    Name of the CSV or pickle file to load
index_column : str, optional
    Column to set as DataFrame index
sort_columns : list of str, optional
    Columns to sort DataFrame by
eval_columns : list of str, optional
    Columns to apply safe_literal_eval to
home_path : str or Path, optional
    Base path to use instead of user's home directory
encoding : str, optional
    The encoding to use when reading CSV files (e.g., 'utf-8', 'latin1')</p>
<h5 id="patientflow.load.load_data--returns">Returns</h5>
<p>pd.DataFrame
    Loaded and transformed DataFrame</p>
<h5 id="patientflow.load.load_data--raises">Raises</h5>
<p>FileNotFoundError
    If the specified file does not exist
ValueError
    If the file format is not supported or other processing errors occur</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
    <span class="n">data_file_path</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">,</span>
    <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">home_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data from CSV or pickle file with optional transformations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_file_path : str</span>
<span class="sd">        Directory path containing the data file</span>
<span class="sd">    file_name : str</span>
<span class="sd">        Name of the CSV or pickle file to load</span>
<span class="sd">    index_column : str, optional</span>
<span class="sd">        Column to set as DataFrame index</span>
<span class="sd">    sort_columns : list of str, optional</span>
<span class="sd">        Columns to sort DataFrame by</span>
<span class="sd">    eval_columns : list of str, optional</span>
<span class="sd">        Columns to apply safe_literal_eval to</span>
<span class="sd">    home_path : str or Path, optional</span>
<span class="sd">        Base path to use instead of user&#39;s home directory</span>
<span class="sd">    encoding : str, optional</span>
<span class="sd">        The encoding to use when reading CSV files (e.g., &#39;utf-8&#39;, &#39;latin1&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Loaded and transformed DataFrame</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the specified file does not exist</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the file format is not supported or other processing errors occur</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="c1"># Use provided home_path if available, otherwise default to user&#39;s home directory</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">home_path</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">/</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found at path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported file format: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">. Must be .csv or .pkl&quot;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index_column</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">index_column</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_column</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Index column &#39;</span><span class="si">{</span><span class="n">index_column</span><span class="si">}</span><span class="s2">&#39; not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sort_columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: One or more sort columns not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eval_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">eval_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">safe_literal_eval</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: Error applying safe_literal_eval to column &#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.load_saved_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_saved_model</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Load a saved model from a file.</p>
<h5 id="patientflow.load.load_saved_model--parameters">Parameters</h5>
<p>model_file_path : Path
    The path to the directory where the model is saved.
model_name : str
    The base name of the model.
prediction_time : tuple of int, optional
    The time of day the model was trained for.</p>
<h5 id="patientflow.load.load_saved_model--returns">Returns</h5>
<p>Any
    The loaded model.</p>
<h5 id="patientflow.load.load_saved_model--raises">Raises</h5>
<p>ModelLoadError
    If the model file cannot be found or loaded.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_saved_model</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a saved model from a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_file_path : Path</span>
<span class="sd">        The path to the directory where the model is saved.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        The base name of the model.</span>
<span class="sd">    prediction_time : tuple of int, optional</span>
<span class="sd">        The time of day the model was trained for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        The loaded model.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ModelLoadError</span>
<span class="sd">        If the model file cannot be found or loaded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prediction_time</span><span class="p">:</span>
        <span class="c1"># retrieve model based on the time of day it is trained for</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

    <span class="n">full_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="n">model_name</span>
    <span class="n">full_path</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.joblib&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="c1"># print(f&quot;Model named {model_name} not found at path: {model_file_path}&quot;)</span>
        <span class="k">raise</span> <span class="n">ModelLoadError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Model named </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> not found at path: </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># print(f&quot;Error loading model: {e}&quot;)</span>
        <span class="k">raise</span> <span class="n">ModelLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading model called </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.parse_args" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_args</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parse command-line arguments for the training script.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="argparse.Namespace" href="https://docs.python.org/3/library/argparse.html#argparse.Namespace">Namespace</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>argparse.Namespace: The parsed arguments containing 'data_folder_name' and 'uclh' keys.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command-line arguments for the training script.</span>

<span class="sd">    Returns:</span>
<span class="sd">        argparse.Namespace: The parsed arguments containing &#39;data_folder_name&#39; and &#39;uclh&#39; keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Train emergency demand models&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--data_folder_name&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;data-synthetic&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of data for training&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--uclh&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Train using UCLH data (True) or Public data (False)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.safe_literal_eval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">safe_literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Safely evaluate a string literal into a Python object.
Handles list-like strings by converting them to lists.</p>
<h5 id="patientflow.load.safe_literal_eval--parameters">Parameters</h5>
<p>s : str
    The string to evaluate.</p>
<h5 id="patientflow.load.safe_literal_eval--returns">Returns</h5>
<p>Any, list, or None
    The evaluated Python object if successful, a list if the input is list-like,
    or None for empty/null values.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">safe_literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safely evaluate a string literal into a Python object.</span>
<span class="sd">    Handles list-like strings by converting them to lists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to evaluate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any, list, or None</span>
<span class="sd">        The evaluated Python object if successful, a list if the input is list-like,</span>
<span class="sd">        or None for empty/null values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Remove square brackets and split by comma</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="c1"># Strip whitespace from each item and remove empty strings</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If the above fails, fall back to ast.literal_eval</span>
                <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
        <span class="c1"># If ast.literal_eval fails, return the original string</span>
        <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.set_data_file_names" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_data_file_names</span><span class="p">(</span><span class="n">uclh</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set file locations based on UCLH or default data source.</p>
<h5 id="patientflow.load.set_data_file_names--parameters">Parameters</h5>
<p>uclh : bool
    If True, use UCLH-specific file locations. If False, use default file locations.
data_file_path : Path
    The base path to the data directory.
config_file_path : str, optional
    The path to the configuration file, required if <code>uclh</code> is True.</p>
<h5 id="patientflow.load.set_data_file_names--returns">Returns</h5>
<p>tuple
    Paths to the required files (visits, arrivals) based on the configuration.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_data_file_names</span><span class="p">(</span><span class="n">uclh</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set file locations based on UCLH or default data source.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uclh : bool</span>
<span class="sd">        If True, use UCLH-specific file locations. If False, use default file locations.</span>
<span class="sd">    data_file_path : Path</span>
<span class="sd">        The base path to the data directory.</span>
<span class="sd">    config_file_path : str, optional</span>
<span class="sd">        The path to the configuration file, required if `uclh` is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Paths to the required files (visits, arrivals) based on the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">uclh</span><span class="p">:</span>
        <span class="n">csv_filename</span> <span class="o">=</span> <span class="s2">&quot;ed_visits.csv&quot;</span>
        <span class="n">yta_csv_filename</span> <span class="o">=</span> <span class="s2">&quot;inpatient_arrivals.csv&quot;</span>

        <span class="n">visits_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">csv_filename</span>
        <span class="n">yta_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">yta_csv_filename</span>

        <span class="k">return</span> <span class="n">visits_csv_path</span><span class="p">,</span> <span class="n">yta_csv_path</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">load_config_file</span><span class="p">(</span>
            <span class="n">config_file_path</span><span class="p">,</span> <span class="n">return_start_end_dates</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;uclh_visits_exc_beds_inc_minority_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span>
        <span class="p">)</span>
        <span class="n">csv_filename</span> <span class="o">=</span> <span class="s2">&quot;uclh_ed_visits.csv&quot;</span>
        <span class="n">yta_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;uclh_yet_to_arrive_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span>
        <span class="p">)</span>
        <span class="n">yta_csv_filename</span> <span class="o">=</span> <span class="s2">&quot;uclh_inpatient_arrivals.csv&quot;</span>

        <span class="n">visits_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">data_filename</span>
        <span class="n">yta_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">yta_filename</span>

        <span class="n">visits_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">csv_filename</span>
        <span class="n">yta_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">yta_csv_filename</span>

    <span class="k">return</span> <span class="n">visits_path</span><span class="p">,</span> <span class="n">visits_csv_path</span><span class="p">,</span> <span class="n">yta_path</span><span class="p">,</span> <span class="n">yta_csv_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.set_file_paths" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_file_paths</span><span class="p">(</span><span class="n">project_root</span><span class="p">,</span> <span class="n">data_folder_name</span><span class="p">,</span> <span class="n">train_dttm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="s1">&#39;config.yaml&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets up the file paths</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>project_root</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Root path of the project</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_folder_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the folder where data files are located</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_dttm</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representation of the datetime at which training commenced. Defaults to None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inference_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A flag indicating whether it is inference time or not. Defaults to False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_file</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of config file. Defaults to "config.yaml"</p>
              </div>
            </td>
            <td>
                  <code>&#39;config.yaml&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String to prefix model folder names. Defaults to None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print path information. Defaults to True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a>, <a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a>, <a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a>, <a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contains (data_file_path, media_file_path, model_file_path, config_path)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_file_paths</span><span class="p">(</span>
    <span class="n">project_root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">data_folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">train_dttm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inference_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the file paths</span>

<span class="sd">    Args:</span>
<span class="sd">        project_root (Path): Root path of the project</span>
<span class="sd">        data_folder_name (str): Name of the folder where data files are located</span>
<span class="sd">        train_dttm (Optional[str], optional): A string representation of the datetime at which training commenced. Defaults to None</span>
<span class="sd">        inference_time (bool, optional): A flag indicating whether it is inference time or not. Defaults to False</span>
<span class="sd">        config_file (str, optional): Name of config file. Defaults to &quot;config.yaml&quot;</span>
<span class="sd">        prefix (Optional[str], optional): String to prefix model folder names. Defaults to None</span>
<span class="sd">        verbose (bool, optional): Whether to print path information. Defaults to True</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains (data_file_path, media_file_path, model_file_path, config_path)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">config_file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration will be loaded from: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_folder_name</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data files will be loaded from: </span><span class="si">{</span><span class="n">data_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model_id</span> <span class="o">=</span> <span class="n">data_folder_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;data-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">train_dttm</span><span class="p">:</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">train_dttm</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">model_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;trained-models&quot;</span> <span class="o">/</span> <span class="n">model_id</span>
    <span class="n">media_file_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="s2">&quot;media&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trained models will be saved to: </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model_file_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">model_file_path</span> <span class="o">/</span> <span class="s2">&quot;model-output&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">media_file_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Images will be saved to: </span><span class="si">{</span><span class="n">media_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_file_path</span><span class="p">,</span> <span class="n">media_file_path</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">,</span> <span class="n">config_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.set_project_root" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_project_root</span><span class="p">(</span><span class="n">env_var</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets project root path from environment variable or infers it from current path.</p>
<p>First checks specified environment variable for project root path.
If not found, searches current path hierarchy for highest-level 'patientflow' directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>env_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of environment variable containing project root path</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Path</code></td>            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validated project root path</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If environment variable not set and 'patientflow' not found in path</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#NotADirectoryError">NotADirectoryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If path doesn't exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If env_var is not None and not a string</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_project_root</span><span class="p">(</span><span class="n">env_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets project root path from environment variable or infers it from current path.</span>

<span class="sd">    First checks specified environment variable for project root path.</span>
<span class="sd">    If not found, searches current path hierarchy for highest-level &#39;patientflow&#39; directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        env_var (Optional[str]): Name of environment variable containing project root path</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path: Validated project root path</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If environment variable not set and &#39;patientflow&#39; not found in path</span>
<span class="sd">        NotADirectoryError: If path doesn&#39;t exist</span>
<span class="sd">        TypeError: If env_var is not None and not a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Only try to get env path if env_var is provided</span>
    <span class="n">env_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span> <span class="k">if</span> <span class="n">env_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">project_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Try getting from environment variable first</span>
    <span class="k">if</span> <span class="n">env_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">project_root</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path does not exist: </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project root from environment: </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project_root</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2"> to Path: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If not in env var, try to infer from current path</span>
        <span class="n">current</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># Search through parents to find highest-level &#39;patientflow&#39; directory</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="o">*</span><span class="n">current</span><span class="o">.</span><span class="n">parents</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;patientflow&quot;</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">project_root</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="c1"># Continue searching to find highest level</span>

        <span class="k">if</span> <span class="n">project_root</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred project root: </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project_root</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find project root - </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2"> not set and &#39;patientflow&#39; not found in path&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current directory: </span><span class="si">{</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_var</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run one of these commands in a new cell to set </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Linux/Mac:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%env </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2">=/path/to/project&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Windows:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%env </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2">=C:</span><span class="se">\\</span><span class="s2">path</span><span class="se">\\</span><span class="s2">to</span><span class="se">\\</span><span class="s2">project&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Project root not found&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.model_artifacts" class="doc doc-heading">
            <code>model_artifacts</code>


</h2>

    <div class="doc doc-contents ">

        <p>Model training results containers.</p>
<p>This module defines a set of data classes to organise results from
model training processes, including hyperparameter tuning, cross-validation fold metrics,
and final trained classifier artifacts. These classes serve as structured containers for
various types of model evaluation outputs and metadata.</p>
<h4 id="patientflow.model_artifacts--classes">Classes</h4>
<p>HyperParameterTrial
    Container for storing hyperparameter tuning trial results.</p>
<p>FoldResults
    Stores evaluation metrics from a single cross-validation fold.</p>
<p>TrainingResults
    Encapsulates comprehensive evaluation metrics and metadata from model training.</p>
<p>TrainedClassifier
    Container for a trained model and associated training results.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.FoldResults" class="doc doc-heading">
            <code>FoldResults</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Store evaluation metrics for a single fold.</p>
<h5 id="patientflow.model_artifacts.FoldResults--attributes">Attributes</h5>
<p>auc : float
    Area Under the ROC Curve (AUC) for this fold.
logloss : float
    Logarithmic loss (cross-entropy loss) for this fold.
auprc : float
    Area Under the Precision-Recall Curve (AUPRC) for this fold.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FoldResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store evaluation metrics for a single fold.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    auc : float</span>
<span class="sd">        Area Under the ROC Curve (AUC) for this fold.</span>
<span class="sd">    logloss : float</span>
<span class="sd">        Logarithmic loss (cross-entropy loss) for this fold.</span>
<span class="sd">    auprc : float</span>
<span class="sd">        Area Under the Precision-Recall Curve (AUPRC) for this fold.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">auc</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">logloss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">auprc</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.HyperParameterTrial" class="doc doc-heading">
            <code>HyperParameterTrial</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Container for a single hyperparameter tuning trial.</p>
<h5 id="patientflow.model_artifacts.HyperParameterTrial--attributes">Attributes</h5>
<p>parameters : dict of str to Any
    Dictionary of hyperparameters used in the trial.
cv_results : dict of str to float
    Cross-validation metrics obtained using the specified parameters.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HyperParameterTrial</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for a single hyperparameter tuning trial.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : dict of str to Any</span>
<span class="sd">        Dictionary of hyperparameters used in the trial.</span>
<span class="sd">    cv_results : dict of str to float</span>
<span class="sd">        Cross-validation metrics obtained using the specified parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">cv_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.TrainedClassifier" class="doc doc-heading">
            <code>TrainedClassifier</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Container for trained model artifacts and their associated information.</p>
<h5 id="patientflow.model_artifacts.TrainedClassifier--attributes">Attributes</h5>
<p>training_results : TrainingResults
    Evaluation metrics and training metadata for the classifier.
pipeline : sklearn.pipeline.Pipeline or None, optional
    The scikit-learn pipeline representing the trained classifier.
calibrated_pipeline : sklearn.pipeline.Pipeline or None, optional
    The calibrated version of the pipeline, if model calibration was performed.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainedClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for trained model artifacts and their associated information.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    training_results : TrainingResults</span>
<span class="sd">        Evaluation metrics and training metadata for the classifier.</span>
<span class="sd">    pipeline : sklearn.pipeline.Pipeline or None, optional</span>
<span class="sd">        The scikit-learn pipeline representing the trained classifier.</span>
<span class="sd">    calibrated_pipeline : sklearn.pipeline.Pipeline or None, optional</span>
<span class="sd">        The calibrated version of the pipeline, if model calibration was performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">training_results</span><span class="p">:</span> <span class="n">TrainingResults</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">calibrated_pipeline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.TrainingResults" class="doc doc-heading">
            <code>TrainingResults</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Store comprehensive evaluation metrics and metadata from model training.</p>
<h5 id="patientflow.model_artifacts.TrainingResults--attributes">Attributes</h5>
<p>prediction_time : tuple of int
    Start and end time of prediction, represented as UNIX timestamps.
training_info : dict of str to Any, optional
    Metadata or logs collected during training.
calibration_info : dict of str to Any, optional
    Information about model calibration, if applicable.
test_results : dict of str to float, optional
    Evaluation metrics computed on the test dataset.
balance_info : dict of str to bool or int or float, optional
    Information related to class balance (e.g., whether data was balanced, class ratios).</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainingResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store comprehensive evaluation metrics and metadata from model training.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_time : tuple of int</span>
<span class="sd">        Start and end time of prediction, represented as UNIX timestamps.</span>
<span class="sd">    training_info : dict of str to Any, optional</span>
<span class="sd">        Metadata or logs collected during training.</span>
<span class="sd">    calibration_info : dict of str to Any, optional</span>
<span class="sd">        Information about model calibration, if applicable.</span>
<span class="sd">    test_results : dict of str to float, optional</span>
<span class="sd">        Evaluation metrics computed on the test dataset.</span>
<span class="sd">    balance_info : dict of str to bool or int or float, optional</span>
<span class="sd">        Information related to class balance (e.g., whether data was balanced, class ratios).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">training_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">calibration_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">test_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">balance_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.predict" class="doc doc-heading">
            <code>predict</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.predict.emergency_demand" class="doc doc-heading">
            <code>emergency_demand</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.create_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_predictions</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">prediction_snapshots</span><span class="p">,</span> <span class="n">specialties</span><span class="p">,</span> <span class="n">prediction_window_hrs</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">cdf_cut_points</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create predictions for emergency demand for a single prediction moment.</p>
<h6 id="patientflow.predict.emergency_demand.create_predictions--parameters">Parameters</h6>
<p>models : Tuple[TrainedClassifier, SequencePredictor, WeightedPoissonPredictor]
    Tuple containing:
    - classifier: TrainedClassifier containing admission predictions
    - spec_model: SequencePredictor for specialty predictions
    - yet_to_arrive_model: WeightedPoissonPredictor for yet-to-arrive predictions
prediction_time : Tuple
    Hour and minute of time for model inference
prediction_snapshots : pd.DataFrame
    DataFrame containing prediction snapshots
specialties : List[str]
    List of specialty names for predictions (e.g., ['surgical', 'medical'])
prediction_window_hrs : float
    Prediction window in hours
x1 : float
    X-coordinate of first point for probability curve
y1 : float
    Y-coordinate of first point for probability curve
x2 : float
    X-coordinate of second point for probability curve
y2 : float
    Y-coordinate of second point for probability curve
cdf_cut_points : List[float]
    List of cumulative distribution function cut points (e.g., [0.9, 0.7])
special_params : Optional[Dict[str, Any]], optional
    Special handling parameters for categories, by default None</p>
<h6 id="patientflow.predict.emergency_demand.create_predictions--returns">Returns</h6>
<p>Dict[str, Dict[str, List[int]]]
    Nested dictionary containing predictions for each specialty:
    {
        'specialty_name': {
            'in_ed': [pred1, pred2, ...],
            'yet_to_arrive': [pred1, pred2, ...]
        }
    }</p>
<h6 id="patientflow.predict.emergency_demand.create_predictions--notes">Notes</h6>
<p>The admissions models in the models dictionary must be ModelResults objects
that contain either a 'pipeline' or 'calibrated_pipeline' attribute. The pipeline
will be used for making predictions, with calibrated_pipeline taking precedence
if both exist.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_predictions</span><span class="p">(</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">,</span> <span class="n">SequencePredictor</span><span class="p">,</span> <span class="n">WeightedPoissonPredictor</span><span class="p">],</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">prediction_snapshots</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">specialties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prediction_window_hrs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">cdf_cut_points</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create predictions for emergency demand for a single prediction moment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models : Tuple[TrainedClassifier, SequencePredictor, WeightedPoissonPredictor]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - classifier: TrainedClassifier containing admission predictions</span>
<span class="sd">        - spec_model: SequencePredictor for specialty predictions</span>
<span class="sd">        - yet_to_arrive_model: WeightedPoissonPredictor for yet-to-arrive predictions</span>
<span class="sd">    prediction_time : Tuple</span>
<span class="sd">        Hour and minute of time for model inference</span>
<span class="sd">    prediction_snapshots : pd.DataFrame</span>
<span class="sd">        DataFrame containing prediction snapshots</span>
<span class="sd">    specialties : List[str]</span>
<span class="sd">        List of specialty names for predictions (e.g., [&#39;surgical&#39;, &#39;medical&#39;])</span>
<span class="sd">    prediction_window_hrs : float</span>
<span class="sd">        Prediction window in hours</span>
<span class="sd">    x1 : float</span>
<span class="sd">        X-coordinate of first point for probability curve</span>
<span class="sd">    y1 : float</span>
<span class="sd">        Y-coordinate of first point for probability curve</span>
<span class="sd">    x2 : float</span>
<span class="sd">        X-coordinate of second point for probability curve</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Y-coordinate of second point for probability curve</span>
<span class="sd">    cdf_cut_points : List[float]</span>
<span class="sd">        List of cumulative distribution function cut points (e.g., [0.9, 0.7])</span>
<span class="sd">    special_params : Optional[Dict[str, Any]], optional</span>
<span class="sd">        Special handling parameters for categories, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Dict[str, List[int]]]</span>
<span class="sd">        Nested dictionary containing predictions for each specialty:</span>
<span class="sd">        {</span>
<span class="sd">            &#39;specialty_name&#39;: {</span>
<span class="sd">                &#39;in_ed&#39;: [pred1, pred2, ...],</span>
<span class="sd">                &#39;yet_to_arrive&#39;: [pred1, pred2, ...]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The admissions models in the models dictionary must be ModelResults objects</span>
<span class="sd">    that contain either a &#39;pipeline&#39; or &#39;calibrated_pipeline&#39; attribute. The pipeline</span>
<span class="sd">    will be used for making predictions, with calibrated_pipeline taking precedence</span>
<span class="sd">    if both exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate model types</span>
    <span class="n">classifier</span><span class="p">,</span> <span class="n">spec_model</span><span class="p">,</span> <span class="n">yet_to_arrive_model</span> <span class="o">=</span> <span class="n">models</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;First model must be of type TrainedClassifier&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec_model</span><span class="p">,</span> <span class="n">SequencePredictor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Second model must be of type SequencePredictor&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="p">,</span> <span class="n">WeightedPoissonPredictor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Third model must be of type WeightedPoissonPredictor&quot;</span><span class="p">)</span>

    <span class="c1"># Check that all models have been fit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">classifier</span><span class="o">.</span><span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Classifier model has not been fit&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spec_model</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec_model</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specialty model has not been fit&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="p">,</span> <span class="s2">&quot;prediction_window&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">prediction_window</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Yet-to-arrive model has not been fit&quot;</span><span class="p">)</span>

    <span class="c1"># Validate that the correct models have been passed for the requested prediction time and prediction window</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">classifier</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Requested prediction time does not match the prediction time of the trained classifier&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">==</span> <span class="n">prediction_window_hrs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Requested prediction window does not match the prediction window of the trained yet-to-arrive model&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Requested specialties do not match the specialties of the trained yet-to-arrive model&quot;</span>
        <span class="p">)</span>

    <span class="n">special_params</span> <span class="o">=</span> <span class="n">spec_model</span><span class="o">.</span><span class="n">special_params</span>

    <span class="k">if</span> <span class="n">special_params</span><span class="p">:</span>
        <span class="n">special_category_func</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_func&quot;</span><span class="p">]</span>
        <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span>
        <span class="n">special_func_map</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">special_category_func</span> <span class="o">=</span> <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_func_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">special_category_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">special_category_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Requested specialties do not match the specialty dictionary defined in special_params&quot;</span>
        <span class="p">)</span>

    <span class="n">predictions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">specialty</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;in_ed&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">specialty</span> <span class="ow">in</span> <span class="n">specialties</span>
    <span class="p">}</span>

    <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">classifier</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">pipeline</span>

    <span class="c1"># Add missing columns expected by the model</span>
    <span class="n">prediction_snapshots</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">prediction_snapshots</span><span class="p">)</span>

    <span class="c1"># Get predictions of admissions for ED patients</span>
    <span class="n">prob_admission_after_ed</span> <span class="o">=</span> <span class="n">model_input_to_pred_proba</span><span class="p">(</span><span class="n">prediction_snapshots</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>

    <span class="c1"># Get predictions of admission to specialty</span>
    <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;specialty_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_specialty_probs</span><span class="p">(</span>
        <span class="n">specialties</span><span class="p">,</span>
        <span class="n">spec_model</span><span class="p">,</span>
        <span class="n">prediction_snapshots</span><span class="p">,</span>
        <span class="n">special_category_func</span><span class="o">=</span><span class="n">special_category_func</span><span class="p">,</span>
        <span class="n">special_category_dict</span><span class="o">=</span><span class="n">special_category_dict</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;elapsed_los_hrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="p">[</span>
        <span class="s2">&quot;elapsed_los&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>

    <span class="c1"># Get probability of admission within prediction window</span>
    <span class="n">prob_admission_in_window</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_probability</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;elapsed_los_hrs&quot;</span><span class="p">],</span> <span class="n">prediction_window_hrs</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
        <span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">special_func_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">special_func_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">specialty</span> <span class="ow">in</span> <span class="n">specialties</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">special_func_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">specialty</span><span class="p">,</span> <span class="n">special_func_map</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
        <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="p">[</span>
            <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">filtered_prob_admission_after_ed</span> <span class="o">=</span> <span class="n">prob_admission_after_ed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">non_zero_indices</span><span class="p">]</span>
        <span class="n">prob_admission_to_specialty</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="p">[</span><span class="s2">&quot;specialty_prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">filtered_prob_admission_to_specialty</span> <span class="o">=</span> <span class="n">prob_admission_to_specialty</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">non_zero_indices</span>
        <span class="p">]</span>
        <span class="n">filtered_prob_admission_in_window</span> <span class="o">=</span> <span class="n">prob_admission_in_window</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">non_zero_indices</span>
        <span class="p">]</span>

        <span class="n">filtered_weights</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">filtered_prob_admission_to_specialty</span> <span class="o">*</span> <span class="n">filtered_prob_admission_in_window</span>
        <span class="p">)</span>

        <span class="n">agg_predicted_in_ed</span> <span class="o">=</span> <span class="n">pred_proba_to_agg_predicted</span><span class="p">(</span>
            <span class="n">filtered_prob_admission_after_ed</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">filtered_weights</span>
        <span class="p">)</span>

        <span class="n">prediction_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">specialty</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">:</span> <span class="n">prediction_time</span><span class="p">}}</span>
        <span class="n">agg_predicted_yta</span> <span class="o">=</span> <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">prediction_context</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
        <span class="p">)</span>

        <span class="n">predictions</span><span class="p">[</span><span class="n">specialty</span><span class="p">][</span><span class="s2">&quot;in_ed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">find_probability_threshold_index</span><span class="p">(</span>
                <span class="n">agg_predicted_in_ed</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">cut_point</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cut_point</span> <span class="ow">in</span> <span class="n">cdf_cut_points</span>
        <span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">specialty</span><span class="p">][</span><span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">find_probability_threshold_index</span><span class="p">(</span>
                <span class="n">agg_predicted_yta</span><span class="p">[</span><span class="n">specialty</span><span class="p">][</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">cut_point</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cut_point</span> <span class="ow">in</span> <span class="n">cdf_cut_points</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.find_probability_threshold_index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_probability_threshold_index</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Returns the index where the cumulative sum of a sequence of probabilities exceeds the given threshold.</p>
<h6 id="patientflow.predict.emergency_demand.find_probability_threshold_index--parameters">Parameters</h6>
<p>sequence : List[float]
    The probability mass function (PMF) of resource needs
threshold : float
    The probability threshold (e.g., 0.9 for 90%)</p>
<h6 id="patientflow.predict.emergency_demand.find_probability_threshold_index--returns">Returns</h6>
<p>int
    The index where the cumulative probability exceeds 1 - threshold,
    indicating the number of resources needed with the specified probability.</p>
<h6 id="patientflow.predict.emergency_demand.find_probability_threshold_index--examples">Examples</h6>
<blockquote>
<blockquote>
<blockquote>
<p>pmf = [0.05, 0.1, 0.2, 0.3, 0.2, 0.1, 0.05]
find_probability_threshold_index(pmf, 0.9)
5</p>
</blockquote>
</blockquote>
</blockquote>
<h5 id="patientflow.predict.emergency_demand.find_probability_threshold_index--this-means-there-is-a-90-probability-of-needing-at-least-5-beds">This means there is a 90% probability of needing at least 5 beds</h5>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_probability_threshold_index</span><span class="p">(</span><span class="n">sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the index where the cumulative sum of a sequence of probabilities exceeds the given threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequence : List[float]</span>
<span class="sd">        The probability mass function (PMF) of resource needs</span>
<span class="sd">    threshold : float</span>
<span class="sd">        The probability threshold (e.g., 0.9 for 90%)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The index where the cumulative probability exceeds 1 - threshold,</span>
<span class="sd">        indicating the number of resources needed with the specified probability.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; pmf = [0.05, 0.1, 0.2, 0.3, 0.2, 0.1, 0.05]</span>
<span class="sd">    &gt;&gt;&gt; find_probability_threshold_index(pmf, 0.9)</span>
<span class="sd">    5</span>
<span class="sd">    # This means there is a 90% probability of needing at least 5 beds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cumulative_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
        <span class="n">cumulative_sum</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">cumulative_sum</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Return the last index if the threshold isn&#39;t reached</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.get_specialty_probs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_specialty_probs</span><span class="p">(</span><span class="n">specialties</span><span class="p">,</span> <span class="n">specialty_model</span><span class="p">,</span> <span class="n">snapshots_df</span><span class="p">,</span> <span class="n">special_category_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">special_category_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate specialty probability distributions for patient visits based on their data.</p>
<p>This function applies a predictive model to each row of the input DataFrame to compute
specialty probability distributions. Optionally, it can classify certain rows as
belonging to a special category (like pediatric cases) based on a user-defined function,
applying a fixed probability distribution for these cases.</p>
<h6 id="patientflow.predict.emergency_demand.get_specialty_probs--parameters">Parameters</h6>


<details class="specialties-" open>
  <summary>str</summary>
  <p>List of specialty names for which predictions are required.</p>
</details>        <p>specialty_model : object
    Trained model for making specialty predictions.
snapshots_df : pandas.DataFrame
    DataFrame containing the data on which predictions are to be made. Must include
    a 'consultation_sequence' column if no special_category_func is applied.
special_category_func : callable, optional
    A function that takes a DataFrame row (Series) as input and returns True if the row
    belongs to a special category that requires a fixed probability distribution.
    If not provided, no special categorization is applied.
special_category_dict : dict, optional
    A dictionary containing the fixed probability distribution for special category cases.
    This dictionary is applied to rows identified by <code>special_category_func</code>. If
    <code>special_category_func</code> is provided, this parameter must also be provided.</p>
<h6 id="patientflow.predict.emergency_demand.get_specialty_probs--returns">Returns</h6>
<p>pandas.Series
    A Series containing dictionaries as values. Each dictionary represents the probability
    distribution of specialties for each patient visit.</p>
<h6 id="patientflow.predict.emergency_demand.get_specialty_probs--raises">Raises</h6>
<p>ValueError
    If <code>special_category_func</code> is provided but <code>special_category_dict</code> is None.</p>
<h6 id="patientflow.predict.emergency_demand.get_specialty_probs--examples">Examples</h6>
<blockquote>
<blockquote>
<blockquote>
<p>snapshots_df = pd.DataFrame({
...     'consultation_sequence': [[0.1, 0.2], [0.3, 0.4], [0.5, 0.6]],
...     'age': [5, 40, 70]
... })
def pediatric_case(row):
...     return row['age'] &lt; 18
special_dist = {'pediatrics': 0.9, 'general': 0.1}
get_specialty_probs('model.pkl', snapshots_df, pediatric_case, special_dist)
0    {'pediatrics': 0.9, 'general': 0.1}
1    {'cardiology': 0.7, 'general': 0.3}
2    {'neurology': 0.8, 'general': 0.2}
dtype: object</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_specialty_probs</span><span class="p">(</span>
    <span class="n">specialties</span><span class="p">,</span>
    <span class="n">specialty_model</span><span class="p">,</span>
    <span class="n">snapshots_df</span><span class="p">,</span>
    <span class="n">special_category_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">special_category_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate specialty probability distributions for patient visits based on their data.</span>

<span class="sd">    This function applies a predictive model to each row of the input DataFrame to compute</span>
<span class="sd">    specialty probability distributions. Optionally, it can classify certain rows as</span>
<span class="sd">    belonging to a special category (like pediatric cases) based on a user-defined function,</span>
<span class="sd">    applying a fixed probability distribution for these cases.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    specialties : str</span>
<span class="sd">        List of specialty names for which predictions are required.</span>
<span class="sd">    specialty_model : object</span>
<span class="sd">        Trained model for making specialty predictions.</span>
<span class="sd">    snapshots_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the data on which predictions are to be made. Must include</span>
<span class="sd">        a &#39;consultation_sequence&#39; column if no special_category_func is applied.</span>
<span class="sd">    special_category_func : callable, optional</span>
<span class="sd">        A function that takes a DataFrame row (Series) as input and returns True if the row</span>
<span class="sd">        belongs to a special category that requires a fixed probability distribution.</span>
<span class="sd">        If not provided, no special categorization is applied.</span>
<span class="sd">    special_category_dict : dict, optional</span>
<span class="sd">        A dictionary containing the fixed probability distribution for special category cases.</span>
<span class="sd">        This dictionary is applied to rows identified by `special_category_func`. If</span>
<span class="sd">        `special_category_func` is provided, this parameter must also be provided.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        A Series containing dictionaries as values. Each dictionary represents the probability</span>
<span class="sd">        distribution of specialties for each patient visit.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `special_category_func` is provided but `special_category_dict` is None.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; snapshots_df = pd.DataFrame({</span>
<span class="sd">    ...     &#39;consultation_sequence&#39;: [[0.1, 0.2], [0.3, 0.4], [0.5, 0.6]],</span>
<span class="sd">    ...     &#39;age&#39;: [5, 40, 70]</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; def pediatric_case(row):</span>
<span class="sd">    ...     return row[&#39;age&#39;] &lt; 18</span>
<span class="sd">    &gt;&gt;&gt; special_dist = {&#39;pediatrics&#39;: 0.9, &#39;general&#39;: 0.1}</span>
<span class="sd">    &gt;&gt;&gt; get_specialty_probs(&#39;model.pkl&#39;, snapshots_df, pediatric_case, special_dist)</span>
<span class="sd">    0    {&#39;pediatrics&#39;: 0.9, &#39;general&#39;: 0.1}</span>
<span class="sd">    1    {&#39;cardiology&#39;: 0.7, &#39;general&#39;: 0.3}</span>
<span class="sd">    2    {&#39;neurology&#39;: 0.8, &#39;general&#39;: 0.2}</span>
<span class="sd">    dtype: object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert consultation_sequence to tuple if not already a tuple</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_df</span><span class="p">[</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">snapshots_df</span><span class="p">[</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span>
    <span class="p">):</span>
        <span class="n">snapshots_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshots_df</span><span class="p">[</span>
            <span class="s2">&quot;consultation_sequence&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="p">())</span>

    <span class="k">if</span> <span class="n">special_category_func</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">special_category_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;special_category_dict must be provided if special_category_func is specified.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Function to determine the specialty probabilities</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">determine_specialty</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">special_category_func</span> <span class="ow">and</span> <span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">special_category_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">specialty_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">])</span>

    <span class="c1"># Apply the determine_specialty function to each row</span>
    <span class="n">specialty_prob_series</span> <span class="o">=</span> <span class="n">snapshots_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_specialty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find all unique keys used in any dictionary within the series</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">specialty_prob_series</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Combine all_keys with the specialties requested</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_keys</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">))</span>

    <span class="c1"># Ensure each dictionary contains all keys found, with default values of 0 for missing keys</span>
    <span class="n">specialty_prob_series</span> <span class="o">=</span> <span class="n">specialty_prob_series</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span>
            <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">specialty_prob_series</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.predictors" class="doc doc-heading">
            <code>predictors</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.predictors.sequence_predictor" class="doc doc-heading">
            <code>sequence_predictor</code>


</h3>

    <div class="doc doc-contents ">

        <p>This module implements a <code>SequencePredictor</code> class that models and predicts the probability distribution
of sequences in categorical data. The class builds a model based on training data, where input sequences
are mapped to specific outcome categories. It provides methods to fit the model, compute sequence-based
probabilities, and make predictions on an unseen datatset of input sequences.</p>
<h5 id="patientflow.predictors.sequence_predictor--classes">Classes</h5>
<p>SequencePredictor : sklearn.base.BaseEstimator, sklearn.base.TransformerMixin
    A model that predicts the probability of ending in different outcome categories based on input sequences.
    Note: All sequence inputs are expected to be tuples. Lists will be automatically converted to tuples,
    and None values will be converted to empty tuples.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.sequence_predictor.SequencePredictor" class="doc doc-heading">
            <code>SequencePredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>, <code><span title="sklearn.base.TransformerMixin">TransformerMixin</span></code></p>


        <p>A class to model sequence-based predictions for categorical data using input and grouping sequences.
This class implements both the <code>fit</code> and <code>predict</code> methods from the parent sklearn classes.</p>
<h6 id="patientflow.predictors.sequence_predictor.SequencePredictor--parameters">Parameters</h6>
<p>input_var : str
    Name of the column representing the input sequence in the DataFrame.
grouping_var : str
    Name of the column representing the grouping sequence in the DataFrame.
outcome_var : str
    Name of the column representing the outcome category in the DataFrame.
apply_special_category_filtering : bool, default=True
    Whether to filter out special categories of patients before fitting the model.
admit_col : str, default='is_admitted'
    Name of the column indicating whether a patient was admitted.</p>
<h6 id="patientflow.predictors.sequence_predictor.SequencePredictor--attributes">Attributes</h6>
<p>weights : dict
    A dictionary storing the probabilities of different input sequences leading to specific outcome categories.
input_to_grouping_probs : pd.DataFrame
    A DataFrame that stores the computed probabilities of input sequences being associated with different grouping sequences.
special_params : dict, optional
    The special category parameters used for filtering, only populated if apply_special_category_filtering=True.
metrics : dict
    A dictionary to store metrics related to the training process.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/sequence_predictor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SequencePredictor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to model sequence-based predictions for categorical data using input and grouping sequences.</span>
<span class="sd">    This class implements both the `fit` and `predict` methods from the parent sklearn classes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_var : str</span>
<span class="sd">        Name of the column representing the input sequence in the DataFrame.</span>
<span class="sd">    grouping_var : str</span>
<span class="sd">        Name of the column representing the grouping sequence in the DataFrame.</span>
<span class="sd">    outcome_var : str</span>
<span class="sd">        Name of the column representing the outcome category in the DataFrame.</span>
<span class="sd">    apply_special_category_filtering : bool, default=True</span>
<span class="sd">        Whether to filter out special categories of patients before fitting the model.</span>
<span class="sd">    admit_col : str, default=&#39;is_admitted&#39;</span>
<span class="sd">        Name of the column indicating whether a patient was admitted.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : dict</span>
<span class="sd">        A dictionary storing the probabilities of different input sequences leading to specific outcome categories.</span>
<span class="sd">    input_to_grouping_probs : pd.DataFrame</span>
<span class="sd">        A DataFrame that stores the computed probabilities of input sequences being associated with different grouping sequences.</span>
<span class="sd">    special_params : dict, optional</span>
<span class="sd">        The special category parameters used for filtering, only populated if apply_special_category_filtering=True.</span>
<span class="sd">    metrics : dict</span>
<span class="sd">        A dictionary to store metrics related to the training process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_var</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="p">,</span>
        <span class="n">apply_special_category_filtering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">admit_col</span><span class="o">=</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_var</span> <span class="o">=</span> <span class="n">input_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span> <span class="o">=</span> <span class="n">grouping_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span> <span class="o">=</span> <span class="n">outcome_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span> <span class="o">=</span> <span class="n">apply_special_category_filtering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span> <span class="o">=</span> <span class="n">admit_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the estimator.&quot;&quot;&quot;</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    input_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    grouping_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    outcome_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    apply_special_category_filtering=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    admit_col=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a sequence to tuple if it&#39;s not already a tuple.</span>
<span class="sd">        Handles string cleaning to avoid double-quoting issues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sequence : tuple, list, or None</span>
<span class="sd">            The sequence to convert</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The input sequence as a tuple, or an empty tuple if input was None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="c1"># Clean any quoted strings in the sequence</span>
            <span class="n">cleaned_sequence</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cleaned_sequence</span><span class="p">)</span> <span class="k">if</span> <span class="n">cleaned_sequence</span> <span class="k">else</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># Clean any quoted strings in the tuple</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">sequence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocesses the input data before fitting the model.</span>

<span class="sd">        Steps include:</span>
<span class="sd">        1. Selecting only admitted patients with a non-null specialty</span>
<span class="sd">        2. Optionally filtering out special categories</span>
<span class="sd">        3. Converting sequence columns to tuple format if they aren&#39;t already</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            DataFrame containing patient data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Preprocessed DataFrame ready for model fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make a copy to avoid modifying the original</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Step 1: Select only admitted patients with a non-null specialty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

        <span class="c1"># Step 2: Optionally apply filtering for special categories</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="p">:</span>
            <span class="c1"># Get configuration for categorizing patients based on columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="c1"># Extract function that identifies non-special category patients</span>
            <span class="n">opposite_special_category_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">][</span>
                <span class="s2">&quot;default&quot;</span>
            <span class="p">]</span>

            <span class="c1"># Determine which category is the special category</span>
            <span class="n">special_category_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">key</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span>
            <span class="p">)</span>

            <span class="c1"># Filter out special category patients</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">opposite_special_category_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">special_category_key</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># Step 3: Convert sequence columns to tuple format</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_var</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SequencePredictor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the predictor based on training data by computing the proportion of each input variable sequence</span>
<span class="sd">        ending in specific outcome variable categories.</span>

<span class="sd">        Automatically preprocesses the data before fitting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            A pandas DataFrame containing at least the columns specified by `input_var`, `grouping_var`, and `outcome_var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : SequencePredictor</span>
<span class="sd">            The fitted SequencePredictor model with calculated probabilities for each sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store metrics about the training data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Preprocess the data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># derive the names of the observed outcome variables from the data</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="c1"># For each sequence count the number of observed categories</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Handle null sequences by assigning them to a specific key</span>
        <span class="n">null_counts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
            <span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>
        <span class="n">null_counts</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">()]</span>

        <span class="c1"># Concatenate null sequence handling</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_grouped</span><span class="p">,</span> <span class="n">null_counts</span><span class="p">])</span>

        <span class="c1"># Calculate the total number of times each grouping sequence occurred</span>
        <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate for each grouping sequence, the proportion of ending with each observed specialty</span>
        <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the probability of each grouping sequence occurring in the original data</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Reweight probabilities of ending with each observed specialty</span>
        <span class="c1"># by the likelihood of each grouping sequence occurring</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">proportions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
            <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">]:</span>  <span class="c1"># Avoid the last column which is the &#39;probability_of_grouping_sequence&#39;</span>
            <span class="n">proportions</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span>

        <span class="c1"># Convert final sequence to a string in order to conduct string searches on it</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;grouping_sequence_to_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">proportions</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="c1"># Row-wise function to return, for each input sequence,</span>
        <span class="c1"># the proportion that end up in each final sequence and thereby</span>
        <span class="c1"># the probability of it ending in any observed category</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span>
            <span class="s2">&quot;grouping_sequence_to_string&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_match_input_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">proportions</span><span class="p">,</span> <span class="n">prop_keys</span><span class="p">))</span>

        <span class="c1"># Convert the prob_input_var_ends_in_observed_specialty column to a dictionary</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Clean the key to remove excess strint quotes</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">clean_tuple_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">item</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="n">cleaned_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clean_tuple_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># save prob_input_var_ends_in_observed_specialty as weights within the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cleaned_dict</span>

        <span class="c1"># save the input to grouping probabilities for use as a reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_to_grouping_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_of_input_to_grouping_sequence</span><span class="p">(</span>
            <span class="n">X</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_string_match_input_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_var_string</span><span class="p">,</span> <span class="n">proportions</span><span class="p">,</span> <span class="n">prop_keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches a given input sequence string with grouped sequences (expressed as strings) in the dataset and aggregates</span>
<span class="sd">        their probabilities for each outcome category. This function filters the data to</span>
<span class="sd">        match only those rows where the *beginning* of the grouped sequence string</span>
<span class="sd">        matches the given input sequence string, allowing for partial matches.</span>
<span class="sd">        For instance, the sequence &#39;medical&#39; will match &#39;medical, elderly&#39; and &#39;medical, surgical&#39;</span>
<span class="sd">        as well as &#39;medical&#39; on its own. It computes the total probabilities of any input sequence ending</span>
<span class="sd">        in each outcome category, and normalizes these totals if possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_var_string : str</span>
<span class="sd">            The sequence of inputs represented as a string, used to match against sequences in the proportions DataFrame.</span>
<span class="sd">        proportions : pd.DataFrame</span>
<span class="sd">            DataFrame containing proportions data with an additional column &#39;grouping_sequence_to_string&#39;</span>
<span class="sd">            which includes string representations of sequences.</span>
<span class="sd">        prop_keys : np.array</span>
<span class="sd">            Array of unique outcomes to consider in calculations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary where keys are outcome names and values are the aggregated and normalized probabilities</span>
<span class="sd">            of an input sequence ending in those outcomes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter rows where the grouped sequence string starts with the input sequence string</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span>
            <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;grouping_sequence_to_string&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">input_var_string</span><span class="p">)</span>
        <span class="p">][</span><span class="n">prop_keys</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Sum of all probabilities to normalize them</span>
        <span class="n">props_total</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Handle cases where the total probability is zero to avoid division by zero</span>
        <span class="k">if</span> <span class="n">props_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">normalized_props</span> <span class="o">=</span> <span class="n">props</span> <span class="o">/</span> <span class="n">props_total</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalized_props</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">props</span> <span class="o">*</span> <span class="mi">0</span>
            <span class="p">)</span>  <span class="c1"># Returns zero probabilities if no matches found</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prop_keys</span><span class="p">,</span> <span class="n">normalized_props</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_probability_of_input_to_grouping_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the probabilities of different input sequences leading to specific grouping sequences.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            A pandas DataFrame containing at least the columns specified by `input_var` and `grouping_var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame containing the probabilities of input sequences leading to grouping sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For each input sequence count the number of grouping sequences</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># # Calculate the total number of times each input sequence occurred</span>
        <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># # Calculate for each grouping sequence, the proportion of ending with each grouping sequence</span>
        <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># # Calculate the probability of each input sequence occurring in the original data</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">proportions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_sequence</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts the probabilities of ending in various outcome categories for a given input sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_sequence : tuple[str, ...]</span>
<span class="sd">            A tuple containing the categories that have been observed for an entity in the order they</span>
<span class="sd">            have been encountered. An empty tuple represents an entity with no observed categories.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of categories and the probabilities that the input sequence will end in them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>

        <span class="c1"># Return a direct lookup of probabilities if possible.</span>
        <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

        <span class="c1"># Otherwise, if the sequence has multiple elements, work back looking for a match</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">input_sequence_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>
            <span class="n">input_sequence</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_sequence_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># remove last element</span>

            <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

        <span class="c1"># If no relevant data is found:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.sequence_predictor.SequencePredictor.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return a string representation of the estimator.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation of the estimator.&quot;&quot;&quot;</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    input_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    grouping_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    outcome_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    apply_special_category_filtering=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    admit_col=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.sequence_predictor.SequencePredictor.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fits the predictor based on training data by computing the proportion of each input variable sequence
ending in specific outcome variable categories.</p>
<p>Automatically preprocesses the data before fitting.</p>
<h6 id="patientflow.predictors.sequence_predictor.SequencePredictor.fit--parameters">Parameters</h6>
<p>X : pd.DataFrame
    A pandas DataFrame containing at least the columns specified by <code>input_var</code>, <code>grouping_var</code>, and <code>outcome_var</code>.</p>
<h6 id="patientflow.predictors.sequence_predictor.SequencePredictor.fit--returns">Returns</h6>
<p>self : SequencePredictor
    The fitted SequencePredictor model with calculated probabilities for each sequence.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SequencePredictor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits the predictor based on training data by computing the proportion of each input variable sequence</span>
<span class="sd">    ending in specific outcome variable categories.</span>

<span class="sd">    Automatically preprocesses the data before fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing at least the columns specified by `input_var`, `grouping_var`, and `outcome_var`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    self : SequencePredictor</span>
<span class="sd">        The fitted SequencePredictor model with calculated probabilities for each sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store metrics about the training data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Preprocess the data</span>
    <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># derive the names of the observed outcome variables from the data</span>
    <span class="n">prop_keys</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1"># For each sequence count the number of observed categories</span>
    <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
        <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Handle null sequences by assigning them to a specific key</span>
    <span class="n">null_counts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
        <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>
    <span class="n">null_counts</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">()]</span>

    <span class="c1"># Concatenate null sequence handling</span>
    <span class="n">X_grouped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_grouped</span><span class="p">,</span> <span class="n">null_counts</span><span class="p">])</span>

    <span class="c1"># Calculate the total number of times each grouping sequence occurred</span>
    <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate for each grouping sequence, the proportion of ending with each observed specialty</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Calculate the probability of each grouping sequence occurring in the original data</span>
    <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Reweight probabilities of ending with each observed specialty</span>
    <span class="c1"># by the likelihood of each grouping sequence occurring</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">proportions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
        <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
    <span class="p">]:</span>  <span class="c1"># Avoid the last column which is the &#39;probability_of_grouping_sequence&#39;</span>
        <span class="n">proportions</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span>

    <span class="c1"># Convert final sequence to a string in order to conduct string searches on it</span>
    <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;grouping_sequence_to_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">proportions</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>
    <span class="c1"># Row-wise function to return, for each input sequence,</span>
    <span class="c1"># the proportion that end up in each final sequence and thereby</span>
    <span class="c1"># the probability of it ending in any observed category</span>
    <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span>
        <span class="s2">&quot;grouping_sequence_to_string&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_match_input_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">proportions</span><span class="p">,</span> <span class="n">prop_keys</span><span class="p">))</span>

    <span class="c1"># Convert the prob_input_var_ends_in_observed_specialty column to a dictionary</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># Clean the key to remove excess strint quotes</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_tuple_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="n">cleaned_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clean_tuple_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># save prob_input_var_ends_in_observed_specialty as weights within the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cleaned_dict</span>

    <span class="c1"># save the input to grouping probabilities for use as a reference</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_to_grouping_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_of_input_to_grouping_sequence</span><span class="p">(</span>
        <span class="n">X</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.sequence_predictor.SequencePredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Predicts the probabilities of ending in various outcome categories for a given input sequence.</p>
<h6 id="patientflow.predictors.sequence_predictor.SequencePredictor.predict--parameters">Parameters</h6>
<p>input_sequence : tuple[str, ...]
    A tuple containing the categories that have been observed for an entity in the order they
    have been encountered. An empty tuple represents an entity with no observed categories.</p>
<h6 id="patientflow.predictors.sequence_predictor.SequencePredictor.predict--returns">Returns</h6>
<p>dict
    A dictionary of categories and the probabilities that the input sequence will end in them.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_sequence</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predicts the probabilities of ending in various outcome categories for a given input sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_sequence : tuple[str, ...]</span>
<span class="sd">        A tuple containing the categories that have been observed for an entity in the order they</span>
<span class="sd">        have been encountered. An empty tuple represents an entity with no observed categories.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of categories and the probabilities that the input sequence will end in them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>

    <span class="c1"># Return a direct lookup of probabilities if possible.</span>
    <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

    <span class="c1"># Otherwise, if the sequence has multiple elements, work back looking for a match</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">input_sequence_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>
        <span class="n">input_sequence</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_sequence_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># remove last element</span>

        <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

    <span class="c1"># If no relevant data is found:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.predictors.weighted_poisson_predictor" class="doc doc-heading">
            <code>weighted_poisson_predictor</code>


</h3>

    <div class="doc doc-contents ">

        <p>Weighted Poisson Predictor</p>
<p>This module implements a custom predictor to estimate the number of hospital admissions within a specified prediction window using historical admission data. It applies Poisson and binomial distributions to forecast future admissions, excluding already arrived patients. The predictor accommodates different data filters for tailored predictions across various hospital settings.</p>


<details class="dependencies" open>
  <summary>Dependencies</summary>
  <ul>
<li>pandas: For data manipulation and analysis, essential for handling the dataset used in predictions.</li>
<li>datetime: For manipulating date and time objects, crucial for time-based predictions.</li>
<li>sklearn: Utilizes BaseEstimator and TransformerMixin from scikit-learn for creating custom, interoperable predictors.</li>
<li>Custom modules:<ul>
<li>calculate.time_varying_arrival_rates: Computes time-varying arrival rates, for each specified interval within the prediction window.</li>
<li>predict.admission_in_prediction_window: Calculates the probability of admission within a specified prediction window.</li>
</ul>
</li>
</ul>
</details>

<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="WeightedPoissonPredictor (patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor)" href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor">WeightedPoissonPredictor</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Predicts the number of admissions within a given prediction window based on historical data and Poisson-binomial distribution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.weighted_poisson_predictor.Methods within WeightedPoissonPredictor">Methods within WeightedPoissonPredictor</span></code></td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><strong>init</strong>(self, filters=None): Initializes the predictor with optional data filters.</li>
<li>filter_dataframe(self, df, filters): Applies filters to the dataset for targeted predictions.</li>
<li>fit(self, train_df, prediction_window, yta_time_interval, prediction_times, json_file_path, reference_year, y=None): Trains the predictor using historical data and various parameters.</li>
<li>predict(self, prediction_context): Predicts the number of admissions using the trained model.</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor" class="doc doc-heading">
            <code>WeightedPoissonPredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>, <code><span title="sklearn.base.TransformerMixin">TransformerMixin</span></code></p>


        <p>A class to predict an aspirational number of admissions within a specified prediction window.
This prediction does not include patients who have already arrived and is based on historical data.
The prediction uses a combination of Poisson and binomial distributions.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.filters">filters</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filters for data categorization</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.verbose">verbose</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable verbose logging</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores metadata about the model and training data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Methods
    <strong>init</strong>(self, filters=None): Initializes the predictor with optional filters for data categorization.
    filter_dataframe(self, df, filters): Filters the dataset based on specified criteria for targeted predictions.
    fit(self, train_df, prediction_window, yta_time_interval, prediction_times, y=None): Trains the model using historical data and prediction parameters.
    predict(self, prediction_context): Predicts the number of admissions for a given context after the model is trained.
    get_weights(self): Retrieves the model parameters computed during fitting.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WeightedPoissonPredictor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to predict an aspirational number of admissions within a specified prediction window.</span>
<span class="sd">    This prediction does not include patients who have already arrived and is based on historical data.</span>
<span class="sd">    The prediction uses a combination of Poisson and binomial distributions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        filters (dict): Optional filters for data categorization</span>
<span class="sd">        verbose (bool): Whether to enable verbose logging</span>
<span class="sd">        metrics (dict): Stores metadata about the model and training data</span>

<span class="sd">    Methods</span>
<span class="sd">        __init__(self, filters=None): Initializes the predictor with optional filters for data categorization.</span>
<span class="sd">        filter_dataframe(self, df, filters): Filters the dataset based on specified criteria for targeted predictions.</span>
<span class="sd">        fit(self, train_df, prediction_window, yta_time_interval, prediction_times, y=None): Trains the model using historical data and prediction parameters.</span>
<span class="sd">        predict(self, prediction_context): Predicts the number of admissions for a given context after the model is trained.</span>
<span class="sd">        get_weights(self): Retrieves the model parameters computed during fitting.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WeightedPoissonPredictor with optional filters.</span>

<span class="sd">        Args:</span>
<span class="sd">            filters (dict, optional): A dictionary defining filters for different categories or specialties.</span>
<span class="sd">                                    If None or empty, no filtering will be applied.</span>
<span class="sd">            verbose (bool, optional): If True, enable info-level logging. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Add metrics dictionary to store metadata</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># Configure logging for Jupyter notebook compatibility</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

            <span class="c1"># Create logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.WeightedPoissonPredictor&quot;</span><span class="p">)</span>

            <span class="c1"># Only set up handlers if they don&#39;t exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

                <span class="c1"># Create handler that writes to sys.stdout</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

                <span class="c1"># Create a formatting configuration</span>
                <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

                <span class="c1"># Add the handler to the logger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

                <span class="c1"># Prevent propagation to root logger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Apply filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a set of filters to a dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): The DataFrame to filter.</span>
<span class="sd">            filters (dict): A dictionary where keys are column names and values are the criteria or function to filter by.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: A filtered DataFrame.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">criteria</span><span class="p">):</span>  <span class="c1"># If the criteria is a function, apply it directly</span>
                <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, assume the criteria is a value or list of values for equality check</span>
                <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="n">criteria</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">filtered_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">num_days</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate parameters required for the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): The data frame to process.</span>
<span class="sd">            prediction_window (int): The total prediction window for prediction.</span>
<span class="sd">            yta_time_interval (int): The interval for splitting the prediction window.</span>
<span class="sd">            prediction_times (list): Times of day at which predictions are made.</span>
<span class="sd">            num_days (int): Number of days over which to calculate time-varying arrival rates</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Calculated arrival_rates parameters organized by time of day.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ntimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span>
        <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="n">prediction_time_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">prediction_time_</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
            <span class="n">prediction_time_hr</span><span class="p">,</span> <span class="n">prediction_time_min</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prediction_time_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_time_</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">prediction_time_</span>
            <span class="p">)</span>
            <span class="n">arrival_rates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">arrival_rates_dict</span><span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prediction_time_hr</span><span class="p">,</span> <span class="n">prediction_time_min</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntimes</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">prediction_time_dict</span><span class="p">[(</span><span class="n">prediction_time_hr</span><span class="p">,</span> <span class="n">prediction_time_min</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;arrival_rates&quot;</span><span class="p">:</span> <span class="n">arrival_rates</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">prediction_time_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WeightedPoissonPredictor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the model to the training data, computing necessary parameters for future predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_df (pandas.DataFrame):</span>
<span class="sd">                The training dataset with historical admission data.</span>
<span class="sd">            prediction_window (int):</span>
<span class="sd">                The prediction prediction window in minutes.</span>
<span class="sd">            yta_time_interval (int):</span>
<span class="sd">                The interval in minutes for splitting the prediction window.</span>
<span class="sd">            prediction_times (list):</span>
<span class="sd">                Times of day at which predictions are made, in hours.</span>
<span class="sd">            num_days (int):</span>
<span class="sd">                 The number of days that the train_df spans</span>
<span class="sd">            epsilon (float, optional):</span>
<span class="sd">                A small value representing acceptable error rate to enable calculation of the maximum value of the random variable representing number of beds.</span>
<span class="sd">            y (None, optional):</span>
<span class="sd">                Ignored, present for compatibility with scikit-learn&#39;s fit method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WeightedPoissonPredictor: The instance itself, fitted with the training data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add error checking at the start of fit</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;prediction_window (</span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2">) divided by yta_time_interval (</span><span class="si">{</span><span class="n">yta_time_interval</span><span class="si">}</span><span class="s2">) must be greater than 1 to generate meaningful predictions&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Store prediction_window, yta_time_interval, and any other parameters as instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">=</span> <span class="n">prediction_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
            <span class="k">else</span> <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prediction_times</span>
        <span class="p">]</span>

        <span class="c1"># Initialize yet_to_arrive_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If there are filters specified, calculate and store the parameters directly with the respective spec keys</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">filters</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filter_dataframe</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">filters</span><span class="p">),</span>
                    <span class="n">prediction_window</span><span class="p">,</span>
                    <span class="n">yta_time_interval</span><span class="p">,</span>
                    <span class="n">prediction_times</span><span class="p">,</span>
                    <span class="n">num_days</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If there are no filters, store the parameters with a generic key of &#39;unfiltered&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s2">&quot;unfiltered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
                <span class="n">train_df</span><span class="p">,</span>
                <span class="n">prediction_window</span><span class="p">,</span>
                <span class="n">yta_time_interval</span><span class="p">,</span>
                <span class="n">prediction_times</span><span class="p">,</span>
                <span class="n">num_days</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Weighted Poisson Predictor trained for these times: </span><span class="si">{</span><span class="n">prediction_times</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;using prediction window of </span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2"> minutes after the time of prediction&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;and time interval of </span><span class="si">{</span><span class="n">yta_time_interval</span><span class="si">}</span><span class="s2"> minutes within the prediction window.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error value for prediction will be </span><span class="si">{</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;To see the weights saved by this model, used the get_weights() method&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Store metrics about the training data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;num_days&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_days</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the weights computed by the fit method.</span>

<span class="sd">        Returns</span>
<span class="sd">            dict: The weights.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts the number of admissions for the given context based on the fitted model.</span>

<span class="sd">        Args:</span>
<span class="sd">            prediction_context (dict): A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">                                       It should specify either a general context or one based on the applied filters.</span>
<span class="sd">            x1 : float</span>
<span class="sd">                The x-coordinate of the first transition point on the aspirational curve, where the growth phase ends and the decay phase begins.</span>
<span class="sd">            y1 : float</span>
<span class="sd">                The y-coordinate of the first transition point (x1), representing the target proportion of patients admitted by time x1.</span>
<span class="sd">            x2 : float</span>
<span class="sd">                The x-coordinate of the second transition point on the curve, beyond which all but a few patients are expected to be admitted.</span>
<span class="sd">            y2 : float</span>
<span class="sd">                The y-coordinate of the second transition point (x2), representing the target proportion of patients admitted by time x2.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary with predictions for each specified context.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">)</span>
        <span class="c1"># Calculate theta, probability of admission in prediction window</span>

        <span class="c1"># for each time interval, calculate time remaining before end of window</span>
        <span class="n">time_remaining_before_end_of_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="p">)</span>

        <span class="c1"># probability of admission in that time</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
            <span class="n">time_remaining_before_end_of_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">filter_values</span> <span class="ow">in</span> <span class="n">prediction_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Filter key &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39; is not recognized in the model weights.&quot;</span>
                    <span class="p">)</span>

                <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">filter_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No &#39;prediction_time&#39; provided for filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span><span class="p">:</span>
                    <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span>
                        <span class="n">prediction_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span>
                    <span class="p">)</span>

                <span class="n">arrival_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">filter_key</span><span class="p">][</span><span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;arrival_rates&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">arrival_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No arrival_rates found for the time of day &#39;</span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&#39; under filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="n">predictions</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">poisson_binom_generating_function</span><span class="p">(</span>
                    <span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Initialize the WeightedPoissonPredictor with optional filters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary defining filters for different categories or specialties.
                    If None or empty, no filtering will be applied.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, enable info-level logging. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the WeightedPoissonPredictor with optional filters.</span>

<span class="sd">    Args:</span>
<span class="sd">        filters (dict, optional): A dictionary defining filters for different categories or specialties.</span>
<span class="sd">                                If None or empty, no filtering will be applied.</span>
<span class="sd">        verbose (bool, optional): If True, enable info-level logging. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Add metrics dictionary to store metadata</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># Configure logging for Jupyter notebook compatibility</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

        <span class="c1"># Create logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.WeightedPoissonPredictor&quot;</span><span class="p">)</span>

        <span class="c1"># Only set up handlers if they don&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="c1"># Create handler that writes to sys.stdout</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="c1"># Create a formatting configuration</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

            <span class="c1"># Add the handler to the logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

            <span class="c1"># Prevent propagation to root logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Apply filters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.filter_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Apply a set of filters to a dataframe.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataFrame to filter.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are column names and values are the criteria or function to filter by.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame: A filtered DataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a set of filters to a dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): The DataFrame to filter.</span>
<span class="sd">        filters (dict): A dictionary where keys are column names and values are the criteria or function to filter by.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: A filtered DataFrame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">criteria</span><span class="p">):</span>  <span class="c1"># If the criteria is a function, apply it directly</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, assume the criteria is a value or list of values for equality check</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="n">criteria</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">filtered_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fits the model to the training data, computing necessary parameters for future predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The training dataset with historical admission data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prediction prediction window in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interval in minutes for splitting the prediction window.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Times of day at which predictions are made, in hours.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days that the train_df spans</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A small value representing acceptable error rate to enable calculation of the maximum value of the random variable representing number of beds.</p>
              </div>
            </td>
            <td>
                  <code>10 ** -7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored, present for compatibility with scikit-learn's fit method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WeightedPoissonPredictor</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WeightedPoissonPredictor (patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor)" href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor">WeightedPoissonPredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The instance itself, fitted with the training data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">train_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WeightedPoissonPredictor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits the model to the training data, computing necessary parameters for future predictions.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_df (pandas.DataFrame):</span>
<span class="sd">            The training dataset with historical admission data.</span>
<span class="sd">        prediction_window (int):</span>
<span class="sd">            The prediction prediction window in minutes.</span>
<span class="sd">        yta_time_interval (int):</span>
<span class="sd">            The interval in minutes for splitting the prediction window.</span>
<span class="sd">        prediction_times (list):</span>
<span class="sd">            Times of day at which predictions are made, in hours.</span>
<span class="sd">        num_days (int):</span>
<span class="sd">             The number of days that the train_df spans</span>
<span class="sd">        epsilon (float, optional):</span>
<span class="sd">            A small value representing acceptable error rate to enable calculation of the maximum value of the random variable representing number of beds.</span>
<span class="sd">        y (None, optional):</span>
<span class="sd">            Ignored, present for compatibility with scikit-learn&#39;s fit method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WeightedPoissonPredictor: The instance itself, fitted with the training data.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add error checking at the start of fit</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;prediction_window (</span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2">) divided by yta_time_interval (</span><span class="si">{</span><span class="n">yta_time_interval</span><span class="si">}</span><span class="s2">) must be greater than 1 to generate meaningful predictions&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Store prediction_window, yta_time_interval, and any other parameters as instance variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">=</span> <span class="n">prediction_window</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="k">else</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prediction_times</span>
    <span class="p">]</span>

    <span class="c1"># Initialize yet_to_arrive_dict</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># If there are filters specified, calculate and store the parameters directly with the respective spec keys</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">filters</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter_dataframe</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">filters</span><span class="p">),</span>
                <span class="n">prediction_window</span><span class="p">,</span>
                <span class="n">yta_time_interval</span><span class="p">,</span>
                <span class="n">prediction_times</span><span class="p">,</span>
                <span class="n">num_days</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If there are no filters, store the parameters with a generic key of &#39;unfiltered&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s2">&quot;unfiltered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
            <span class="n">train_df</span><span class="p">,</span>
            <span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">yta_time_interval</span><span class="p">,</span>
            <span class="n">prediction_times</span><span class="p">,</span>
            <span class="n">num_days</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Weighted Poisson Predictor trained for these times: </span><span class="si">{</span><span class="n">prediction_times</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;using prediction window of </span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2"> minutes after the time of prediction&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;and time interval of </span><span class="si">{</span><span class="n">yta_time_interval</span><span class="si">}</span><span class="s2"> minutes within the prediction window.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error value for prediction will be </span><span class="si">{</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;To see the weights saved by this model, used the get_weights() method&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Store metrics about the training data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;num_days&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_days</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.get_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_weights</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the weights computed by the fit method.</p>
<p>Returns
    dict: The weights.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the weights computed by the fit method.</span>

<span class="sd">    Returns</span>
<span class="sd">        dict: The weights.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">prediction_context</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Predicts the number of admissions for the given context based on the fitted model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary defining the context for which predictions are to be made.
                       It should specify either a general context or one based on the applied filters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
The x-coordinate of the first transition point on the aspirational curve, where the growth phase ends and the decay phase begins.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
The y-coordinate of the first transition point (x1), representing the target proportion of patients admitted by time x1.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
The x-coordinate of the second transition point on the curve, beyond which all but a few patients are expected to be admitted.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
The y-coordinate of the second transition point (x2), representing the target proportion of patients admitted by time x2.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary with predictions for each specified context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predicts the number of admissions for the given context based on the fitted model.</span>

<span class="sd">    Args:</span>
<span class="sd">        prediction_context (dict): A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">                                   It should specify either a general context or one based on the applied filters.</span>
<span class="sd">        x1 : float</span>
<span class="sd">            The x-coordinate of the first transition point on the aspirational curve, where the growth phase ends and the decay phase begins.</span>
<span class="sd">        y1 : float</span>
<span class="sd">            The y-coordinate of the first transition point (x1), representing the target proportion of patients admitted by time x1.</span>
<span class="sd">        x2 : float</span>
<span class="sd">            The x-coordinate of the second transition point on the curve, beyond which all but a few patients are expected to be admitted.</span>
<span class="sd">        y2 : float</span>
<span class="sd">            The y-coordinate of the second transition point (x2), representing the target proportion of patients admitted by time x2.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary with predictions for each specified context.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">)</span>
    <span class="c1"># Calculate theta, probability of admission in prediction window</span>

    <span class="c1"># for each time interval, calculate time remaining before end of window</span>
    <span class="n">time_remaining_before_end_of_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="p">)</span>

    <span class="c1"># probability of admission in that time</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
        <span class="n">time_remaining_before_end_of_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">filter_values</span> <span class="ow">in</span> <span class="n">prediction_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Filter key &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39; is not recognized in the model weights.&quot;</span>
                <span class="p">)</span>

            <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">filter_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No &#39;prediction_time&#39; provided for filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span><span class="p">:</span>
                <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span>
                    <span class="n">prediction_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span>
                <span class="p">)</span>

            <span class="n">arrival_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">filter_key</span><span class="p">][</span><span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;arrival_rates&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">arrival_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No arrival_rates found for the time of day &#39;</span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&#39; under filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="n">predictions</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">poisson_binom_generating_function</span><span class="p">(</span>
                <span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.weighted_poisson_predictor.aggregate_probabilities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_probabilities</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate probabilities for a range of values using the weighted Poisson-Binomial distribution.</p>
<p>Parameters
lam (numpy.ndarray): An array of lambda values for each time interval.
kmax (int): The maximum number of events to consider.
theta (numpy.ndarray): An array of theta values for each time interval.
time_index (int): The current time index for which to calculate probabilities.</p>
<p>Returns
numpy.ndarray: Aggregated probabilities for the given time index.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_probabilities</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregate probabilities for a range of values using the weighted Poisson-Binomial distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    lam (numpy.ndarray): An array of lambda values for each time interval.</span>
<span class="sd">    kmax (int): The maximum number of events to consider.</span>
<span class="sd">    theta (numpy.ndarray): An array of theta values for each time interval.</span>
<span class="sd">    time_index (int): The current time index for which to calculate probabilities.</span>

<span class="sd">    Returns</span>
<span class="sd">    numpy.ndarray: Aggregated probabilities for the given time index.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kmax</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">time_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">time_index</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">time_index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid kmax, time_index, or array lengths.&quot;</span><span class="p">)</span>

    <span class="n">probabilities_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">probabilities_matrix</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_poisson_binomial</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">[</span><span class="n">time_index</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">probabilities_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.weighted_poisson_predictor.convolute_distributions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convolute_distributions</span><span class="p">(</span><span class="n">dist_a</span><span class="p">,</span> <span class="n">dist_b</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convolutes two probability distributions represented as dataframes.</p>
<p>Parameters
dist_a (pd.DataFrame): The first distribution with columns ['sum', 'prob'].
dist_b (pd.DataFrame): The second distribution with columns ['sum', 'prob'].</p>
<p>Returns
pd.DataFrame: The convoluted distribution.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convolute_distributions</span><span class="p">(</span><span class="n">dist_a</span><span class="p">,</span> <span class="n">dist_b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convolutes two probability distributions represented as dataframes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    dist_a (pd.DataFrame): The first distribution with columns [&#39;sum&#39;, &#39;prob&#39;].</span>
<span class="sd">    dist_b (pd.DataFrame): The second distribution with columns [&#39;sum&#39;, &#39;prob&#39;].</span>

<span class="sd">    Returns</span>
<span class="sd">    pd.DataFrame: The convoluted distribution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">dist_a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">{</span>
        <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prob&quot;</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">dist_b</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataFrames must contain &#39;sum&#39; and &#39;prob&#39; columns.&quot;</span><span class="p">)</span>

    <span class="n">sums</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dist_a</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dist_b</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]]</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dist_a</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dist_b</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sums</span><span class="p">,</span> <span class="n">probs</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.weighted_poisson_predictor.find_nearest_previous_prediction_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span><span class="n">requested_time</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Finds the nearest previous time of day in 'prediction_times' relative to the requested time.
If the requested time is earlier than all times in 'prediction_times', the function returns
the latest time in 'prediction_times'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>requested_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The requested time as (hour, minute).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available prediction times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>closest_prediction_time</code></td>            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The closest previous time of day from 'prediction_times'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_nearest_previous_prediction_time</span><span class="p">(</span><span class="n">requested_time</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the nearest previous time of day in &#39;prediction_times&#39; relative to the requested time.</span>
<span class="sd">    If the requested time is earlier than all times in &#39;prediction_times&#39;, the function returns</span>
<span class="sd">    the latest time in &#39;prediction_times&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        requested_time (tuple): The requested time as (hour, minute).</span>
<span class="sd">        prediction_times (list): List of available prediction times.</span>

<span class="sd">    Returns:</span>
<span class="sd">        closest_prediction_time (tuple): The closest previous time of day from &#39;prediction_times&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">requested_time</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">requested_time</span>

    <span class="n">original_prediction_time</span> <span class="o">=</span> <span class="n">requested_time</span>
    <span class="n">requested_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">requested_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">requested_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span>
    <span class="p">)</span>
    <span class="n">closest_prediction_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">prediction_time_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;%H:%M&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">min_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prediction_time_time</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
        <span class="n">prediction_time_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;%H:%M&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">requested_datetime</span> <span class="o">-</span> <span class="n">prediction_time_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># If the difference is negative, it means the prediction_time_time is ahead of the requested_time,</span>
        <span class="c1"># hence we calculate the difference by considering a day&#39;s wrap around.</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">+=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># Add 24 hours in seconds</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_diff</span><span class="p">:</span>
            <span class="n">closest_prediction_time</span> <span class="o">=</span> <span class="n">prediction_time_time</span>
            <span class="n">min_diff</span> <span class="o">=</span> <span class="n">diff</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Time of day requested of </span><span class="si">{</span><span class="n">original_prediction_time</span><span class="si">}</span><span class="s2"> was not in model training. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Reverting to predictions for </span><span class="si">{</span><span class="n">closest_prediction_time</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">closest_prediction_time</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.weighted_poisson_predictor.poisson_binom_generating_function" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">poisson_binom_generating_function</span><span class="p">(</span><span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate a distribution based on the aggregate of Poisson and Binomial distributions over time intervals.</p>
<p>Parameters
NTimes (int): The number of time intervals.
arrival_rates (numpy.ndarray): An array of lambda values for each time interval.
theta (numpy.ndarray): An array of theta values for each time interval.
epsilon (float): The desired error threshold.</p>
<p>Returns
pd.DataFrame: The generated distribution.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">poisson_binom_generating_function</span><span class="p">(</span><span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a distribution based on the aggregate of Poisson and Binomial distributions over time intervals.</span>

<span class="sd">    Parameters</span>
<span class="sd">    NTimes (int): The number of time intervals.</span>
<span class="sd">    arrival_rates (numpy.ndarray): An array of lambda values for each time interval.</span>
<span class="sd">    theta (numpy.ndarray): An array of theta values for each time interval.</span>
<span class="sd">    epsilon (float): The desired error threshold.</span>

<span class="sd">    Returns</span>
<span class="sd">    pd.DataFrame: The generated distribution.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">NTimes</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epsilon</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epsilon</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ensure NTimes &gt; 0 and 0 &lt; epsilon &lt; 1.&quot;</span><span class="p">)</span>

    <span class="n">maxlam</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)</span>
    <span class="n">kmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">maxlam</span><span class="p">))</span>
    <span class="n">distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NTimes</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NTimes</span><span class="p">):</span>
        <span class="n">distribution</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate_probabilities</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="n">distribution</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]})</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NTimes</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">total_distribution</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">total_distribution</span> <span class="o">=</span> <span class="n">convolute_distributions</span><span class="p">(</span><span class="n">total_distribution</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">total_distribution</span> <span class="o">=</span> <span class="n">total_distribution</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="s2">&quot;agg_proba&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">total_distribution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.weighted_poisson_predictor.weighted_poisson_binomial" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weighted_poisson_binomial</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate weighted probabilities using Poisson and Binomial distributions.</p>
<p>Parameters
i (int): The upper bound of the range for the binomial distribution.
lam (float): The lambda parameter for the Poisson distribution.
theta (float): The probability of success for the binomial distribution.</p>
<p>Returns
numpy.ndarray: An array of weighted probabilities.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">weighted_poisson_binomial</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate weighted probabilities using Poisson and Binomial distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    i (int): The upper bound of the range for the binomial distribution.</span>
<span class="sd">    lam (float): The lambda parameter for the Poisson distribution.</span>
<span class="sd">    theta (float): The probability of success for the binomial distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">    numpy.ndarray: An array of weighted probabilities.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lam</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">theta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ensure i &gt;= 0, lam &gt;= 0, and 0 &lt;= theta &lt;= 1.&quot;</span><span class="p">)</span>

    <span class="n">arr_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">arr_seq</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span> <span class="o">*</span> <span class="n">probabilities</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.prepare" class="doc doc-heading">
            <code>prepare</code>


</h2>

    <div class="doc doc-contents ">

        <p>Module for preparing data, loading models, and organizing snapshots for inference.</p>
<p>This module provides functionality to load a trained model, prepare data for
making predictions, calculate arrival rates, and organize snapshot data. It allows for selecting one
snapshot per visit, filtering snapshots by prediction time, and mapping
snapshot dates to corresponding indices.</p>
<h4 id="patientflow.prepare--functions">Functions</h4>
<p>prepare_for_inference(model_file_path, model_name, prediction_time=None,
                      model_only=False, df=None, data_path=None,
                      single_snapshot_per_visit=True, index_column='snapshot_id',
                      sort_columns=None, eval_columns=None,
                      exclude_from_training_data=None)
    Loads a model and prepares data for inference.</p>
<p>select_one_snapshot_per_visit(df, visit_col, seed=42)
    Selects one snapshot per visit based on a random number and returns the filtered DataFrame.</p>
<p>prepare_patient_snapshots(df, prediction_time, exclude_columns, single_snapshot_per_visit=True)
    Filters the DataFrame by prediction time and optionally selects one snapshot per visit.</p>
<p>prepare_group_snapshot_dict(df, start_dt=None, end_dt=None)
    Prepares a dictionary mapping snapshot dates to their corresponding snapshot indices.</p>
<p>calculate_time_varying_arrival_rates(df, yta_time_interval)
    Calculates the time-varying arrival rates for a dataset indexed by datetime.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="patientflow.prepare.SpecialCategoryParams" class="doc doc-heading">
            <code>SpecialCategoryParams</code>


</h3>


    <div class="doc doc-contents ">


        <p>A picklable implementation of special category parameters for patient classification.</p>
<p>This class identifies pediatric patients based on available age-related columns
in the dataset and provides functions to categorize patients accordingly.
It's designed to be serializable with pickle by implementing the <strong>reduce</strong> method.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.prepare.SpecialCategoryParams.columns">columns</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of column names from the dataset</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.prepare.SpecialCategoryParams.method_type">method_type</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The method used for age detection ('age_on_arrival' or 'age_group')</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.prepare.SpecialCategoryParams.special_category_dict">special_category_dict</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default category values mapping</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpecialCategoryParams</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A picklable implementation of special category parameters for patient classification.</span>

<span class="sd">    This class identifies pediatric patients based on available age-related columns</span>
<span class="sd">    in the dataset and provides functions to categorize patients accordingly.</span>
<span class="sd">    It&#39;s designed to be serializable with pickle by implementing the __reduce__ method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        columns (list): List of column names from the dataset</span>
<span class="sd">        method_type (str): The method used for age detection (&#39;age_on_arrival&#39; or &#39;age_group&#39;)</span>
<span class="sd">        special_category_dict (dict): Default category values mapping</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the SpecialCategoryParams object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            columns (list or pandas.Index): Column names from the dataset</span>
<span class="sd">                used to determine the appropriate age identification method</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither &#39;age_on_arrival&#39; nor &#39;age_group&#39; columns are found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;medical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;surgical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;haem/onc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;age_on_arrival&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_on_arrival&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;age_group&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_group&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown data format: could not find expected age columns&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify if a patient is pediatric based on age data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            row (Union[dict, pd.Series]): A row of patient data containing either</span>
<span class="sd">                &#39;age_on_arrival&#39; or &#39;age_group&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the patient is pediatric (age &lt; 18 or age_group is &#39;0-17&#39;),</span>
<span class="sd">                 False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">18</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># age_group</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0-17&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">opposite_special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify if a patient is NOT pediatric.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            row (Union[dict, pd.Series]): A row of patient data</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the patient is NOT pediatric, False if they are pediatric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_params_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the special parameter dictionary in the format expected by the application.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Union[Callable, Dict[str, float], Dict[str, Callable]]]: A dictionary containing:</span>
<span class="sd">                - &#39;special_category_func&#39;: Function to identify pediatric patients</span>
<span class="sd">                - &#39;special_category_dict&#39;: Default category values (float)</span>
<span class="sd">                - &#39;special_func_map&#39;: Mapping of category names to detection functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;special_category_func&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
            <span class="s2">&quot;special_category_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span><span class="p">,</span>
            <span class="s2">&quot;special_func_map&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_special_category_func</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;SpecialCategoryParams&quot;</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Support for pickle serialization.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Type[&#39;SpecialCategoryParams&#39;], Tuple[list]]: A tuple containing:</span>
<span class="sd">                - The class itself (to be called as a function)</span>
<span class="sd">                - A tuple of arguments to pass to the class constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the SpecialCategoryParams object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>columns</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a> or <span title="pandas.Index">Index</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column names from the dataset
used to determine the appropriate age identification method</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If neither 'age_on_arrival' nor 'age_group' columns are found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the SpecialCategoryParams object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        columns (list or pandas.Index): Column names from the dataset</span>
<span class="sd">            used to determine the appropriate age identification method</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If neither &#39;age_on_arrival&#39; nor &#39;age_group&#39; columns are found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;surgical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;haem/onc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;age_on_arrival&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_on_arrival&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;age_group&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_group&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown data format: could not find expected age columns&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.__reduce__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__reduce__</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Support for pickle serialization.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" title="typing.Type" href="https://docs.python.org/3/library/typing.html#typing.Type">Type</a>[<a class="autorefs autorefs-internal" title="SpecialCategoryParams (patientflow.prepare.SpecialCategoryParams)" href="#patientflow.prepare.SpecialCategoryParams">SpecialCategoryParams</a>], <a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[Type['SpecialCategoryParams'], Tuple[list]]: A tuple containing:
- The class itself (to be called as a function)
- A tuple of arguments to pass to the class constructor</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;SpecialCategoryParams&quot;</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Support for pickle serialization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Type[&#39;SpecialCategoryParams&#39;], Tuple[list]]: A tuple containing:</span>
<span class="sd">            - The class itself (to be called as a function)</span>
<span class="sd">            - A tuple of arguments to pass to the class constructor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.get_params_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_params_dict</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the special parameter dictionary in the format expected by the application.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>], <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Union[Callable, Dict[str, float], Dict[str, Callable]]]: A dictionary containing:
- 'special_category_func': Function to identify pediatric patients
- 'special_category_dict': Default category values (float)
- 'special_func_map': Mapping of category names to detection functions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_params_dict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the special parameter dictionary in the format expected by the application.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Union[Callable, Dict[str, float], Dict[str, Callable]]]: A dictionary containing:</span>
<span class="sd">            - &#39;special_category_func&#39;: Function to identify pediatric patients</span>
<span class="sd">            - &#39;special_category_dict&#39;: Default category values (float)</span>
<span class="sd">            - &#39;special_func_map&#39;: Mapping of category names to detection functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;special_category_func&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
        <span class="s2">&quot;special_category_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span><span class="p">,</span>
        <span class="s2">&quot;special_func_map&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_special_category_func</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.opposite_special_category_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">opposite_special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Identify if a patient is NOT pediatric.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>row</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <span title="pandas.Series">Series</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A row of patient data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the patient is NOT pediatric, False if they are pediatric</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">opposite_special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify if a patient is NOT pediatric.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        row (Union[dict, pd.Series]): A row of patient data</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the patient is NOT pediatric, False if they are pediatric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.special_category_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Identify if a patient is pediatric based on age data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>row</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <span title="pandas.Series">Series</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A row of patient data containing either
'age_on_arrival' or 'age_group'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the patient is pediatric (age &lt; 18 or age_group is '0-17'),
 False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify if a patient is pediatric based on age data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        row (Union[dict, pd.Series]): A row of patient data containing either</span>
<span class="sd">            &#39;age_on_arrival&#39; or &#39;age_group&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the patient is pediatric (age &lt; 18 or age_group is &#39;0-17&#39;),</span>
<span class="sd">             False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">18</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># age_group</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0-17&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.assign_patient_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">assign_patient_ids</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_training_set</span><span class="p">,</span> <span class="n">start_validation_set</span><span class="p">,</span> <span class="n">start_test_set</span><span class="p">,</span> <span class="n">end_test_set</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">patient_id</span><span class="o">=</span><span class="s1">&#39;mrn&#39;</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;encounter&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Probabilistically assign patient IDs to train/validation/test sets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with patient_id, encounter, and temporal columns</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_training_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for training period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_validation_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for validation period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_test_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for test period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_test_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End date for test period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>date_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for temporal splitting</p>
              </div>
            </td>
            <td>
                  <code>&#39;arrival_datetime&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for patient identifier (default: 'mrn')</p>
              </div>
            </td>
            <td>
                  <code>&#39;mrn&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for visit identifier (default: 'encounter')</p>
              </div>
            </td>
            <td>
                  <code>&#39;encounter&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with patient ID assignments based on weighted random sampling</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Counts encounters in each time period per patient ID</li>
<li>Randomly assigns each patient ID to one set, weighted by their temporal distribution</li>
<li>Patient with 70% encounters in training, 30% in validation has 70% chance of training assignment</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">assign_patient_ids</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">start_training_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_validation_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_test_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">end_test_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mrn&quot;</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;encounter&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Probabilistically assign patient IDs to train/validation/test sets.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with patient_id, encounter, and temporal columns</span>
<span class="sd">        start_training_set: Start date for training period</span>
<span class="sd">        start_validation_set: Start date for validation period</span>
<span class="sd">        start_test_set: Start date for test period</span>
<span class="sd">        end_test_set: End date for test period</span>
<span class="sd">        date_col: Column name for temporal splitting</span>
<span class="sd">        patient_id: Column name for patient identifier (default: &#39;mrn&#39;)</span>
<span class="sd">        visit_col: Column name for visit identifier (default: &#39;encounter&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with patient ID assignments based on weighted random sampling</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Counts encounters in each time period per patient ID</span>
<span class="sd">        - Randomly assigns each patient ID to one set, weighted by their temporal distribution</span>
<span class="sd">        - Patient with 70% encounters in training, 30% in validation has 70% chance of training assignment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patients</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">])[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Handle date_col as string, datetime, or date type</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]):</span>
        <span class="c1"># Already datetime, extract date if needed</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;date&quot;</span><span class="p">):</span>
            <span class="n">date_series</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Already date type</span>
            <span class="n">date_series</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Try to convert string to datetime</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">])</span>
            <span class="n">date_series</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not convert column &#39;</span><span class="si">{</span><span class="n">date_col</span><span class="si">}</span><span class="s2">&#39; to datetime format: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Filter out patient IDs outside temporal bounds</span>
    <span class="n">pre_training_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">start_training_set</span><span class="p">]</span>
    <span class="n">post_test_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">end_test_set</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_training_patients</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_training_patients</span><span class="p">)</span><span class="si">}</span><span class="s2"> patients with only pre-training visits&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_test_patients</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">post_test_patients</span><span class="p">)</span><span class="si">}</span><span class="s2"> patients with only post-test visits&quot;</span>
        <span class="p">)</span>

    <span class="n">valid_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span>
        <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_training_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">end_test_set</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">valid_patients</span>

    <span class="c1"># Use the date_series for set assignment</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;training_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_training_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">start_validation_set</span>
    <span class="p">)</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;validation_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_validation_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">start_test_set</span>
    <span class="p">)</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;test_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_test_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">end_test_set</span>
    <span class="p">)</span>

    <span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)[</span>
        <span class="p">[</span><span class="s2">&quot;training_set&quot;</span><span class="p">,</span> <span class="s2">&quot;validation_set&quot;</span><span class="p">,</span> <span class="s2">&quot;test_set&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;training_validation_test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">apply_set</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Patient Set Overlaps (before random assignment):&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train-Valid: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valid-Test: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train-Test: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All Sets: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> total patients&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">patients</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.create_special_category_objects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creates a configuration for categorizing patients with special handling for pediatric cases.</p>
<h5 id="patientflow.prepare.create_special_category_objects--parameters">Parameters:</h5>
<p>columns : list or pandas.Index
    The column names available in the dataset. Used to determine which age format is present.</p>
<h5 id="patientflow.prepare.create_special_category_objects--returns">Returns:</h5>
<p>dict
    A dictionary containing special category configuration.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_special_category_objects</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a configuration for categorizing patients with special handling for pediatric cases.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    columns : list or pandas.Index</span>
<span class="sd">        The column names available in the dataset. Used to determine which age format is present.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing special category configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the class instance and return its parameter dictionary</span>
    <span class="n">params_obj</span> <span class="o">=</span> <span class="n">SpecialCategoryParams</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params_obj</span><span class="o">.</span><span class="n">get_params_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.create_temporal_splits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_temporal_splits</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_train</span><span class="p">,</span> <span class="n">start_valid</span><span class="p">,</span> <span class="n">start_test</span><span class="p">,</span> <span class="n">end_test</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">patient_id</span><span class="o">=</span><span class="s1">&#39;mrn&#39;</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;encounter&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Split dataset into temporal train/validation/test sets.</p>
<p>Creates temporal data splits using primary datetime column and optional snapshot dates.
Handles patient ID grouping if present to prevent data leakage.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_train</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training start (inclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_valid</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation start (inclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test start (inclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test end (exclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>col_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Primary datetime column for splitting</p>
              </div>
            </td>
            <td>
                  <code>&#39;arrival_datetime&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for patient identifier (default: 'mrn')</p>
              </div>
            </td>
            <td>
                  <code>&#39;mrn&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for visit identifier (default: 'encounter')</p>
              </div>
            </td>
            <td>
                  <code>&#39;encounter&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(train_df, valid_df, test_df) Split dataframes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_temporal_splits</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">start_train</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_valid</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_test</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">end_test</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mrn&quot;</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;encounter&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split dataset into temporal train/validation/test sets.</span>

<span class="sd">    Creates temporal data splits using primary datetime column and optional snapshot dates.</span>
<span class="sd">    Handles patient ID grouping if present to prevent data leakage.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Input dataframe</span>
<span class="sd">        start_train: Training start (inclusive)</span>
<span class="sd">        start_valid: Validation start (inclusive)</span>
<span class="sd">        start_test: Test start (inclusive)</span>
<span class="sd">        end_test: Test end (exclusive)</span>
<span class="sd">        col_name: Primary datetime column for splitting</span>
<span class="sd">        patient_id: Column name for patient identifier (default: &#39;mrn&#39;)</span>
<span class="sd">        visit_col: Column name for visit identifier (default: &#39;encounter&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (train_df, valid_df, test_df) Split dataframes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_date_value</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert timestamp or date column to date, handling both types&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">series</span>

    <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">set_assignment</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">assign_patient_ids</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">start_train</span><span class="p">,</span>
            <span class="n">start_valid</span><span class="p">,</span>
            <span class="n">start_test</span><span class="p">,</span>
            <span class="n">end_test</span><span class="p">,</span>
            <span class="n">col_name</span><span class="p">,</span>
            <span class="n">patient_id</span><span class="p">,</span>
            <span class="n">visit_col</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patient_sets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">set_assignment</span><span class="p">[</span><span class="n">set_assignment</span><span class="o">.</span><span class="n">training_validation_test</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="n">splits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">set_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">start_train</span><span class="p">,</span> <span class="n">start_valid</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">start_valid</span><span class="p">,</span> <span class="n">start_test</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">start_test</span><span class="p">,</span> <span class="n">end_test</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">end</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;snapshot_date&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">df</span><span class="p">[</span><span class="n">patient_id</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">patient_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">])</span>

        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split sizes: </span><span class="si">{</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">splits</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.create_yta_filters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create specialty filters for categorizing patients by specialty and age group.</p>
<p>This function generates a dictionary of filters based on specialty categories,
with special handling for pediatric patients. It uses the SpecialCategoryParams
class to determine which specialties correspond to pediatric care.</p>
<h5 id="patientflow.prepare.create_yta_filters--parameters">Parameters:</h5>
<p>df : pandas.DataFrame
    DataFrame containing patient data with columns that include either
    'age_on_arrival' or 'age_group' for pediatric classification</p>
<h5 id="patientflow.prepare.create_yta_filters--returns">Returns:</h5>
<p>dict
    A dictionary mapping specialty names to filter configurations.
    Each configuration contains:
    - For pediatric specialty: {"is_child": True}
    - For other specialties: {"specialty": specialty_name, "is_child": False}</p>
<h5 id="patientflow.prepare.create_yta_filters--examples">Examples:</h5>
<blockquote>
<blockquote>
<blockquote>
<p>df = pd.DataFrame({'patient_id': [1, 2], 'age_on_arrival': [10, 40]})
filters = create_yta_filters(df)
print(filters['paediatric'])
{'is_child': True}
print(filters['medical'])
{'specialty': 'medical', 'is_child': False}</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create specialty filters for categorizing patients by specialty and age group.</span>

<span class="sd">    This function generates a dictionary of filters based on specialty categories,</span>
<span class="sd">    with special handling for pediatric patients. It uses the SpecialCategoryParams</span>
<span class="sd">    class to determine which specialties correspond to pediatric care.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data with columns that include either</span>
<span class="sd">        &#39;age_on_arrival&#39; or &#39;age_group&#39; for pediatric classification</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping specialty names to filter configurations.</span>
<span class="sd">        Each configuration contains:</span>
<span class="sd">        - For pediatric specialty: {&quot;is_child&quot;: True}</span>
<span class="sd">        - For other specialties: {&quot;specialty&quot;: specialty_name, &quot;is_child&quot;: False}</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;patient_id&#39;: [1, 2], &#39;age_on_arrival&#39;: [10, 40]})</span>
<span class="sd">    &gt;&gt;&gt; filters = create_yta_filters(df)</span>
<span class="sd">    &gt;&gt;&gt; print(filters[&#39;paediatric&#39;])</span>
<span class="sd">    {&#39;is_child&#39;: True}</span>
<span class="sd">    &gt;&gt;&gt; print(filters[&#39;medical&#39;])</span>
<span class="sd">    {&#39;specialty&#39;: &#39;medical&#39;, &#39;is_child&#39;: False}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the special category parameters using the picklable implementation</span>
    <span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Extract necessary data from the special_params</span>
    <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span>

    <span class="c1"># Create the specialty_filters dictionary</span>
    <span class="n">specialty_filters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">specialty</span><span class="p">,</span> <span class="n">is_paediatric_flag</span> <span class="ow">in</span> <span class="n">special_category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_paediatric_flag</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="c1"># For the paediatric specialty, set `is_child` to True</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For other specialties, set `is_child` to False</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="n">specialty</span><span class="p">,</span> <span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">specialty_filters</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.prepare_for_inference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_for_inference</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="s1">&#39;snapshot_id&#39;</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;visit_number&#39;</span><span class="p">,</span> <span class="s1">&#39;snapshot_date&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction_time&#39;</span><span class="p">],</span> <span class="n">eval_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prediction_time&#39;</span><span class="p">,</span> <span class="s1">&#39;consultation_sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;final_sequence&#39;</span><span class="p">],</span> <span class="n">exclude_from_training_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;visit_number&#39;</span><span class="p">,</span> <span class="s1">&#39;snapshot_date&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction_time&#39;</span><span class="p">])</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Load a trained model and prepare data for making predictions.</p>
<p>This function retrieves a trained model from a specified file path and,
if requested, prepares the data required for inference. The data can be
provided either as a DataFrame or as a file path to a CSV file. The function
allows filtering and processing of the data to match the model's requirements.
If available, it will use the calibrated pipeline instead of the regular pipeline.</p>
<h5 id="patientflow.prepare.prepare_for_inference--parameters">Parameters</h5>
<p>model_file_path : str
    The file path where the trained model is saved.
model_name : str
    The name of the model to be loaded.
prediction_time : str, optional
    The time at which predictions are to be made. This is used to filter
    the data for the relevant time snapshot.
model_only : bool, optional
    If True, only the model is returned. If False, both the prepared data
    and the model are returned. Default is False.
df : pandas.DataFrame, optional
    The DataFrame containing the data to be used for inference. If not
    provided, data_path must be specified.
data_path : str, optional
    The file path to a CSV file containing the data to be used for inference.
    Ignored if <code>df</code> is provided.
single_snapshot_per_visit : bool, optional
    If True, only a single snapshot per visit is considered. Default is True.
index_column : str, optional
    The name of the index column in the data. Default is 'snapshot_id'.
sort_columns : list of str, optional
    The columns to sort the data by. Default is ["visit_number", "snapshot_date", "prediction_time"].
eval_columns : list of str, optional
    The columns that require literal evaluation of their content when loading from csv.
    Default is ["prediction_time", "consultation_sequence", "final_sequence"].
exclude_from_training_data : list of str, optional
    The columns to be excluded from the training data. Default is ["visit_number", "snapshot_date", "prediction_time"].</p>
<h5 id="patientflow.prepare.prepare_for_inference--returns">Returns</h5>
<p>model : object
    The loaded model (calibrated pipeline if available, otherwise regular pipeline).
X_test : pandas.DataFrame, optional
    The features prepared for testing, returned only if model_only is False.
y_test : pandas.Series, optional
    The labels corresponding to X_test, returned only if model_only is False.</p>
<h5 id="patientflow.prepare.prepare_for_inference--raises">Raises</h5>
<p>KeyError
    If the 'training_validation_test' column is not found in the provided DataFrame.</p>
<h5 id="patientflow.prepare.prepare_for_inference--notes">Notes</h5>
<ul>
<li>Either <code>df</code> or <code>data_path</code> must be provided. If neither is provided or if <code>df</code>
  is empty, the function will print an error message and return None.</li>
<li>The function will automatically use a calibrated pipeline if one is available
  in the model, otherwise it will fall back to the regular pipeline.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_for_inference</span><span class="p">(</span>
    <span class="n">model_file_path</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">index_column</span><span class="o">=</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">,</span>
    <span class="n">sort_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_time&quot;</span><span class="p">],</span>
    <span class="n">eval_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;final_sequence&quot;</span><span class="p">],</span>
    <span class="n">exclude_from_training_data</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_time&quot;</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a trained model and prepare data for making predictions.</span>

<span class="sd">    This function retrieves a trained model from a specified file path and,</span>
<span class="sd">    if requested, prepares the data required for inference. The data can be</span>
<span class="sd">    provided either as a DataFrame or as a file path to a CSV file. The function</span>
<span class="sd">    allows filtering and processing of the data to match the model&#39;s requirements.</span>
<span class="sd">    If available, it will use the calibrated pipeline instead of the regular pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_file_path : str</span>
<span class="sd">        The file path where the trained model is saved.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        The name of the model to be loaded.</span>
<span class="sd">    prediction_time : str, optional</span>
<span class="sd">        The time at which predictions are to be made. This is used to filter</span>
<span class="sd">        the data for the relevant time snapshot.</span>
<span class="sd">    model_only : bool, optional</span>
<span class="sd">        If True, only the model is returned. If False, both the prepared data</span>
<span class="sd">        and the model are returned. Default is False.</span>
<span class="sd">    df : pandas.DataFrame, optional</span>
<span class="sd">        The DataFrame containing the data to be used for inference. If not</span>
<span class="sd">        provided, data_path must be specified.</span>
<span class="sd">    data_path : str, optional</span>
<span class="sd">        The file path to a CSV file containing the data to be used for inference.</span>
<span class="sd">        Ignored if `df` is provided.</span>
<span class="sd">    single_snapshot_per_visit : bool, optional</span>
<span class="sd">        If True, only a single snapshot per visit is considered. Default is True.</span>
<span class="sd">    index_column : str, optional</span>
<span class="sd">        The name of the index column in the data. Default is &#39;snapshot_id&#39;.</span>
<span class="sd">    sort_columns : list of str, optional</span>
<span class="sd">        The columns to sort the data by. Default is [&quot;visit_number&quot;, &quot;snapshot_date&quot;, &quot;prediction_time&quot;].</span>
<span class="sd">    eval_columns : list of str, optional</span>
<span class="sd">        The columns that require literal evaluation of their content when loading from csv.</span>
<span class="sd">        Default is [&quot;prediction_time&quot;, &quot;consultation_sequence&quot;, &quot;final_sequence&quot;].</span>
<span class="sd">    exclude_from_training_data : list of str, optional</span>
<span class="sd">        The columns to be excluded from the training data. Default is [&quot;visit_number&quot;, &quot;snapshot_date&quot;, &quot;prediction_time&quot;].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : object</span>
<span class="sd">        The loaded model (calibrated pipeline if available, otherwise regular pipeline).</span>
<span class="sd">    X_test : pandas.DataFrame, optional</span>
<span class="sd">        The features prepared for testing, returned only if model_only is False.</span>
<span class="sd">    y_test : pandas.Series, optional</span>
<span class="sd">        The labels corresponding to X_test, returned only if model_only is False.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    KeyError</span>
<span class="sd">        If the &#39;training_validation_test&#39; column is not found in the provided DataFrame.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Either `df` or `data_path` must be provided. If neither is provided or if `df`</span>
<span class="sd">      is empty, the function will print an error message and return None.</span>
<span class="sd">    - The function will automatically use a calibrated pipeline if one is available</span>
<span class="sd">      in the model, otherwise it will fall back to the regular pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># retrieve model trained for this time of day</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_saved_model</span><span class="p">(</span><span class="n">model_file_path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

    <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pipeline</span>

    <span class="k">if</span> <span class="n">model_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pipeline</span>

    <span class="k">if</span> <span class="n">data_path</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data_from_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">index_column</span><span class="p">,</span> <span class="n">sort_columns</span><span class="p">,</span> <span class="n">eval_columns</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please supply a dataset if not passing a data path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">training_validation_test</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;training_validation_test&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column training_validation_test not found in dataframe&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
        <span class="n">test_df</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="p">,</span>
        <span class="n">single_snapshot_per_visit</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pipeline</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.prepare_group_snapshot_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_group_snapshot_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepares a dictionary mapping snapshot dates to their corresponding snapshot indices.</p>
<p>Args:
df (pd.DataFrame): DataFrame containing at least a 'snapshot_date' column which represents the dates.
start_dt (datetime.date): Start date (optional)
end_dt (datetime.date): End date (optional)</p>
<p>Returns:
dict: A dictionary where keys are dates and values are arrays of indices corresponding to each date's snapshots.
A array can be empty if there are no snapshots associated with a date</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_group_snapshot_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares a dictionary mapping snapshot dates to their corresponding snapshot indices.</span>

<span class="sd">    Args:</span>
<span class="sd">    df (pd.DataFrame): DataFrame containing at least a &#39;snapshot_date&#39; column which represents the dates.</span>
<span class="sd">    start_dt (datetime.date): Start date (optional)</span>
<span class="sd">    end_dt (datetime.date): End date (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary where keys are dates and values are arrays of indices corresponding to each date&#39;s snapshots.</span>
<span class="sd">    A array can be empty if there are no snapshots associated with a date</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure &#39;snapshot_date&#39; is in the DataFrame</span>
    <span class="k">if</span> <span class="s2">&quot;snapshot_date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataFrame must include a &#39;snapshot_date&#39; column&quot;</span><span class="p">)</span>

    <span class="c1"># Filter DataFrame to date range if provided</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">start_dt</span> <span class="ow">and</span> <span class="n">end_dt</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_dt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end_dt</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># Group the DataFrame by &#39;snapshot_date&#39; and collect the indices for each group</span>
    <span class="n">snapshots_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">date</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># If start_dt and end_dt are specified, add any missing keys from prediction_dates</span>
    <span class="k">if</span> <span class="n">start_dt</span><span class="p">:</span>
        <span class="n">prediction_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prediction_dates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshots_dict</span><span class="p">:</span>
                <span class="n">snapshots_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">snapshots_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.prepare_patient_snapshots" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_patient_snapshots</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get snapshots of data at a specific prediction time with configurable visit and label columns.</p>
<h5 id="patientflow.prepare.prepare_patient_snapshots--parameters">Parameters:</h5>
<p>df : pandas.DataFrame
    Input DataFrame containing the data
prediction_time : str or datetime
    The specific prediction time to filter for
exclude_columns : list
    List of columns to exclude from the final DataFrame
single_snapshot_per_visit : bool, default=True
    Whether to select only one snapshot per visit. If True, visit_col must be provided.
visit_col : str, optional
    Name of the column containing visit identifiers. Required if single_snapshot_per_visit is True.
label_col : str, default="is_admitted"
    Name of the column containing the target labels</p>
<h5 id="patientflow.prepare.prepare_patient_snapshots--returns">Returns:</h5>
<p>Tuple[pandas.DataFrame, pandas.Series]
    A tuple containing:
    - DataFrame: Processed DataFrame with features
    - Series: Corresponding labels</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_patient_snapshots</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get snapshots of data at a specific prediction time with configurable visit and label columns.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing the data</span>
<span class="sd">    prediction_time : str or datetime</span>
<span class="sd">        The specific prediction time to filter for</span>
<span class="sd">    exclude_columns : list</span>
<span class="sd">        List of columns to exclude from the final DataFrame</span>
<span class="sd">    single_snapshot_per_visit : bool, default=True</span>
<span class="sd">        Whether to select only one snapshot per visit. If True, visit_col must be provided.</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of the column containing visit identifiers. Required if single_snapshot_per_visit is True.</span>
<span class="sd">    label_col : str, default=&quot;is_admitted&quot;</span>
<span class="sd">        Name of the column containing the target labels</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    Tuple[pandas.DataFrame, pandas.Series]</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - DataFrame: Processed DataFrame with features</span>
<span class="sd">        - Series: Corresponding labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">single_snapshot_per_visit</span> <span class="ow">and</span> <span class="n">visit_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;visit_col must be provided when single_snapshot_per_visit is True&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Filter by the time of day while keeping the original index</span>
    <span class="n">df_tod</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">single_snapshot_per_visit</span><span class="p">:</span>
        <span class="c1"># Select one row for each visit</span>
        <span class="n">df_single</span> <span class="o">=</span> <span class="n">select_one_snapshot_per_visit</span><span class="p">(</span><span class="n">df_tod</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">)</span>
        <span class="c1"># Create label array with the same index</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_single</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Drop specified columns and ensure we do not reset the index</span>
        <span class="n">df_single</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_single</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Directly modify df_tod without resetting the index</span>
        <span class="n">df_tod</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;random_number&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">exclude_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_tod</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_tod</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.train" class="doc doc-heading">
            <code>train</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.train.classifiers" class="doc doc-heading">
            <code>classifiers</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.chronological_cross_validation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">chronological_cross_validation</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform time series cross-validation with multiple metrics.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">chronological_cross_validation</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">n_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform time series cross-validation with multiple metrics.&quot;&quot;&quot;</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">)</span>

    <span class="n">train_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FoldResults</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FoldResults</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">valid_preds</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">train_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">))</span>
        <span class="n">valid_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">valid_preds</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FoldResults</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics_list</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">FoldResults</span><span class="o">.</span><span class="n">__dataclass_fields__</span>
        <span class="p">}</span>

    <span class="n">train_means</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">train_metrics</span><span class="p">)</span>
    <span class="n">valid_means</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;train_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">train_means</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="o">|</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;valid_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">valid_means</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.create_balance_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_balance_info</span><span class="p">(</span><span class="n">is_balanced</span><span class="p">,</span> <span class="n">original_size</span><span class="p">,</span> <span class="n">balanced_size</span><span class="p">,</span> <span class="n">original_positive_rate</span><span class="p">,</span> <span class="n">balanced_positive_rate</span><span class="p">,</span> <span class="n">majority_to_minority_ratio</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a dictionary with balance information.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_balance_info</span><span class="p">(</span>
    <span class="n">is_balanced</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">balanced_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">original_positive_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">balanced_positive_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">majority_to_minority_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a dictionary with balance information.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;is_balanced&quot;</span><span class="p">:</span> <span class="n">is_balanced</span><span class="p">,</span>
        <span class="s2">&quot;original_size&quot;</span><span class="p">:</span> <span class="n">original_size</span><span class="p">,</span>
        <span class="s2">&quot;balanced_size&quot;</span><span class="p">:</span> <span class="n">balanced_size</span><span class="p">,</span>
        <span class="s2">&quot;original_positive_rate&quot;</span><span class="p">:</span> <span class="n">original_positive_rate</span><span class="p">,</span>
        <span class="s2">&quot;balanced_positive_rate&quot;</span><span class="p">:</span> <span class="n">balanced_positive_rate</span><span class="p">,</span>
        <span class="s2">&quot;majority_to_minority_ratio&quot;</span><span class="p">:</span> <span class="n">majority_to_minority_ratio</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.create_column_transformer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_column_transformer</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a column transformer for a dataframe with dynamic column handling.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_column_transformer</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnTransformer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a column transformer for a dataframe with dynamic column handling.&quot;&quot;&quot;</span>
    <span class="n">transformers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">ordinal_mappings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ordinal_mappings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ordinal_mappings</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">col</span><span class="p">,</span>
                    <span class="n">OrdinalEncoder</span><span class="p">(</span>
                        <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">ordinal_mappings</span><span class="p">[</span><span class="n">col</span><span class="p">]],</span>
                        <span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;use_encoded_value&quot;</span><span class="p">,</span>
                        <span class="n">unknown_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="p">[</span><span class="n">col</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">):</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">col</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="p">[</span><span class="n">col</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.evaluate_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate model on test set.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">Series</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate model on test set.&quot;&quot;&quot;</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;test_auc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)),</span>
        <span class="s2">&quot;test_logloss&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)),</span>
        <span class="s2">&quot;test_auprc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.evaluate_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate multiple metrics for given predictions.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_predictions</span><span class="p">(</span>
    <span class="n">y_true</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FoldResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate multiple metrics for given predictions.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">FoldResults</span><span class="p">(</span>
        <span class="n">auc</span><span class="o">=</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="n">logloss</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="n">auprc</span><span class="o">=</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.get_dataset_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dataset_metadata</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get dataset sizes and class balances.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dataset_metadata</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">X_valid</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span>
    <span class="n">y_valid</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span>
    <span class="n">y_test</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get dataset sizes and class balances.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;train_valid_test_set_no&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;train_set_no&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
            <span class="s2">&quot;valid_set_no&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span>
            <span class="s2">&quot;test_set_no&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s2">&quot;train_valid_test_class_balance&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;y_train_class_balance&quot;</span><span class="p">:</span> <span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span>
            <span class="s2">&quot;y_valid_class_balance&quot;</span><span class="p">:</span> <span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y_valid</span><span class="p">),</span>
            <span class="s2">&quot;y_test_class_balance&quot;</span><span class="p">:</span> <span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.get_feature_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_feature_metadata</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Extract feature names and importances from pipeline.</p>
<h6 id="patientflow.train.classifiers.get_feature_metadata--parameters">Parameters</h6>
<p>pipeline : Pipeline
    Sklearn pipeline containing feature transformer and classifier</p>
<h6 id="patientflow.train.classifiers.get_feature_metadata--returns">Returns</h6>
<p>FeatureMetadata
    Dictionary containing feature names and their importance scores (if available)</p>
<h6 id="patientflow.train.classifiers.get_feature_metadata--raises">Raises</h6>
<p>AttributeError
    If the classifier doesn't support feature importance</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_feature_metadata</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureMetadata</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract feature names and importances from pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline : Pipeline</span>
<span class="sd">        Sklearn pipeline containing feature transformer and classifier</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FeatureMetadata</span>
<span class="sd">        Dictionary containing feature names and their importance scores (if available)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AttributeError</span>
<span class="sd">        If the classifier doesn&#39;t support feature importance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformed_cols</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
        <span class="s2">&quot;feature_transformer&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span>

    <span class="c1"># Try different common feature importance attributes</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;feature_importances_&quot;</span><span class="p">):</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;coef_&quot;</span><span class="p">):</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Classifier doesn&#39;t provide feature importance scores&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;feature_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">transformed_cols</span><span class="p">],</span>
        <span class="s2">&quot;feature_importances&quot;</span><span class="p">:</span> <span class="n">importances</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.initialise_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialise_model</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xgb_specific_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="s1">&#39;enable_categorical&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize a model with given hyperparameters.</p>
<h6 id="patientflow.train.classifiers.initialise_model--parameters">Parameters</h6>
<p>model_class : Type
    The classifier class to instantiate
params : Dict[str, Any]
    Model-specific parameters to set
xgb_specific_params : Dict[str, Any], optional
    XGBoost-specific default parameters</p>
<h6 id="patientflow.train.classifiers.initialise_model--returns">Returns</h6>
<p>Any
    Initialized model instance</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialise_model</span><span class="p">(</span>
    <span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">xgb_specific_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n_jobs&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="s2">&quot;logloss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enable_categorical&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a model with given hyperparameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_class : Type</span>
<span class="sd">        The classifier class to instantiate</span>
<span class="sd">    params : Dict[str, Any]</span>
<span class="sd">        Model-specific parameters to set</span>
<span class="sd">    xgb_specific_params : Dict[str, Any], optional</span>
<span class="sd">        XGBoost-specific default parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        Initialized model instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_class</span> <span class="o">==</span> <span class="n">XGBClassifier</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">xgb_specific_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.train_classifier" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_classifier</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">valid_visits</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="n">XGBClassifier</span><span class="p">,</span> <span class="n">use_balanced_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">calibrate_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calibration_method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train a single model including data preparation and balancing.</p>
<h6 id="patientflow.train.classifiers.train_classifier--parameters">Parameters:</h6>
<p>train_visits : DataFrame
    Training visits dataset
valid_visits : DataFrame
    Validation visits dataset
test_visits : DataFrame
    Test visits dataset
prediction_time : Tuple[int, int]
    The prediction time point to use
exclude_from_training_data : List[str]
    Columns to exclude from training
grid : Dict[str, List[Any]]
    Parameter grid for hyperparameter tuning
ordinal_mappings : Dict[str, List[Any]]
    Mappings for ordinal categorical features
visit_col : str, optional
    Name of the visit column. Required if single_snapshot_per_visit is True.
model_class : Type, optional
    The classifier class to use. Must be sklearn-compatible with fit() and predict_proba().
    Defaults to XGBClassifier.
use_balanced_training : bool, default=True
    Whether to use balanced training data
majority_to_minority_ratio : float, default=1.0
    Ratio of majority to minority class samples
calibrate_probabilities : bool, default=True
    Whether to apply probability calibration to the best model
calibration_method : str, default='sigmoid'
    Method for probability calibration ('isotonic' or 'sigmoid')
single_snapshot_per_visit : bool, default=True
    Whether to select only one snapshot per visit. If True, visit_col must be provided.</p>
<h6 id="patientflow.train.classifiers.train_classifier--returns">Returns:</h6>
<p>TrainedClassifier
    Trained model, including metrics, and feature information</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_classifier</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">valid_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">exclude_from_training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">ordinal_mappings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">,</span>
    <span class="n">use_balanced_training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">majority_to_minority_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">calibrate_probabilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">calibration_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">single_snapshot_per_visit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainedClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a single model including data preparation and balancing.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    train_visits : DataFrame</span>
<span class="sd">        Training visits dataset</span>
<span class="sd">    valid_visits : DataFrame</span>
<span class="sd">        Validation visits dataset</span>
<span class="sd">    test_visits : DataFrame</span>
<span class="sd">        Test visits dataset</span>
<span class="sd">    prediction_time : Tuple[int, int]</span>
<span class="sd">        The prediction time point to use</span>
<span class="sd">    exclude_from_training_data : List[str]</span>
<span class="sd">        Columns to exclude from training</span>
<span class="sd">    grid : Dict[str, List[Any]]</span>
<span class="sd">        Parameter grid for hyperparameter tuning</span>
<span class="sd">    ordinal_mappings : Dict[str, List[Any]]</span>
<span class="sd">        Mappings for ordinal categorical features</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of the visit column. Required if single_snapshot_per_visit is True.</span>
<span class="sd">    model_class : Type, optional</span>
<span class="sd">        The classifier class to use. Must be sklearn-compatible with fit() and predict_proba().</span>
<span class="sd">        Defaults to XGBClassifier.</span>
<span class="sd">    use_balanced_training : bool, default=True</span>
<span class="sd">        Whether to use balanced training data</span>
<span class="sd">    majority_to_minority_ratio : float, default=1.0</span>
<span class="sd">        Ratio of majority to minority class samples</span>
<span class="sd">    calibrate_probabilities : bool, default=True</span>
<span class="sd">        Whether to apply probability calibration to the best model</span>
<span class="sd">    calibration_method : str, default=&#39;sigmoid&#39;</span>
<span class="sd">        Method for probability calibration (&#39;isotonic&#39; or &#39;sigmoid&#39;)</span>
<span class="sd">    single_snapshot_per_visit : bool, default=True</span>
<span class="sd">        Whether to select only one snapshot per visit. If True, visit_col must be provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    TrainedClassifier</span>
<span class="sd">        Trained model, including metrics, and feature information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">single_snapshot_per_visit</span> <span class="ow">and</span> <span class="n">visit_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;visit_col must be provided when single_snapshot_per_visit is True&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get snapshots for each set</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
        <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="n">single_snapshot_per_visit</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
        <span class="n">valid_visits</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
        <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="n">single_snapshot_per_visit</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
        <span class="n">test_visits</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
        <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="n">single_snapshot_per_visit</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get dataset metadata before any balancing</span>
    <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="n">get_dataset_metadata</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">y_test</span>
    <span class="p">)</span>

    <span class="c1"># Store original size and positive rate before any balancing</span>
    <span class="n">original_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">original_positive_rate</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">use_balanced_training</span><span class="p">:</span>
        <span class="n">pos_indices</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">neg_indices</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">n_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_indices</span><span class="p">)</span>
        <span class="n">n_neg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_pos</span> <span class="o">*</span> <span class="n">majority_to_minority_ratio</span><span class="p">)</span>

        <span class="n">neg_indices_sampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">neg_indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">n_neg</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_indices</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">train_balanced_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos_indices</span><span class="p">,</span> <span class="n">neg_indices_sampled</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">train_balanced_indices</span><span class="p">)</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_balanced_indices</span><span class="p">]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_balanced_indices</span><span class="p">]</span>

    <span class="c1"># Create balance info after any balancing is done</span>
    <span class="n">balance_info</span> <span class="o">=</span> <span class="n">create_balance_info</span><span class="p">(</span>
        <span class="n">is_balanced</span><span class="o">=</span><span class="n">use_balanced_training</span><span class="p">,</span>
        <span class="n">original_size</span><span class="o">=</span><span class="n">original_size</span><span class="p">,</span>
        <span class="n">balanced_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
        <span class="n">original_positive_rate</span><span class="o">=</span><span class="n">original_positive_rate</span><span class="p">,</span>
        <span class="n">balanced_positive_rate</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="n">majority_to_minority_ratio</span>
        <span class="k">if</span> <span class="n">use_balanced_training</span>
        <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Initialize best training results with default values</span>
    <span class="n">best_training</span> <span class="o">=</span> <span class="n">TrainingResults</span><span class="p">(</span>
        <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">balance_info</span><span class="o">=</span><span class="n">balance_info</span><span class="p">,</span>
        <span class="c1"># Other fields will use their default empty dictionaries</span>
    <span class="p">)</span>

    <span class="c1"># Initialize best model container</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">TrainedClassifier</span><span class="p">(</span>
        <span class="n">training_results</span><span class="o">=</span><span class="n">best_training</span><span class="p">,</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">calibrated_pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">trials_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">HyperParameterTrial</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_logloss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">ParameterGrid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="c1"># Initialize model based on provided class</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">initialise_model</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">column_transformer</span> <span class="o">=</span> <span class="n">create_column_transformer</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">)</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
            <span class="p">[(</span><span class="s2">&quot;feature_transformer&quot;</span><span class="p">,</span> <span class="n">column_transformer</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">cv_results</span> <span class="o">=</span> <span class="n">chronological_cross_validation</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="c1"># Store trial results</span>
        <span class="n">trials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">HyperParameterTrial</span><span class="p">(</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Make a copy to ensure immutability</span>
                <span class="n">cv_results</span><span class="o">=</span><span class="n">cv_results</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cv_results</span><span class="p">[</span><span class="s2">&quot;valid_logloss&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_logloss</span><span class="p">:</span>
            <span class="n">best_logloss</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s2">&quot;valid_logloss&quot;</span><span class="p">]</span>
            <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>

            <span class="c1"># Get feature metadata if available</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">feature_metadata</span> <span class="o">=</span> <span class="n">get_feature_metadata</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
                <span class="n">has_feature_importance</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
                <span class="n">feature_metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;feature_names&quot;</span><span class="p">:</span> <span class="n">column_transformer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;feature_importances&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
                <span class="n">has_feature_importance</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Update training results</span>
            <span class="n">best_training</span><span class="o">.</span><span class="n">training_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv_trials&quot;</span><span class="p">:</span> <span class="n">trials_list</span><span class="p">,</span>
                <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">feature_metadata</span><span class="p">[</span><span class="s2">&quot;feature_names&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;importances&quot;</span><span class="p">:</span> <span class="n">feature_metadata</span><span class="p">[</span><span class="s2">&quot;feature_importances&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;has_importance_values&quot;</span><span class="p">:</span> <span class="n">has_feature_importance</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;dataset_info&quot;</span><span class="p">:</span> <span class="n">dataset_metadata</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">calibrate_probabilities</span><span class="p">:</span>
                <span class="n">best_training</span><span class="o">.</span><span class="n">calibration_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">calibration_method</span><span class="p">}</span>

    <span class="c1"># Apply probability calibration to the best model if requested</span>
    <span class="k">if</span> <span class="n">calibrate_probabilities</span> <span class="ow">and</span> <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">best_feature_transformer</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
            <span class="s2">&quot;feature_transformer&quot;</span>
        <span class="p">]</span>
        <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span>

        <span class="n">X_valid_transformed</span> <span class="o">=</span> <span class="n">best_feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>

        <span class="n">calibrated_classifier</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
            <span class="n">estimator</span><span class="o">=</span><span class="n">best_classifier</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">calibration_method</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">calibrated_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_valid_transformed</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>

        <span class="n">calibrated_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;feature_transformer&quot;</span><span class="p">,</span> <span class="n">best_feature_transformer</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">calibrated_classifier</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">best_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="o">=</span> <span class="n">calibrated_pipeline</span>
        <span class="n">best_training</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">calibrated_pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_training</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">best_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.train_multiple_classifiers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_multiple_classifiers</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">valid_visits</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;visit_number&#39;</span><span class="p">,</span> <span class="n">calibrate_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calibration_method</span><span class="o">=</span><span class="s1">&#39;isotonic&#39;</span><span class="p">,</span> <span class="n">use_balanced_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train admission prediction models for multiple prediction times.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_multiple_classifiers</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">valid_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">exclude_from_training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">ordinal_mappings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
    <span class="n">calibrate_probabilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">calibration_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;isotonic&quot;</span><span class="p">,</span>
    <span class="n">use_balanced_training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">majority_to_minority_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train admission prediction models for multiple prediction times.&quot;&quot;&quot;</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">prediction_time</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing: </span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

        <span class="c1"># Train model with the new simplified interface</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
            <span class="n">train_visits</span><span class="p">,</span>
            <span class="n">valid_visits</span><span class="p">,</span>
            <span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">grid</span><span class="p">,</span>
            <span class="n">ordinal_mappings</span><span class="p">,</span>
            <span class="n">visit_col</span><span class="p">,</span>
            <span class="n">use_balanced_training</span><span class="o">=</span><span class="n">use_balanced_training</span><span class="p">,</span>
            <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="n">majority_to_minority_ratio</span><span class="p">,</span>
            <span class="n">calibrate_probabilities</span><span class="o">=</span><span class="n">calibrate_probabilities</span><span class="p">,</span>
            <span class="n">calibration_method</span><span class="o">=</span><span class="n">calibration_method</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">trained_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_model</span>

    <span class="k">return</span> <span class="n">trained_models</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.emergency_demand" class="doc doc-heading">
            <code>emergency_demand</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.emergency_demand.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">data_folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main entry point for training patient flow models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_folder_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of data folder</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">data_folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point for training patient flow models.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_folder_name (str, optional): Name of data folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse arguments if not provided</span>
    <span class="k">if</span> <span class="n">data_folder_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
        <span class="n">data_folder_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data_folder_name</span> <span class="k">if</span> <span class="n">data_folder_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">data_folder_name</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data from folder: </span><span class="si">{</span><span class="n">data_folder_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">project_root</span> <span class="o">=</span> <span class="n">set_project_root</span><span class="p">()</span>

    <span class="c1"># Set file locations</span>
    <span class="n">data_file_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">,</span> <span class="n">config_path</span> <span class="o">=</span> <span class="n">set_file_paths</span><span class="p">(</span>
        <span class="n">project_root</span><span class="o">=</span><span class="n">project_root</span><span class="p">,</span>
        <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">train_dttm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_folder_name</span><span class="o">=</span><span class="n">data_folder_name</span><span class="p">,</span>
        <span class="n">config_file</span><span class="o">=</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Load parameters</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config_file</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

    <span class="c1"># Extract parameters</span>
    <span class="n">prediction_times</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_times&quot;</span><span class="p">]</span>
    <span class="n">start_training_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;start_training_set&quot;</span><span class="p">]</span>
    <span class="n">start_validation_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;start_validation_set&quot;</span><span class="p">]</span>
    <span class="n">start_test_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;start_test_set&quot;</span><span class="p">]</span>
    <span class="n">end_test_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;end_test_set&quot;</span><span class="p">]</span>
    <span class="n">prediction_window</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_window&quot;</span><span class="p">]</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">])</span>
    <span class="n">yta_time_interval</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;yta_time_interval&quot;</span><span class="p">]</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span>

    <span class="c1"># Load data</span>
    <span class="n">ed_visits</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
        <span class="n">data_file_path</span><span class="o">=</span><span class="n">data_file_path</span><span class="p">,</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;ed_visits.csv&quot;</span><span class="p">,</span>
        <span class="n">index_column</span><span class="o">=</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">,</span>
        <span class="n">sort_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_time&quot;</span><span class="p">],</span>
        <span class="n">eval_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;final_sequence&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">inpatient_arrivals</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
        <span class="n">data_file_path</span><span class="o">=</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;inpatient_arrivals.csv&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create snapshot date</span>
    <span class="n">ed_visits</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ed_visits</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Set up model parameters</span>
    <span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="s2">&quot;subsample&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">],</span> <span class="s2">&quot;colsample_bytree&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">]}</span>

    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;specialty&quot;</span><span class="p">,</span>
        <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_sequence&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">ordinal_mappings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;0-17&quot;</span><span class="p">,</span>
            <span class="s2">&quot;18-24&quot;</span><span class="p">,</span>
            <span class="s2">&quot;25-34&quot;</span><span class="p">,</span>
            <span class="s2">&quot;35-44&quot;</span><span class="p">,</span>
            <span class="s2">&quot;45-54&quot;</span><span class="p">,</span>
            <span class="s2">&quot;55-64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;65-74&quot;</span><span class="p">,</span>
            <span class="s2">&quot;75-102&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latest_acvpu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">],</span>
        <span class="s2">&quot;latest_obs_manchester_triage_acuity&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Yellow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Orange&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Red&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latest_obs_objective_pain_score&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Nil&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Mild&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Moderate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Severe</span><span class="se">\\</span><span class="s2">E</span><span class="se">\\</span><span class="s2">Very Severe&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latest_obs_level_of_consciousness&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">specialties</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;surgical&quot;</span><span class="p">,</span> <span class="s2">&quot;haem/onc&quot;</span><span class="p">,</span> <span class="s2">&quot;medical&quot;</span><span class="p">,</span> <span class="s2">&quot;paediatric&quot;</span><span class="p">]</span>
    <span class="n">cdf_cut_points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
    <span class="n">curve_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="c1"># Call train_all_models with prepared parameters</span>
    <span class="n">train_all_models</span><span class="p">(</span>
        <span class="n">visits</span><span class="o">=</span><span class="n">ed_visits</span><span class="p">,</span>
        <span class="n">start_training_set</span><span class="o">=</span><span class="n">start_training_set</span><span class="p">,</span>
        <span class="n">start_validation_set</span><span class="o">=</span><span class="n">start_validation_set</span><span class="p">,</span>
        <span class="n">start_test_set</span><span class="o">=</span><span class="n">start_test_set</span><span class="p">,</span>
        <span class="n">end_test_set</span><span class="o">=</span><span class="n">end_test_set</span><span class="p">,</span>
        <span class="n">yta</span><span class="o">=</span><span class="n">inpatient_arrivals</span><span class="p">,</span>
        <span class="n">model_file_path</span><span class="o">=</span><span class="n">model_file_path</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">curve_params</span><span class="o">=</span><span class="n">curve_params</span><span class="p">,</span>
        <span class="n">grid_params</span><span class="o">=</span><span class="n">grid_params</span><span class="p">,</span>
        <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span>
        <span class="n">ordinal_mappings</span><span class="o">=</span><span class="n">ordinal_mappings</span><span class="p">,</span>
        <span class="n">specialties</span><span class="o">=</span><span class="n">specialties</span><span class="p">,</span>
        <span class="n">cdf_cut_points</span><span class="o">=</span><span class="n">cdf_cut_points</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.emergency_demand.test_real_time_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_real_time_predictions</span><span class="p">(</span><span class="n">visits</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">specialties</span><span class="p">,</span> <span class="n">cdf_cut_points</span><span class="p">,</span> <span class="n">curve_params</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test real-time predictions by selecting a random sample from the visits dataset
and generating predictions using the trained models.</p>
<h6 id="patientflow.train.emergency_demand.test_real_time_predictions--parameters">Parameters</h6>
<p>visits : pd.DataFrame
    DataFrame containing visit data with columns including 'prediction_time',
    'snapshot_date', and other required features for predictions.
models : Tuple[Dict[str, TrainedClassifier], SequencePredictor, WeightedPoissonPredictor]
    Tuple containing:
    - trained_classifiers: TrainedClassifier containing admission predictions
    - spec_model: SequencePredictor for specialty predictions
    - yet_to_arrive_model: WeightedPoissonPredictor for yet-to-arrive predictions
prediction_window : int
    Size of the prediction window in minutes for which to generate forecasts.
specialties : list[str]
    List of specialty names to generate predictions for (e.g., ['surgical',
    'medical', 'paediatric']).
cdf_cut_points : list[float]
    List of probability thresholds for cumulative distribution function
    cut points (e.g., [0.9, 0.7]).
curve_params : tuple[float, float, float, float]
    Parameters (x1, y1, x2, y2) defining the curve used for predictions.
random_seed : int
    Random seed for reproducible sampling of test cases.</p>
<h6 id="patientflow.train.emergency_demand.test_real_time_predictions--returns">Returns</h6>
<p>dict
    Dictionary containing:
    - 'prediction_time': str, The time point for which predictions were made
    - 'prediction_date': str, The date for which predictions were made
    - 'realtime_preds': dict, The generated predictions for the sample</p>
<h6 id="patientflow.train.emergency_demand.test_real_time_predictions--raises">Raises</h6>
<p>Exception
    If real-time inference fails, with detailed error message printed before
    system exit.</p>
<h6 id="patientflow.train.emergency_demand.test_real_time_predictions--notes">Notes</h6>
<p>The function selects a single random row from the visits DataFrame and
generates predictions for that specific time point using all provided models.
The predictions are made using the create_predictions() function with the
specified parameters.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_real_time_predictions</span><span class="p">(</span>
    <span class="n">visits</span><span class="p">,</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span> <span class="n">SequencePredictor</span><span class="p">,</span> <span class="n">WeightedPoissonPredictor</span>
    <span class="p">],</span>
    <span class="n">prediction_window</span><span class="p">,</span>
    <span class="n">specialties</span><span class="p">,</span>
    <span class="n">cdf_cut_points</span><span class="p">,</span>
    <span class="n">curve_params</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test real-time predictions by selecting a random sample from the visits dataset</span>
<span class="sd">    and generating predictions using the trained models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    visits : pd.DataFrame</span>
<span class="sd">        DataFrame containing visit data with columns including &#39;prediction_time&#39;,</span>
<span class="sd">        &#39;snapshot_date&#39;, and other required features for predictions.</span>
<span class="sd">    models : Tuple[Dict[str, TrainedClassifier], SequencePredictor, WeightedPoissonPredictor]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - trained_classifiers: TrainedClassifier containing admission predictions</span>
<span class="sd">        - spec_model: SequencePredictor for specialty predictions</span>
<span class="sd">        - yet_to_arrive_model: WeightedPoissonPredictor for yet-to-arrive predictions</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Size of the prediction window in minutes for which to generate forecasts.</span>
<span class="sd">    specialties : list[str]</span>
<span class="sd">        List of specialty names to generate predictions for (e.g., [&#39;surgical&#39;,</span>
<span class="sd">        &#39;medical&#39;, &#39;paediatric&#39;]).</span>
<span class="sd">    cdf_cut_points : list[float]</span>
<span class="sd">        List of probability thresholds for cumulative distribution function</span>
<span class="sd">        cut points (e.g., [0.9, 0.7]).</span>
<span class="sd">    curve_params : tuple[float, float, float, float]</span>
<span class="sd">        Parameters (x1, y1, x2, y2) defining the curve used for predictions.</span>
<span class="sd">    random_seed : int</span>
<span class="sd">        Random seed for reproducible sampling of test cases.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">        - &#39;prediction_time&#39;: str, The time point for which predictions were made</span>
<span class="sd">        - &#39;prediction_date&#39;: str, The date for which predictions were made</span>
<span class="sd">        - &#39;realtime_preds&#39;: dict, The generated predictions for the sample</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If real-time inference fails, with detailed error message printed before</span>
<span class="sd">        system exit.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function selects a single random row from the visits DataFrame and</span>
<span class="sd">    generates predictions for that specific time point using all provided models.</span>
<span class="sd">    The predictions are made using the create_predictions() function with the</span>
<span class="sd">    specified parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select random test set row</span>
    <span class="n">random_row</span> <span class="o">=</span> <span class="n">visits</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">random_row</span><span class="o">.</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">prediction_date</span> <span class="o">=</span> <span class="n">random_row</span><span class="o">.</span><span class="n">snapshot_date</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get prediction snapshots</span>
    <span class="n">prediction_snapshots</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span>
        <span class="p">(</span><span class="n">visits</span><span class="o">.</span><span class="n">prediction_time</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">visits</span><span class="o">.</span><span class="n">snapshot_date</span> <span class="o">==</span> <span class="n">prediction_date</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">trained_classifiers</span><span class="p">,</span> <span class="n">spec_model</span><span class="p">,</span> <span class="n">yet_to_arrive_model</span> <span class="o">=</span> <span class="n">models</span>

    <span class="c1"># Find the model matching the required prediction time</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="n">trained_classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">:</span>
            <span class="n">classifier</span> <span class="o">=</span> <span class="n">trained_model</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">classifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model found for prediction time </span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">curve_params</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">create_predictions</span><span class="p">(</span>
            <span class="n">models</span><span class="o">=</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">spec_model</span><span class="p">,</span> <span class="n">yet_to_arrive_model</span><span class="p">),</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">prediction_snapshots</span><span class="o">=</span><span class="n">prediction_snapshots</span><span class="p">,</span>
            <span class="n">specialties</span><span class="o">=</span><span class="n">specialties</span><span class="p">,</span>
            <span class="n">prediction_window_hrs</span><span class="o">=</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
            <span class="n">cdf_cut_points</span><span class="o">=</span><span class="n">cdf_cut_points</span><span class="p">,</span>
            <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span>
            <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
            <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span>
            <span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real-time inference ran correctly&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real-time inference failed due to this error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.emergency_demand.train_all_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_all_models</span><span class="p">(</span><span class="n">visits</span><span class="p">,</span> <span class="n">start_training_set</span><span class="p">,</span> <span class="n">start_validation_set</span><span class="p">,</span> <span class="n">start_test_set</span><span class="p">,</span> <span class="n">end_test_set</span><span class="p">,</span> <span class="n">yta</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;visit_number&#39;</span><span class="p">,</span> <span class="n">specialties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cdf_cut_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_models</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_realtime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train and evaluate patient flow models.</p>
<h6 id="patientflow.train.emergency_demand.train_all_models--parameters">Parameters</h6>
<p>visits : pd.DataFrame
    DataFrame containing visit data.
yta : pd.DataFrame
    DataFrame containing yet-to-arrive data.
prediction_times : list
    List of times for making predictions.
prediction_window : int
    Prediction window size in minutes.
yta_time_interval : int
    Interval size for yet-to-arrive predictions in minutes.
epsilon : float
    Epsilon parameter for model training.
grid_params : dict
    Hyperparameter grid for model training.
exclude_columns : list
    Columns to exclude during training.
ordinal_mappings : dict
    Ordinal variable mappings for categorical features.
random_seed : int
    Random seed for reproducibility.
visit_col : str, optional
    Name of column in dataset that is used to identify a hospital visit (eg visit_number, csn).
specialties : list, optional
    List of specialties to consider. Required if test_realtime is True.
cdf_cut_points : list, optional
    CDF cut points for predictions. Required if test_realtime is True.
curve_params : tuple, optional
    Curve parameters (x1, y1, x2, y2). Required if test_realtime is True.
model_file_path : Path, optional
    Path to save trained models. Required if save_models is True.
save_models : bool, optional
    Whether to save the trained models to disk. Defaults to True.
test_realtime : bool, optional
    Whether to run real-time prediction tests. Defaults to True.</p>
<h6 id="patientflow.train.emergency_demand.train_all_models--returns">Returns</h6>
<p>None</p>
<h6 id="patientflow.train.emergency_demand.train_all_models--raises">Raises</h6>
<p>ValueError
    If save_models is True but model_file_path is not provided,
    or if test_realtime is True but any of specialties, cdf_cut_points, or curve_params are not provided.</p>
<h6 id="patientflow.train.emergency_demand.train_all_models--notes">Notes</h6>
<p>The function generates model names internally:
- "admissions": "admissions"
- "specialty": "ed_specialty"
- "yet_to_arrive": f"yet_to_arrive_{int(prediction_window/60)}_hours"</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_all_models</span><span class="p">(</span>
    <span class="n">visits</span><span class="p">,</span>
    <span class="n">start_training_set</span><span class="p">,</span>
    <span class="n">start_validation_set</span><span class="p">,</span>
    <span class="n">start_test_set</span><span class="p">,</span>
    <span class="n">end_test_set</span><span class="p">,</span>
    <span class="n">yta</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">,</span>
    <span class="n">grid_params</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="p">,</span>
    <span class="n">ordinal_mappings</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
    <span class="n">specialties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cdf_cut_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_models</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">test_realtime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train and evaluate patient flow models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    visits : pd.DataFrame</span>
<span class="sd">        DataFrame containing visit data.</span>
<span class="sd">    yta : pd.DataFrame</span>
<span class="sd">        DataFrame containing yet-to-arrive data.</span>
<span class="sd">    prediction_times : list</span>
<span class="sd">        List of times for making predictions.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Prediction window size in minutes.</span>
<span class="sd">    yta_time_interval : int</span>
<span class="sd">        Interval size for yet-to-arrive predictions in minutes.</span>
<span class="sd">    epsilon : float</span>
<span class="sd">        Epsilon parameter for model training.</span>
<span class="sd">    grid_params : dict</span>
<span class="sd">        Hyperparameter grid for model training.</span>
<span class="sd">    exclude_columns : list</span>
<span class="sd">        Columns to exclude during training.</span>
<span class="sd">    ordinal_mappings : dict</span>
<span class="sd">        Ordinal variable mappings for categorical features.</span>
<span class="sd">    random_seed : int</span>
<span class="sd">        Random seed for reproducibility.</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of column in dataset that is used to identify a hospital visit (eg visit_number, csn).</span>
<span class="sd">    specialties : list, optional</span>
<span class="sd">        List of specialties to consider. Required if test_realtime is True.</span>
<span class="sd">    cdf_cut_points : list, optional</span>
<span class="sd">        CDF cut points for predictions. Required if test_realtime is True.</span>
<span class="sd">    curve_params : tuple, optional</span>
<span class="sd">        Curve parameters (x1, y1, x2, y2). Required if test_realtime is True.</span>
<span class="sd">    model_file_path : Path, optional</span>
<span class="sd">        Path to save trained models. Required if save_models is True.</span>
<span class="sd">    save_models : bool, optional</span>
<span class="sd">        Whether to save the trained models to disk. Defaults to True.</span>
<span class="sd">    test_realtime : bool, optional</span>
<span class="sd">        Whether to run real-time prediction tests. Defaults to True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If save_models is True but model_file_path is not provided,</span>
<span class="sd">        or if test_realtime is True but any of specialties, cdf_cut_points, or curve_params are not provided.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function generates model names internally:</span>
<span class="sd">    - &quot;admissions&quot;: &quot;admissions&quot;</span>
<span class="sd">    - &quot;specialty&quot;: &quot;ed_specialty&quot;</span>
<span class="sd">    - &quot;yet_to_arrive&quot;: f&quot;yet_to_arrive_{int(prediction_window/60)}_hours&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate parameters</span>
    <span class="k">if</span> <span class="n">save_models</span> <span class="ow">and</span> <span class="n">model_file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model_file_path must be provided when save_models is True&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_realtime</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">specialties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;specialties must be provided when test_realtime is True&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdf_cut_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;cdf_cut_points must be provided when test_realtime is True&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">curve_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;curve_params must be provided when test_realtime is True&quot;</span><span class="p">)</span>

    <span class="c1"># Set random seed</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="c1"># Define model names internally</span>
    <span class="n">model_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;admissions&quot;</span><span class="p">:</span> <span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="s2">&quot;ed_specialty&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;yet_to_arrive_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s2">_hours&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;arrival_datetime&quot;</span> <span class="ow">in</span> <span class="n">visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="s2">&quot;snapshot_date&quot;</span>

    <span class="n">train_visits</span><span class="p">,</span> <span class="n">valid_visits</span><span class="p">,</span> <span class="n">test_visits</span> <span class="o">=</span> <span class="n">create_temporal_splits</span><span class="p">(</span>
        <span class="n">visits</span><span class="p">,</span>
        <span class="n">start_training_set</span><span class="p">,</span>
        <span class="n">start_validation_set</span><span class="p">,</span>
        <span class="n">start_test_set</span><span class="p">,</span>
        <span class="n">end_test_set</span><span class="p">,</span>
        <span class="n">col_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">train_yta</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_temporal_splits</span><span class="p">(</span>
        <span class="n">yta</span><span class="p">[(</span><span class="o">~</span><span class="n">yta</span><span class="o">.</span><span class="n">specialty</span><span class="o">.</span><span class="n">isnull</span><span class="p">())],</span>
        <span class="n">start_training_set</span><span class="p">,</span>
        <span class="n">start_validation_set</span><span class="p">,</span>
        <span class="n">start_test_set</span><span class="p">,</span>
        <span class="n">end_test_set</span><span class="p">,</span>
        <span class="n">col_name</span><span class="o">=</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Use predicted_times from visits if not explicitly provided</span>
    <span class="k">if</span> <span class="n">prediction_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prediction_times</span> <span class="o">=</span> <span class="n">visits</span><span class="o">.</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1"># Train admission models</span>
    <span class="n">admission_models</span> <span class="o">=</span> <span class="n">train_multiple_classifiers</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="o">=</span><span class="n">train_visits</span><span class="p">,</span>
        <span class="n">valid_visits</span><span class="o">=</span><span class="n">valid_visits</span><span class="p">,</span>
        <span class="n">test_visits</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="n">grid_params</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span>
        <span class="n">ordinal_mappings</span><span class="o">=</span><span class="n">ordinal_mappings</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;admissions&quot;</span><span class="p">],</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save admission models if requested</span>

    <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
        <span class="n">save_model</span><span class="p">(</span><span class="n">admission_models</span><span class="p">,</span> <span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;admissions&quot;</span><span class="p">],</span> <span class="n">model_file_path</span><span class="p">)</span>

    <span class="c1"># Train specialty model</span>
    <span class="n">specialty_model</span> <span class="o">=</span> <span class="n">train_sequence_predictor</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="o">=</span><span class="n">train_visits</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;specialty&quot;</span><span class="p">],</span>
        <span class="n">input_var</span><span class="o">=</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="o">=</span><span class="s2">&quot;final_sequence&quot;</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="o">=</span><span class="s2">&quot;specialty&quot;</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save specialty model if requested</span>
    <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
        <span class="n">save_model</span><span class="p">(</span><span class="n">specialty_model</span><span class="p">,</span> <span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;specialty&quot;</span><span class="p">],</span> <span class="n">model_file_path</span><span class="p">)</span>

    <span class="c1"># Train yet-to-arrive model</span>
    <span class="n">yta_model_name</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">]</span>

    <span class="n">num_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_validation_set</span> <span class="o">-</span> <span class="n">start_training_set</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="n">yta_model</span> <span class="o">=</span> <span class="n">train_weighted_poisson_predictor</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="o">=</span><span class="n">train_visits</span><span class="p">,</span>
        <span class="n">train_yta</span><span class="o">=</span><span class="n">train_yta</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save yet-to-arrive model if requested</span>
    <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
        <span class="n">save_model</span><span class="p">(</span><span class="n">yta_model</span><span class="p">,</span> <span class="n">yta_model_name</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Models have been saved to </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test real-time predictions if requested</span>
    <span class="k">if</span> <span class="n">test_realtime</span><span class="p">:</span>
        <span class="n">test_real_time_predictions</span><span class="p">(</span>
            <span class="n">visits</span><span class="o">=</span><span class="n">visits</span><span class="p">,</span>
            <span class="n">models</span><span class="o">=</span><span class="p">(</span><span class="n">admission_models</span><span class="p">,</span> <span class="n">specialty_model</span><span class="p">,</span> <span class="n">yta_model</span><span class="p">),</span>
            <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">specialties</span><span class="o">=</span><span class="n">specialties</span><span class="p">,</span>
            <span class="n">cdf_cut_points</span><span class="o">=</span><span class="n">cdf_cut_points</span><span class="p">,</span>
            <span class="n">curve_params</span><span class="o">=</span><span class="n">curve_params</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.sequence_predictor" class="doc doc-heading">
            <code>sequence_predictor</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.sequence_predictor.get_default_visits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_default_visits</span><span class="p">(</span><span class="n">admitted</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Filters a dataframe of patient visits to include only non-pediatric patients.</p>
<p>This function identifies and removes pediatric patients from the dataset based on
both age criteria and specialty assignment. It automatically detects the appropriate
age column format from the provided dataframe.</p>
<h6 id="patientflow.train.sequence_predictor.get_default_visits--parameters">Parameters:</h6>
<p>admitted : DataFrame
    A pandas DataFrame containing patient visit information. Must include either
    'age_on_arrival' or 'age_group' columns, and a 'specialty' column.</p>
<h6 id="patientflow.train.sequence_predictor.get_default_visits--returns">Returns:</h6>
<p>DataFrame
    A filtered DataFrame containing only non-pediatric patients (adults).</p>
<h6 id="patientflow.train.sequence_predictor.get_default_visits--notes">Notes:</h6>
<p>The function automatically detects which age-related columns are present in the
dataframe and configures the appropriate filtering logic. It removes patients who
are either:
1. Identified as pediatric based on age criteria, or
2. Assigned to a pediatric specialty</p>
<h6 id="patientflow.train.sequence_predictor.get_default_visits--examples">Examples:</h6>
<blockquote>
<blockquote>
<blockquote>
<p>adult_visits = get_default_visits(all_patient_visits)
print(f"Reduced from {len(all_patient_visits)} to {len(adult_visits)} adult visits")</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_default_visits</span><span class="p">(</span><span class="n">admitted</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters a dataframe of patient visits to include only non-pediatric patients.</span>

<span class="sd">    This function identifies and removes pediatric patients from the dataset based on</span>
<span class="sd">    both age criteria and specialty assignment. It automatically detects the appropriate</span>
<span class="sd">    age column format from the provided dataframe.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    admitted : DataFrame</span>
<span class="sd">        A pandas DataFrame containing patient visit information. Must include either</span>
<span class="sd">        &#39;age_on_arrival&#39; or &#39;age_group&#39; columns, and a &#39;specialty&#39; column.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    DataFrame</span>
<span class="sd">        A filtered DataFrame containing only non-pediatric patients (adults).</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    The function automatically detects which age-related columns are present in the</span>
<span class="sd">    dataframe and configures the appropriate filtering logic. It removes patients who</span>
<span class="sd">    are either:</span>
<span class="sd">    1. Identified as pediatric based on age criteria, or</span>
<span class="sd">    2. Assigned to a pediatric specialty</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; adult_visits = get_default_visits(all_patient_visits)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Reduced from {len(all_patient_visits)} to {len(adult_visits)} adult visits&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get configuration for categorizing patients based on age columns</span>
    <span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">admitted</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Extract function that identifies non-pediatric patients</span>
    <span class="n">opposite_special_category_func</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>

    <span class="c1"># Determine which category is the special category (should be &quot;paediatric&quot;)</span>
    <span class="n">special_category_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="n">key</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span>
    <span class="p">)</span>

    <span class="c1"># Filter out pediatric patients based on both age criteria and specialty</span>
    <span class="n">filtered_admitted</span> <span class="o">=</span> <span class="n">admitted</span><span class="p">[</span>
        <span class="n">admitted</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">opposite_special_category_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">admitted</span><span class="p">[</span><span class="s2">&quot;specialty&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">special_category_key</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">filtered_admitted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.sequence_predictor.train_sequence_predictor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_sequence_predictor</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">,</span> <span class="n">input_var</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">,</span> <span class="n">outcome_var</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train a specialty prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training data containing visit information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name identifier for the model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name containing visit identifiers</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for input sequence</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for grouping sequence</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outcome_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for target variable</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="SequencePredictor (patientflow.predictors.sequence_predictor.SequencePredictor)" href="#patientflow.predictors.sequence_predictor.SequencePredictor">SequencePredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained SequencePredictor model</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_sequence_predictor</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">outcome_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SequencePredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train a specialty prediction model.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_visits: Training data containing visit information</span>
<span class="sd">        model_name: Name identifier for the model</span>
<span class="sd">        visit_col: Column name containing visit identifiers</span>
<span class="sd">        input_var: Column name for input sequence</span>
<span class="sd">        grouping_var: Column name for grouping sequence</span>
<span class="sd">        outcome_var: Column name for target variable</span>

<span class="sd">    Returns:</span>
<span class="sd">        Trained SequencePredictor model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">visits_single</span> <span class="o">=</span> <span class="n">select_one_snapshot_per_visit</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">)</span>
    <span class="n">admitted</span> <span class="o">=</span> <span class="n">visits_single</span><span class="p">[</span>
        <span class="p">(</span><span class="n">visits_single</span><span class="o">.</span><span class="n">is_admitted</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">visits_single</span><span class="o">.</span><span class="n">specialty</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="n">filtered_admitted</span> <span class="o">=</span> <span class="n">get_default_visits</span><span class="p">(</span><span class="n">admitted</span><span class="p">)</span>

    <span class="n">filtered_admitted</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">input_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_admitted</span><span class="p">[</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="p">()</span>
    <span class="p">)</span>
    <span class="n">filtered_admitted</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_admitted</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="p">()</span>
    <span class="p">)</span>

    <span class="n">spec_model</span> <span class="o">=</span> <span class="n">SequencePredictor</span><span class="p">(</span>
        <span class="n">input_var</span><span class="o">=</span><span class="n">input_var</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="o">=</span><span class="n">outcome_var</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">spec_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">filtered_admitted</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spec_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.utils" class="doc doc-heading">
            <code>utils</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.utils.save_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save trained model(s) to disk.</p>
<h6 id="patientflow.train.utils.save_model--parameters">Parameters</h6>
<p>model : object or dict
    A single model instance or a dictionary of models to save.
model_name : str
    Base name to use for saving the model(s).
model_file_path : Path
    Directory path where the model(s) will be saved.</p>
<h6 id="patientflow.train.utils.save_model--returns">Returns</h6>
<p>None</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save trained model(s) to disk.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : object or dict</span>
<span class="sd">        A single model instance or a dictionary of models to save.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Base name to use for saving the model(s).</span>
<span class="sd">    model_file_path : Path</span>
<span class="sd">        Directory path where the model(s) will be saved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># Handle dictionary of models (e.g., admission models)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="n">name</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.joblib&quot;</span><span class="p">)</span>
            <span class="n">dump</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Handle single model (e.g., specialty or yet-to-arrive model)</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="n">model_name</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.joblib&quot;</span><span class="p">)</span>
        <span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.weighted_poisson_predictor" class="doc doc-heading">
            <code>weighted_poisson_predictor</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.weighted_poisson_predictor.create_yta_filters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create specialty filters for categorizing patients by specialty and age group.</p>
<p>This function generates a dictionary of filters based on specialty categories,
with special handling for pediatric patients. It uses the SpecialCategoryParams
class to determine which specialties correspond to pediatric care.</p>
<h6 id="patientflow.train.weighted_poisson_predictor.create_yta_filters--parameters">Parameters:</h6>
<p>df : pandas.DataFrame
    DataFrame containing patient data with columns that include either
    'age_on_arrival' or 'age_group' for pediatric classification</p>
<h6 id="patientflow.train.weighted_poisson_predictor.create_yta_filters--returns">Returns:</h6>
<p>dict
    A dictionary mapping specialty names to filter configurations.
    Each configuration contains:
    - For pediatric specialty: {"is_child": True}
    - For other specialties: {"specialty": specialty_name, "is_child": False}</p>
<h6 id="patientflow.train.weighted_poisson_predictor.create_yta_filters--examples">Examples:</h6>
<blockquote>
<blockquote>
<blockquote>
<p>df = pd.DataFrame({'patient_id': [1, 2], 'age_on_arrival': [10, 40]})
filters = create_yta_filters(df)
print(filters['paediatric'])
{'is_child': True}
print(filters['medical'])
{'specialty': 'medical', 'is_child': False}</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create specialty filters for categorizing patients by specialty and age group.</span>

<span class="sd">    This function generates a dictionary of filters based on specialty categories,</span>
<span class="sd">    with special handling for pediatric patients. It uses the SpecialCategoryParams</span>
<span class="sd">    class to determine which specialties correspond to pediatric care.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data with columns that include either</span>
<span class="sd">        &#39;age_on_arrival&#39; or &#39;age_group&#39; for pediatric classification</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping specialty names to filter configurations.</span>
<span class="sd">        Each configuration contains:</span>
<span class="sd">        - For pediatric specialty: {&quot;is_child&quot;: True}</span>
<span class="sd">        - For other specialties: {&quot;specialty&quot;: specialty_name, &quot;is_child&quot;: False}</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;patient_id&#39;: [1, 2], &#39;age_on_arrival&#39;: [10, 40]})</span>
<span class="sd">    &gt;&gt;&gt; filters = create_yta_filters(df)</span>
<span class="sd">    &gt;&gt;&gt; print(filters[&#39;paediatric&#39;])</span>
<span class="sd">    {&#39;is_child&#39;: True}</span>
<span class="sd">    &gt;&gt;&gt; print(filters[&#39;medical&#39;])</span>
<span class="sd">    {&#39;specialty&#39;: &#39;medical&#39;, &#39;is_child&#39;: False}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the special category parameters using the picklable implementation</span>
    <span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Extract necessary data from the special_params</span>
    <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span>

    <span class="c1"># Create the specialty_filters dictionary</span>
    <span class="n">specialty_filters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">specialty</span><span class="p">,</span> <span class="n">is_paediatric_flag</span> <span class="ow">in</span> <span class="n">special_category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_paediatric_flag</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="c1"># For the paediatric specialty, set `is_child` to True</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For other specialties, set `is_child` to False</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="n">specialty</span><span class="p">,</span> <span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">specialty_filters</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.weighted_poisson_predictor.train_weighted_poisson_predictor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_weighted_poisson_predictor</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">train_yta</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train a yet-to-arrive prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Visits dataset (used for identifying special categories)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_yta</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training data for yet-to-arrive predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time window for predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval for predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of prediction times</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Epsilon parameter for model</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of days to consider</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="WeightedPoissonPredictor (patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor)" href="#patientflow.predictors.weighted_poisson_predictor.WeightedPoissonPredictor">WeightedPoissonPredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained WeightedPoissonPredictor model</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/weighted_poisson_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_weighted_poisson_predictor</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">train_yta</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10e-7</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightedPoissonPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train a yet-to-arrive prediction model.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_visits: Visits dataset (used for identifying special categories)</span>
<span class="sd">        train_yta: Training data for yet-to-arrive predictions</span>
<span class="sd">        prediction_window: Time window for predictions</span>
<span class="sd">        yta_time_interval: Time interval for predictions</span>
<span class="sd">        prediction_times: List of prediction times</span>
<span class="sd">        epsilon: Epsilon parameter for model</span>
<span class="sd">        num_days: Number of days to consider</span>

<span class="sd">    Returns:</span>
<span class="sd">        Trained WeightedPoissonPredictor model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;arrival_datetime&quot;</span> <span class="ow">in</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">train_yta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">train_yta</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">train_yta</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset needs arrival_datetime column&quot;</span><span class="p">)</span>

    <span class="n">specialty_filters</span> <span class="o">=</span> <span class="n">create_yta_filters</span><span class="p">(</span><span class="n">train_visits</span><span class="p">)</span>

    <span class="n">yta_model</span> <span class="o">=</span> <span class="n">WeightedPoissonPredictor</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">specialty_filters</span><span class="p">)</span>
    <span class="n">yta_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_df</span><span class="o">=</span><span class="n">train_yta</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">yta_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2024 Zella King
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/zmek" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.action.edit"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>