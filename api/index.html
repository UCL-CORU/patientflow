
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation website for PatientFlow">
      
      
        <meta name="author" content="Zella King">
      
      
      
        <link rel="prev" href="../LICENSE/">
      
      
        <link rel="next" href="../notebooks/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>API reference - PatientFlow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
<style>
  /* Make dataframe tables scroll horizontally when they're too wide */
  .md-typeset .dataframe {
    display: block;
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
    white-space: nowrap;
    margin-bottom: 1rem;
    border-collapse: collapse;
  }

  /* Handle table containers */
  .md-typeset div table {
    display: table;
    width: 100%;
  }

  /* Ensure code outputs don't overflow */
  .md-content__inner pre {
    overflow-x: auto;
    max-width: 100%;
  }

  /* Images should not overflow */
  .md-typeset img {
    max-width: 100%;
  }
</style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PatientFlow" class="md-header__button md-logo" aria-label="PatientFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PatientFlow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zmek/patientflow/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zmek/patientflow
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PatientFlow" class="md-nav__button md-logo" aria-label="PatientFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PatientFlow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zmek/patientflow/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zmek/patientflow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    patientflow: a Python package for real-time predictions of hospital bed demand from current and incoming patients
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../LICENSE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MIT License
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#patientflow" class="md-nav__link">
    <span class="md-ellipsis">
      patientflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression" class="md-nav__link">
    <span class="md-ellipsis">
      build_expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression" class="md-nav__link">
    <span class="md-ellipsis">
      compute_core_expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols" class="md-nav__link">
    <span class="md-ellipsis">
      create_symbols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs" class="md-nav__link">
    <span class="md-ellipsis">
      expression_subs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_for_prediction_moment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_using_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_using_survival_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba" class="md-nav__link">
    <span class="md-ellipsis">
      model_input_to_pred_proba
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted" class="md-nav__link">
    <span class="md-ellipsis">
      pred_proba_to_agg_predicted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff" class="md-nav__link">
    <span class="md-ellipsis">
      return_coeff
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.calculate" class="md-nav__link">
    <span class="md-ellipsis">
      calculate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window" class="md-nav__link">
    <span class="md-ellipsis">
      admission_in_prediction_window
    </span>
  </a>
  
    <nav class="md-nav" aria-label="admission_in_prediction_window">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.calculate_admission_probability_from_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_admission_probability_from_survival_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.calculate_probability" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_probability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.create_curve" class="md-nav__link">
    <span class="md-ellipsis">
      create_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.decay_curve" class="md-nav__link">
    <span class="md-ellipsis">
      decay_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.get_survival_probability" class="md-nav__link">
    <span class="md-ellipsis">
      get_survival_probability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.get_y_from_aspirational_curve" class="md-nav__link">
    <span class="md-ellipsis">
      get_y_from_aspirational_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.growth_curve" class="md-nav__link">
    <span class="md-ellipsis">
      growth_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      arrival_rates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="arrival_rates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.admission_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      admission_probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.count_yet_to_arrive" class="md-nav__link">
    <span class="md-ellipsis">
      count_yet_to_arrive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.process_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      process_arrival_rates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.time_varying_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      time_varying_arrival_rates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.time_varying_arrival_rates_lagged" class="md-nav__link">
    <span class="md-ellipsis">
      time_varying_arrival_rates_lagged
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.unfettered_demand_by_hour" class="md-nav__link">
    <span class="md-ellipsis">
      unfettered_demand_by_hour
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.weighted_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_arrival_rates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      survival_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="survival_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.survival_curve.calculate_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_survival_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.errors" class="md-nav__link">
    <span class="md-ellipsis">
      errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError" class="md-nav__link">
    <span class="md-ellipsis">
      MissingKeysError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.ModelLoadError" class="md-nav__link">
    <span class="md-ellipsis">
      ModelLoadError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calc_mae_mpe" class="md-nav__link">
    <span class="md-ellipsis">
      calc_mae_mpe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_admission_probs_relative_to_prediction" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_admission_probs_relative_to_prediction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_results" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_weighted_observed" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_weighted_observed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.combine_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      combine_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.create_time_mask" class="md-nav__link">
    <span class="md-ellipsis">
      create_time_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_combined_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_combined_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_six_week_average" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_six_week_average
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.get_arrivals_with_admission_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_arrivals_with_admission_probs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.predict_using_previous_weeks" class="md-nav__link">
    <span class="md-ellipsis">
      predict_using_previous_weeks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.generate" class="md-nav__link">
    <span class="md-ellipsis">
      generate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_finished_visits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_snapshots
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      data_from_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols" class="md-nav__link">
    <span class="md-ellipsis">
      get_dict_cols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file" class="md-nav__link">
    <span class="md-ellipsis">
      load_config_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.parse_args" class="md-nav__link">
    <span class="md-ellipsis">
      parse_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval" class="md-nav__link">
    <span class="md-ellipsis">
      safe_literal_eval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names" class="md-nav__link">
    <span class="md-ellipsis">
      set_data_file_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_file_paths" class="md-nav__link">
    <span class="md-ellipsis">
      set_file_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_project_root" class="md-nav__link">
    <span class="md-ellipsis">
      set_project_root
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.model_artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      model_artifacts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_artifacts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.FoldResults" class="md-nav__link">
    <span class="md-ellipsis">
      FoldResults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.HyperParameterTrial" class="md-nav__link">
    <span class="md-ellipsis">
      HyperParameterTrial
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainedClassifier" class="md-nav__link">
    <span class="md-ellipsis">
      TrainedClassifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainingResults" class="md-nav__link">
    <span class="md-ellipsis">
      TrainingResults
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.add_missing_columns" class="md-nav__link">
    <span class="md-ellipsis">
      add_missing_columns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      create_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index" class="md-nav__link">
    <span class="md-ellipsis">
      find_probability_threshold_index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_specialty_probs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predictors" class="md-nav__link">
    <span class="md-ellipsis">
      predictors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predictors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors" class="md-nav__link">
    <span class="md-ellipsis">
      incoming_admission_predictors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="incoming_admission_predictors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      EmpiricalIncomingAdmissionPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EmpiricalIncomingAdmissionPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.get_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      get_survival_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      IncomingAdmissionPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IncomingAdmissionPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.filter_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      filter_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      ParametricIncomingAdmissionPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParametricIncomingAdmissionPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.aggregate_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.convolute_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      convolute_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.find_nearest_previous_prediction_time" class="md-nav__link">
    <span class="md-ellipsis">
      find_nearest_previous_prediction_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.poisson_binom_generating_function" class="md-nav__link">
    <span class="md-ellipsis">
      poisson_binom_generating_function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.weighted_poisson_binomial" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_binomial
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_to_outcome_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_to_outcome_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor" class="md-nav__link">
    <span class="md-ellipsis">
      SequenceToOutcomePredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequenceToOutcomePredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      value_to_outcome_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="value_to_outcome_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor" class="md-nav__link">
    <span class="md-ellipsis">
      ValueToOutcomePredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ValueToOutcomePredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.prepare" class="md-nav__link">
    <span class="md-ellipsis">
      prepare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams" class="md-nav__link">
    <span class="md-ellipsis">
      SpecialCategoryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpecialCategoryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__reduce__" class="md-nav__link">
    <span class="md-ellipsis">
      __reduce__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.get_params_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_params_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.opposite_special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      opposite_special_category_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      special_category_func
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.additional_details" class="md-nav__link">
    <span class="md-ellipsis">
      additional_details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.apply_set" class="md-nav__link">
    <span class="md-ellipsis">
      apply_set
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.assign_patient_ids" class="md-nav__link">
    <span class="md-ellipsis">
      assign_patient_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.convert_dict_to_values" class="md-nav__link">
    <span class="md-ellipsis">
      convert_dict_to_values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.convert_set_to_dummies" class="md-nav__link">
    <span class="md-ellipsis">
      convert_set_to_dummies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects" class="md-nav__link">
    <span class="md-ellipsis">
      create_special_category_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_temporal_splits" class="md-nav__link">
    <span class="md-ellipsis">
      create_temporal_splits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.find_group_for_colname" class="md-nav__link">
    <span class="md-ellipsis">
      find_group_for_colname
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.generate_description" class="md-nav__link">
    <span class="md-ellipsis">
      generate_description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_group_snapshot_dict" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_group_snapshot_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_patient_snapshots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.select_one_snapshot_per_visit" class="md-nav__link">
    <span class="md-ellipsis">
      select_one_snapshot_per_visit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.validate_special_category_objects" class="md-nav__link">
    <span class="md-ellipsis">
      validate_special_category_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.write_data_dict" class="md-nav__link">
    <span class="md-ellipsis">
      write_data_dict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      survival_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="survival_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.survival_curve.calculate_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_survival_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      classifiers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="classifiers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.calculate_class_balance" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_class_balance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.chronological_cross_validation" class="md-nav__link">
    <span class="md-ellipsis">
      chronological_cross_validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_balance_info" class="md-nav__link">
    <span class="md-ellipsis">
      create_balance_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_column_transformer" class="md-nav__link">
    <span class="md-ellipsis">
      create_column_transformer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_dataset_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataset_metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_feature_metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialise_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier" class="md-nav__link">
    <span class="md-ellipsis">
      train_classifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_multiple_classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      train_multiple_classifiers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      test_real_time_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models" class="md-nav__link">
    <span class="md-ellipsis">
      train_all_models
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.incoming_admission_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      incoming_admission_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="incoming_admission_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.incoming_admission_predictor.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.incoming_admission_predictor.train_parametric_admission_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_parametric_admission_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits" class="md-nav__link">
    <span class="md-ellipsis">
      get_default_visits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.train_sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_sequence_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.viz" class="md-nav__link">
    <span class="md-ellipsis">
      viz
    </span>
  </a>
  
    <nav class="md-nav" aria-label="viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      arrival_rates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="arrival_rates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.annotate_hour_line" class="md-nav__link">
    <span class="md-ellipsis">
      annotate_hour_line
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.draw_window_visualization" class="md-nav__link">
    <span class="md-ellipsis">
      draw_window_visualization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.get_window_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      get_window_parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.plot_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      plot_arrival_rates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.plot_cumulative_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      plot_cumulative_arrival_rates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.aspirational_curve" class="md-nav__link">
    <span class="md-ellipsis">
      aspirational_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aspirational_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.aspirational_curve.plot_curve" class="md-nav__link">
    <span class="md-ellipsis">
      plot_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.calibration" class="md-nav__link">
    <span class="md-ellipsis">
      calibration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calibration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.calibration.plot_calibration" class="md-nav__link">
    <span class="md-ellipsis">
      plot_calibration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.data_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      data_distribution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="data_distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.data_distribution.plot_data_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      plot_data_distribution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.epudd" class="md-nav__link">
    <span class="md-ellipsis">
      epudd
    </span>
  </a>
  
    <nav class="md-nav" aria-label="epudd">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.epudd.plot_epudd" class="md-nav__link">
    <span class="md-ellipsis">
      plot_epudd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.estimated_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      estimated_probabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="estimated_probabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.estimated_probabilities.plot_estimated_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      plot_estimated_probabilities
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.features" class="md-nav__link">
    <span class="md-ellipsis">
      features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.features.plot_features" class="md-nav__link">
    <span class="md-ellipsis">
      plot_features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap" class="md-nav__link">
    <span class="md-ellipsis">
      madcap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="madcap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap.classify_age" class="md-nav__link">
    <span class="md-ellipsis">
      classify_age
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap.plot_madcap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_madcap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap.plot_madcap_by_group" class="md-nav__link">
    <span class="md-ellipsis">
      plot_madcap_by_group
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected" class="md-nav__link">
    <span class="md-ellipsis">
      observed_against_expected
    </span>
  </a>
  
    <nav class="md-nav" aria-label="observed_against_expected">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected.plot_arrival_delta_single_instance" class="md-nav__link">
    <span class="md-ellipsis">
      plot_arrival_delta_single_instance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected.plot_arrival_deltas" class="md-nav__link">
    <span class="md-ellipsis">
      plot_arrival_deltas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected.plot_deltas" class="md-nav__link">
    <span class="md-ellipsis">
      plot_deltas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.probability_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      probability_distribution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="probability_distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.probability_distribution.plot_prob_dist" class="md-nav__link">
    <span class="md-ellipsis">
      plot_prob_dist
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.quantile_quantile" class="md-nav__link">
    <span class="md-ellipsis">
      quantile_quantile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="quantile_quantile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.quantile_quantile.qq_plot" class="md-nav__link">
    <span class="md-ellipsis">
      qq_plot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.randomised_pit" class="md-nav__link">
    <span class="md-ellipsis">
      randomised_pit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="randomised_pit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.randomised_pit.plot_randomised_pit" class="md-nav__link">
    <span class="md-ellipsis">
      plot_randomised_pit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.shap" class="md-nav__link">
    <span class="md-ellipsis">
      shap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="shap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.shap.plot_shap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_shap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      survival_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="survival_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.survival_curve.plot_admission_time_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      plot_admission_time_survival_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.trial_results" class="md-nav__link">
    <span class="md-ellipsis">
      trial_results
    </span>
  </a>
  
    <nav class="md-nav" aria-label="trial_results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.trial_results.plot_trial_results" class="md-nav__link">
    <span class="md-ellipsis">
      plot_trial_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.utils.clean_title_for_filename" class="md-nav__link">
    <span class="md-ellipsis">
      clean_title_for_filename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.utils.format_prediction_time" class="md-nav__link">
    <span class="md-ellipsis">
      format_prediction_time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Notebooks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Notebooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About the notebooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/0_Set_up_your_environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0. Set up your environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/1_Meet_the_users_of_our_predictions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1. Introducing our users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2a_Create_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2a. Create patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2b_Predict_using_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2b. Make predictions using patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2c_Evaluate_patient_snapshot_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2c. Evaluate models trained on patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2d_Explore_the_datasets_provided/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2d. Explore the datasets provided
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3a_Prepare_group_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3a. Prepare group snapshots from patient snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3b_Evaluate_group_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3b. Evaluate group snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3c_Predict_bed_counts_without_using_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3c. Predict bed counts without using patient snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3d_Predict_bed_counts_for_subgroups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3d. Predict bed count distributions for subgroups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4a_Specify_emergency_demand_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4a. Specify requirements for emergency demand prediction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4b_Predict_emergency_demand/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4b. Predict emergency demand
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4c_Evaluate_emergency_demand_predictions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4c. Evaluate predictions of emergency demand
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/4d_Predict_emergency_demand_with_special_categories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4d. Evaluate predictions with special categories
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Src
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Src
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Patientflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Patientflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../src/patientflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PatientFlow: A Python package for converting patient-level predictions into output that is useful for bed managers in hospitals
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#patientflow" class="md-nav__link">
    <span class="md-ellipsis">
      patientflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.build_expression" class="md-nav__link">
    <span class="md-ellipsis">
      build_expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.compute_core_expression" class="md-nav__link">
    <span class="md-ellipsis">
      compute_core_expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.create_symbols" class="md-nav__link">
    <span class="md-ellipsis">
      create_symbols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.expression_subs" class="md-nav__link">
    <span class="md-ellipsis">
      expression_subs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_for_prediction_moment" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_for_prediction_moment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.get_prob_dist_using_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      get_prob_dist_using_survival_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.model_input_to_pred_proba" class="md-nav__link">
    <span class="md-ellipsis">
      model_input_to_pred_proba
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.pred_proba_to_agg_predicted" class="md-nav__link">
    <span class="md-ellipsis">
      pred_proba_to_agg_predicted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.aggregate.return_coeff" class="md-nav__link">
    <span class="md-ellipsis">
      return_coeff
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.calculate" class="md-nav__link">
    <span class="md-ellipsis">
      calculate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window" class="md-nav__link">
    <span class="md-ellipsis">
      admission_in_prediction_window
    </span>
  </a>
  
    <nav class="md-nav" aria-label="admission_in_prediction_window">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.calculate_admission_probability_from_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_admission_probability_from_survival_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.calculate_probability" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_probability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.create_curve" class="md-nav__link">
    <span class="md-ellipsis">
      create_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.decay_curve" class="md-nav__link">
    <span class="md-ellipsis">
      decay_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.get_survival_probability" class="md-nav__link">
    <span class="md-ellipsis">
      get_survival_probability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.get_y_from_aspirational_curve" class="md-nav__link">
    <span class="md-ellipsis">
      get_y_from_aspirational_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.admission_in_prediction_window.growth_curve" class="md-nav__link">
    <span class="md-ellipsis">
      growth_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      arrival_rates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="arrival_rates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.admission_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      admission_probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.count_yet_to_arrive" class="md-nav__link">
    <span class="md-ellipsis">
      count_yet_to_arrive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.process_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      process_arrival_rates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.time_varying_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      time_varying_arrival_rates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.time_varying_arrival_rates_lagged" class="md-nav__link">
    <span class="md-ellipsis">
      time_varying_arrival_rates_lagged
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.unfettered_demand_by_hour" class="md-nav__link">
    <span class="md-ellipsis">
      unfettered_demand_by_hour
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.arrival_rates.weighted_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_arrival_rates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      survival_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="survival_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.calculate.survival_curve.calculate_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_survival_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.errors" class="md-nav__link">
    <span class="md-ellipsis">
      errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.MissingKeysError" class="md-nav__link">
    <span class="md-ellipsis">
      MissingKeysError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.errors.ModelLoadError" class="md-nav__link">
    <span class="md-ellipsis">
      ModelLoadError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calc_mae_mpe" class="md-nav__link">
    <span class="md-ellipsis">
      calc_mae_mpe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_admission_probs_relative_to_prediction" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_admission_probs_relative_to_prediction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_results" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.calculate_weighted_observed" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_weighted_observed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.combine_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      combine_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.create_time_mask" class="md-nav__link">
    <span class="md-ellipsis">
      create_time_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_combined_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_combined_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.evaluate_six_week_average" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_six_week_average
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.get_arrivals_with_admission_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_arrivals_with_admission_probs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.evaluate.predict_using_previous_weeks" class="md-nav__link">
    <span class="md-ellipsis">
      predict_using_previous_weeks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.generate" class="md-nav__link">
    <span class="md-ellipsis">
      generate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_finished_visits" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_finished_visits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.generate.create_fake_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      create_fake_snapshots
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.load.data_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      data_from_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_dict_cols" class="md-nav__link">
    <span class="md-ellipsis">
      get_dict_cols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.get_model_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_config_file" class="md-nav__link">
    <span class="md-ellipsis">
      load_config_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.load_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.parse_args" class="md-nav__link">
    <span class="md-ellipsis">
      parse_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.safe_literal_eval" class="md-nav__link">
    <span class="md-ellipsis">
      safe_literal_eval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_data_file_names" class="md-nav__link">
    <span class="md-ellipsis">
      set_data_file_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_file_paths" class="md-nav__link">
    <span class="md-ellipsis">
      set_file_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.load.set_project_root" class="md-nav__link">
    <span class="md-ellipsis">
      set_project_root
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.model_artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      model_artifacts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_artifacts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.FoldResults" class="md-nav__link">
    <span class="md-ellipsis">
      FoldResults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.HyperParameterTrial" class="md-nav__link">
    <span class="md-ellipsis">
      HyperParameterTrial
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainedClassifier" class="md-nav__link">
    <span class="md-ellipsis">
      TrainedClassifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.model_artifacts.TrainingResults" class="md-nav__link">
    <span class="md-ellipsis">
      TrainingResults
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.add_missing_columns" class="md-nav__link">
    <span class="md-ellipsis">
      add_missing_columns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.create_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      create_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.find_probability_threshold_index" class="md-nav__link">
    <span class="md-ellipsis">
      find_probability_threshold_index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predict.emergency_demand.get_specialty_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_specialty_probs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.predictors" class="md-nav__link">
    <span class="md-ellipsis">
      predictors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predictors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors" class="md-nav__link">
    <span class="md-ellipsis">
      incoming_admission_predictors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="incoming_admission_predictors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      EmpiricalIncomingAdmissionPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EmpiricalIncomingAdmissionPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.get_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      get_survival_curve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      IncomingAdmissionPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IncomingAdmissionPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.filter_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      filter_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor" class="md-nav__link">
    <span class="md-ellipsis">
      ParametricIncomingAdmissionPredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParametricIncomingAdmissionPredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.aggregate_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.convolute_distributions" class="md-nav__link">
    <span class="md-ellipsis">
      convolute_distributions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.find_nearest_previous_prediction_time" class="md-nav__link">
    <span class="md-ellipsis">
      find_nearest_previous_prediction_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.poisson_binom_generating_function" class="md-nav__link">
    <span class="md-ellipsis">
      poisson_binom_generating_function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.incoming_admission_predictors.weighted_poisson_binomial" class="md-nav__link">
    <span class="md-ellipsis">
      weighted_poisson_binomial
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_to_outcome_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_to_outcome_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor" class="md-nav__link">
    <span class="md-ellipsis">
      SequenceToOutcomePredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequenceToOutcomePredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      value_to_outcome_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="value_to_outcome_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor" class="md-nav__link">
    <span class="md-ellipsis">
      ValueToOutcomePredictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ValueToOutcomePredictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.prepare" class="md-nav__link">
    <span class="md-ellipsis">
      prepare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams" class="md-nav__link">
    <span class="md-ellipsis">
      SpecialCategoryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpecialCategoryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.__reduce__" class="md-nav__link">
    <span class="md-ellipsis">
      __reduce__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.get_params_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_params_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.opposite_special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      opposite_special_category_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.SpecialCategoryParams.special_category_func" class="md-nav__link">
    <span class="md-ellipsis">
      special_category_func
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.additional_details" class="md-nav__link">
    <span class="md-ellipsis">
      additional_details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.apply_set" class="md-nav__link">
    <span class="md-ellipsis">
      apply_set
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.assign_patient_ids" class="md-nav__link">
    <span class="md-ellipsis">
      assign_patient_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.convert_dict_to_values" class="md-nav__link">
    <span class="md-ellipsis">
      convert_dict_to_values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.convert_set_to_dummies" class="md-nav__link">
    <span class="md-ellipsis">
      convert_set_to_dummies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_special_category_objects" class="md-nav__link">
    <span class="md-ellipsis">
      create_special_category_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_temporal_splits" class="md-nav__link">
    <span class="md-ellipsis">
      create_temporal_splits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.find_group_for_colname" class="md-nav__link">
    <span class="md-ellipsis">
      find_group_for_colname
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.generate_description" class="md-nav__link">
    <span class="md-ellipsis">
      generate_description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_group_snapshot_dict" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_group_snapshot_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.prepare_patient_snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_patient_snapshots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.select_one_snapshot_per_visit" class="md-nav__link">
    <span class="md-ellipsis">
      select_one_snapshot_per_visit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.validate_special_category_objects" class="md-nav__link">
    <span class="md-ellipsis">
      validate_special_category_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.prepare.write_data_dict" class="md-nav__link">
    <span class="md-ellipsis">
      write_data_dict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      survival_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="survival_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.survival_curve.calculate_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_survival_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      classifiers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="classifiers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.calculate_class_balance" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_class_balance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.chronological_cross_validation" class="md-nav__link">
    <span class="md-ellipsis">
      chronological_cross_validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_balance_info" class="md-nav__link">
    <span class="md-ellipsis">
      create_balance_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.create_column_transformer" class="md-nav__link">
    <span class="md-ellipsis">
      create_column_transformer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.evaluate_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_dataset_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataset_metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.get_feature_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_feature_metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.initialise_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialise_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_classifier" class="md-nav__link">
    <span class="md-ellipsis">
      train_classifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.classifiers.train_multiple_classifiers" class="md-nav__link">
    <span class="md-ellipsis">
      train_multiple_classifiers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand" class="md-nav__link">
    <span class="md-ellipsis">
      emergency_demand
    </span>
  </a>
  
    <nav class="md-nav" aria-label="emergency_demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.test_real_time_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      test_real_time_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.emergency_demand.train_all_models" class="md-nav__link">
    <span class="md-ellipsis">
      train_all_models
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.incoming_admission_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      incoming_admission_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="incoming_admission_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.incoming_admission_predictor.create_yta_filters" class="md-nav__link">
    <span class="md-ellipsis">
      create_yta_filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.incoming_admission_predictor.train_parametric_admission_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_parametric_admission_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      sequence_predictor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sequence_predictor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.get_default_visits" class="md-nav__link">
    <span class="md-ellipsis">
      get_default_visits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.sequence_predictor.train_sequence_predictor" class="md-nav__link">
    <span class="md-ellipsis">
      train_sequence_predictor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.train.utils.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patientflow.viz" class="md-nav__link">
    <span class="md-ellipsis">
      viz
    </span>
  </a>
  
    <nav class="md-nav" aria-label="viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      arrival_rates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="arrival_rates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.annotate_hour_line" class="md-nav__link">
    <span class="md-ellipsis">
      annotate_hour_line
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.draw_window_visualization" class="md-nav__link">
    <span class="md-ellipsis">
      draw_window_visualization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.get_window_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      get_window_parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.plot_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      plot_arrival_rates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.arrival_rates.plot_cumulative_arrival_rates" class="md-nav__link">
    <span class="md-ellipsis">
      plot_cumulative_arrival_rates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.aspirational_curve" class="md-nav__link">
    <span class="md-ellipsis">
      aspirational_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aspirational_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.aspirational_curve.plot_curve" class="md-nav__link">
    <span class="md-ellipsis">
      plot_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.calibration" class="md-nav__link">
    <span class="md-ellipsis">
      calibration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calibration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.calibration.plot_calibration" class="md-nav__link">
    <span class="md-ellipsis">
      plot_calibration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.data_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      data_distribution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="data_distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.data_distribution.plot_data_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      plot_data_distribution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.epudd" class="md-nav__link">
    <span class="md-ellipsis">
      epudd
    </span>
  </a>
  
    <nav class="md-nav" aria-label="epudd">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.epudd.plot_epudd" class="md-nav__link">
    <span class="md-ellipsis">
      plot_epudd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.estimated_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      estimated_probabilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="estimated_probabilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.estimated_probabilities.plot_estimated_probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      plot_estimated_probabilities
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.features" class="md-nav__link">
    <span class="md-ellipsis">
      features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.features.plot_features" class="md-nav__link">
    <span class="md-ellipsis">
      plot_features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap" class="md-nav__link">
    <span class="md-ellipsis">
      madcap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="madcap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap.classify_age" class="md-nav__link">
    <span class="md-ellipsis">
      classify_age
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap.plot_madcap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_madcap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.madcap.plot_madcap_by_group" class="md-nav__link">
    <span class="md-ellipsis">
      plot_madcap_by_group
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected" class="md-nav__link">
    <span class="md-ellipsis">
      observed_against_expected
    </span>
  </a>
  
    <nav class="md-nav" aria-label="observed_against_expected">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected.plot_arrival_delta_single_instance" class="md-nav__link">
    <span class="md-ellipsis">
      plot_arrival_delta_single_instance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected.plot_arrival_deltas" class="md-nav__link">
    <span class="md-ellipsis">
      plot_arrival_deltas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.observed_against_expected.plot_deltas" class="md-nav__link">
    <span class="md-ellipsis">
      plot_deltas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.probability_distribution" class="md-nav__link">
    <span class="md-ellipsis">
      probability_distribution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="probability_distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.probability_distribution.plot_prob_dist" class="md-nav__link">
    <span class="md-ellipsis">
      plot_prob_dist
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.quantile_quantile" class="md-nav__link">
    <span class="md-ellipsis">
      quantile_quantile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="quantile_quantile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.quantile_quantile.qq_plot" class="md-nav__link">
    <span class="md-ellipsis">
      qq_plot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.randomised_pit" class="md-nav__link">
    <span class="md-ellipsis">
      randomised_pit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="randomised_pit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.randomised_pit.plot_randomised_pit" class="md-nav__link">
    <span class="md-ellipsis">
      plot_randomised_pit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.shap" class="md-nav__link">
    <span class="md-ellipsis">
      shap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="shap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.shap.plot_shap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_shap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      survival_curve
    </span>
  </a>
  
    <nav class="md-nav" aria-label="survival_curve">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.survival_curve.plot_admission_time_survival_curve" class="md-nav__link">
    <span class="md-ellipsis">
      plot_admission_time_survival_curve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.trial_results" class="md-nav__link">
    <span class="md-ellipsis">
      trial_results
    </span>
  </a>
  
    <nav class="md-nav" aria-label="trial_results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.trial_results.plot_trial_results" class="md-nav__link">
    <span class="md-ellipsis">
      plot_trial_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.utils.clean_title_for_filename" class="md-nav__link">
    <span class="md-ellipsis">
      clean_title_for_filename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patientflow.viz.utils.format_prediction_time" class="md-nav__link">
    <span class="md-ellipsis">
      format_prediction_time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/zmek/patientflow/edit/main/docs/api.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="api-reference">API reference</h1>


<div class="doc doc-object doc-module">



<a id="patientflow"></a>
    <div class="doc doc-contents first">

        <p>PatientFlow: A package for predicting short-term hospital bed demand.</p>
<p>This package provides tools and models for analysing patient flow data and
making predictions about emergency demand, elective demand, and hospital discharges.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="patientflow.aggregate" class="doc doc-heading">
            <code>aggregate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Aggregate Prediction From Patient-Level Probabilities</p>
<p>This submodule provides functions to aggregate patient-level predicted probabilities into a probability distribution.
The module uses symbolic mathematics to generate and manipulate expressions, enabling the computation of aggregate probabilities based on individual patient-level predictions.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.create_symbols : function">create_symbols : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate a sequence of symbolic objects intended for use in mathematical expressions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.compute_core_expression : function">compute_core_expression : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compute a symbolic expression involving a basic mathematical operation with a symbol and a constant.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.build_expression : function">build_expression : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Construct a cumulative product expression by combining individual symbolic expressions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.expression_subs : function">expression_subs : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Substitute values into a symbolic expression based on a mapping from symbols to predictions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.return_coeff : function">return_coeff : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Extract the coefficient of a specified power from an expanded symbolic expression.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.model_input_to_pred_proba : function">model_input_to_pred_proba : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Use a predictive model to convert model input data into predicted probabilities.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.pred_proba_to_agg_predicted : function">pred_proba_to_agg_predicted : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Convert individual probability predictions into aggregate predicted probability distribution using optional weights.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.get_prob_dist_for_prediction_moment : function">get_prob_dist_for_prediction_moment : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate both predicted distributions and observed values for a given date using test data.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.get_prob_dist : function">get_prob_dist : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate probability distributions for each snapshot date based on given model predictions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.aggregate.get_prob_dist_without_patient_snapshots : function">get_prob_dist_without_patient_snapshots : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate probability distributions for each snapshot date using an EmpiricalSurvivalPredictor.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.build_expression" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct a cumulative product expression by combining individual symbolic expressions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>syms</code>
            </td>
            <td>
                  <code><span title="iterable">iterable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Iterable containing symbols to use in the expressions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of terms to include in the cumulative product.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Expr">Expr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cumulative product of the expressions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a cumulative product expression by combining individual symbolic expressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    syms : iterable</span>
<span class="sd">        Iterable containing symbols to use in the expressions.</span>
<span class="sd">    n : int</span>
<span class="sd">        The number of terms to include in the cumulative product.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Expr</span>
<span class="sd">        The cumulative product of the expressions.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">expression</span> <span class="o">*=</span> <span class="n">compute_core_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expression</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.compute_core_expression" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_core_expression</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute a symbolic expression involving a basic mathematical operation with a symbol and a constant.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ri</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The constant value to substitute into the expression.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>s</code>
            </td>
            <td>
                  <code><span title="Symbol">Symbol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The symbolic object used in the expression.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Expr">Expr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The symbolic expression after substitution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_core_expression</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a symbolic expression involving a basic mathematical operation with a symbol and a constant.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ri : float</span>
<span class="sd">        The constant value to substitute into the expression.</span>
<span class="sd">    s : Symbol</span>
<span class="sd">        The symbolic object used in the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Expr</span>
<span class="sd">        The symbolic expression after substitution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">core_expression</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">core_expression</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">r</span><span class="p">:</span> <span class="n">ri</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.create_symbols" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a sequence of symbolic objects intended for use in mathematical expressions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of symbols to create.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing the generated symbolic objects.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a sequence of symbolic objects intended for use in mathematical expressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of symbols to create.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing the generated symbolic objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">symbols</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;r0:</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.expression_subs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">expression_subs</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Substitute values into a symbolic expression based on a mapping from symbols to predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>expression</code>
            </td>
            <td>
                  <code><span title="Expr">Expr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The symbolic expression to perform substitution on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of symbols and corresponding predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predictions</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of numerical predictions to substitute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Expr">Expr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The expression after performing the substitution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">expression_subs</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Substitute values into a symbolic expression based on a mapping from symbols to predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression : Expr</span>
<span class="sd">        The symbolic expression to perform substitution on.</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of symbols and corresponding predictions.</span>
<span class="sd">    predictions : list</span>
<span class="sd">        List of numerical predictions to substitute.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Expr</span>
<span class="sd">        The expression after performing the substitution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">syms</span> <span class="o">=</span> <span class="n">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">substitution</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">predictions</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">substitution</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.get_prob_dist" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prob_dist</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate probability distributions for each snapshot date based on given model predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>snapshots_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping snapshot dates to indices in <code>X_test</code> and <code>y_test</code>.
Must have datetime.date objects as keys and lists of indices as values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>X_test</code>
            </td>
            <td>
                  <code><span title="DataFrame">DataFrame</span> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input test data to be passed to the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Observed target values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#object">object</a> or <span title="TrainedClassifier">TrainedClassifier</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a predictive model which provides a <code>predict_proba</code> method,
or a TrainedClassifier object containing a pipeline.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weights</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Series containing weights for the test data points, which may influence the prediction,
by default None. If provided, the weights should be indexed similarly to <code>X_test</code> and <code>y_test</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>, <span title="optional">optional</span>(default=False))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print progress information.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>category_filter</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean mask indicating which samples belong to the specific outcome category being analyzed.
Should be the same length as y_test.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>normal_approx_threshold</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <span title="optional">optional</span>(default=30))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the number of rows in a snapshot exceeds this threshold, use a Normal distribution approximation.
Set to None or a very large number to always use the exact symbolic computation.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping snapshot dates to probability distributions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If snapshots_dict is not properly formatted or empty.
If model has no predict_proba method and is not a TrainedClassifier.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prob_dist</span><span class="p">(</span>
    <span class="n">snapshots_dict</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">,</span>
    <span class="n">y_test</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate probability distributions for each snapshot date based on given model predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    snapshots_dict : dict</span>
<span class="sd">        A dictionary mapping snapshot dates to indices in `X_test` and `y_test`.</span>
<span class="sd">        Must have datetime.date objects as keys and lists of indices as values.</span>
<span class="sd">    X_test : DataFrame or array-like</span>
<span class="sd">        Input test data to be passed to the model.</span>
<span class="sd">    y_test : array-like</span>
<span class="sd">        Observed target values.</span>
<span class="sd">    model : object or TrainedClassifier</span>
<span class="sd">        Either a predictive model which provides a `predict_proba` method,</span>
<span class="sd">        or a TrainedClassifier object containing a pipeline.</span>
<span class="sd">    weights : pandas.Series, optional</span>
<span class="sd">        A Series containing weights for the test data points, which may influence the prediction,</span>
<span class="sd">        by default None. If provided, the weights should be indexed similarly to `X_test` and `y_test`.</span>
<span class="sd">    verbose : bool, optional (default=False)</span>
<span class="sd">        If True, print progress information.</span>
<span class="sd">    category_filter : array-like, optional</span>
<span class="sd">        Boolean mask indicating which samples belong to the specific outcome category being analyzed.</span>
<span class="sd">        Should be the same length as y_test.</span>
<span class="sd">    normal_approx_threshold : int, optional (default=30)</span>
<span class="sd">        If the number of rows in a snapshot exceeds this threshold, use a Normal distribution approximation.</span>
<span class="sd">        Set to None or a very large number to always use the exact symbolic computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping snapshot dates to probability distributions.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If snapshots_dict is not properly formatted or empty.</span>
<span class="sd">        If model has no predict_proba method and is not a TrainedClassifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate snapshots_dict format</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshots_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;snapshots_dict cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">snapshots_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;snapshots_dict keys must be datetime.date objects, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;snapshots_dict values must be lists, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All indices in snapshots_dict must be integers&quot;</span><span class="p">)</span>

    <span class="c1"># Extract pipeline if model is a TrainedClassifier</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pipeline</span>
    <span class="c1"># Validate that model has predict_proba method</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Model must either be a TrainedClassifier or have a predict_proba method&quot;</span>
        <span class="p">)</span>

    <span class="n">prob_dist_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculating probability distributions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This may take a minute or more&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize a counter for notifying the user every 10 snapshot dates processed</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">snapshots_to_include</span> <span class="ow">in</span> <span class="n">snapshots_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_to_include</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Create an empty dictionary for the current snapshot date</span>
            <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;agg_predicted&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;agg_observed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Ensure the lengths of test features and outcomes are equal</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">y_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">]</span>
            <span class="p">),</span> <span class="s2">&quot;Mismatch in lengths of X_test and y_test snapshots.&quot;</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment_weights</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction_moment_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Apply category filter</span>
            <span class="k">if</span> <span class="n">category_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment_category_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction_moment_category_filter</span> <span class="o">=</span> <span class="n">category_filter</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">snapshots_to_include</span>
                <span class="p">]</span>

            <span class="c1"># Pass the normal_approx_threshold to get_prob_dist_for_prediction_moment</span>
            <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_prob_dist_for_prediction_moment</span><span class="p">(</span>
                <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">],</span>
                <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">snapshots_to_include</span><span class="p">],</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">prediction_moment_weights</span><span class="p">,</span>
                <span class="n">category_filter</span><span class="o">=</span><span class="n">prediction_moment_category_filter</span><span class="p">,</span>
                <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="n">normal_approx_threshold</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Increment the counter and notify the user every 10 snapshot dates processed</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_dist_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.get_prob_dist_for_prediction_moment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prob_dist_for_prediction_moment</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate both predicted distributions and observed values for a given date using test data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test features for a specific snapshot date.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#object">object</a> or <span title="TrainedClassifier">TrainedClassifier</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a predictive model which provides a <code>predict_proba</code> method,
or a TrainedClassifier object containing a pipeline.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weights</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weights to apply to the predictions for aggregate calculation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inference_time</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>, <span title="optional">optional</span>(default=False))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, do not calculate or return actual aggregate.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Actual outcomes corresponding to the test features. Required if inference_time is False.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>category_filter</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean mask indicating which samples belong to the specific outcome category being analyzed.
Should be the same length as y_test.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>normal_approx_threshold</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <span title="optional">optional</span>(default=30))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the number of rows in X_test exceeds this threshold, use a Normal distribution approximation.
Set to None or a very large number to always use the exact symbolic computation.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary with keys 'agg_predicted' and, if inference_time is False, 'agg_observed'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If y_test is not provided when inference_time is False.
If model has no predict_proba method and is not a TrainedClassifier.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prob_dist_for_prediction_moment</span><span class="p">(</span>
    <span class="n">X_test</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">category_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate both predicted distributions and observed values for a given date using test data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_test : array-like</span>
<span class="sd">        Test features for a specific snapshot date.</span>
<span class="sd">    model : object or TrainedClassifier</span>
<span class="sd">        Either a predictive model which provides a `predict_proba` method,</span>
<span class="sd">        or a TrainedClassifier object containing a pipeline.</span>
<span class="sd">    weights : array-like, optional</span>
<span class="sd">        Weights to apply to the predictions for aggregate calculation.</span>
<span class="sd">    inference_time : bool, optional (default=False)</span>
<span class="sd">        If True, do not calculate or return actual aggregate.</span>
<span class="sd">    y_test : array-like, optional</span>
<span class="sd">        Actual outcomes corresponding to the test features. Required if inference_time is False.</span>
<span class="sd">    category_filter : array-like, optional</span>
<span class="sd">        Boolean mask indicating which samples belong to the specific outcome category being analyzed.</span>
<span class="sd">        Should be the same length as y_test.</span>
<span class="sd">    normal_approx_threshold : int, optional (default=30)</span>
<span class="sd">        If the number of rows in X_test exceeds this threshold, use a Normal distribution approximation.</span>
<span class="sd">        Set to None or a very large number to always use the exact symbolic computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary with keys &#39;agg_predicted&#39; and, if inference_time is False, &#39;agg_observed&#39;.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If y_test is not provided when inference_time is False.</span>
<span class="sd">        If model has no predict_proba method and is not a TrainedClassifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span> <span class="ow">and</span> <span class="n">y_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;y_test must be provided if inference_time is False.&quot;</span><span class="p">)</span>

    <span class="c1"># Extract pipeline if model is a TrainedClassifier</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pipeline</span>
    <span class="c1"># Validate that model has predict_proba method</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Model must either be a TrainedClassifier or have a predict_proba method&quot;</span>
        <span class="p">)</span>

    <span class="n">prediction_moment_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pred_proba</span> <span class="o">=</span> <span class="n">model_input_to_pred_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">agg_predicted</span> <span class="o">=</span> <span class="n">pred_proba_to_agg_predicted</span><span class="p">(</span>
            <span class="n">pred_proba</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">normal_approx_threshold</span>
        <span class="p">)</span>
        <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_predicted</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span><span class="p">:</span>
            <span class="c1"># Apply category filter when calculating observed sum</span>
            <span class="k">if</span> <span class="n">category_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span> <span class="o">&amp;</span> <span class="n">category_filter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span><span class="p">:</span>
            <span class="n">prediction_moment_dict</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">prediction_moment_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.get_prob_dist_using_survival_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prob_dist_using_survival_curve</span><span class="p">(</span><span class="n">snapshot_dates</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate probability distributions for each snapshot date using an EmpiricalIncomingAdmissionPredictor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>snapshot_dates</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of dates for which to calculate probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing test visit data. Must have either:
- start_time_col as a column and end_time_col as a column, or
- start_time_col as the index and end_time_col as a column</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>category</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Category to use for predictions (e.g., 'medical', 'surgical')</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (hour, minute) representing the time of day for predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prediction window duration</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing start times (or index name if using index)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing end times</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="EmpiricalSurvivalPredictor">EmpiricalSurvivalPredictor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A fitted instance of EmpiricalSurvivalPredictor</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>, <span title="optional">optional</span>(default=False))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print progress information</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping snapshot dates to probability distributions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If test_visits does not have the required columns or if model is not fitted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prob_dist_using_survival_curve</span><span class="p">(</span>
    <span class="n">snapshot_dates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">date</span><span class="p">],</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">start_time_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">end_time_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">EmpiricalIncomingAdmissionPredictor</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate probability distributions for each snapshot date using an EmpiricalIncomingAdmissionPredictor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    snapshot_dates : array-like</span>
<span class="sd">        Array of dates for which to calculate probability distributions.</span>
<span class="sd">    test_visits : pandas.DataFrame</span>
<span class="sd">        DataFrame containing test visit data. Must have either:</span>
<span class="sd">        - start_time_col as a column and end_time_col as a column, or</span>
<span class="sd">        - start_time_col as the index and end_time_col as a column</span>
<span class="sd">    category : str</span>
<span class="sd">        Category to use for predictions (e.g., &#39;medical&#39;, &#39;surgical&#39;)</span>
<span class="sd">    prediction_time : tuple</span>
<span class="sd">        Tuple of (hour, minute) representing the time of day for predictions</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        The prediction window duration</span>
<span class="sd">    start_time_col : str</span>
<span class="sd">        Name of the column containing start times (or index name if using index)</span>
<span class="sd">    end_time_col : str</span>
<span class="sd">        Name of the column containing end times</span>
<span class="sd">    model : EmpiricalSurvivalPredictor</span>
<span class="sd">        A fitted instance of EmpiricalSurvivalPredictor</span>
<span class="sd">    verbose : bool, optional (default=False)</span>
<span class="sd">        If True, print progress information</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping snapshot dates to probability distributions.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If test_visits does not have the required columns or if model is not fitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Validate test_visits has required columns</span>
    <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># start_time_col is a regular column</span>
        <span class="k">if</span> <span class="n">end_time_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">end_time_col</span><span class="si">}</span><span class="s2">&#39; not found in DataFrame&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if start_time_col is the index</span>
        <span class="k">if</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">start_time_col</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">start_time_col</span><span class="si">}</span><span class="s2">&#39; not found in DataFrame columns or index (index.name is &#39;</span><span class="si">{</span><span class="n">test_visits</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">end_time_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">end_time_col</span><span class="si">}</span><span class="s2">&#39; not found in DataFrame&quot;</span><span class="p">)</span>

    <span class="c1"># Validate model is fitted</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;survival_df&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before calling get_prob_dist_empirical&quot;</span><span class="p">)</span>

    <span class="n">prob_dist_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculating probability distributions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot_dates</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Create prediction context that will be the same for all dates</span>
    <span class="n">prediction_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">category</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">:</span> <span class="n">prediction_time</span><span class="p">}}</span>

    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">snapshot_dates</span><span class="p">:</span>
        <span class="c1"># Create prediction moment by combining snapshot date and prediction time</span>
        <span class="n">prediction_moment</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span>
            <span class="n">dt</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># Convert to UTC if the test_visits timestamps are timezone-aware</span>
        <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_visits</span><span class="p">[</span><span class="n">start_time_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment</span> <span class="o">=</span> <span class="n">prediction_moment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prediction_moment</span> <span class="o">=</span> <span class="n">prediction_moment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="c1"># Get predictions from model</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">prediction_context</span><span class="p">)</span>
        <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">[</span><span class="n">category</span><span class="p">]}</span>

        <span class="c1"># Calculate observed values</span>
        <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">test_visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># start_time_col is a regular column</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_visits</span><span class="p">[</span><span class="n">start_time_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prediction_moment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">test_visits</span><span class="p">[</span><span class="n">end_time_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">prediction_moment</span> <span class="o">+</span> <span class="n">prediction_window</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># start_time_col is the index</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_visits</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">prediction_moment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">test_visits</span><span class="p">[</span><span class="n">end_time_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">prediction_moment</span> <span class="o">+</span> <span class="n">prediction_window</span>
            <span class="p">)</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">][</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nrow</span><span class="p">)</span> <span class="k">if</span> <span class="n">nrow</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot_dates</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshot dates&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_dist_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.model_input_to_pred_proba" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model_input_to_pred_proba</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Use a predictive model to convert model input data into predicted probabilities.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_input</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input data to the model, typically as features used for predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#object">object</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A model object with a <code>predict_proba</code> method that computes probability estimates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pandas DataFrame containing the predicted probabilities for the positive class,
with one column labeled 'pred_proba'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">model_input_to_pred_proba</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use a predictive model to convert model input data into predicted probabilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_input : array-like</span>
<span class="sd">        The input data to the model, typically as features used for predictions.</span>
<span class="sd">    model : object</span>
<span class="sd">        A model object with a `predict_proba` method that computes probability estimates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">        A pandas DataFrame containing the predicted probabilities for the positive class,</span>
<span class="sd">        with one column labeled &#39;pred_proba&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">model_input</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">model_input</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.pred_proba_to_agg_predicted" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pred_proba_to_agg_predicted</span><span class="p">(</span><span class="n">predictions_proba</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert individual probability predictions into aggregate predicted probability distribution using optional weights.
Uses a Normal approximation for large datasets (&gt; normal_approx_threshold) for better performance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>predictions_proba</code>
            </td>
            <td>
                  <code><span title="DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing the probability predictions; must have a single column named 'pred_proba'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weights</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of weights, of the same length as the DataFrame rows, to apply to each prediction.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>normal_approx_threshold</code>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <span title="optional">optional</span>(default=30))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the number of rows in predictions_proba exceeds this threshold, use a Normal distribution approximation.
Set to None or a very large number to always use the exact symbolic computation.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame with a single column 'agg_proba' showing the aggregated probability,
indexed from 0 to n, where n is the number of predictions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pred_proba_to_agg_predicted</span><span class="p">(</span>
    <span class="n">predictions_proba</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_approx_threshold</span><span class="o">=</span><span class="mi">30</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert individual probability predictions into aggregate predicted probability distribution using optional weights.</span>
<span class="sd">    Uses a Normal approximation for large datasets (&gt; normal_approx_threshold) for better performance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions_proba : DataFrame</span>
<span class="sd">        A DataFrame containing the probability predictions; must have a single column named &#39;pred_proba&#39;.</span>
<span class="sd">    weights : array-like, optional</span>
<span class="sd">        An array of weights, of the same length as the DataFrame rows, to apply to each prediction.</span>
<span class="sd">    normal_approx_threshold : int, optional (default=30)</span>
<span class="sd">        If the number of rows in predictions_proba exceeds this threshold, use a Normal distribution approximation.</span>
<span class="sd">        Set to None or a very large number to always use the exact symbolic computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">        A DataFrame with a single column &#39;agg_proba&#39; showing the aggregated probability,</span>
<span class="sd">        indexed from 0 to n, where n is the number of predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions_proba</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">normal_approx_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">normal_approx_threshold</span><span class="p">:</span>
        <span class="c1"># Apply a normal approximation for large datasets</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

        <span class="c1"># Apply weights if provided</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">predictions_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">predictions_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Calculate mean and variance for the normal approximation</span>
        <span class="c1"># For a sum of Bernoulli variables, mean = sum of probabilities</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Variance = sum of p_i * (1-p_i)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probs</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Handle the case where variance is zero (all probabilities are 0 or 1)</span>
        <span class="k">if</span> <span class="n">variance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If variance is zero, all probabilities are the same (either all 0 or all 1)</span>
            <span class="c1"># The distribution is deterministic - all probability mass is at the mean</span>
            <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">)):</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate probabilities for each possible count using normal approximation</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="c1"># Probability that count = i is the probability that a normal RV falls between i-0.5 and i+0.5</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span>
                        <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">agg_predicted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

            <span class="c1"># Normalize to ensure the probabilities sum to 1</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">agg_predicted_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">agg_predicted_dict</span><span class="p">:</span>
                    <span class="n">agg_predicted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If all probabilities are zero, set a uniform distribution</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agg_predicted_dict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">agg_predicted_dict</span><span class="p">:</span>
                    <span class="n">agg_predicted_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use the original symbolic computation for smaller datasets</span>
        <span class="n">local_proba</span> <span class="o">=</span> <span class="n">predictions_proba</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">weights</span>

        <span class="n">syms</span> <span class="o">=</span> <span class="n">create_symbols</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">build_expression</span><span class="p">(</span><span class="n">syms</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression_subs</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">local_proba</span><span class="p">[</span><span class="s2">&quot;pred_proba&quot;</span><span class="p">])</span>
        <span class="n">agg_predicted_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">return_coeff</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

    <span class="n">agg_predicted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">agg_predicted_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">agg_predicted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.aggregate.return_coeff" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">return_coeff</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extract the coefficient of a specified power from an expanded symbolic expression.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>expression</code>
            </td>
            <td>
                  <code><span title="Expr">Expr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The expression to expand and extract from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The power of the term whose coefficient is to be extracted.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="number">number</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coefficient of the specified power in the expression.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/aggregate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">return_coeff</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the coefficient of a specified power from an expanded symbolic expression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression : Expr</span>
<span class="sd">        The expression to expand and extract from.</span>
<span class="sd">    i : int</span>
<span class="sd">        The power of the term whose coefficient is to be extracted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    number</span>
<span class="sd">        The coefficient of the specified power in the expression.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expand</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="o">.</span><span class="n">coeff</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.calculate" class="doc doc-heading">
            <code>calculate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Calculation module for patient flow metrics.</p>
<p>This module provides functions for calculating various patient flow metrics such as
arrival rates and admission probabilities within prediction windows.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.calculate.admission_in_prediction_window" class="doc doc-heading">
            <code>admission_in_prediction_window</code>


</h3>

    <div class="doc doc-contents ">

        <p>This module provides functions to model and analyze a curve consisting of an exponential growth segment followed by an exponential decay segment. It includes functions to create the curve, calculate specific points on it, and evaluate probabilities based on its shape.</p>
<p>Its intended use is to derive the probability of a patient being admitted to a hospital within a certain elapsed time after their arrival in the Emergency Department (ED), given the hospital's aspirations for the time it takes patients to be admitted.
For this purpose, two points on the curve are required as parameters:</p>
<pre><code>* (x1,y1) : The target proportion of patients y1 (eg 76%) who have been admitted or discharged by time x1 (eg 4 hours).
* (x2, y2) : The time x2 by which all but a small proportion y2 of patients have been admitted.
</code></pre>
<p>It is assumed that values of y where x &lt; x1 is a growth curve grow exponentially towards x1 and that (x1,y1) the curve switches to a decay curve.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.admission_in_prediction_window.growth_curve : function">growth_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate exponential growth at a point where x &lt; x1.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.admission_in_prediction_window.decay_curve : function">decay_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate exponential decay at a point where x &gt;= x1.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.admission_in_prediction_window.create_curve : function">create_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate a full curve with both growth and decay segments.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.admission_in_prediction_window.get_y_from_aspirational_curve : function">get_y_from_aspirational_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Read from the curve a value for y, the probability of being admitted, for a given moment x hours after arrival</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.admission_in_prediction_window.calculate_probability : function">calculate_probability : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compute the probability of a patient being admitted by the end of a prediction window, given how much time has elapsed since their arrival.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.admission_in_prediction_window.get_survival_probability : function">get_survival_probability : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate the probability of a patient still being in the ED after a certain time using survival curve data.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.calculate_admission_probability_from_survival_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_admission_probability_from_survival_curve</span><span class="p">(</span><span class="n">elapsed_los</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">survival_df</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates the probability of an admission occurring within a specified prediction window after the moment of prediction,
based on the patient's elapsed time in the ED prior to the moment of prediction and the length of the window.
Uses empirical survival curve data instead of an aspirational curve.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>elapsed_los</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The elapsed time since the patient arrived at the ED.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The duration of the prediction window after the point of prediction, for which the probability is calculated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>survival_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing survival curve data with columns:
- time_hours: Time points in hours
- survival_probability: Probability of still being in ED at each time point</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability of admission occurring within the given prediction window.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function calculates the conditional probability of admission within the prediction window,
given that the patient hasn't been admitted yet. It uses the formula:</p>
<p>P(admission in window | not admitted yet) =
    (P(not admitted at elapsed) - P(not admitted at elapsed + window)) / P(not admitted at elapsed)</p>
<p>Since survival probability = P(not admitted), this becomes:</p>
<p>P(admission in window | not admitted yet) =
    (survival_prob(elapsed) - survival_prob(elapsed + window)) / survival_prob(elapsed)</p>
</details>

<details class="edge-case-handling" open>
  <summary>Edge Case Handling</summary>
  <p>When elapsed_los is extremely high, the survival probability can reach 0, which would cause
division by zero. In such cases, this function returns a probability of 1.0, reflecting
certainty of admission.</p>
<p>When elapsed_hours + prediction_window_hours exceeds the maximum time in the survival data,
the get_survival_probability function will return the last known survival probability and
issue a warning. This may affect the accuracy of the admission probability calculation
if the survival curve hasn't reached its asymptotic value.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <p>Calculate the probability that a patient, who has already been in the ED for 3 hours,
will be admitted in the next 2 hours using empirical survival data.</p>
<blockquote>
<blockquote>
<blockquote>
<p>from datetime import timedelta
survival_df = pd.DataFrame({
...     'time_hours': [0, 2, 4, 6, 8],
...     'survival_probability': [1.0, 0.8, 0.5, 0.2, 0.1]
... })
calculate_admission_probability_from_survival_curve(timedelta(hours=3), timedelta(hours=2), survival_df)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_admission_probability_from_survival_curve</span><span class="p">(</span>
    <span class="n">elapsed_los</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">survival_df</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the probability of an admission occurring within a specified prediction window after the moment of prediction,</span>
<span class="sd">    based on the patient&#39;s elapsed time in the ED prior to the moment of prediction and the length of the window.</span>
<span class="sd">    Uses empirical survival curve data instead of an aspirational curve.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elapsed_los : timedelta</span>
<span class="sd">        The elapsed time since the patient arrived at the ED.</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        The duration of the prediction window after the point of prediction, for which the probability is calculated.</span>
<span class="sd">    survival_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing survival curve data with columns:</span>
<span class="sd">        - time_hours: Time points in hours</span>
<span class="sd">        - survival_probability: Probability of still being in ED at each time point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The probability of admission occurring within the given prediction window.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function calculates the conditional probability of admission within the prediction window,</span>
<span class="sd">    given that the patient hasn&#39;t been admitted yet. It uses the formula:</span>

<span class="sd">    P(admission in window | not admitted yet) =</span>
<span class="sd">        (P(not admitted at elapsed) - P(not admitted at elapsed + window)) / P(not admitted at elapsed)</span>

<span class="sd">    Since survival probability = P(not admitted), this becomes:</span>

<span class="sd">    P(admission in window | not admitted yet) =</span>
<span class="sd">        (survival_prob(elapsed) - survival_prob(elapsed + window)) / survival_prob(elapsed)</span>

<span class="sd">    Edge Case Handling</span>
<span class="sd">    ------------------</span>
<span class="sd">    When elapsed_los is extremely high, the survival probability can reach 0, which would cause</span>
<span class="sd">    division by zero. In such cases, this function returns a probability of 1.0, reflecting</span>
<span class="sd">    certainty of admission.</span>

<span class="sd">    When elapsed_hours + prediction_window_hours exceeds the maximum time in the survival data,</span>
<span class="sd">    the get_survival_probability function will return the last known survival probability and</span>
<span class="sd">    issue a warning. This may affect the accuracy of the admission probability calculation</span>
<span class="sd">    if the survival curve hasn&#39;t reached its asymptotic value.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Calculate the probability that a patient, who has already been in the ED for 3 hours,</span>
<span class="sd">    will be admitted in the next 2 hours using empirical survival data.</span>

<span class="sd">    &gt;&gt;&gt; from datetime import timedelta</span>
<span class="sd">    &gt;&gt;&gt; survival_df = pd.DataFrame({</span>
<span class="sd">    ...     &#39;time_hours&#39;: [0, 2, 4, 6, 8],</span>
<span class="sd">    ...     &#39;survival_probability&#39;: [1.0, 0.8, 0.5, 0.2, 0.1]</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; calculate_admission_probability_from_survival_curve(timedelta(hours=3), timedelta(hours=2), survival_df)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert timedelta to hours</span>
    <span class="n">elapsed_hours</span> <span class="o">=</span> <span class="n">elapsed_los</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
    <span class="n">prediction_window_hours</span> <span class="o">=</span> <span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="c1"># Validate elapsed time to ensure it represents a reasonable time value in hours</span>
    <span class="k">if</span> <span class="n">elapsed_hours</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;elapsed_los must be non-negative (cannot have negative elapsed time)&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">elapsed_hours</span> <span class="o">&gt;</span> <span class="mi">168</span><span class="p">:</span>  <span class="c1"># 168 hours = 1 week</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;elapsed_los appears to be longer than 168 hours (1 week). &quot;</span>
            <span class="s2">&quot;Check that the units of elapsed_los are correct&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">elapsed_hours</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;elapsed_los must be a finite time duration&quot;</span><span class="p">)</span>

    <span class="c1"># Validate prediction window to ensure it represents a reasonable time value in hours</span>
    <span class="k">if</span> <span class="n">prediction_window_hours</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;prediction_window must be non-negative (cannot have negative prediction window)&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">prediction_window_hours</span> <span class="o">&gt;</span> <span class="mi">72</span><span class="p">:</span>  <span class="c1"># 72 hours = 3 days</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;prediction_window appears to be longer than 72 hours (3 days). &quot;</span>
            <span class="s2">&quot;Check that the units of prediction_window are correct&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">prediction_window_hours</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be a finite time duration&quot;</span><span class="p">)</span>

    <span class="c1"># Get survival probabilities using the existing function</span>
    <span class="n">survival_prob_at_elapsed</span> <span class="o">=</span> <span class="n">get_survival_probability</span><span class="p">(</span><span class="n">survival_df</span><span class="p">,</span> <span class="n">elapsed_hours</span><span class="p">)</span>
    <span class="n">survival_prob_at_end_of_window</span> <span class="o">=</span> <span class="n">get_survival_probability</span><span class="p">(</span>
        <span class="n">survival_df</span><span class="p">,</span> <span class="n">elapsed_hours</span> <span class="o">+</span> <span class="n">prediction_window_hours</span>
    <span class="p">)</span>

    <span class="c1"># Direct return for edge cases where survival probability is 0 (patient already admitted)</span>
    <span class="k">if</span> <span class="n">survival_prob_at_elapsed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="c1"># Calculate the conditional probability of admission within the prediction window</span>
    <span class="c1"># given that the patient hasn&#39;t been admitted yet</span>
    <span class="c1"># P(admission in window | not admitted yet) =</span>
    <span class="c1"># (P(not admitted at elapsed) - P(not admitted at elapsed + window)) / P(not admitted at elapsed)</span>
    <span class="n">conditional_prob</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">survival_prob_at_elapsed</span> <span class="o">-</span> <span class="n">survival_prob_at_end_of_window</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">survival_prob_at_elapsed</span>

    <span class="k">return</span> <span class="n">conditional_prob</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.calculate_probability" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_probability</span><span class="p">(</span><span class="n">elapsed_los</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates the probability of an admission occurring within a specified prediction window after the moment of prediction,
based on the patient's elapsed time in the ED prior to the moment of prediction and the length of the window</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>elapsed_los</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The elapsed time since the patient arrived at the ED.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The duration of the prediction window after the point of prediction, for which the probability is calculated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time target for the first key point on the curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The proportion target for the first key point (e.g., 76% of patients admitted by time x1).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time target for the second key point on the curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The proportion target for the second key point (e.g., 99% of patients admitted by time x2).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability of the event occurring within the given prediction window.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="edge-case-handling" open>
  <summary>Edge Case Handling</summary>
  <p>When elapsed_los is extremely high, such as values significantly greater than x2, the admission probability prior to the current time (<code>prob_admission_prior_to_now</code>) can reach 1.0 despite the curve being asymptotic. This scenario can cause computational errors when calculating the conditional probability, as it involves a division by zero. In such cases, this function directly returns a probability of 1.0, reflecting certainty of admission.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <p>Calculate the probability that a patient, who has already been in the ED for 3 hours, will be admitted in the next 2 hours. The ED targets that 76% of patients are admitted or discharged within 4 hours, and 99% within 12 hours.</p>
<blockquote>
<blockquote>
<blockquote>
<p>from datetime import timedelta
calculate_probability(timedelta(hours=3), timedelta(hours=2), 4, 0.76, 12, 0.99)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_probability</span><span class="p">(</span>
    <span class="n">elapsed_los</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the probability of an admission occurring within a specified prediction window after the moment of prediction,</span>
<span class="sd">    based on the patient&#39;s elapsed time in the ED prior to the moment of prediction and the length of the window</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elapsed_los : timedelta</span>
<span class="sd">        The elapsed time since the patient arrived at the ED.</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        The duration of the prediction window after the point of prediction, for which the probability is calculated.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        The time target for the first key point on the curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        The proportion target for the first key point (e.g., 76% of patients admitted by time x1).</span>
<span class="sd">    x2 : float</span>
<span class="sd">        The time target for the second key point on the curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        The proportion target for the second key point (e.g., 99% of patients admitted by time x2).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The probability of the event occurring within the given prediction window.</span>

<span class="sd">    Edge Case Handling</span>
<span class="sd">    ------------------</span>
<span class="sd">    When elapsed_los is extremely high, such as values significantly greater than x2, the admission probability prior to the current time (`prob_admission_prior_to_now`) can reach 1.0 despite the curve being asymptotic. This scenario can cause computational errors when calculating the conditional probability, as it involves a division by zero. In such cases, this function directly returns a probability of 1.0, reflecting certainty of admission.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Calculate the probability that a patient, who has already been in the ED for 3 hours, will be admitted in the next 2 hours. The ED targets that 76% of patients are admitted or discharged within 4 hours, and 99% within 12 hours.</span>

<span class="sd">    &gt;&gt;&gt; from datetime import timedelta</span>
<span class="sd">    &gt;&gt;&gt; calculate_probability(timedelta(hours=3), timedelta(hours=2), 4, 0.76, 12, 0.99)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elapsed_los</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;elapsed_los must be a timedelta object&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be a timedelta object&quot;</span><span class="p">)</span>

    <span class="c1"># Convert timedelta to hours</span>
    <span class="n">elapsed_hours</span> <span class="o">=</span> <span class="n">elapsed_los</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
    <span class="n">prediction_window_hours</span> <span class="o">=</span> <span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="c1"># Validate elapsed time to ensure it represents a reasonable time value in hours</span>
    <span class="k">if</span> <span class="n">elapsed_hours</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;elapsed_los must be non-negative (cannot have negative elapsed time)&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">elapsed_hours</span> <span class="o">&gt;</span> <span class="mi">168</span><span class="p">:</span>  <span class="c1"># 168 hours = 1 week</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;elapsed_los appears to be longer than 168 hours (1 week). &quot;</span>
            <span class="s2">&quot;Check that the units of elapsed_los are correct&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">elapsed_hours</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;elapsed_los must be a finite time duration&quot;</span><span class="p">)</span>

    <span class="c1"># Validate prediction window to ensure it represents a reasonable time value in hours</span>
    <span class="k">if</span> <span class="n">prediction_window_hours</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;prediction_window must be non-negative (cannot have negative prediction window)&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">prediction_window_hours</span> <span class="o">&gt;</span> <span class="mi">72</span><span class="p">:</span>  <span class="c1"># 72 hours = 3 days</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;prediction_window appears to be longer than 72 hours (3 days). &quot;</span>
            <span class="s2">&quot;Check that the units of prediction_window are correct&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">prediction_window_hours</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be a finite time duration&quot;</span><span class="p">)</span>

    <span class="c1"># probability of still being in the ED now (a function of elapsed time since arrival)</span>
    <span class="n">prob_admission_prior_to_now</span> <span class="o">=</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
        <span class="n">elapsed_hours</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
    <span class="p">)</span>

    <span class="c1"># prob admission when adding the prediction window added to elapsed time since arrival</span>
    <span class="n">prob_admission_by_end_of_window</span> <span class="o">=</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
        <span class="n">elapsed_hours</span> <span class="o">+</span> <span class="n">prediction_window_hours</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
    <span class="p">)</span>

    <span class="c1"># Direct return for edge cases where `prob_admission_prior_to_now` reaches 1.0</span>
    <span class="k">if</span> <span class="n">prob_admission_prior_to_now</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="c1"># Calculate the conditional probability of admission within the prediction window</span>
    <span class="c1"># given that the patient hasn&#39;t been admitted yet</span>
    <span class="n">conditional_prob</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">prob_admission_by_end_of_window</span> <span class="o">-</span> <span class="n">prob_admission_prior_to_now</span>
    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob_admission_prior_to_now</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conditional_prob</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.create_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_curve</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">generate_values</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generates parameters for an exponential growth and decay curve.
Optionally generates x-values and corresponding y-values across a default or specified range.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-value where the curve transitions from growth to decay.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-value at the transition point x1.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-value defining the end of the decay curve for calculation purposes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-value at x2, intended to fine-tune the decay rate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>a</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initial value coefficient for the growth curve, defaults to 0.01.</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generate_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Flag to determine whether to generate x-values and y-values for visualization purposes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If generate_values is False, returns (gamma, lamda, a).
If generate_values is True, returns (gamma, lamda, a, x_values, y_values).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_curve</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">generate_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates parameters for an exponential growth and decay curve.</span>
<span class="sd">    Optionally generates x-values and corresponding y-values across a default or specified range.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x1 : float</span>
<span class="sd">        The x-value where the curve transitions from growth to decay.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        The y-value at the transition point x1.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        The x-value defining the end of the decay curve for calculation purposes.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        The y-value at x2, intended to fine-tune the decay rate.</span>
<span class="sd">    a : float, optional</span>
<span class="sd">        The initial value coefficient for the growth curve, defaults to 0.01.</span>
<span class="sd">    generate_values : bool, optional</span>
<span class="sd">        Flag to determine whether to generate x-values and y-values for visualization purposes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        If generate_values is False, returns (gamma, lamda, a).</span>
<span class="sd">        If generate_values is True, returns (gamma, lamda, a, x_values, y_values).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x1 must be less than x2&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;y1 must be less than y2, and both must be between 0 and 1&quot;</span><span class="p">)</span>

    <span class="c1"># Constants for growth and decay</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y1</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">x1</span>
    <span class="n">lamda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">generate_values</span><span class="p">:</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">y_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">growth_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x1</span> <span class="k">else</span> <span class="n">decay_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">lamda</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_values</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lamda</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span>

    <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lamda</span><span class="p">,</span> <span class="n">a</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.decay_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decay_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">lamda</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the exponential decay value at a given x using specified parameters.
The function supports both scalar and array inputs for x.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-value(s) at which to evaluate the curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-value where the growth curve transitions to the decay curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-value at the transition point, where the decay curve starts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lamda</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The decay rate coefficient.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-value(s) of the decay curve at x.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">decay_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">lamda</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the exponential decay value at a given x using specified parameters.</span>
<span class="sd">    The function supports both scalar and array inputs for x.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float or np.ndarray</span>
<span class="sd">        The x-value(s) at which to evaluate the curve.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        The x-value where the growth curve transitions to the decay curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        The y-value at the transition point, where the decay curve starts.</span>
<span class="sd">    lamda : float</span>
<span class="sd">        The decay rate coefficient.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or np.ndarray</span>
<span class="sd">        The y-value(s) of the decay curve at x.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">y1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lamda</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.get_survival_probability" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_survival_probability</span><span class="p">(</span><span class="n">survival_df</span><span class="p">,</span> <span class="n">time_hours</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the probability of a patient still being in the ED after a specified time
using survival curve data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>survival_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing survival curve data with columns:
- time_hours: Time points in hours
- survival_probability: Probability of still being in ED at each time point</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_hours</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time point (in hours) at which to calculate the survival probability</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability of still being in the ED at the specified time</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>If the exact time_hours is not in the survival curve data, the function will
  interpolate between the nearest time points</li>
<li>If time_hours is less than the minimum time in the data, returns 1.0</li>
<li>If time_hours is greater than the maximum time in the data, uses exponential
  decay extrapolation based on the last few data points</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">survival_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="gp">... </span>    <span class="s1">&#39;time_hours&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;survival_probability&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="gp">... </span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_survival_probability</span><span class="p">(</span><span class="n">survival_df</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="go">0.65  # interpolated between 0.8 and 0.5</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_survival_probability</span><span class="p">(</span><span class="n">survival_df</span><span class="p">,</span> <span class="n">time_hours</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the probability of a patient still being in the ED after a specified time</span>
<span class="sd">    using survival curve data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    survival_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing survival curve data with columns:</span>
<span class="sd">        - time_hours: Time points in hours</span>
<span class="sd">        - survival_probability: Probability of still being in ED at each time point</span>
<span class="sd">    time_hours : float</span>
<span class="sd">        The time point (in hours) at which to calculate the survival probability</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The probability of still being in the ED at the specified time</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - If the exact time_hours is not in the survival curve data, the function will</span>
<span class="sd">      interpolate between the nearest time points</span>
<span class="sd">    - If time_hours is less than the minimum time in the data, returns 1.0</span>
<span class="sd">    - If time_hours is greater than the maximum time in the data, uses exponential</span>
<span class="sd">      decay extrapolation based on the last few data points</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; survival_df = pd.DataFrame({</span>
<span class="sd">    ...     &#39;time_hours&#39;: [0, 2, 4, 6],</span>
<span class="sd">    ...     &#39;survival_probability&#39;: [1.0, 0.8, 0.5, 0.2]</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; get_survival_probability(survival_df, 3.5)</span>
<span class="sd">    0.65  # interpolated between 0.8 and 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_hours</span> <span class="o">&lt;</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">time_hours</span> <span class="o">&gt;</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
        <span class="c1"># Use exponential decay extrapolation for times beyond the data</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">max_prob</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Track whether we attempted exponential fitting and whether it failed</span>
        <span class="n">attempted_exponential_fitting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">exponential_fitting_failed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Use the last 3 points to fit exponential decay if available</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survival_df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">attempted_exponential_fitting</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Get the last 3 points for fitting</span>
            <span class="n">last_times</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">last_probs</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Fit exponential decay: P(t) = P0 * exp(-lambda * (t - t0))</span>
            <span class="c1"># where P0 is the probability at t0, and lambda is the decay rate</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">last_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">P0</span> <span class="o">=</span> <span class="n">last_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Calculate decay rate lambda using the last two points</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">last_times</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">last_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span> <span class="o">=</span> <span class="n">last_probs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">last_probs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># For exponential fitting, replace P2 = 0 with a small positive value</span>
            <span class="c1"># to ensure the decay can be calculated while maintaining asymptotic behavior</span>
            <span class="k">if</span> <span class="n">P2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">P2_fit</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># Small positive value for fitting</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">P2_fit</span> <span class="o">=</span> <span class="n">P2</span>

            <span class="c1"># lambda = -ln(P2/P1) / (t2 - t1)</span>
            <span class="k">if</span> <span class="n">P2_fit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">P1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="p">:</span>
                <span class="n">lambda_decay</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P2_fit</span> <span class="o">/</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>

                <span class="c1"># Extrapolate using exponential decay</span>
                <span class="n">extrapolated_prob</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambda_decay</span> <span class="o">*</span> <span class="p">(</span><span class="n">time_hours</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

                <span class="c1"># Ensure the probability doesn&#39;t go below 0</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">extrapolated_prob</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exponential_fitting_failed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Fallback: use the last known value if exponential fitting fails</span>
        <span class="c1"># Only warn if we actually attempted exponential fitting but it failed</span>
        <span class="k">if</span> <span class="n">attempted_exponential_fitting</span> <span class="ow">and</span> <span class="n">exponential_fitting_failed</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Time </span><span class="si">{</span><span class="n">time_hours</span><span class="si">}</span><span class="s2"> hours exceeds maximum time in survival data &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">max_time</span><span class="si">}</span><span class="s2"> hours). Exponential fitting failed (invalid data), using last known survival probability &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">max_prob</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) as fallback.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">max_prob</span>

    <span class="c1"># Find the closest time points for interpolation</span>
    <span class="n">lower_idx</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time_hours</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">upper_idx</span> <span class="o">=</span> <span class="n">lower_idx</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">lower_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">upper_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">survival_df</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get the surrounding points</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lower_idx</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">upper_idx</span><span class="p">]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lower_idx</span><span class="p">]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">upper_idx</span><span class="p">]</span>

    <span class="c1"># Linear interpolation</span>
    <span class="k">return</span> <span class="n">p1</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">time_hours</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.get_y_from_aspirational_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the probability y that a patient will have been admitted by a specified x after their arrival, by reading from the aspirational curve that has been constrained to pass through points (x1, y1) and (x2, y2) with an exponential growth curve where x &lt; x1 and an exponential decay where x &lt; x2</p>
<p>The function handles scalar or array inputs for x and determines y using either an exponential growth curve (for x &lt; x1)
or an exponential decay curve (for x &gt;= x1). The curve parameters are derived to ensure the curve passes through
specified points (x1, y1) and (x2, y2).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-coordinate(s) at which to calculate the y-value on the curve. Can be a single value or an array of values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-coordinate of the first key point on the curve, where the growth phase ends and the decay phase begins.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-coordinate of the first key point (x1), representing the target proportion of patients admitted by time x1.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-coordinate of the second key point on the curve, beyond which all but a few patients are expected to be admitted.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-coordinate of the second key point (x2), representing the target proportion of patients admitted by time x2.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculated y-value(s) (probability of admission) at the given x. The type of the return matches the input type
for x (either scalar or array).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the probability y that a patient will have been admitted by a specified x after their arrival, by reading from the aspirational curve that has been constrained to pass through points (x1, y1) and (x2, y2) with an exponential growth curve where x &lt; x1 and an exponential decay where x &lt; x2</span>

<span class="sd">    The function handles scalar or array inputs for x and determines y using either an exponential growth curve (for x &lt; x1)</span>
<span class="sd">    or an exponential decay curve (for x &gt;= x1). The curve parameters are derived to ensure the curve passes through</span>
<span class="sd">    specified points (x1, y1) and (x2, y2).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float or np.ndarray</span>
<span class="sd">        The x-coordinate(s) at which to calculate the y-value on the curve. Can be a single value or an array of values.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        The x-coordinate of the first key point on the curve, where the growth phase ends and the decay phase begins.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        The y-coordinate of the first key point (x1), representing the target proportion of patients admitted by time x1.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        The x-coordinate of the second key point on the curve, beyond which all but a few patients are expected to be admitted.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        The y-coordinate of the second key point (x2), representing the target proportion of patients admitted by time x2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or np.ndarray</span>
<span class="sd">        The calculated y-value(s) (probability of admission) at the given x. The type of the return matches the input type</span>
<span class="sd">        for x (either scalar or array).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span><span class="p">,</span> <span class="n">lamda</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">create_curve</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x1</span><span class="p">,</span> <span class="n">growth_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gamma</span><span class="p">),</span> <span class="n">decay_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">lamda</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.admission_in_prediction_window.growth_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">growth_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the exponential growth value at a given x using specified parameters.
The function supports both scalar and array inputs for x.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The x-value(s) at which to evaluate the curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>a</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coefficient that defines the starting point of the growth curve when x is 0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gamma</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The growth rate coefficient of the curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-value(s) of the growth curve at x.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/admission_in_prediction_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">growth_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the exponential growth value at a given x using specified parameters.</span>
<span class="sd">    The function supports both scalar and array inputs for x.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float or np.ndarray</span>
<span class="sd">        The x-value(s) at which to evaluate the curve.</span>
<span class="sd">    a : float</span>
<span class="sd">        The coefficient that defines the starting point of the growth curve when x is 0.</span>
<span class="sd">    gamma : float</span>
<span class="sd">        The growth rate coefficient of the curve.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or np.ndarray</span>
<span class="sd">        The y-value(s) of the growth curve at x.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.calculate.arrival_rates" class="doc doc-heading">
            <code>arrival_rates</code>


</h3>

    <div class="doc doc-contents ">

        <p>Calculate and process time-varying arrival rates and admission probabilities.</p>
<p>This module provides functions for calculating arrival rates, admission probabilities,
and unfettered demand rates for inpatient arrivals using an aspirational approach.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.arrival_rates.time_varying_arrival_rates : function">time_varying_arrival_rates : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate arrival rates for each time interval across the dataset's date range.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.arrival_rates.time_varying_arrival_rates_lagged : function">time_varying_arrival_rates_lagged : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create lagged arrival rates based on time intervals.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.arrival_rates.admission_probabilities : function">admission_probabilities : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compute cumulative and hourly admission probabilities using aspirational curves.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.arrival_rates.weighted_arrival_rates : function">weighted_arrival_rates : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Aggregate weighted arrival rates for specific time intervals.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.arrival_rates.unfettered_demand_by_hour : function">unfettered_demand_by_hour : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Estimate inpatient demand by hour using historical data and aspirational curves.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.calculate.arrival_rates.count_yet_to_arrive : function">count_yet_to_arrive : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Count patients who arrived after prediction times and were admitted within prediction windows.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>All times are handled in local timezone</li>
<li>Arrival rates are normalized by the number of unique days in the dataset</li>
<li>Demand calculations consider both historical patterns and admission probabilities</li>
<li>Time intervals must divide evenly into 24 hours</li>
<li>Aspirational curves use (x1,y1) and (x2,y2) coordinates to model admission probabilities</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Generate random arrival times over a week</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># For reproducibility</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n_arrivals</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">random_times</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">)</span> <span class="o">+</span>
<span class="gp">... </span>    <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="o">+</span>
<span class="gp">... </span>    <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="o">+</span>
<span class="gp">... </span>    <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_arrivals</span><span class="p">)</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">random_times</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Calculate various rates and demand</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rates</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">lagged_rates</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates_lagged</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lagged_by</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">demand</span> <span class="o">=</span> <span class="n">unfettered_demand_by_hour</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
</code></pre></div>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.admission_probabilities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">admission_probabilities</span><span class="p">(</span><span class="n">hours_since_arrival</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate probability of admission for each hour since arrival.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hours_since_arrival</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of hours since arrival.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate of the aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate of the aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate of the aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate of the aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
- np.ndarray: Cumulative admission probabilities
- np.ndarray: Hourly admission probabilities</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The aspirational curve is defined by two points (x1,y1) and (x2,y2) and is used
to model the probability of admission over time.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">admission_probabilities</span><span class="p">(</span>
    <span class="n">hours_since_arrival</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate probability of admission for each hour since arrival.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hours_since_arrival : np.ndarray</span>
<span class="sd">        Array of hours since arrival.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate of the aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate of the aspirational curve.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate of the aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate of the aspirational curve.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - np.ndarray: Cumulative admission probabilities</span>
<span class="sd">        - np.ndarray: Hourly admission probabilities</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The aspirational curve is defined by two points (x1,y1) and (x2,y2) and is used</span>
<span class="sd">    to model the probability of admission over time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prob_admission_by_hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours_since_arrival</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">prob_admission_within_hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">prob_admission_by_hour</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_admission_by_hour</span><span class="p">,</span> <span class="n">prob_admission_within_hour</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.count_yet_to_arrive" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">count_yet_to_arrive</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">snapshot_dates</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">prediction_window_hours</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Count patients who arrived after prediction times and were admitted within prediction windows.</p>
<p>This function counts patients who arrived after specified prediction times and were
admitted to a ward within the specified prediction window for each combination of
snapshot date and prediction time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing patient data with 'arrival_datetime',
'admitted_to_ward_datetime', and 'patient_id' columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>snapshot_dates</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dates (datetime.date objects) to analyze.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (hour, minute) tuples representing prediction times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window_hours</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of prediction window in hours after the prediction time.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with columns:
- 'snapshot_date': The date of the snapshot
- 'prediction_time': Tuple of (hour, minute) for the prediction time
- 'count': Number of unique patients who arrived after prediction time
          and were admitted within the prediction window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If df is not a DataFrame or if required columns are missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prediction_window_hours is not positive.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function is useful for analyzing historical patterns of patient arrivals
and admissions to inform predictive models for emergency department demand.
Only patients with non-null admitted_to_ward_datetime are counted.</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prediction_times</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">snapshot_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">count_yet_to_arrive</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">snapshot_dates</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_yet_to_arrive</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">snapshot_dates</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">prediction_window_hours</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count patients who arrived after prediction times and were admitted within prediction windows.</span>

<span class="sd">    This function counts patients who arrived after specified prediction times and were</span>
<span class="sd">    admitted to a ward within the specified prediction window for each combination of</span>
<span class="sd">    snapshot date and prediction time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A DataFrame containing patient data with &#39;arrival_datetime&#39;,</span>
<span class="sd">        &#39;admitted_to_ward_datetime&#39;, and &#39;patient_id&#39; columns.</span>
<span class="sd">    snapshot_dates : list</span>
<span class="sd">        List of dates (datetime.date objects) to analyze.</span>
<span class="sd">    prediction_times : list</span>
<span class="sd">        List of (hour, minute) tuples representing prediction times.</span>
<span class="sd">    prediction_window_hours : float</span>
<span class="sd">        Length of prediction window in hours after the prediction time.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with columns:</span>
<span class="sd">        - &#39;snapshot_date&#39;: The date of the snapshot</span>
<span class="sd">        - &#39;prediction_time&#39;: Tuple of (hour, minute) for the prediction time</span>
<span class="sd">        - &#39;count&#39;: Number of unique patients who arrived after prediction time</span>
<span class="sd">                  and were admitted within the prediction window</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If df is not a DataFrame or if required columns are missing.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If prediction_window_hours is not positive.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is useful for analyzing historical patterns of patient arrivals</span>
<span class="sd">    and admissions to inform predictive models for emergency department demand.</span>
<span class="sd">    Only patients with non-null admitted_to_ward_datetime are counted.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; from datetime import date, time</span>
<span class="sd">    &gt;&gt;&gt; prediction_times = [(12, 0), (15, 30)]</span>
<span class="sd">    &gt;&gt;&gt; snapshot_dates = [date(2023, 1, 1), date(2023, 1, 2)]</span>
<span class="sd">    &gt;&gt;&gt; results = count_yet_to_arrive(df, snapshot_dates, prediction_times, 8.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The input &#39;df&#39; must be a pandas DataFrame.&quot;</span><span class="p">)</span>

    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;admitted_to_ward_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;patient_id&quot;</span><span class="p">]</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataFrame missing required columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window_hours</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="ow">or</span> <span class="n">prediction_window_hours</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prediction_window_hours must be a positive number.&quot;</span><span class="p">)</span>

    <span class="c1"># Create an empty list to store results</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># For each combination of date and time</span>
    <span class="k">for</span> <span class="n">date_val</span> <span class="ow">in</span> <span class="n">snapshot_dates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
            <span class="c1"># Create the prediction datetime</span>
            <span class="n">prediction_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date_val</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Calculate the end of the prediction window</span>
            <span class="n">prediction_window_end</span> <span class="o">=</span> <span class="n">prediction_datetime</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span>
                <span class="n">hours</span><span class="o">=</span><span class="n">prediction_window_hours</span>
            <span class="p">)</span>

            <span class="c1"># Count patients who arrived after prediction time and were admitted within the window</span>
            <span class="n">admitted_within_window</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prediction_datetime</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;admitted_to_ward_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">prediction_window_end</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Store the result</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;snapshot_date&quot;</span><span class="p">:</span> <span class="n">date_val</span><span class="p">,</span>
                    <span class="s2">&quot;prediction_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">),</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">admitted_within_window</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="c1"># Convert results to a DataFrame</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.process_arrival_rates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_arrival_rates</span><span class="p">(</span><span class="n">arrival_rates_dict</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Process arrival rates dictionary into formats needed for plotting.</p>


<details class="----parameters" open>
  <summary><pre><code>Parameters
</code></pre></summary>
  <pre><code>arrival_rates_dict : Dict[datetime.time, float]
    Mapping of times to arrival rates.
</code></pre>
</details>

<details class="----returns" open>
  <summary><pre><code>Returns
</code></pre></summary>
  <pre><code>Tuple[List[float], List[str], List[int]]
    A tuple containing:
    - List[float]: Arrival rate values
    - List[str]: Formatted hour range strings (e.g., "09-
</code></pre>
<p>10")
        - List[int]: Integers for x-axis positioning</p>
</details>

<details class="----notes" open>
  <summary><pre><code>Notes
</code></pre></summary>
  <pre><code>The hour labels are formatted with line breaks for better plot readability.
</code></pre>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_arrival_rates</span><span class="p">(</span>
    <span class="n">arrival_rates_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process arrival rates dictionary into formats needed for plotting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arrival_rates_dict : Dict[datetime.time, float]</span>
<span class="sd">        Mapping of times to arrival rates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[List[float], List[str], List[int]]</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - List[float]: Arrival rate values</span>
<span class="sd">        - List[str]: Formatted hour range strings (e.g., &quot;09-\n10&quot;)</span>
<span class="sd">        - List[int]: Integers for x-axis positioning</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The hour labels are formatted with line breaks for better plot readability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract hours and rates</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrival_rates_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">arrival_rates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrival_rates_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Create formatted hour labels with line breaks for better plot readability</span>
    <span class="n">hour_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hour</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">((</span><span class="n">hour</span><span class="o">.</span><span class="n">hour</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span>
    <span class="p">]</span>

    <span class="c1"># Generate numerical values for x-axis positioning</span>
    <span class="n">hour_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hour_labels</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">hour_labels</span><span class="p">,</span> <span class="n">hour_values</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.time_varying_arrival_rates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">time_varying_arrival_rates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the time-varying arrival rates for a dataset indexed by datetime.</p>
<p>This function computes the arrival rates for each time interval specified, across
the entire date range present in the dataframe. The arrival rate is calculated as
the number of entries in the dataframe for each time interval, divided by the
number of days in the dataset's timespan.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame indexed by datetime, representing the data for which arrival rates
are to be calculated. The index of the DataFrame should be of datetime type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a> or <a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time interval for which the arrival rates are to be calculated.
If int, assumed to be in minutes. If timedelta, will be converted to minutes.
For example, if <code>yta_time_interval=60</code>, the function will calculate hourly
arrival rates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days that the DataFrame spans. If not provided, the number of
days is calculated from the date of the min and max arrival datetimes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, enable info-level logging. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="collections.OrderedDict" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a>[<a class="autorefs autorefs-external" title="datetime.datetime.time" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.time">time</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping times to arrival rates, where times are datetime.time
objects and rates are float values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If 'df' is not a pandas DataFrame, 'yta_time_interval' is not an integer or timedelta,
or the DataFrame index is not a DatetimeIndex.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If 'yta_time_interval' is less than or equal to 0 or does not divide evenly
into 24 hours.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The minimum and maximum dates in the dataset are used to determine the timespan
if num_days is not provided.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">time_varying_arrival_rates</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">],</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the time-varying arrival rates for a dataset indexed by datetime.</span>

<span class="sd">    This function computes the arrival rates for each time interval specified, across</span>
<span class="sd">    the entire date range present in the dataframe. The arrival rate is calculated as</span>
<span class="sd">    the number of entries in the dataframe for each time interval, divided by the</span>
<span class="sd">    number of days in the dataset&#39;s timespan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A DataFrame indexed by datetime, representing the data for which arrival rates</span>
<span class="sd">        are to be calculated. The index of the DataFrame should be of datetime type.</span>
<span class="sd">    yta_time_interval : int or timedelta</span>
<span class="sd">        The time interval for which the arrival rates are to be calculated.</span>
<span class="sd">        If int, assumed to be in minutes. If timedelta, will be converted to minutes.</span>
<span class="sd">        For example, if `yta_time_interval=60`, the function will calculate hourly</span>
<span class="sd">        arrival rates.</span>
<span class="sd">    num_days : int, optional</span>
<span class="sd">        The number of days that the DataFrame spans. If not provided, the number of</span>
<span class="sd">        days is calculated from the date of the min and max arrival datetimes.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        If True, enable info-level logging. Defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict[datetime.time, float]</span>
<span class="sd">        A dictionary mapping times to arrival rates, where times are datetime.time</span>
<span class="sd">        objects and rates are float values.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If &#39;df&#39; is not a pandas DataFrame, &#39;yta_time_interval&#39; is not an integer or timedelta,</span>
<span class="sd">        or the DataFrame index is not a DatetimeIndex.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If &#39;yta_time_interval&#39; is less than or equal to 0 or does not divide evenly</span>
<span class="sd">        into 24 hours.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The minimum and maximum dates in the dataset are used to determine the timespan</span>
<span class="sd">    if num_days is not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># Create logger with a unique name</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.time_varying_arrival_rates&quot;</span><span class="p">)</span>

        <span class="c1"># Only set up handlers if they don&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="c1"># Create handler that writes to sys.stdout</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="c1"># Create a formatting configuration</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

            <span class="c1"># Add the handler to the logger</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

            <span class="c1"># Prevent propagation to root logger</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The input &#39;df&#39; must be a pandas DataFrame.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;The parameter &#39;yta_time_interval&#39; must be an integer or timedelta.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The DataFrame index must be a pandas DatetimeIndex.&quot;</span><span class="p">)</span>

    <span class="c1"># Handle both timedelta and numeric inputs for yta_time_interval</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="n">yta_time_interval_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">yta_time_interval_minutes</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be a timedelta object or integer&quot;</span><span class="p">)</span>

    <span class="c1"># Validate time interval</span>
    <span class="n">minutes_in_day</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="k">if</span> <span class="n">yta_time_interval_minutes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;yta_time_interval&#39; must be positive.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minutes_in_day</span> <span class="o">%</span> <span class="n">yta_time_interval_minutes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Time interval (</span><span class="si">{</span><span class="n">yta_time_interval_minutes</span><span class="si">}</span><span class="s2"> minutes) must divide evenly into 24 hours.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">num_days</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Calculate total days between first and last date</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inferring number of days from dataset&quot;</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">num_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">num_days</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataFrame contains no data.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculating time-varying arrival rates for data provided, which spans </span><span class="si">{</span><span class="n">num_days</span><span class="si">}</span><span class="s2"> unique dates&quot;</span>
        <span class="p">)</span>

    <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="c1"># Initialize a time object to iterate through one day in the specified intervals</span>
    <span class="n">_start_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_stop_datetime</span> <span class="o">=</span> <span class="n">_start_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Iterate over each interval in a single day to calculate the arrival rate</span>
    <span class="k">while</span> <span class="n">_start_datetime</span> <span class="o">!=</span> <span class="n">_stop_datetime</span><span class="p">:</span>
        <span class="n">_start_time</span> <span class="o">=</span> <span class="n">_start_datetime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_end_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_start_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">yta_time_interval_minutes</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Filter the dataframe for entries within the current time interval</span>
        <span class="n">_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">between_time</span><span class="p">(</span><span class="n">_start_time</span><span class="p">,</span> <span class="n">_end_time</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate and store the arrival rate for the interval</span>
        <span class="n">arrival_rates_dict</span><span class="p">[</span><span class="n">_start_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_days</span>

        <span class="c1"># Move to the next interval</span>
        <span class="n">_start_datetime</span> <span class="o">=</span> <span class="n">_start_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">yta_time_interval_minutes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arrival_rates_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.time_varying_arrival_rates_lagged" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">time_varying_arrival_rates_lagged</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lagged_by</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate lagged time-varying arrival rates for a dataset indexed by datetime.</p>
<p>This function first calculates the basic arrival rates and then adjusts them by
a specified lag time, returning the rates sorted by the lagged times.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame indexed by datetime, representing the data for which arrival rates
are to be calculated. The index must be a DatetimeIndex.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lagged_by</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of hours to lag the arrival times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days that the DataFrame spans. If not provided, the number of
days is calculated from the date of the min and max arrival datetimes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a> or <a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time interval for which the arrival rates are to be calculated.
If int, assumed to be in minutes. If timedelta, will be converted to minutes.
Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="collections.OrderedDict" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a>[<a class="autorefs autorefs-external" title="datetime.datetime.time" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.time">time</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping lagged times (datetime.time objects) to their
corresponding arrival rates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If df is not a DataFrame, lagged_by is not an integer, yta_time_interval is not an integer or timedelta,
or DataFrame index is not DatetimeIndex.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If lagged_by is negative or yta_time_interval is not positive.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The lagged times are calculated by adding the specified number of hours to each
time in the original arrival rates dictionary.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">time_varying_arrival_rates_lagged</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">lagged_by</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate lagged time-varying arrival rates for a dataset indexed by datetime.</span>

<span class="sd">    This function first calculates the basic arrival rates and then adjusts them by</span>
<span class="sd">    a specified lag time, returning the rates sorted by the lagged times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A DataFrame indexed by datetime, representing the data for which arrival rates</span>
<span class="sd">        are to be calculated. The index must be a DatetimeIndex.</span>
<span class="sd">    lagged_by : int</span>
<span class="sd">        Number of hours to lag the arrival times.</span>
<span class="sd">    num_days : int, optional</span>
<span class="sd">        The number of days that the DataFrame spans. If not provided, the number of</span>
<span class="sd">        days is calculated from the date of the min and max arrival datetimes.</span>
<span class="sd">    yta_time_interval : int or timedelta, optional</span>
<span class="sd">        The time interval for which the arrival rates are to be calculated.</span>
<span class="sd">        If int, assumed to be in minutes. If timedelta, will be converted to minutes.</span>
<span class="sd">        Defaults to 60.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict[datetime.time, float]</span>
<span class="sd">        A dictionary mapping lagged times (datetime.time objects) to their</span>
<span class="sd">        corresponding arrival rates.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If df is not a DataFrame, lagged_by is not an integer, yta_time_interval is not an integer or timedelta,</span>
<span class="sd">        or DataFrame index is not DatetimeIndex.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If lagged_by is negative or yta_time_interval is not positive.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The lagged times are calculated by adding the specified number of hours to each</span>
<span class="sd">    time in the original arrival rates dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The input &#39;df&#39; must be a pandas DataFrame.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lagged_by</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;lagged_by&#39; must be an integer.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;The parameter &#39;yta_time_interval&#39; must be an integer or timedelta.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The DataFrame index must be a pandas DatetimeIndex.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lagged_by</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;lagged_by&#39; must be non-negative.&quot;</span><span class="p">)</span>

    <span class="c1"># Handle both timedelta and numeric inputs for yta_time_interval</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="n">yta_time_interval_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">yta_time_interval_minutes</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be a timedelta object or integer&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">yta_time_interval_minutes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;yta_time_interval&#39; must be positive.&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate base arrival rates</span>
    <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
    <span class="p">)</span>

    <span class="c1"># Apply lag to the times</span>
    <span class="n">lagged_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">reference_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Use arbitrary reference date</span>

    <span class="k">for</span> <span class="n">base_time</span><span class="p">,</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">arrival_rates_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Combine with reference date and apply lag</span>
        <span class="n">lagged_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">reference_date</span><span class="p">,</span> <span class="n">base_time</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
            <span class="n">hours</span><span class="o">=</span><span class="n">lagged_by</span>
        <span class="p">)</span>
        <span class="n">lagged_dict</span><span class="p">[</span><span class="n">lagged_datetime</span><span class="o">.</span><span class="n">time</span><span class="p">()]</span> <span class="o">=</span> <span class="n">rate</span>

    <span class="c1"># Sort by lagged times</span>
    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lagged_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.unfettered_demand_by_hour" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">unfettered_demand_by_hour</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">max_hours_since_arrival</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate true inpatient demand by hour based on historical arrival data.</p>
<p>This function estimates demand rates using historical arrival data and an aspirational
curve for admission probabilities. It takes a DataFrame of historical arrivals and
parameters defining an aspirational curve to calculate hourly demand rates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame indexed by datetime, representing historical arrival data.
The index must be a DatetimeIndex.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate of the aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate of the aspirational curve (0-1).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate of the aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate of the aspirational curve (0-1).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a> or <a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval for which the arrival rates are to be calculated.
If int, assumed to be in minutes. If timedelta, will be converted to minutes.
Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_hours_since_arrival</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum hours since arrival to consider. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days that the DataFrame spans. If not provided, the number of
days is calculated from the date of the min and max arrival datetimes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="collections.OrderedDict" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a>[<a class="autorefs autorefs-external" title="datetime.datetime.time" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.time">time</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping times (datetime.time objects) to their corresponding
demand rates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If df is not a DataFrame, coordinates are not floats, or DataFrame index
is not DatetimeIndex.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If coordinates are outside valid ranges, yta_time_interval is not positive,
or doesn't divide evenly into 24 hours.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function combines historical arrival patterns with admission probabilities
to estimate true inpatient demand. The aspirational curve is used to model
how admission probabilities change over time.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unfettered_demand_by_hour</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="n">max_hours_since_arrival</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate true inpatient demand by hour based on historical arrival data.</span>

<span class="sd">    This function estimates demand rates using historical arrival data and an aspirational</span>
<span class="sd">    curve for admission probabilities. It takes a DataFrame of historical arrivals and</span>
<span class="sd">    parameters defining an aspirational curve to calculate hourly demand rates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A DataFrame indexed by datetime, representing historical arrival data.</span>
<span class="sd">        The index must be a DatetimeIndex.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate of the aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate of the aspirational curve (0-1).</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate of the aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate of the aspirational curve (0-1).</span>
<span class="sd">    yta_time_interval : int or timedelta, optional</span>
<span class="sd">        Time interval for which the arrival rates are to be calculated.</span>
<span class="sd">        If int, assumed to be in minutes. If timedelta, will be converted to minutes.</span>
<span class="sd">        Defaults to 60.</span>
<span class="sd">    max_hours_since_arrival : int, optional</span>
<span class="sd">        Maximum hours since arrival to consider. Defaults to 10.</span>
<span class="sd">    num_days : int, optional</span>
<span class="sd">        The number of days that the DataFrame spans. If not provided, the number of</span>
<span class="sd">        days is calculated from the date of the min and max arrival datetimes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict[datetime.time, float]</span>
<span class="sd">        A dictionary mapping times (datetime.time objects) to their corresponding</span>
<span class="sd">        demand rates.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If df is not a DataFrame, coordinates are not floats, or DataFrame index</span>
<span class="sd">        is not DatetimeIndex.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If coordinates are outside valid ranges, yta_time_interval is not positive,</span>
<span class="sd">        or doesn&#39;t divide evenly into 24 hours.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function combines historical arrival patterns with admission probabilities</span>
<span class="sd">    to estimate true inpatient demand. The aspirational curve is used to model</span>
<span class="sd">    how admission probabilities change over time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The input &#39;df&#39; must be a pandas DataFrame.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The DataFrame index must be a pandas DatetimeIndex.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Curve coordinates must be numeric values.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;The parameter &#39;yta_time_interval&#39; must be an integer or timedelta.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_hours_since_arrival</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;max_hours_since_arrival&#39; must be an integer.&quot;</span><span class="p">)</span>

    <span class="c1"># Handle both timedelta and numeric inputs for yta_time_interval</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="n">yta_time_interval_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">yta_time_interval_minutes</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be a timedelta object or integer&quot;</span><span class="p">)</span>

    <span class="c1"># Validate time interval</span>
    <span class="n">minutes_in_day</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="k">if</span> <span class="n">yta_time_interval_minutes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;yta_time_interval&#39; must be positive.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minutes_in_day</span> <span class="o">%</span> <span class="n">yta_time_interval_minutes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Time interval (</span><span class="si">{</span><span class="n">yta_time_interval_minutes</span><span class="si">}</span><span class="s2"> minutes) must divide evenly into 24 hours.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">max_hours_since_arrival</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;max_hours_since_arrival&#39; must be positive.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y1</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Y-coordinates must be between 0 and 1.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="n">x2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x1 must be less than x2.&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate number of intervals in a day</span>
    <span class="n">num_intervals</span> <span class="o">=</span> <span class="n">minutes_in_day</span> <span class="o">//</span> <span class="n">yta_time_interval_minutes</span>

    <span class="c1"># Calculate admission probabilities</span>
    <span class="n">hours_since_arrival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_hours_since_arrival</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">prob_admission_within_hour</span> <span class="o">=</span> <span class="n">admission_probabilities</span><span class="p">(</span>
        <span class="n">hours_since_arrival</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
    <span class="p">)</span>

    <span class="c1"># Calculate base arrival rates from historical data</span>
    <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">yta_time_interval_minutes</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
    <span class="p">)</span>

    <span class="c1"># Convert dict to arrays while preserving order</span>
    <span class="n">hour_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrival_rates_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">arrival_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">arrival_rates_dict</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hour_keys</span><span class="p">])</span>

    <span class="c1"># Initialize array for weighted arrival rates</span>
    <span class="n">weighted_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_hours_since_arrival</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)))</span>

    <span class="c1"># Calculate weighted arrival rates for each hour and elapsed time</span>
    <span class="k">for</span> <span class="n">hour_idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hour_keys</span><span class="p">):</span>
        <span class="n">arrival_rate</span> <span class="o">=</span> <span class="n">arrival_rates</span><span class="p">[</span><span class="n">hour_idx</span><span class="p">]</span>
        <span class="n">weighted_rates</span><span class="p">[:,</span> <span class="n">hour_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">arrival_rate</span> <span class="o">*</span> <span class="n">prob_admission_within_hour</span><span class="p">[:</span><span class="n">max_hours_since_arrival</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Calculate summed demand rates for each hour</span>
    <span class="n">demand_by_hour</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">elapsed_hours</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hours_since_arrival</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">hour_idx</span><span class="p">,</span> <span class="n">hour_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hour_keys</span><span class="p">):</span>
        <span class="n">demand_by_hour</span><span class="p">[</span><span class="n">hour_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_arrival_rates</span><span class="p">(</span>
            <span class="n">weighted_rates</span><span class="p">,</span> <span class="n">elapsed_hours</span><span class="p">,</span> <span class="n">hour_idx</span><span class="p">,</span> <span class="n">num_intervals</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">demand_by_hour</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.arrival_rates.weighted_arrival_rates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weighted_arrival_rates</span><span class="p">(</span><span class="n">weighted_rates</span><span class="p">,</span> <span class="n">elapsed_hours</span><span class="p">,</span> <span class="n">hour_idx</span><span class="p">,</span> <span class="n">num_intervals</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate sum of weighted arrival rates for a specific time interval.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>weighted_rates</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of weighted arrival rates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>elapsed_hours</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#range">range</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of elapsed hours to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hour_idx</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current interval index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_intervals</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of intervals in a day.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sum of weighted arrival rates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function calculates the sum of weighted arrival rates by iterating through
the elapsed hours and considering the appropriate interval index for each hour.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">weighted_arrival_rates</span><span class="p">(</span>
    <span class="n">weighted_rates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">elapsed_hours</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span> <span class="n">hour_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_intervals</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate sum of weighted arrival rates for a specific time interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weighted_rates : np.ndarray</span>
<span class="sd">        Array of weighted arrival rates.</span>
<span class="sd">    elapsed_hours : range</span>
<span class="sd">        Range of elapsed hours to consider.</span>
<span class="sd">    hour_idx : int</span>
<span class="sd">        Current interval index.</span>
<span class="sd">    num_intervals : int</span>
<span class="sd">        Total number of intervals in a day.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Sum of weighted arrival rates.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function calculates the sum of weighted arrival rates by iterating through</span>
<span class="sd">    the elapsed hours and considering the appropriate interval index for each hour.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">elapsed_hour</span> <span class="ow">in</span> <span class="n">elapsed_hours</span><span class="p">:</span>
        <span class="n">interval_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">hour_idx</span> <span class="o">-</span> <span class="n">elapsed_hour</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_intervals</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">weighted_rates</span><span class="p">[</span><span class="n">elapsed_hour</span><span class="p">][</span><span class="n">interval_index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.calculate.survival_curve" class="doc doc-heading">
            <code>survival_curve</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.calculate.survival_curve.calculate_survival_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_survival_curve</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate survival curve data from patient visit data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient visit data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the start time (e.g., arrival_datetime)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the end time (e.g., departure_datetime)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with columns:
- time_hours: Time points in hours
- survival_probability: Survival probabilities at each time point
- event_probability: Event probabilities (1 - survival_probability)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/calculate/survival_curve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_survival_curve</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate survival curve data from patient visit data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient visit data</span>
<span class="sd">    start_time_col : str</span>
<span class="sd">        Name of the column containing the start time (e.g., arrival_datetime)</span>
<span class="sd">    end_time_col : str</span>
<span class="sd">        Name of the column containing the end time (e.g., departure_datetime)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with columns:</span>
<span class="sd">        - time_hours: Time points in hours</span>
<span class="sd">        - survival_probability: Survival probabilities at each time point</span>
<span class="sd">        - event_probability: Event probabilities (1 - survival_probability)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the wait time in hours</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">end_time_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">start_time_col</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="c1"># Drop any rows with missing wait times</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Sort the data by wait time</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate the number of patients</span>
    <span class="n">n_patients</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span>

    <span class="c1"># Calculate the survival function manually</span>
    <span class="c1"># For each time point, calculate proportion of patients who are still waiting</span>
    <span class="n">unique_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">survival_prob</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">unique_times</span><span class="p">:</span>
        <span class="c1"># Number of patients who experienced the event after this time point</span>
        <span class="n">n_event_after</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span>
        <span class="c1"># Proportion of patients still waiting</span>
        <span class="n">survival_prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_event_after</span> <span class="o">/</span> <span class="n">n_patients</span><span class="p">)</span>

    <span class="c1"># Add zero hours wait time (everyone is waiting at time 0)</span>
    <span class="n">unique_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">unique_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">survival_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">survival_prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Return structured DataFrame</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;time_hours&quot;</span><span class="p">:</span> <span class="n">unique_times</span><span class="p">,</span>
            <span class="s2">&quot;survival_probability&quot;</span><span class="p">:</span> <span class="n">survival_prob</span><span class="p">,</span>
            <span class="s2">&quot;event_probability&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">survival_prob</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.errors" class="doc doc-heading">
            <code>errors</code>


</h2>

    <div class="doc doc-contents ">

        <p>Custom exception classes for model loading and validation.</p>
<p>This module defines specialized exceptions used during model loading</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="ModelLoadError (patientflow.errors.ModelLoadError)" href="#patientflow.errors.ModelLoadError">ModelLoadError</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Raised when a model fails to load due to an unspecified error.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="MissingKeysError (patientflow.errors.MissingKeysError)" href="#patientflow.errors.MissingKeysError">MissingKeysError</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Raised when expected keys are missing from a dictionary of special parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="patientflow.errors.MissingKeysError" class="doc doc-heading">
            <code>MissingKeysError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code></p>


        <p>Exception raised when required keys are missing from special_params.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>missing_keys</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#set">set</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The keys that are required but missing from the input dictionary.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.errors.MissingKeysError.missing_keys">missing_keys</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#set">set</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores the missing keys that caused the exception.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MissingKeysError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when required keys are missing from special_params.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    missing_keys : list or set</span>
<span class="sd">        The keys that are required but missing from the input dictionary.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    missing_keys : list or set</span>
<span class="sd">        Stores the missing keys that caused the exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">missing_keys</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;special_params is missing required keys: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_keys</span> <span class="o">=</span> <span class="n">missing_keys</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.errors.ModelLoadError" class="doc doc-heading">
            <code>ModelLoadError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#Exception">Exception</a></code></p>


        <p>Exception raised when a model fails to load.</p>
<p>This generic exception can be used to signal a failure during the model
loading process due to unexpected issues such as file corruption,
invalid formats, or unsupported configurations.</p>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ModelLoadError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a model fails to load.</span>

<span class="sd">    This generic exception can be used to signal a failure during the model</span>
<span class="sd">    loading process due to unexpected issues such as file corruption,</span>
<span class="sd">    invalid formats, or unsupported configurations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.evaluate" class="doc doc-heading">
            <code>evaluate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Patient Flow Evaluation Module</p>
<p>This module provides functions for evaluating and comparing different prediction models
for non-clincal outcomes in a healthcare setting. It includes utilities for calculating
metrics such as Mean Absolute Error (MAE) and Mean Percentage Error (MPE), as well as
functions for predicting admissions based on historical data and combining different
prediction models.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.calculate_results : function">calculate_results : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate evaluation metrics based on expected and observed values</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.calc_mae_mpe : function">calc_mae_mpe : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate MAE and MPE for probability distribution predictions</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.calculate_admission_probs_relative_to_prediction : function">calculate_admission_probs_relative_to_prediction : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate admission probabilities for arrivals relative to a prediction time window</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.get_arrivals_with_admission_probs : function">get_arrivals_with_admission_probs : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get arrivals before and after prediction time with their admission probabilities</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.calculate_weighted_observed : function">calculate_weighted_observed : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate actual admissions assuming ED targets are met</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.create_time_mask : function">create_time_mask : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create a mask for times before/after a specific hour:minute</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.predict_using_previous_weeks : function">predict_using_previous_weeks : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Predict admissions using average from previous weeks</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.evaluate_six_week_average : function">evaluate_six_week_average : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Evaluate the six-week average prediction model</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.combine_distributions : function">combine_distributions : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Combine two probability distributions using convolution</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.evaluate.evaluate_combined_model : function">evaluate_combined_model : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Evaluate a combined prediction model</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calc_mae_mpe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_mae_mpe</span><span class="p">(</span><span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">use_most_probable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate MAE and MPE for all prediction times in the given probability distribution dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_most_probable</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the most probable value or mathematical expectation of the distribution.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of results sorted by prediction time, containing:
- expected : List[Union[int, float]]
    Expected values for each prediction
- observed : List[float]
    Observed values for each prediction
- mae : float
    Mean Absolute Error
- mpe : float
    Mean Percentage Error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_mae_mpe</span><span class="p">(</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">use_most_probable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate MAE and MPE for all prediction times in the given probability distribution dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prob_dist_dict_all : Dict[Any, Dict[Any, Dict[str, Any]]]</span>
<span class="sd">        Nested dictionary containing probability distributions.</span>
<span class="sd">    use_most_probable : bool, optional</span>
<span class="sd">        Whether to use the most probable value or mathematical expectation of the distribution.</span>
<span class="sd">        Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]</span>
<span class="sd">        Dictionary of results sorted by prediction time, containing:</span>
<span class="sd">        - expected : List[Union[int, float]]</span>
<span class="sd">            Expected values for each prediction</span>
<span class="sd">        - observed : List[float]</span>
<span class="sd">            Observed values for each prediction</span>
<span class="sd">        - mae : float</span>
<span class="sd">            Mean Absolute Error</span>
<span class="sd">        - mpe : float</span>
<span class="sd">            Mean Percentage Error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create temporary results dictionary</span>
    <span class="n">unsorted_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process results as before</span>
    <span class="k">for</span> <span class="n">_prediction_time</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">_prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">preds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">_prediction_time</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span>

            <span class="n">expected_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">use_most_probable</span>
                <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                        <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">observed_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">])</span>

            <span class="n">expected_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expected_value</span><span class="p">)</span>
            <span class="n">observed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_value</span><span class="p">)</span>

        <span class="n">unsorted_results</span><span class="p">[</span><span class="n">_prediction_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_results</span><span class="p">(</span>
            <span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span>
        <span class="p">)</span>

    <span class="c1"># Sort results by prediction time</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_time_value</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Extract time from key (e.g., &#39;admissions_1530&#39; -&gt; 1530)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

    <span class="c1"># Create sorted dictionary</span>
    <span class="n">sorted_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">unsorted_results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_time_value</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">sorted_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calculate_admission_probs_relative_to_prediction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_datetime</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">is_before</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate admission probabilities for arrivals relative to a prediction time window.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing arrival_datetime column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_datetime</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Datetime for prediction window start.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window length in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_before</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean indicating if arrivals are before prediction time.
Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with added probability columns:
- hours_before_pred_window : float
    Hours before prediction window (if is_before=True)
- hours_after_pred_window : float
    Hours after prediction window (if is_before=False)
- prob_admission_before_pred_window : float
    Probability of admission before prediction window
- prob_admission_in_pred_window : float
    Probability of admission within prediction window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">prediction_datetime</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">is_before</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate admission probabilities for arrivals relative to a prediction time window.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing arrival_datetime column.</span>
<span class="sd">    prediction_datetime : datetime</span>
<span class="sd">        Datetime for prediction window start.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Window length in minutes.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate for aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate for aspirational curve.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate for aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate for aspirational curve.</span>
<span class="sd">    is_before : bool, optional</span>
<span class="sd">        Boolean indicating if arrivals are before prediction time.</span>
<span class="sd">        Default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with added probability columns:</span>
<span class="sd">        - hours_before_pred_window : float</span>
<span class="sd">            Hours before prediction window (if is_before=True)</span>
<span class="sd">        - hours_after_pred_window : float</span>
<span class="sd">            Hours after prediction window (if is_before=False)</span>
<span class="sd">        - prob_admission_before_pred_window : float</span>
<span class="sd">            Probability of admission before prediction window</span>
<span class="sd">        - prob_admission_in_pred_window : float</span>
<span class="sd">            Probability of admission within prediction window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">is_before</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hours_before_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">prediction_datetime</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;prob_admission_before_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="s2">&quot;hours_before_pred_window&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="s2">&quot;hours_before_pred_window&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">+</span> <span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hours_after_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">prediction_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="s2">&quot;hours_after_pred_window&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calculate_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_results</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate evaluation metrics based on expected and observed values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>expected_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of expected values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>observed_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of observed values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
- expected : List[Union[int, float]]
    Original expected values
- observed : List[float]
    Original observed values
- mae : float
    Mean Absolute Error
- mpe : float
    Mean Percentage Error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_results</span><span class="p">(</span>
    <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate evaluation metrics based on expected and observed values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expected_values : List[Union[int, float]]</span>
<span class="sd">        List of expected values.</span>
<span class="sd">    observed_values : List[float]</span>
<span class="sd">        List of observed values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Union[List[Union[int, float]], float]]</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">        - expected : List[Union[int, float]]</span>
<span class="sd">            Original expected values</span>
<span class="sd">        - observed : List[float]</span>
<span class="sd">            Original observed values</span>
<span class="sd">        - mae : float</span>
<span class="sd">            Mean Absolute Error</span>
<span class="sd">        - mpe : float</span>
<span class="sd">            Mean Percentage Error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)</span>
    <span class="n">observed_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">observed_values</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_values</span><span class="p">,</span>
            <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">observed_values</span><span class="p">,</span>
            <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;mpe&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">absolute_errors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">expected_array</span> <span class="o">-</span> <span class="n">observed_array</span><span class="p">)</span>
    <span class="n">mae</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">absolute_errors</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">absolute_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="n">non_zero_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">observed_array</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">filtered_absolute_errors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">absolute_errors</span><span class="p">[</span><span class="n">non_zero_mask</span><span class="p">]</span>
    <span class="n">filtered_observed_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">observed_array</span><span class="p">[</span><span class="n">non_zero_mask</span><span class="p">]</span>

    <span class="n">mpe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_absolute_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_observed_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">percentage_errors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">filtered_absolute_errors</span> <span class="o">/</span> <span class="n">filtered_observed_array</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">)</span>
        <span class="n">mpe</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">percentage_errors</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_values</span><span class="p">,</span>
        <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">observed_values</span><span class="p">,</span>
        <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
        <span class="s2">&quot;mpe&quot;</span><span class="p">:</span> <span class="n">mpe</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.calculate_weighted_observed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_weighted_observed</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate weighted observed admissions for a specific date and prediction window.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with arrival_datetime column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target date for calculation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window length in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (hour, minute) for prediction time.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weighted sum of observed admissions for the specified time period.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_weighted_observed</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate weighted observed admissions for a specific date and prediction window.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with arrival_datetime column.</span>
<span class="sd">    dt : datetime.date</span>
<span class="sd">        Target date for calculation.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Window length in minutes.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate for aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate for aspirational curve.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate for aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate for aspirational curve.</span>
<span class="sd">    prediction_time : tuple</span>
<span class="sd">        Tuple of (hour, minute) for prediction time.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Weighted sum of observed admissions for the specified time period.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create prediction datetime</span>
    <span class="n">prediction_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="n">hour</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">minute</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Filter for target date and get arrivals with probabilities</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">dt</span><span class="p">]</span>
    <span class="n">arrived_before</span><span class="p">,</span> <span class="n">arrived_after</span> <span class="o">=</span> <span class="n">get_arrivals_with_admission_probs</span><span class="p">(</span>
        <span class="n">filtered_df</span><span class="p">,</span>
        <span class="n">prediction_datetime</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">x1</span><span class="p">,</span>
        <span class="n">y1</span><span class="p">,</span>
        <span class="n">x2</span><span class="p">,</span>
        <span class="n">y2</span><span class="p">,</span>
        <span class="n">target_date</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Calculate weighted sum</span>
    <span class="n">weighted_observed</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">arrived_before</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">arrived_after</span><span class="p">[</span><span class="s2">&quot;prob_admission_in_pred_window&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">weighted_observed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.combine_distributions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">combine_distributions</span><span class="p">(</span><span class="n">dist1</span><span class="p">,</span> <span class="n">dist2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Combine two probability distributions using convolution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dist1</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First probability distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dist2</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second probability distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Combined probability distribution with columns:
- agg_predicted : float
    Combined probability values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">combine_distributions</span><span class="p">(</span><span class="n">dist1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dist2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine two probability distributions using convolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dist1 : pandas.DataFrame</span>
<span class="sd">        First probability distribution.</span>
<span class="sd">    dist2 : pandas.DataFrame</span>
<span class="sd">        Second probability distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Combined probability distribution with columns:</span>
<span class="sd">        - agg_predicted : float</span>
<span class="sd">            Combined probability values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr1</span> <span class="o">=</span> <span class="n">dist1</span><span class="o">.</span><span class="n">values</span>
    <span class="n">arr2</span> <span class="o">=</span> <span class="n">dist2</span><span class="o">.</span><span class="n">values</span>

    <span class="n">combined</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)</span>
    <span class="n">new_index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>

    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">new_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">])</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">combined_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.create_time_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_time_mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a mask for times before/after a specific hour:minute.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing arrival_datetime column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hour</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target hour (0-23).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>minute</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target minute (0-59).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean mask indicating times after the specified hour:minute.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_time_mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mask for times before/after a specific hour:minute.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing arrival_datetime column.</span>
<span class="sd">    hour : int</span>
<span class="sd">        Target hour (0-23).</span>
<span class="sd">    minute : int</span>
<span class="sd">        Target minute (0-59).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        Boolean mask indicating times after the specified hour:minute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="n">hour</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">hour</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;</span> <span class="n">minute</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.evaluate_combined_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_combined_model</span><span class="p">(</span><span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">yta_preds</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">use_most_probable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Evaluate the combined prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_preds</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Yet-to-arrive predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window length in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour and minute of prediction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_weeks</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of previous weeks to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_most_probable</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the most probable value or expected value.
Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing evaluation results:
- expected : List[Union[int, float]]
    Expected values for each prediction
- observed : List[float]
    Observed values for each prediction
- mae : float
    Mean Absolute Error
- mpe : float
    Mean Percentage Error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_combined_model</span><span class="p">(</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">yta_preds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">num_weeks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_most_probable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate the combined prediction model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prob_dist_dict_all : Dict[Any, Dict[Any, Dict[str, Any]]]</span>
<span class="sd">        Nested dictionary containing probability distributions.</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data.</span>
<span class="sd">    yta_preds : pandas.DataFrame</span>
<span class="sd">        Yet-to-arrive predictions.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Window length in minutes.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate for aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate for aspirational curve.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate for aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate for aspirational curve.</span>
<span class="sd">    prediction_time : Tuple[int, int]</span>
<span class="sd">        Hour and minute of prediction.</span>
<span class="sd">    num_weeks : int</span>
<span class="sd">        Number of previous weeks to consider.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    use_most_probable : bool, optional</span>
<span class="sd">        Whether to use the most probable value or expected value.</span>
<span class="sd">        Default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]</span>
<span class="sd">        Dictionary containing evaluation results:</span>
<span class="sd">        - expected : List[Union[int, float]]</span>
<span class="sd">            Expected values for each prediction</span>
<span class="sd">        - observed : List[float]</span>
<span class="sd">            Observed values for each prediction</span>
<span class="sd">        - mae : float</span>
<span class="sd">            Mean Absolute Error</span>
<span class="sd">        - mpe : float</span>
<span class="sd">            Mean Percentage Error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">in_ed_preds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">combine_distributions</span><span class="p">(</span><span class="n">yta_preds</span><span class="p">,</span> <span class="n">in_ed_preds</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">])</span>

        <span class="n">expected_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">use_most_probable</span>
            <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">observed_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">calculate_weighted_observed</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">expected_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expected_value</span><span class="p">)</span>
        <span class="n">observed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_value</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_name</span><span class="p">:</span> <span class="n">calculate_results</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.evaluate_six_week_average" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_six_week_average</span><span class="p">(</span><span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Evaluate the six-week average prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing probability distributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour and minute of prediction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_weeks</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of previous weeks to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing evaluation results:
- expected : List[Union[int, float]]
    Expected values for each prediction
- observed : List[float]
    Observed values for each prediction</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_six_week_average</span><span class="p">(</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">num_weeks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the six-week average prediction model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prob_dist_dict_all : Dict[Any, Dict[Any, Dict[str, Any]]]</span>
<span class="sd">        Nested dictionary containing probability distributions.</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Prediction window in minutes.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate for aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate for aspirational curve.</span>
<span class="sd">    prediction_time : Tuple[int, int]</span>
<span class="sd">        Hour and minute of prediction.</span>
<span class="sd">    num_weeks : int</span>
<span class="sd">        Number of previous weeks to consider.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[Any, Dict[str, Union[List[Union[int, float]], float]]]</span>
<span class="sd">        Dictionary containing evaluation results:</span>
<span class="sd">        - expected : List[Union[int, float]]</span>
<span class="sd">            Expected values for each prediction</span>
<span class="sd">        - observed : List[float]</span>
<span class="sd">            Observed values for each prediction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observed_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">expected_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">predict_using_previous_weeks</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">observed_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">calculate_weighted_observed</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">expected_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expected_value</span><span class="p">)</span>
        <span class="n">observed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_value</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_name</span><span class="p">:</span> <span class="n">calculate_results</span><span class="p">(</span><span class="n">expected_values</span><span class="p">,</span> <span class="n">observed_values</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.get_arrivals_with_admission_probs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_arrivals_with_admission_probs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_datetime</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">date_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_weekday</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get arrivals before and after prediction time with their admission probabilities.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with arrival_datetime column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_datetime</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Datetime for prediction window start.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window length in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (hour, minute) for prediction time.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>date_range</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tuple of (start_date, end_date) to filter data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_date</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional specific date to analyze.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_weekday</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional specific weekday to filter for (0-6, where 0 is Monday).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (arrived_before, arrived_after) DataFrames containing:
- arrived_before : pandas.DataFrame
    DataFrame with arrivals before prediction time
- arrived_after : pandas.DataFrame
    DataFrame with arrivals after prediction time</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_arrivals_with_admission_probs</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">prediction_datetime</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">,</span>
    <span class="n">date_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_weekday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get arrivals before and after prediction time with their admission probabilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with arrival_datetime column.</span>
<span class="sd">    prediction_datetime : datetime</span>
<span class="sd">        Datetime for prediction window start.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Window length in minutes.</span>
<span class="sd">    prediction_time : tuple</span>
<span class="sd">        Tuple of (hour, minute) for prediction time.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate for aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate for aspirational curve.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate for aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate for aspirational curve.</span>
<span class="sd">    date_range : tuple, optional</span>
<span class="sd">        Optional tuple of (start_date, end_date) to filter data.</span>
<span class="sd">    target_date : datetime.date, optional</span>
<span class="sd">        Optional specific date to analyze.</span>
<span class="sd">    target_weekday : int, optional</span>
<span class="sd">        Optional specific weekday to filter for (0-6, where 0 is Monday).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Tuple of (arrived_before, arrived_after) DataFrames containing:</span>
<span class="sd">        - arrived_before : pandas.DataFrame</span>
<span class="sd">            DataFrame with arrivals before prediction time</span>
<span class="sd">        - arrived_after : pandas.DataFrame</span>
<span class="sd">            DataFrame with arrivals after prediction time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">prediction_time</span>

    <span class="c1"># Create base time masks</span>
    <span class="n">after_mask</span> <span class="o">=</span> <span class="n">create_time_mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span>
    <span class="n">before_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">after_mask</span>

    <span class="c1"># Add date and weekday conditions if specified</span>
    <span class="k">if</span> <span class="n">date_range</span><span class="p">:</span>
        <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">date_range</span>
        <span class="n">date_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">end_date</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">target_weekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_mask</span> <span class="o">&amp;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">==</span> <span class="n">target_weekday</span>

        <span class="n">after_mask</span> <span class="o">&amp;=</span> <span class="n">date_mask</span>
        <span class="n">before_mask</span> <span class="o">&amp;=</span> <span class="n">date_mask</span>

    <span class="k">if</span> <span class="n">target_date</span><span class="p">:</span>
        <span class="n">target_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">target_date</span>
        <span class="n">after_mask</span> <span class="o">&amp;=</span> <span class="n">target_mask</span>
        <span class="n">before_mask</span> <span class="o">&amp;=</span> <span class="n">target_mask</span>

    <span class="c1"># Calculate probabilities for filtered groups</span>
    <span class="n">arrived_before</span> <span class="o">=</span> <span class="n">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">before_mask</span><span class="p">],</span>
        <span class="n">prediction_datetime</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">x1</span><span class="p">,</span>
        <span class="n">y1</span><span class="p">,</span>
        <span class="n">x2</span><span class="p">,</span>
        <span class="n">y2</span><span class="p">,</span>
        <span class="n">is_before</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">arrived_after</span> <span class="o">=</span> <span class="n">calculate_admission_probs_relative_to_prediction</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">after_mask</span><span class="p">],</span>
        <span class="n">prediction_datetime</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">x1</span><span class="p">,</span>
        <span class="n">y1</span><span class="p">,</span>
        <span class="n">x2</span><span class="p">,</span>
        <span class="n">y2</span><span class="p">,</span>
        <span class="n">is_before</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">arrived_before</span><span class="p">,</span> <span class="n">arrived_after</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.evaluate.predict_using_previous_weeks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_using_previous_weeks</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate predicted admissions remaining until midnight.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Date for prediction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window length in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second x-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second y-coordinate for aspirational curve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour and minute of prediction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_weeks</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of previous weeks to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weighted</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to weight the numbers according to aspirational ED targets.
Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted number of admissions remaining until midnight.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/evaluate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_using_previous_weeks</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">num_weeks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">weighted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate predicted admissions remaining until midnight.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data.</span>
<span class="sd">    dt : datetime</span>
<span class="sd">        Date for prediction.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Window length in minutes.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        First x-coordinate for aspirational curve.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        First y-coordinate for aspirational curve.</span>
<span class="sd">    x2 : float</span>
<span class="sd">        Second x-coordinate for aspirational curve.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Second y-coordinate for aspirational curve.</span>
<span class="sd">    prediction_time : Tuple[int, int]</span>
<span class="sd">        Hour and minute of prediction.</span>
<span class="sd">    num_weeks : int</span>
<span class="sd">        Number of previous weeks to consider.</span>
<span class="sd">    weighted : bool, optional</span>
<span class="sd">        Whether to weight the numbers according to aspirational ED targets.</span>
<span class="sd">        Default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Predicted number of admissions remaining until midnight.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prediction_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="n">hour</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">minute</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">target_day_of_week</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

    <span class="n">end_date</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="n">num_weeks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weighted</span><span class="p">:</span>
        <span class="c1"># Create mask for historical data</span>
        <span class="n">historical_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">==</span> <span class="n">target_day_of_week</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create explicit copy of filtered data</span>
        <span class="n">historical_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">historical_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Calculate minutes until midnight</span>
        <span class="n">midnight_times</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">historical_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">historical_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;minutes_to_midnight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">midnight_times</span> <span class="o">-</span> <span class="n">historical_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># Calculate admission probabilities</span>
        <span class="n">historical_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">historical_data</span><span class="p">[</span>
            <span class="s2">&quot;minutes_to_midnight&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

        <span class="c1"># Group by date and calculate average</span>
        <span class="n">historical_daily_sums</span> <span class="o">=</span> <span class="n">historical_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">historical_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="p">)[</span><span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">historical_average</span> <span class="o">=</span> <span class="n">historical_daily_sums</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Create mask for today&#39;s data</span>
        <span class="n">today_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">dt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prediction_datetime</span>
        <span class="p">)</span>

        <span class="c1"># Create explicit copy of today&#39;s filtered data</span>
        <span class="n">today_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">today_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Calculate minutes until midnight for today&#39;s data</span>
        <span class="n">midnight_today</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">today_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;minutes_to_midnight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">midnight_today</span> <span class="o">-</span> <span class="n">today_data</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># Calculate admission probabilities for today</span>
        <span class="n">today_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_data</span><span class="p">[</span>
            <span class="s2">&quot;minutes_to_midnight&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

        <span class="n">today_sum</span> <span class="o">=</span> <span class="n">today_data</span><span class="p">[</span><span class="s2">&quot;admission_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">still_to_admit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">historical_average</span> <span class="o">-</span> <span class="n">today_sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Original unweighted logic with explicit copies</span>
        <span class="n">historical_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">==</span> <span class="n">target_day_of_week</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">historical_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">historical_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">average_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_df</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_weeks</span>

        <span class="n">target_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">dt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prediction_datetime</span>
        <span class="p">)</span>
        <span class="n">target_date_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_mask</span><span class="p">])</span>

        <span class="n">still_to_admit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">average_count</span> <span class="o">-</span> <span class="n">target_date_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">still_to_admit</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.generate" class="doc doc-heading">
            <code>generate</code>


</h2>

    <div class="doc doc-contents ">

        <p>Generate fake Emergency Department visit data.</p>
<p>This module provides functions to generate fake datasets for patient visits to an emergency department (ED).
It generates arrival and departure times, triage scores, lab orders, and patient admissions.
The functions are used for illustrative purposes in some of the notebooks.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="create_fake_finished_visits(start_date, end_date, mean_patients_per_day, admitted_only=False) (patientflow.generate.create_fake_finished_visits)" href="#patientflow.generate.create_fake_finished_visits">create_fake_finished_visits</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate synthetic patient visits, triage observations, and lab orders.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="create_fake_snapshots(prediction_times, start_date, end_date, df=None, observations_df=None, lab_orders_df=None, mean_patients_per_day=50) (patientflow.generate.create_fake_snapshots)" href="#patientflow.generate.create_fake_snapshots">create_fake_snapshots</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create patient-level snapshots at specific times with visit, triage, and lab features.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.generate.create_fake_finished_visits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_fake_finished_visits</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">mean_patients_per_day</span><span class="p">,</span> <span class="n">admitted_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate synthetic patient visit data for an emergency department.</p>
<p>This function simulates a realistic distribution of patient arrivals, triage scores, lengths of stay,
admissions, and lab orders over a specified date range. Some patients may have multiple visits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start_date</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The starting date for the simulation (inclusive). Can be a datetime object or a string in 'YYYY-MM-DD' format.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_date</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ending date for the simulation (exclusive). Can be a datetime object or a string in 'YYYY-MM-DD' format.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mean_patients_per_day</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The average number of patient visits to generate per day.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>admitted_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only return admitted patients. The mean_patients_per_day will be adjusted to maintain
the same total number of admitted patients as would be expected in the full dataset.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>visits_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing visit records with the following columns:
- 'visit_number'
- 'patient_id'
- 'arrival_datetime'
- 'departure_datetime'
- 'is_admitted'
- 'specialty'
- 'age'</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>observations_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing triage score observations with columns:
- 'visit_number'
- 'observation_datetime'
- 'triage_score'</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>lab_orders_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing lab test orders with columns:
- 'visit_number'
- 'order_datetime'
- 'lab_name'</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Patients are more likely to arrive during daytime hours.</li>
<li>20% of patients will have more than one visit during the simulation period.</li>
<li>Lab test ordering likelihood depends on the severity of the triage score.</li>
<li>When admitted_only=True, the mean_patients_per_day is adjusted to maintain the same number
  of admitted patients as would be expected in the full dataset.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/generate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_fake_finished_visits</span><span class="p">(</span>
    <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">mean_patients_per_day</span><span class="p">,</span> <span class="n">admitted_only</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate synthetic patient visit data for an emergency department.</span>

<span class="sd">    This function simulates a realistic distribution of patient arrivals, triage scores, lengths of stay,</span>
<span class="sd">    admissions, and lab orders over a specified date range. Some patients may have multiple visits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_date : str or datetime</span>
<span class="sd">        The starting date for the simulation (inclusive). Can be a datetime object or a string in &#39;YYYY-MM-DD&#39; format.</span>
<span class="sd">    end_date : str or datetime</span>
<span class="sd">        The ending date for the simulation (exclusive). Can be a datetime object or a string in &#39;YYYY-MM-DD&#39; format.</span>
<span class="sd">    mean_patients_per_day : float</span>
<span class="sd">        The average number of patient visits to generate per day.</span>
<span class="sd">    admitted_only : bool, optional</span>
<span class="sd">        If True, only return admitted patients. The mean_patients_per_day will be adjusted to maintain</span>
<span class="sd">        the same total number of admitted patients as would be expected in the full dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    visits_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing visit records with the following columns:</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;patient_id&#39;</span>
<span class="sd">        - &#39;arrival_datetime&#39;</span>
<span class="sd">        - &#39;departure_datetime&#39;</span>
<span class="sd">        - &#39;is_admitted&#39;</span>
<span class="sd">        - &#39;specialty&#39;</span>
<span class="sd">        - &#39;age&#39;</span>
<span class="sd">    observations_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing triage score observations with columns:</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;observation_datetime&#39;</span>
<span class="sd">        - &#39;triage_score&#39;</span>
<span class="sd">    lab_orders_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing lab test orders with columns:</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;order_datetime&#39;</span>
<span class="sd">        - &#39;lab_name&#39;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Patients are more likely to arrive during daytime hours.</span>
<span class="sd">    - 20% of patients will have more than one visit during the simulation period.</span>
<span class="sd">    - Lab test ordering likelihood depends on the severity of the triage score.</span>
<span class="sd">    - When admitted_only=True, the mean_patients_per_day is adjusted to maintain the same number</span>
<span class="sd">      of admitted patients as would be expected in the full dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert string dates to datetime if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set random seed for reproducibility</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># You can change this seed value as needed</span>

    <span class="c1"># Define admission probabilities based on triage score</span>
    <span class="c1"># Triage 1: 80% admission, Triage 2: 60%, Triage 3: 30%, Triage 4: 10%, Triage 5: 2%</span>
    <span class="n">admission_probabilities</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>  <span class="c1"># Highest severity - highest admission probability</span>
        <span class="mi">2</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>  <span class="c1"># Lowest severity - lowest admission probability</span>
    <span class="p">}</span>

    <span class="c1"># Define triage score distribution</span>
    <span class="c1"># Most common is 3-4, less common are 2 and 5, least common is 1 (most severe)</span>
    <span class="n">triage_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">]</span>  <span class="c1"># For scores 1-5</span>

    <span class="c1"># Calculate total days in range (changed to exclusive end date)</span>
    <span class="n">days_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="c1"># If admitted_only is True, adjust mean_patients_per_day to maintain the same number of admitted patients</span>
    <span class="k">if</span> <span class="n">admitted_only</span><span class="p">:</span>
        <span class="c1"># Calculate expected admission rate based on triage probabilities and admission probabilities</span>
        <span class="n">expected_admission_rate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">triage_prob</span> <span class="o">*</span> <span class="n">admission_prob</span>
            <span class="k">for</span> <span class="n">triage_prob</span><span class="p">,</span> <span class="n">admission_prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">triage_probabilities</span><span class="p">,</span> <span class="n">admission_probabilities</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Adjust mean_patients_per_day to maintain the same number of admitted patients</span>
        <span class="n">mean_patients_per_day</span> <span class="o">=</span> <span class="n">mean_patients_per_day</span> <span class="o">/</span> <span class="n">expected_admission_rate</span>

    <span class="c1"># Generate random number of patients for each day using Poisson distribution</span>
    <span class="n">daily_patients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">mean_patients_per_day</span><span class="p">,</span> <span class="n">days_range</span><span class="p">)</span>

    <span class="c1"># Calculate the total number of visits</span>
    <span class="n">total_visits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">daily_patients</span><span class="p">)</span>

    <span class="c1"># Calculate approximately how many unique patients we need</span>
    <span class="c1"># If 20% of patients have more than one visit (let&#39;s assume they have exactly 2),</span>
    <span class="c1"># then for N total visits, we need approximately N * 0.8 + (N * 0.2) / 2 unique patients</span>
    <span class="c1"># Simplifying: N * (0.8 + 0.1) = N * 0.9 unique patients</span>
    <span class="n">num_unique_patients</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_visits</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>

    <span class="c1"># Create patient ids</span>
    <span class="n">patient_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_unique_patients</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Define common ED lab tests and their ordering probabilities based on triage score</span>
    <span class="n">lab_tests</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CBC&quot;</span><span class="p">,</span> <span class="s2">&quot;BMP&quot;</span><span class="p">,</span> <span class="s2">&quot;Troponin&quot;</span><span class="p">,</span> <span class="s2">&quot;D-dimer&quot;</span><span class="p">,</span> <span class="s2">&quot;Urinalysis&quot;</span><span class="p">]</span>
    <span class="n">lab_probabilities</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Higher severity -&gt; more likely to get labs</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.70</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.50</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.60</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="mi">5</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;CBC&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
            <span class="s2">&quot;BMP&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
            <span class="s2">&quot;Troponin&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="s2">&quot;D-dimer&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="s2">&quot;Urinalysis&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">visits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lab_orders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visit_number</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Create a dictionary to track number of visits per patient</span>
    <span class="n">patient_visit_count</span> <span class="o">=</span> <span class="p">{</span><span class="n">patient_id</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">}</span>

    <span class="c1"># Create a pool of patients who will have multiple visits (20% of patients)</span>
    <span class="n">multi_visit_patients</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">patient_ids</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">num_unique_patients</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">day_idx</span><span class="p">,</span> <span class="n">num_patients</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">daily_patients</span><span class="p">):</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">day_idx</span><span class="p">)</span>

        <span class="c1"># Generate patients for this day</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patients</span><span class="p">):</span>
            <span class="c1"># Select a patient ID based on our requirements</span>
            <span class="c1"># If we haven&#39;t assigned all patients yet, use a new one</span>
            <span class="c1"># Otherwise, pick from multi-visit patients</span>
            <span class="n">available_new_patients</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">patient_ids</span> <span class="k">if</span> <span class="n">patient_visit_count</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">available_new_patients</span><span class="p">:</span>
                <span class="c1"># Use a new patient</span>
                <span class="n">patient_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_new_patients</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># All patients have at least one visit, now use multi-visit patients</span>
                <span class="n">patient_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">multi_visit_patients</span><span class="p">))</span>

            <span class="c1"># Increment the visit count for this patient</span>
            <span class="n">patient_visit_count</span><span class="p">[</span><span class="n">patient_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Random hour for arrival (more likely during daytime)</span>
            <span class="n">arrival_hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Mean at 1 PM, std dev of 4 hours</span>
            <span class="n">arrival_hour</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">arrival_hour</span><span class="p">)))</span>  <span class="c1"># Clamp between 0-23</span>

            <span class="c1"># Random minutes</span>
            <span class="n">arrival_minute</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

            <span class="c1"># Create arrival datetime</span>
            <span class="n">arrival_datetime</span> <span class="o">=</span> <span class="n">current_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">hour</span><span class="o">=</span><span class="n">arrival_hour</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="n">arrival_minute</span><span class="p">,</span>
                <span class="n">second</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Generate triage score (1-5)</span>
            <span class="n">triage_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="n">triage_probabilities</span><span class="p">)</span>

            <span class="c1"># Generate admission status based on triage score</span>
            <span class="n">admission_prob</span> <span class="o">=</span> <span class="n">admission_probabilities</span><span class="p">[</span><span class="n">triage_score</span><span class="p">]</span>
            <span class="n">is_admitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">admission_prob</span><span class="p">,</span> <span class="n">admission_prob</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Generate specialty for admitted patients</span>
            <span class="k">if</span> <span class="n">is_admitted</span><span class="p">:</span>
                <span class="n">specialty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;medical&quot;</span><span class="p">,</span> <span class="s2">&quot;surgical&quot;</span><span class="p">,</span> <span class="s2">&quot;haem/onc&quot;</span><span class="p">,</span> <span class="s2">&quot;paediatric&quot;</span><span class="p">],</span>
                    <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specialty</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Skip this visit if admitted_only is True and patient is not admitted</span>
            <span class="k">if</span> <span class="n">admitted_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_admitted</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Generate length of stay (in minutes) - log-normal distribution</span>
            <span class="c1"># Most visits are 4 to 12 hours, but some can be shorter or longer</span>
            <span class="n">length_of_stay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">5.8</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">length_of_stay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">60</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2880</span><span class="p">,</span> <span class="n">length_of_stay</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># Between 1 hour and 48 hours</span>

            <span class="c1"># Make higher triage scores (more severe) stay longer on average</span>
            <span class="k">if</span> <span class="n">triage_score</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">length_of_stay</span> <span class="o">*=</span> <span class="mf">1.8</span>  <span class="c1"># 80% longer stays for more severe cases</span>

            <span class="c1"># Calculate departure time</span>
            <span class="n">departure_datetime</span> <span class="o">=</span> <span class="n">arrival_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">length_of_stay</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># For returning patients, use the same age as their first visit</span>
            <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">visits</span><span class="p">]:</span>
                <span class="c1"># Find the age from a previous visit</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">visits</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">patient_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Generate age with a distribution skewed towards older adults</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">3.8</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># Centers around 45 years</span>
                <span class="n">age</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">age</span><span class="p">))</span>  <span class="c1"># Clamp between 0-100 years</span>

            <span class="c1"># Add visit record (without triage score, but with patient_id)</span>
            <span class="n">visits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                    <span class="s2">&quot;visit_number&quot;</span><span class="p">:</span> <span class="n">visit_number</span><span class="p">,</span>
                    <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">:</span> <span class="n">arrival_datetime</span><span class="p">,</span>
                    <span class="s2">&quot;departure_datetime&quot;</span><span class="p">:</span> <span class="n">departure_datetime</span><span class="p">,</span>
                    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">age</span><span class="p">,</span>
                    <span class="s2">&quot;is_admitted&quot;</span><span class="p">:</span> <span class="n">is_admitted</span><span class="p">,</span>
                    <span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="n">specialty</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Generate triage observation within first 10 minutes</span>
            <span class="n">minutes_after_arrival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">observation_datetime</span> <span class="o">=</span> <span class="n">arrival_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">minutes</span><span class="o">=</span><span class="n">minutes_after_arrival</span>
            <span class="p">)</span>

            <span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;visit_number&quot;</span><span class="p">:</span> <span class="n">visit_number</span><span class="p">,</span>
                    <span class="s2">&quot;observation_datetime&quot;</span><span class="p">:</span> <span class="n">observation_datetime</span><span class="p">,</span>
                    <span class="s2">&quot;triage_score&quot;</span><span class="p">:</span> <span class="n">triage_score</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Generate lab orders if visit is longer than 2 hours</span>
            <span class="k">if</span> <span class="n">length_of_stay</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span>
                <span class="c1"># For each lab test, decide if it should be ordered based on triage score</span>
                <span class="k">for</span> <span class="n">lab_test</span> <span class="ow">in</span> <span class="n">lab_tests</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">lab_probabilities</span><span class="p">[</span><span class="n">triage_score</span><span class="p">][</span><span class="n">lab_test</span><span class="p">]:</span>
                        <span class="c1"># Order time is after triage but within first 90 minutes</span>
                        <span class="n">minutes_after_triage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                            <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">minutes_after_arrival</span>
                        <span class="p">)</span>
                        <span class="n">order_datetime</span> <span class="o">=</span> <span class="n">observation_datetime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                            <span class="n">minutes</span><span class="o">=</span><span class="n">minutes_after_triage</span>
                        <span class="p">)</span>

                        <span class="n">lab_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;visit_number&quot;</span><span class="p">:</span> <span class="n">visit_number</span><span class="p">,</span>
                                <span class="s2">&quot;order_datetime&quot;</span><span class="p">:</span> <span class="n">order_datetime</span><span class="p">,</span>
                                <span class="s2">&quot;lab_name&quot;</span><span class="p">:</span> <span class="n">lab_test</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

            <span class="n">visit_number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Create DataFrames and sort by time</span>
    <span class="n">visits_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">visits</span><span class="p">)</span>
    <span class="n">visits_df</span> <span class="o">=</span> <span class="n">visits_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">observations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
    <span class="n">observations_df</span> <span class="o">=</span> <span class="n">observations_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;observation_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">lab_orders_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lab_orders</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lab_orders_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">lab_orders_df</span> <span class="o">=</span> <span class="n">lab_orders_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;order_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">visits_df</span><span class="p">,</span> <span class="n">observations_df</span><span class="p">,</span> <span class="n">lab_orders_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.generate.create_fake_snapshots" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_fake_snapshots</span><span class="p">(</span><span class="n">prediction_times</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">observations_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lab_orders_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_patients_per_day</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate patient-level snapshots at specific times for prediction modeling.</p>
<p>For each specified time on each date in the range, this function returns a snapshot of patients
who are currently in the emergency department, along with their visit features, latest triage score,
and number of lab tests ordered prior to that time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code>list of tuple of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of (hour, minute) tuples indicating times of day to create snapshots.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_date</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The starting date for generating snapshots (inclusive).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_date</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ending date for generating snapshots (exclusive).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Patient visit data from <code>create_fake_finished_visits</code>. If None, synthetic data is generated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>observations_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Triage score data from <code>create_fake_finished_visits</code>. If None, synthetic data is generated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lab_orders_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lab order data from <code>create_fake_finished_visits</code>. If None, synthetic data is generated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mean_patients_per_day</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average number of patients per day (used only if synthetic data is generated).</p>
              </div>
            </td>
            <td>
                  <code>50</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>final_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame with one row per patient visit present at the snapshot time. Columns include:
- 'snapshot_date'
- 'prediction_time'
- 'patient_id'
- 'visit_number'
- 'is_admitted'
- 'age'
- 'latest_triage_score'
- One column per lab test: 'num_<lab_name>_orders'</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Only patients present in the ED at the snapshot time are included.</li>
<li>Lab order columns reflect counts of tests ordered before the snapshot time.</li>
<li>If no patients are present at a snapshot time, that snapshot is omitted.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/generate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_fake_snapshots</span><span class="p">(</span>
    <span class="n">prediction_times</span><span class="p">,</span>
    <span class="n">start_date</span><span class="p">,</span>
    <span class="n">end_date</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">observations_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_orders_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mean_patients_per_day</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate patient-level snapshots at specific times for prediction modeling.</span>

<span class="sd">    For each specified time on each date in the range, this function returns a snapshot of patients</span>
<span class="sd">    who are currently in the emergency department, along with their visit features, latest triage score,</span>
<span class="sd">    and number of lab tests ordered prior to that time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_times : list of tuple of int</span>
<span class="sd">        A list of (hour, minute) tuples indicating times of day to create snapshots.</span>
<span class="sd">    start_date : str or datetime</span>
<span class="sd">        The starting date for generating snapshots (inclusive).</span>
<span class="sd">    end_date : str or datetime</span>
<span class="sd">        The ending date for generating snapshots (exclusive).</span>
<span class="sd">    df : pandas.DataFrame, optional</span>
<span class="sd">        Patient visit data from `create_fake_finished_visits`. If None, synthetic data is generated.</span>
<span class="sd">    observations_df : pandas.DataFrame, optional</span>
<span class="sd">        Triage score data from `create_fake_finished_visits`. If None, synthetic data is generated.</span>
<span class="sd">    lab_orders_df : pandas.DataFrame, optional</span>
<span class="sd">        Lab order data from `create_fake_finished_visits`. If None, synthetic data is generated.</span>
<span class="sd">    mean_patients_per_day : float, optional</span>
<span class="sd">        Average number of patients per day (used only if synthetic data is generated).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    final_df : pandas.DataFrame</span>
<span class="sd">        A DataFrame with one row per patient visit present at the snapshot time. Columns include:</span>
<span class="sd">        - &#39;snapshot_date&#39;</span>
<span class="sd">        - &#39;prediction_time&#39;</span>
<span class="sd">        - &#39;patient_id&#39;</span>
<span class="sd">        - &#39;visit_number&#39;</span>
<span class="sd">        - &#39;is_admitted&#39;</span>
<span class="sd">        - &#39;age&#39;</span>
<span class="sd">        - &#39;latest_triage_score&#39;</span>
<span class="sd">        - One column per lab test: &#39;num_&lt;lab_name&gt;_orders&#39;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Only patients present in the ED at the snapshot time are included.</span>
<span class="sd">    - Lab order columns reflect counts of tests ordered before the snapshot time.</span>
<span class="sd">    - If no patients are present at a snapshot time, that snapshot is omitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Generate fake data if not provided</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">observations_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lab_orders_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">observations_df</span><span class="p">,</span> <span class="n">lab_orders_df</span> <span class="o">=</span> <span class="n">create_fake_finished_visits</span><span class="p">(</span>
            <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">mean_patients_per_day</span>
        <span class="p">)</span>

    <span class="c1"># Add date conversion at the start</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="c1"># Create date range (changed to exclusive end date)</span>
    <span class="n">snapshot_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_date</span>
    <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;</span> <span class="n">end_date</span><span class="p">:</span>  <span class="c1"># Changed from &lt;= to &lt;</span>
        <span class="n">snapshot_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_date</span><span class="p">)</span>
        <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get unique lab test names</span>
    <span class="n">lab_tests</span> <span class="o">=</span> <span class="n">lab_orders_df</span><span class="p">[</span><span class="s2">&quot;lab_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">lab_orders_df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># Create empty list to store all results</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># For each combination of date and time</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">snapshot_dates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
            <span class="n">snapshot_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">))</span>

            <span class="c1"># Filter dataframe for this snapshot</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;departure_datetime&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">snapshot_datetime</span>
            <span class="p">)</span>
            <span class="n">snapshot_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Create copy to avoid SettingWithCopyWarning</span>

            <span class="c1"># Skip if no patients at this time</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get triage scores recorded before the snapshot time</span>
            <span class="n">valid_observations</span> <span class="o">=</span> <span class="n">observations_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">observations_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">observations_df</span><span class="p">[</span><span class="s2">&quot;observation_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Keep only the most recent triage score for each visit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">valid_observations</span> <span class="o">=</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="s2">&quot;observation_datetime&quot;</span>
                <span class="p">)</span>
                <span class="n">valid_observations</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">valid_observations</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;visit_number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">valid_observations</span> <span class="o">=</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;triage_score&quot;</span><span class="p">:</span> <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Get lab orders placed before the snapshot time</span>
            <span class="n">valid_orders</span> <span class="o">=</span> <span class="n">lab_orders_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">lab_orders_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lab_orders_df</span><span class="p">[</span><span class="s2">&quot;order_datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Initialize lab_counts with zeros for all visits in snapshot_df</span>
            <span class="n">lab_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
                    <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span>
                <span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_orders&quot;</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">lab_tests</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Update counts if there are any valid orders</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_orders</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">order_counts</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">valid_orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;lab_name&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">size</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">order_counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_orders&quot;</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">order_counts</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>
                <span class="c1"># Update the counts in lab_counts where we have orders</span>
                <span class="n">lab_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">order_counts</span><span class="p">)</span>

            <span class="n">lab_counts</span> <span class="o">=</span> <span class="n">lab_counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="c1"># Add snapshot information columns</span>
            <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
            <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">)</span>

            <span class="c1"># Merge with valid observations to get triage scores, handling empty case</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_observations</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">snapshot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">snapshot_df</span><span class="p">,</span>
                    <span class="n">valid_observations</span><span class="p">[[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">]],</span>
                    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">snapshot_df</span><span class="p">[</span><span class="s2">&quot;latest_triage_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">snapshot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Merge with lab counts</span>
            <span class="n">snapshot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">snapshot_df</span><span class="p">,</span> <span class="n">lab_counts</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Fill NA values in lab count columns with 0</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">snapshot_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_orders&quot;</span><span class="p">):</span>
                    <span class="n">snapshot_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Optionally check for all-NA in key columns</span>
                <span class="n">snapshot_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;snapshot_datetime&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="c1"># Only check columns that exist in the DataFrame</span>
                <span class="n">check_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">snapshot_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">snapshot_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_cols</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">snapshot_df</span><span class="p">[</span><span class="n">check_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot_df</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipping DataFrame with all-NA values in key columns: </span><span class="si">{</span><span class="n">check_cols</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping empty DataFrame&quot;</span><span class="p">)</span>

    <span class="c1"># Combine all results into single dataframe</span>
    <span class="k">if</span> <span class="n">all_results</span><span class="p">:</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Define column order</span>
        <span class="n">snapshot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span>
        <span class="n">visit_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;patient_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">lab_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_orders&quot;</span><span class="p">)]</span>

        <span class="c1"># Ensure all required columns exist</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">visit_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">:</span>
                    <span class="n">final_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Reorder columns</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">snapshot_cols</span> <span class="o">+</span> <span class="n">visit_cols</span> <span class="o">+</span> <span class="n">lab_cols</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create empty dataframe with correct columns if no results found</span>
        <span class="n">lab_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_orders&quot;</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">lab_tests</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latest_triage_score&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">lab_cols</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Name the index snapshot_id before returning</span>
    <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;snapshot_id&quot;</span>
    <span class="k">return</span> <span class="n">final_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.load" class="doc doc-heading">
            <code>load</code>


</h2>

    <div class="doc doc-contents ">

        <p>This module provides functionality for loading configuration files, data from CSV files, and trained machine learning models.</p>
<p>It includes the following features:</p>
<ul>
<li><strong>Loading Configurations</strong>: Parse YAML configuration files and extract necessary parameters for data processing and modeling.</li>
<li><strong>Data Handling</strong>: Load and preprocess data from CSV files, including optional operations like setting an index, sorting, and applying literal evaluation on columns.</li>
<li><strong>Model Management</strong>: Load saved machine learning models, customize model filenames based on time, and categorize DataFrame columns into predefined groups for analysis.</li>
</ul>
<p>The module handles common file and parsing errors, returning appropriate error messages or exceptions.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.parse_args:">parse_args:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Parses command-line arguments for training models.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.set_project_root:">set_project_root:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Validates project root path from specified environment variable.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.load_config_file:">load_config_file:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Load a YAML configuration file and extract key parameters.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.set_file_paths:">set_file_paths:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Sets up the file paths based on UCLH-specific or default parameters.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.set_data_file_names:">set_data_file_names:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Set file locations based on UCLH-specific or default data sources.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.safe_literal_eval:">safe_literal_eval:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Safely evaluate string literals into Python objects when loading from csv.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.load_data:">load_data:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Load and preprocess data from a CSV or pickle file.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.get_model_key:">get_model_key:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate a model name based on the time of day.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.load_saved_model:">load_saved_model:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Load a machine learning model saved in a joblib file.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.load.get_dict_cols:">get_dict_cols:</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Categorize columns from a DataFrame into predefined groups for analysis.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.load.data_from_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data_from_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Loads data from a CSV file, with optional transformations. LEGACY!</p>
<p>This function loads a CSV file into a pandas DataFrame and provides the following optional features:
- Setting a specified column as the index.
- Sorting the DataFrame by one or more specified columns.
- Applying safe literal evaluation to specified columns to handle string representations of Python objects.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>csv_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The relative or absolute path to the CSV file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index_column</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column to set as the index of the DataFrame. If not provided, no index column is set.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sort_columns</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of columns by which to sort the DataFrame. If not provided, the DataFrame is not sorted.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eval_columns</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of columns to which <code>safe_literal_eval</code> should be applied. This is useful for columns containing
string representations of Python data structures (e.g., lists, dictionaries).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pandas DataFrame containing the loaded data with any specified transformations applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#SystemExit">SystemExit</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file cannot be found or another error occurs during loading or processing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function will terminate the program with a message if the file is not found or if any errors
occur while loading the data. If sorting columns or applying <code>safe_literal_eval</code> fails,
a warning message is printed, but execution continues.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">data_from_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data from a CSV file, with optional transformations. LEGACY!</span>

<span class="sd">    This function loads a CSV file into a pandas DataFrame and provides the following optional features:</span>
<span class="sd">    - Setting a specified column as the index.</span>
<span class="sd">    - Sorting the DataFrame by one or more specified columns.</span>
<span class="sd">    - Applying safe literal evaluation to specified columns to handle string representations of Python objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    csv_path : str</span>
<span class="sd">        The relative or absolute path to the CSV file.</span>
<span class="sd">    index_column : str, optional</span>
<span class="sd">        The column to set as the index of the DataFrame. If not provided, no index column is set.</span>
<span class="sd">    sort_columns : list of str, optional</span>
<span class="sd">        A list of columns by which to sort the DataFrame. If not provided, the DataFrame is not sorted.</span>
<span class="sd">    eval_columns : list of str, optional</span>
<span class="sd">        A list of columns to which `safe_literal_eval` should be applied. This is useful for columns containing</span>
<span class="sd">        string representations of Python data structures (e.g., lists, dictionaries).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing the loaded data with any specified transformations applied.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    SystemExit</span>
<span class="sd">        If the file cannot be found or another error occurs during loading or processing.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function will terminate the program with a message if the file is not found or if any errors</span>
<span class="sd">    occur while loading the data. If sorting columns or applying `safe_literal_eval` fails,</span>
<span class="sd">    a warning message is printed, but execution continues.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="n">csv_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found at path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found at path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index_column</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">index_column</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_column</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index column &#39;</span><span class="si">{</span><span class="n">index_column</span><span class="si">}</span><span class="s2">&#39; not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sort_columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One or more sort columns not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eval_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">eval_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">safe_literal_eval</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying safe_literal_eval to column &#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.get_dict_cols" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dict_cols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Categorize DataFrame columns into predefined groups.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataFrame to categorize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are column group names and values are lists of column names in each group.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dict_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Categorize DataFrame columns into predefined groups.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        The DataFrame to categorize.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary where keys are column group names and values are lists of column names in each group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">not_used_in_training_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;snapshot_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;training_validation_test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;random_number&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">arrival_and_demographic_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;elapsed_los&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age_group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arrival_method&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">summary_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;num_obs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_obs_events&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_obs_types&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_lab_batteries_ordered&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">location_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observations_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labs_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">consults_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;has_consultation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;specialty&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">outcome_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">col</span> <span class="ow">in</span> <span class="n">not_used_in_training_vars</span>
            <span class="ow">or</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">arrival_and_demographic_vars</span>
            <span class="ow">or</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">summary_vars</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="s2">&quot;visited&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;location&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">location_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;num_obs&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;latest_obs&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">observations_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;lab_orders&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;latest_lab_results&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">labs_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">consults_vars</span> <span class="ow">or</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outcome_vars</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Already categorized</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; did not match any predefined group&quot;</span><span class="p">)</span>

    <span class="c1"># Create a list of column groups</span>
    <span class="n">col_group_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;not used in training&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arrival and demographic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">,</span>
        <span class="s2">&quot;location&quot;</span><span class="p">,</span>
        <span class="s2">&quot;observations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lab orders and results&quot;</span><span class="p">,</span>
        <span class="s2">&quot;consults&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outcome&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Create a list of the column names within those groups</span>
    <span class="n">col_groups</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">not_used_in_training_vars</span><span class="p">,</span>
        <span class="n">arrival_and_demographic_vars</span><span class="p">,</span>
        <span class="n">summary_vars</span><span class="p">,</span>
        <span class="n">location_vars</span><span class="p">,</span>
        <span class="n">observations_vars</span><span class="p">,</span>
        <span class="n">labs_vars</span><span class="p">,</span>
        <span class="n">consults_vars</span><span class="p">,</span>
        <span class="n">outcome_vars</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Use dictionary to combine them</span>
    <span class="n">dict_col_groups</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">category</span><span class="p">:</span> <span class="n">var_list</span> <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">var_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">col_group_names</span><span class="p">,</span> <span class="n">col_groups</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dict_col_groups</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.get_model_key" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a model name based on the time of day.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base name of the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code>tuple of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple representing the time of day (hour, minute).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the model name based on the time of day.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a model name based on the time of day.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        The base name of the model.</span>
<span class="sd">    prediction_time : tuple of int</span>
<span class="sd">        A tuple representing the time of day (hour, minute).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A string representing the model name based on the time of day.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hour_</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="n">prediction_time</span>
    <span class="n">min_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_</span><span class="si">}</span><span class="s2">0&quot;</span> <span class="k">if</span> <span class="n">min_</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_</span><span class="p">)</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour_</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">min_</span>
    <span class="k">return</span> <span class="n">model_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.load_config_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_config_file</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span> <span class="n">return_start_end_dates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Load configuration from a YAML file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the configuration file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_start_end_dates</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, return only the start and end dates from the file (default is False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>return_start_end_dates</code> is True, returns a tuple of start and end dates (str).
Otherwise, returns a dictionary containing the configuration parameters.
Returns None if an error occurs during file reading or parsing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_config_file</span><span class="p">(</span>
    <span class="n">config_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_start_end_dates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load configuration from a YAML file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_file_path : str</span>
<span class="sd">        The path to the configuration file.</span>
<span class="sd">    return_start_end_dates : bool, optional</span>
<span class="sd">        If True, return only the start and end dates from the file (default is False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or tuple or None</span>
<span class="sd">        If `return_start_end_dates` is True, returns a tuple of start and end dates (str).</span>
<span class="sd">        Otherwise, returns a dictionary containing the configuration parameters.</span>
<span class="sd">        Returns None if an error occurs during file reading or parsing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: The file &#39;</span><span class="si">{</span><span class="n">config_file_path</span><span class="si">}</span><span class="s2">&#39; was not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing YAML file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_start_end_dates</span><span class="p">:</span>
            <span class="c1"># load the dates used in saved data for uclh versions</span>
            <span class="k">if</span> <span class="s2">&quot;file_dates&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;file_dates&quot;</span><span class="p">]:</span>
                <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;file_dates&quot;</span><span class="p">]]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error: &#39;file_dates&#39; key not found or empty in the configuration file.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;prediction_times&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prediction_times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_times&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;prediction_times&#39; key not found in the configuration file.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;modelling_dates&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;modelling_dates&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_training_set&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_validation_set&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_test_set&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_test_set&quot;</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;modelling_dates&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error: expecting 4 modelling dates and only got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modelling_dates&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prediction_window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_window&quot;</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epsilon&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;yta_time_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yta_time_interval&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span>

    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Missing key in the configuration file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Invalid value found in the configuration file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.load_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_data</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">home_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Loads data from CSV or pickle file with optional transformations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path containing the data file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the CSV or pickle file to load</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index_column</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column to set as DataFrame index</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sort_columns</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to sort DataFrame by</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eval_columns</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to apply safe_literal_eval to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>home_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base path to use instead of user's home directory</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encoding</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The encoding to use when reading CSV files (e.g., 'utf-8', 'latin1')</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Loaded and transformed DataFrame</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#FileNotFoundError">FileNotFoundError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified file does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file format is not supported or other processing errors occur</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
    <span class="n">data_file_path</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">,</span>
    <span class="n">index_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sort_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">eval_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">home_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data from CSV or pickle file with optional transformations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_file_path : str</span>
<span class="sd">        Directory path containing the data file</span>
<span class="sd">    file_name : str</span>
<span class="sd">        Name of the CSV or pickle file to load</span>
<span class="sd">    index_column : str, optional</span>
<span class="sd">        Column to set as DataFrame index</span>
<span class="sd">    sort_columns : list of str, optional</span>
<span class="sd">        Columns to sort DataFrame by</span>
<span class="sd">    eval_columns : list of str, optional</span>
<span class="sd">        Columns to apply safe_literal_eval to</span>
<span class="sd">    home_path : str or Path, optional</span>
<span class="sd">        Base path to use instead of user&#39;s home directory</span>
<span class="sd">    encoding : str, optional</span>
<span class="sd">        The encoding to use when reading CSV files (e.g., &#39;utf-8&#39;, &#39;latin1&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Loaded and transformed DataFrame</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the specified file does not exist</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the file format is not supported or other processing errors occur</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="c1"># Use provided home_path if available, otherwise default to user&#39;s home directory</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">home_path</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">/</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found at path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported file format: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">. Must be .csv or .pkl&quot;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index_column</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">index_column</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_column</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Index column &#39;</span><span class="si">{</span><span class="n">index_column</span><span class="si">}</span><span class="s2">&#39; not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sort_columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: One or more sort columns not found in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eval_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">eval_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">safe_literal_eval</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: Error applying safe_literal_eval to column &#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.parse_args" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_args</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parse command-line arguments for the training script.</p>
<p>Returns:
    argparse.Namespace: The parsed arguments containing 'data_folder_name' and 'uclh' keys.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command-line arguments for the training script.</span>

<span class="sd">    Returns:</span>
<span class="sd">        argparse.Namespace: The parsed arguments containing &#39;data_folder_name&#39; and &#39;uclh&#39; keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Train emergency demand models&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--data_folder_name&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;data-synthetic&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of data for training&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--uclh&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Train using UCLH data (True) or Public data (False)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.safe_literal_eval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">safe_literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Safely evaluate a string literal into a Python object.
Handles list-like strings by converting them to lists.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>s</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The string to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Any, list, or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The evaluated Python object if successful, a list if the input is list-like,
or None for empty/null values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">safe_literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safely evaluate a string literal into a Python object.</span>
<span class="sd">    Handles list-like strings by converting them to lists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to evaluate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any, list, or None</span>
<span class="sd">        The evaluated Python object if successful, a list if the input is list-like,</span>
<span class="sd">        or None for empty/null values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Remove square brackets and split by comma</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="c1"># Strip whitespace from each item and remove empty strings</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If the above fails, fall back to ast.literal_eval</span>
                <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
        <span class="c1"># If ast.literal_eval fails, return the original string</span>
        <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.set_data_file_names" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_data_file_names</span><span class="p">(</span><span class="n">uclh</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set file locations based on UCLH or default data source.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>uclh</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use UCLH-specific file locations. If False, use default file locations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base path to the data directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the configuration file, required if <code>uclh</code> is True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Paths to the required files (visits, arrivals) based on the configuration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_data_file_names</span><span class="p">(</span><span class="n">uclh</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set file locations based on UCLH or default data source.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uclh : bool</span>
<span class="sd">        If True, use UCLH-specific file locations. If False, use default file locations.</span>
<span class="sd">    data_file_path : Path</span>
<span class="sd">        The base path to the data directory.</span>
<span class="sd">    config_file_path : str, optional</span>
<span class="sd">        The path to the configuration file, required if `uclh` is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Paths to the required files (visits, arrivals) based on the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">uclh</span><span class="p">:</span>
        <span class="n">csv_filename</span> <span class="o">=</span> <span class="s2">&quot;ed_visits.csv&quot;</span>
        <span class="n">yta_csv_filename</span> <span class="o">=</span> <span class="s2">&quot;inpatient_arrivals.csv&quot;</span>

        <span class="n">visits_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">csv_filename</span>
        <span class="n">yta_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">yta_csv_filename</span>

        <span class="k">return</span> <span class="n">visits_csv_path</span><span class="p">,</span> <span class="n">yta_csv_path</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">load_config_file</span><span class="p">(</span>
            <span class="n">config_file_path</span><span class="p">,</span> <span class="n">return_start_end_dates</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;uclh_visits_exc_beds_inc_minority_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span>
        <span class="p">)</span>
        <span class="n">csv_filename</span> <span class="o">=</span> <span class="s2">&quot;uclh_ed_visits.csv&quot;</span>
        <span class="n">yta_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;uclh_yet_to_arrive_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span>
        <span class="p">)</span>
        <span class="n">yta_csv_filename</span> <span class="o">=</span> <span class="s2">&quot;uclh_inpatient_arrivals.csv&quot;</span>

        <span class="n">visits_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">data_filename</span>
        <span class="n">yta_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">yta_filename</span>

        <span class="n">visits_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">csv_filename</span>
        <span class="n">yta_csv_path</span> <span class="o">=</span> <span class="n">data_file_path</span> <span class="o">/</span> <span class="n">yta_csv_filename</span>

    <span class="k">return</span> <span class="n">visits_path</span><span class="p">,</span> <span class="n">visits_csv_path</span><span class="p">,</span> <span class="n">yta_path</span><span class="p">,</span> <span class="n">yta_csv_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.set_file_paths" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_file_paths</span><span class="p">(</span><span class="n">project_root</span><span class="p">,</span> <span class="n">data_folder_name</span><span class="p">,</span> <span class="n">train_dttm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="s1">&#39;config.yaml&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets up the file paths</p>
<p>Args:
    project_root (Path): Root path of the project
    data_folder_name (str): Name of the folder where data files are located
    train_dttm (Optional[str], optional): A string representation of the datetime at which training commenced. Defaults to None
    inference_time (bool, optional): A flag indicating whether it is inference time or not. Defaults to False
    config_file (str, optional): Name of config file. Defaults to "config.yaml"
    prefix (Optional[str], optional): String to prefix model folder names. Defaults to None
    verbose (bool, optional): Whether to print path information. Defaults to True</p>
<p>Returns:
    tuple: Contains (data_file_path, media_file_path, model_file_path, config_path)</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_file_paths</span><span class="p">(</span>
    <span class="n">project_root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">data_folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">train_dttm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inference_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the file paths</span>

<span class="sd">    Args:</span>
<span class="sd">        project_root (Path): Root path of the project</span>
<span class="sd">        data_folder_name (str): Name of the folder where data files are located</span>
<span class="sd">        train_dttm (Optional[str], optional): A string representation of the datetime at which training commenced. Defaults to None</span>
<span class="sd">        inference_time (bool, optional): A flag indicating whether it is inference time or not. Defaults to False</span>
<span class="sd">        config_file (str, optional): Name of config file. Defaults to &quot;config.yaml&quot;</span>
<span class="sd">        prefix (Optional[str], optional): String to prefix model folder names. Defaults to None</span>
<span class="sd">        verbose (bool, optional): Whether to print path information. Defaults to True</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Contains (data_file_path, media_file_path, model_file_path, config_path)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">config_file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration will be loaded from: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_folder_name</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data files will be loaded from: </span><span class="si">{</span><span class="n">data_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model_id</span> <span class="o">=</span> <span class="n">data_folder_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;data-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">train_dttm</span><span class="p">:</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">train_dttm</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">model_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;trained-models&quot;</span> <span class="o">/</span> <span class="n">model_id</span>
    <span class="n">media_file_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="s2">&quot;media&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_time</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trained models will be saved to: </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model_file_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">model_file_path</span> <span class="o">/</span> <span class="s2">&quot;model-output&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">media_file_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Images will be saved to: </span><span class="si">{</span><span class="n">media_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_file_path</span><span class="p">,</span> <span class="n">media_file_path</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">,</span> <span class="n">config_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.load.set_project_root" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_project_root</span><span class="p">(</span><span class="n">env_var</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets project root path from environment variable or infers it from current path.</p>
<p>First checks specified environment variable for project root path.
If not found, searches current path hierarchy for highest-level 'patientflow' directory.</p>
<p>Args:
    env_var (Optional[str]): Name of environment variable containing project root path</p>
<p>Returns:
    Path: Validated project root path</p>
<p>Raises:
    ValueError: If environment variable not set and 'patientflow' not found in path
    NotADirectoryError: If path doesn't exist
    TypeError: If env_var is not None and not a string</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_project_root</span><span class="p">(</span><span class="n">env_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets project root path from environment variable or infers it from current path.</span>

<span class="sd">    First checks specified environment variable for project root path.</span>
<span class="sd">    If not found, searches current path hierarchy for highest-level &#39;patientflow&#39; directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        env_var (Optional[str]): Name of environment variable containing project root path</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path: Validated project root path</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If environment variable not set and &#39;patientflow&#39; not found in path</span>
<span class="sd">        NotADirectoryError: If path doesn&#39;t exist</span>
<span class="sd">        TypeError: If env_var is not None and not a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Only try to get env path if env_var is provided</span>
    <span class="n">env_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span> <span class="k">if</span> <span class="n">env_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">project_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Try getting from environment variable first</span>
    <span class="k">if</span> <span class="n">env_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">project_root</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path does not exist: </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project root from environment: </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project_root</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2"> to Path: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If not in env var, try to infer from current path</span>
        <span class="n">current</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># Search through parents to find highest-level &#39;patientflow&#39; directory</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="o">*</span><span class="n">current</span><span class="o">.</span><span class="n">parents</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;patientflow&quot;</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">project_root</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="c1"># Continue searching to find highest level</span>

        <span class="k">if</span> <span class="n">project_root</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred project root: </span><span class="si">{</span><span class="n">project_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project_root</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find project root - </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2"> not set and &#39;patientflow&#39; not found in path&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current directory: </span><span class="si">{</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_var</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run one of these commands in a new cell to set </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Linux/Mac:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%env </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2">=/path/to/project&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Windows:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%env </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2">=C:</span><span class="se">\\</span><span class="s2">path</span><span class="se">\\</span><span class="s2">to</span><span class="se">\\</span><span class="s2">project&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Project root not found&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.model_artifacts" class="doc doc-heading">
            <code>model_artifacts</code>


</h2>

    <div class="doc doc-contents ">

        <p>Model training results containers.</p>
<p>This module defines a set of data classes to organise results from
model training, including hyperparameter tuning, cross-validation fold metrics,
and final trained classifier artifacts. These classes serve as structured containers for
various types of model evaluation outputs and metadata.</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="HyperParameterTrial


  
      dataclass
   (patientflow.model_artifacts.HyperParameterTrial)" href="#patientflow.model_artifacts.HyperParameterTrial">HyperParameterTrial</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Container for storing hyperparameter tuning trial results.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="FoldResults


  
      dataclass
   (patientflow.model_artifacts.FoldResults)" href="#patientflow.model_artifacts.FoldResults">FoldResults</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Stores evaluation metrics from a single cross-validation fold.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="TrainingResults


  
      dataclass
   (patientflow.model_artifacts.TrainingResults)" href="#patientflow.model_artifacts.TrainingResults">TrainingResults</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Encapsulates comprehensive evaluation metrics and metadata from model training.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Container for a trained model and associated training results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.FoldResults" class="doc doc-heading">
            <code>FoldResults</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Store evaluation metrics for a single fold.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.FoldResults.auc">auc</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Area Under the ROC Curve (AUC) for this fold.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.FoldResults.logloss">logloss</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logarithmic loss (cross-entropy loss) for this fold.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.FoldResults.auprc">auprc</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Area Under the Precision-Recall Curve (AUPRC) for this fold.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FoldResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store evaluation metrics for a single fold.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    auc : float</span>
<span class="sd">        Area Under the ROC Curve (AUC) for this fold.</span>
<span class="sd">    logloss : float</span>
<span class="sd">        Logarithmic loss (cross-entropy loss) for this fold.</span>
<span class="sd">    auprc : float</span>
<span class="sd">        Area Under the Precision-Recall Curve (AUPRC) for this fold.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">auc</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">logloss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">auprc</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.HyperParameterTrial" class="doc doc-heading">
            <code>HyperParameterTrial</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Container for a single hyperparameter tuning trial.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.HyperParameterTrial.parameters">parameters</span></code></td>
            <td>
                  <code>dict of str to Any</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of hyperparameters used in the trial.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.HyperParameterTrial.cv_results">cv_results</span></code></td>
            <td>
                  <code>dict of str to float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cross-validation metrics obtained using the specified parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HyperParameterTrial</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for a single hyperparameter tuning trial.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : dict of str to Any</span>
<span class="sd">        Dictionary of hyperparameters used in the trial.</span>
<span class="sd">    cv_results : dict of str to float</span>
<span class="sd">        Cross-validation metrics obtained using the specified parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">cv_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.TrainedClassifier" class="doc doc-heading">
            <code>TrainedClassifier</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Container for trained model artifacts and their associated information.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainedClassifier.training_results">training_results</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TrainingResults


  
      dataclass
   (patientflow.model_artifacts.TrainingResults)" href="#patientflow.model_artifacts.TrainingResults">TrainingResults</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Evaluation metrics and training metadata for the classifier.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainedClassifier.pipeline">pipeline</span></code></td>
            <td>
                  <code>(<span title="sklearn.pipeline.Pipeline">Pipeline</span> or None, <span title="optional">optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The scikit-learn pipeline representing the trained classifier.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainedClassifier.calibrated_pipeline">calibrated_pipeline</span></code></td>
            <td>
                  <code>(<span title="sklearn.pipeline.Pipeline">Pipeline</span> or None, <span title="optional">optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calibrated version of the pipeline, if model calibration was performed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainedClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for trained model artifacts and their associated information.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    training_results : TrainingResults</span>
<span class="sd">        Evaluation metrics and training metadata for the classifier.</span>
<span class="sd">    pipeline : sklearn.pipeline.Pipeline or None, optional</span>
<span class="sd">        The scikit-learn pipeline representing the trained classifier.</span>
<span class="sd">    calibrated_pipeline : sklearn.pipeline.Pipeline or None, optional</span>
<span class="sd">        The calibrated version of the pipeline, if model calibration was performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">training_results</span><span class="p">:</span> <span class="n">TrainingResults</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">calibrated_pipeline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="patientflow.model_artifacts.TrainingResults" class="doc doc-heading">
            <code>TrainingResults</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Store comprehensive evaluation metrics and metadata from model training.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainingResults.prediction_time">prediction_time</span></code></td>
            <td>
                  <code>tuple of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start and end time of prediction, represented as UNIX timestamps.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainingResults.training_info">training_info</span></code></td>
            <td>
                  <code>dict of str to Any, optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata or logs collected during training.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainingResults.calibration_info">calibration_info</span></code></td>
            <td>
                  <code>dict of str to Any, optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about model calibration, if applicable.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainingResults.test_results">test_results</span></code></td>
            <td>
                  <code>dict of str to float, optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Evaluation metrics computed on the test dataset. None if test evaluation was not performed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.model_artifacts.TrainingResults.balance_info">balance_info</span></code></td>
            <td>
                  <code>dict of str to bool or int or float, optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information related to class balance (e.g., whether data was balanced, class ratios).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/model_artifacts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainingResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store comprehensive evaluation metrics and metadata from model training.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_time : tuple of int</span>
<span class="sd">        Start and end time of prediction, represented as UNIX timestamps.</span>
<span class="sd">    training_info : dict of str to Any, optional</span>
<span class="sd">        Metadata or logs collected during training.</span>
<span class="sd">    calibration_info : dict of str to Any, optional</span>
<span class="sd">        Information about model calibration, if applicable.</span>
<span class="sd">    test_results : dict of str to float, optional</span>
<span class="sd">        Evaluation metrics computed on the test dataset. None if test evaluation was not performed.</span>
<span class="sd">    balance_info : dict of str to bool or int or float, optional</span>
<span class="sd">        Information related to class balance (e.g., whether data was balanced, class ratios).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">training_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">calibration_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">test_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">balance_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.predict" class="doc doc-heading">
            <code>predict</code>


</h2>

    <div class="doc doc-contents ">

        <p>Prediction module for patient flow forecasting.</p>
<p>This module provides functions for making predictions about future patient flow,
including emergency demand forecasting and other predictive analytics.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.predict.emergency_demand" class="doc doc-heading">
            <code>emergency_demand</code>


</h3>

    <div class="doc doc-contents ">

        <p>Emergency demand prediction module.</p>
<p>This module provides functionality for predicting emergency department demand,
including specialty-specific predictions for both current patients and yet-to-arrive patients.
It handles probability calculations, model predictions, and threshold-based resource estimation.</p>
<p>The module integrates multiple prediction models:
- Admission prediction classifier
- Specialty sequence predictor
- Yet-to-arrive weighted Poisson predictor</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.predict.emergency_demand.add_missing_columns : function">add_missing_columns : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add missing columns required by the prediction pipeline</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.predict.emergency_demand.find_probability_threshold_index : function">find_probability_threshold_index : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Find index where cumulative probability exceeds threshold</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.predict.emergency_demand.get_specialty_probs : function">get_specialty_probs : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate specialty probability distributions</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.predict.emergency_demand.create_predictions : function">create_predictions : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create predictions for emergency demand</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.add_missing_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add missing columns required by the prediction pipeline from the training data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pipeline</code>
            </td>
            <td>
                  <code><span title="sklearn.pipeline.Pipeline">Pipeline</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The trained pipeline containing the feature transformer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe that may be missing required columns</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with missing columns added and filled with appropriate default values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>Adds columns with default values based on column name patterns:
- lab_orders_, visited_, has_ : False
- num_, total_ : 0
- latest_ : pd.NA
- arrival_method : "None"
- others : pd.NA</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add missing columns required by the prediction pipeline from the training data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline : sklearn.pipeline.Pipeline</span>
<span class="sd">        The trained pipeline containing the feature transformer</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input dataframe that may be missing required columns</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with missing columns added and filled with appropriate default values</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Adds columns with default values based on column name patterns:</span>
<span class="sd">    - lab_orders_, visited_, has_ : False</span>
<span class="sd">    - num_, total_ : 0</span>
<span class="sd">    - latest_ : pd.NA</span>
<span class="sd">    - arrival_method : &quot;None&quot;</span>
<span class="sd">    - others : pd.NA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check input data for missing columns</span>
    <span class="n">column_transformer</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;feature_transformer&quot;</span><span class="p">]</span>

    <span class="c1"># Function to get feature names before one-hot encoding</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_names_before_encoding</span><span class="p">(</span><span class="n">column_transformer</span><span class="p">):</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">column_transformer</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">):</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">):</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">):</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature_names</span>

    <span class="n">feature_names_before_encoding</span> <span class="o">=</span> <span class="n">get_feature_names_before_encoding</span><span class="p">(</span>
        <span class="n">column_transformer</span>
    <span class="p">)</span>

    <span class="n">added_columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">missing_col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">feature_names_before_encoding</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">missing_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;lab_orders_&quot;</span><span class="p">,</span> <span class="s2">&quot;visited_&quot;</span><span class="p">,</span> <span class="s2">&quot;has_&quot;</span><span class="p">)):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">missing_col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">missing_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;num_&quot;</span><span class="p">,</span> <span class="s2">&quot;total_&quot;</span><span class="p">)):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">missing_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">missing_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;latest_&quot;</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">missing_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="k">elif</span> <span class="n">missing_col</span> <span class="o">==</span> <span class="s2">&quot;arrival_method&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">missing_col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">missing_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="n">added_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">missing_col</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">added_columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Warning: The following columns were used in training, but not found in the real-time data. These have been added to the dataframe: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">added_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.create_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_predictions</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">prediction_snapshots</span><span class="p">,</span> <span class="n">specialties</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">cdf_cut_points</span><span class="p">,</span> <span class="n">use_admission_in_window_prob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create predictions for emergency demand for a single prediction moment.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-internal" title="SequenceToOutcomePredictor (patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor)" href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor">SequenceToOutcomePredictor</a>, <a class="autorefs autorefs-internal" title="ValueToOutcomePredictor (patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor)" href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor">ValueToOutcomePredictor</a>], <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-internal" title="ParametricIncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor">ParametricIncomingAdmissionPredictor</a>, <a class="autorefs autorefs-internal" title="EmpiricalIncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor">EmpiricalIncomingAdmissionPredictor</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing:
- classifier: TrainedClassifier containing admission predictions
- spec_model: SequenceToOutcomePredictor or ValueToOutcomePredictor for specialty predictions
- yet_to_arrive_model: ParametricIncomingAdmissionPredictor or EmpiricalIncomingAdmissionPredictor for yet-to-arrive predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour and minute of time for model inference</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_snapshots</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing prediction snapshots. Must have an 'elapsed_los' column of type timedelta.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>specialties</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of specialty names for predictions (e.g., ['surgical', 'medical'])</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window as a timedelta object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>X-coordinate of first point for probability curve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y-coordinate of first point for probability curve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>X-coordinate of second point for probability curve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y-coordinate of second point for probability curve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cdf_cut_points</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of cumulative distribution function cut points (e.g., [0.9, 0.7])</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_admission_in_window_prob</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use probability calculation for admission within prediction window for patients
already in the ED. If False, probability is set to 1.0 for all current ED patients.
This parameter does not affect the yet-to-arrive predictions. By default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary containing predictions for each specialty:
{
    'specialty_name': {
        'in_ed': [pred1, pred2, ...],
        'yet_to_arrive': [pred1, pred2, ...]
    }
}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any of the models are not of the expected type or if prediction_window is not a timedelta</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If models have not been fit or if prediction parameters don't match training parameters
If 'elapsed_los' column is missing or not of type timedelta</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The models in the models dictionary must be ModelResults objects
that contain either a 'pipeline' or 'calibrated_pipeline' attribute. The pipeline
will be used for making predictions, with calibrated_pipeline taking precedence
if both exist.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_predictions</span><span class="p">(</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">TrainedClassifier</span><span class="p">,</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">SequenceToOutcomePredictor</span><span class="p">,</span> <span class="n">ValueToOutcomePredictor</span><span class="p">],</span>
        <span class="n">Union</span><span class="p">[</span>
            <span class="n">ParametricIncomingAdmissionPredictor</span><span class="p">,</span> <span class="n">EmpiricalIncomingAdmissionPredictor</span>
        <span class="p">],</span>
    <span class="p">],</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">prediction_snapshots</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">specialties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">cdf_cut_points</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">use_admission_in_window_prob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create predictions for emergency demand for a single prediction moment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models : Tuple[TrainedClassifier, Union[SequenceToOutcomePredictor, ValueToOutcomePredictor], Union[ParametricIncomingAdmissionPredictor, EmpiricalIncomingAdmissionPredictor]]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - classifier: TrainedClassifier containing admission predictions</span>
<span class="sd">        - spec_model: SequenceToOutcomePredictor or ValueToOutcomePredictor for specialty predictions</span>
<span class="sd">        - yet_to_arrive_model: ParametricIncomingAdmissionPredictor or EmpiricalIncomingAdmissionPredictor for yet-to-arrive predictions</span>
<span class="sd">    prediction_time : Tuple</span>
<span class="sd">        Hour and minute of time for model inference</span>
<span class="sd">    prediction_snapshots : pandas.DataFrame</span>
<span class="sd">        DataFrame containing prediction snapshots. Must have an &#39;elapsed_los&#39; column of type timedelta.</span>
<span class="sd">    specialties : List[str]</span>
<span class="sd">        List of specialty names for predictions (e.g., [&#39;surgical&#39;, &#39;medical&#39;])</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        Prediction window as a timedelta object</span>
<span class="sd">    x1 : float</span>
<span class="sd">        X-coordinate of first point for probability curve</span>
<span class="sd">    y1 : float</span>
<span class="sd">        Y-coordinate of first point for probability curve</span>
<span class="sd">    x2 : float</span>
<span class="sd">        X-coordinate of second point for probability curve</span>
<span class="sd">    y2 : float</span>
<span class="sd">        Y-coordinate of second point for probability curve</span>
<span class="sd">    cdf_cut_points : List[float]</span>
<span class="sd">        List of cumulative distribution function cut points (e.g., [0.9, 0.7])</span>
<span class="sd">    use_admission_in_window_prob : bool, optional</span>
<span class="sd">        Whether to use probability calculation for admission within prediction window for patients</span>
<span class="sd">        already in the ED. If False, probability is set to 1.0 for all current ED patients.</span>
<span class="sd">        This parameter does not affect the yet-to-arrive predictions. By default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Dict[str, List[int]]]</span>
<span class="sd">        Nested dictionary containing predictions for each specialty:</span>
<span class="sd">        {</span>
<span class="sd">            &#39;specialty_name&#39;: {</span>
<span class="sd">                &#39;in_ed&#39;: [pred1, pred2, ...],</span>
<span class="sd">                &#39;yet_to_arrive&#39;: [pred1, pred2, ...]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If any of the models are not of the expected type or if prediction_window is not a timedelta</span>
<span class="sd">    ValueError</span>
<span class="sd">        If models have not been fit or if prediction parameters don&#39;t match training parameters</span>
<span class="sd">        If &#39;elapsed_los&#39; column is missing or not of type timedelta</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The models in the models dictionary must be ModelResults objects</span>
<span class="sd">    that contain either a &#39;pipeline&#39; or &#39;calibrated_pipeline&#39; attribute. The pipeline</span>
<span class="sd">    will be used for making predictions, with calibrated_pipeline taking precedence</span>
<span class="sd">    if both exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate model types</span>
    <span class="n">classifier</span><span class="p">,</span> <span class="n">spec_model</span><span class="p">,</span> <span class="n">yet_to_arrive_model</span> <span class="o">=</span> <span class="n">models</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;First model must be of type TrainedClassifier&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">spec_model</span><span class="p">,</span> <span class="p">(</span><span class="n">SequenceToOutcomePredictor</span><span class="p">,</span> <span class="n">ValueToOutcomePredictor</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Second model must be of type SequenceToOutcomePredictor or ValueToOutcomePredictor&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">yet_to_arrive_model</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ParametricIncomingAdmissionPredictor</span><span class="p">,</span> <span class="n">EmpiricalIncomingAdmissionPredictor</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Third model must be of type ParametricIncomingAdmissionPredictor or EmpiricalIncomingAdmissionPredictor&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;elapsed_los&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Column &#39;elapsed_los&#39; not found in prediction_snapshots&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_timedelta64_dtype</span><span class="p">(</span><span class="n">prediction_snapshots</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">]):</span>
        <span class="n">actual_type</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Column &#39;elapsed_los&#39; must be a timedelta column, but found type: </span><span class="si">{</span><span class="n">actual_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check that all models have been fit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">classifier</span><span class="o">.</span><span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Classifier model has not been fit&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spec_model</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec_model</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specialty model has not been fit&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="p">,</span> <span class="s2">&quot;prediction_window&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">prediction_window</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Yet-to-arrive model has not been fit&quot;</span><span class="p">)</span>

    <span class="c1"># Validate that the correct models have been passed for the requested prediction time and prediction window</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">classifier</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Requested prediction time </span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2"> does not match the prediction time of the trained classifier </span><span class="si">{</span><span class="n">classifier</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Compare prediction windows directly</span>
    <span class="k">if</span> <span class="n">prediction_window</span> <span class="o">!=</span> <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Requested prediction window </span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2"> does not match the prediction window of the trained yet-to-arrive model </span><span class="si">{</span><span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Requested specialties </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">)</span><span class="si">}</span><span class="s2"> do not match the specialties of the trained yet-to-arrive model </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">special_params</span> <span class="o">=</span> <span class="n">spec_model</span><span class="o">.</span><span class="n">special_params</span>

    <span class="k">if</span> <span class="n">special_params</span><span class="p">:</span>
        <span class="n">special_category_func</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_func&quot;</span><span class="p">]</span>
        <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span>
        <span class="n">special_func_map</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">special_category_func</span> <span class="o">=</span> <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_func_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">special_category_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">special_category_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Requested specialties do not match the specialty dictionary defined in special_params&quot;</span>
        <span class="p">)</span>

    <span class="n">predictions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">specialty</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;in_ed&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">specialty</span> <span class="ow">in</span> <span class="n">specialties</span>
    <span class="p">}</span>

    <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">classifier</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">pipeline</span>

    <span class="c1"># Add missing columns expected by the model</span>
    <span class="n">prediction_snapshots</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">prediction_snapshots</span><span class="p">)</span>

    <span class="c1"># Before we get predictions, we need to create a temp copy with the elapsed_los column in seconds</span>
    <span class="n">prediction_snapshots_temp</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">prediction_snapshots_temp</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction_snapshots_temp</span><span class="p">[</span>
        <span class="s2">&quot;elapsed_los&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

    <span class="c1"># Get predictions of admissions for ED patients</span>
    <span class="n">prob_admission_after_ed</span> <span class="o">=</span> <span class="n">model_input_to_pred_proba</span><span class="p">(</span>
        <span class="n">prediction_snapshots_temp</span><span class="p">,</span> <span class="n">pipeline</span>
    <span class="p">)</span>

    <span class="c1"># Get predictions of admission to specialty</span>
    <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;specialty_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_specialty_probs</span><span class="p">(</span>
        <span class="n">specialties</span><span class="p">,</span>
        <span class="n">spec_model</span><span class="p">,</span>
        <span class="n">prediction_snapshots</span><span class="p">,</span>
        <span class="n">special_category_func</span><span class="o">=</span><span class="n">special_category_func</span><span class="p">,</span>
        <span class="n">special_category_dict</span><span class="o">=</span><span class="n">special_category_dict</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get probability of admission within prediction window for current ED patients</span>
    <span class="k">if</span> <span class="n">use_admission_in_window_prob</span><span class="p">:</span>
        <span class="c1"># Check if the third model is EmpiricalIncomingAdmissionPredictor and use survival curve</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yet_to_arrive_model</span><span class="p">,</span> <span class="n">EmpiricalIncomingAdmissionPredictor</span><span class="p">):</span>
            <span class="n">prob_admission_in_window</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_admission_probability_from_survival_curve</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">],</span>
                    <span class="n">prediction_window</span><span class="p">,</span>
                    <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">survival_df</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_admission_in_window</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_probability</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">],</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prob_admission_in_window</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">special_func_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">special_func_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">specialty</span> <span class="ow">in</span> <span class="n">specialties</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">special_func_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">specialty</span><span class="p">,</span> <span class="n">special_func_map</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
        <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="p">[</span>
            <span class="n">prediction_snapshots</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">filtered_prob_admission_after_ed</span> <span class="o">=</span> <span class="n">prob_admission_after_ed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">non_zero_indices</span><span class="p">]</span>
        <span class="n">prob_admission_to_specialty</span> <span class="o">=</span> <span class="n">prediction_snapshots</span><span class="p">[</span><span class="s2">&quot;specialty_prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">filtered_prob_admission_to_specialty</span> <span class="o">=</span> <span class="n">prob_admission_to_specialty</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">non_zero_indices</span>
        <span class="p">]</span>
        <span class="n">filtered_prob_admission_in_window</span> <span class="o">=</span> <span class="n">prob_admission_in_window</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">non_zero_indices</span>
        <span class="p">]</span>

        <span class="n">filtered_weights</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">filtered_prob_admission_to_specialty</span> <span class="o">*</span> <span class="n">filtered_prob_admission_in_window</span>
        <span class="p">)</span>

        <span class="n">agg_predicted_in_ed</span> <span class="o">=</span> <span class="n">pred_proba_to_agg_predicted</span><span class="p">(</span>
            <span class="n">filtered_prob_admission_after_ed</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">filtered_weights</span>
        <span class="p">)</span>

        <span class="n">prediction_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">specialty</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">:</span> <span class="n">prediction_time</span><span class="p">}}</span>
        <span class="n">agg_predicted_yta</span> <span class="o">=</span> <span class="n">yet_to_arrive_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">prediction_context</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">y2</span>
        <span class="p">)</span>

        <span class="n">predictions</span><span class="p">[</span><span class="n">specialty</span><span class="p">][</span><span class="s2">&quot;in_ed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">find_probability_threshold_index</span><span class="p">(</span>
                <span class="n">agg_predicted_in_ed</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cut_point</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cut_point</span> <span class="ow">in</span> <span class="n">cdf_cut_points</span>
        <span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">specialty</span><span class="p">][</span><span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">find_probability_threshold_index</span><span class="p">(</span>
                <span class="n">agg_predicted_yta</span><span class="p">[</span><span class="n">specialty</span><span class="p">][</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cut_point</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cut_point</span> <span class="ow">in</span> <span class="n">cdf_cut_points</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.find_probability_threshold_index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_probability_threshold_index</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Find index where cumulative probability exceeds threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sequence</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability mass function (PMF) of resource needs</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability threshold (e.g., 0.9 for 90%)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index where the cumulative probability exceeds 1 - threshold,
indicating the number of resources needed with the specified probability</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">pmf</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">find_probability_threshold_index</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="go">5</span>
<span class="go"># This means there is a 90% probability of needing at least 5 beds</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_probability_threshold_index</span><span class="p">(</span><span class="n">sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find index where cumulative probability exceeds threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequence : List[float]</span>
<span class="sd">        The probability mass function (PMF) of resource needs</span>
<span class="sd">    threshold : float</span>
<span class="sd">        The probability threshold (e.g., 0.9 for 90%)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The index where the cumulative probability exceeds 1 - threshold,</span>
<span class="sd">        indicating the number of resources needed with the specified probability</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; pmf = [0.05, 0.1, 0.2, 0.3, 0.2, 0.1, 0.05]</span>
<span class="sd">    &gt;&gt;&gt; find_probability_threshold_index(pmf, 0.9)</span>
<span class="sd">    5</span>
<span class="sd">    # This means there is a 90% probability of needing at least 5 beds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cumulative_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
        <span class="n">cumulative_sum</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">cumulative_sum</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Return the last index if the threshold isn&#39;t reached</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predict.emergency_demand.get_specialty_probs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_specialty_probs</span><span class="p">(</span><span class="n">specialties</span><span class="p">,</span> <span class="n">specialty_model</span><span class="p">,</span> <span class="n">snapshots_df</span><span class="p">,</span> <span class="n">special_category_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">special_category_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate specialty probability distributions for patient visits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>specialties</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of specialty names for which predictions are required</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>specialty_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#object">object</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained model for making specialty predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>snapshots_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing the data on which predictions are to be made. Must include
the input_var column if no special_category_func is applied</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>special_category_func</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#callable">callable</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that takes a DataFrame row (Series) as input and returns True if the row
belongs to a special category that requires a fixed probability distribution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>special_category_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the fixed probability distribution for special category cases.
Required if special_category_func is provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Series containing dictionaries as values. Each dictionary represents the probability
distribution of specialties for each patient visit</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If special_category_func is provided but special_category_dict is None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predict/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_specialty_probs</span><span class="p">(</span>
    <span class="n">specialties</span><span class="p">,</span>
    <span class="n">specialty_model</span><span class="p">,</span>
    <span class="n">snapshots_df</span><span class="p">,</span>
    <span class="n">special_category_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">special_category_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate specialty probability distributions for patient visits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    specialties : str</span>
<span class="sd">        List of specialty names for which predictions are required</span>
<span class="sd">    specialty_model : object</span>
<span class="sd">        Trained model for making specialty predictions</span>
<span class="sd">    snapshots_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the data on which predictions are to be made. Must include</span>
<span class="sd">        the input_var column if no special_category_func is applied</span>
<span class="sd">    special_category_func : callable, optional</span>
<span class="sd">        A function that takes a DataFrame row (Series) as input and returns True if the row</span>
<span class="sd">        belongs to a special category that requires a fixed probability distribution</span>
<span class="sd">    special_category_dict : dict, optional</span>
<span class="sd">        A dictionary containing the fixed probability distribution for special category cases.</span>
<span class="sd">        Required if special_category_func is provided</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        A Series containing dictionaries as values. Each dictionary represents the probability</span>
<span class="sd">        distribution of specialties for each patient visit</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If special_category_func is provided but special_category_dict is None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert input_var to tuple if not already a tuple</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_df</span><span class="p">[</span><span class="n">specialty_model</span><span class="o">.</span><span class="n">input_var</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">snapshots_df</span><span class="p">[</span><span class="n">specialty_model</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span>
    <span class="p">):</span>
        <span class="n">snapshots_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">specialty_model</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshots_df</span><span class="p">[</span>
            <span class="n">specialty_model</span><span class="o">.</span><span class="n">input_var</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="p">())</span>

    <span class="k">if</span> <span class="n">special_category_func</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">special_category_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;special_category_dict must be provided if special_category_func is specified.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Function to determine the specialty probabilities</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">determine_specialty</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">special_category_func</span> <span class="ow">and</span> <span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">special_category_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">specialty_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">specialty_model</span><span class="o">.</span><span class="n">input_var</span><span class="p">])</span>

    <span class="c1"># Apply the determine_specialty function to each row</span>
    <span class="n">specialty_prob_series</span> <span class="o">=</span> <span class="n">snapshots_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_specialty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find all unique keys used in any dictionary within the series</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">specialty_prob_series</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Combine all_keys with the specialties requested</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_keys</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">specialties</span><span class="p">))</span>

    <span class="c1"># Ensure each dictionary contains all keys found, with default values of 0 for missing keys</span>
    <span class="n">specialty_prob_series</span> <span class="o">=</span> <span class="n">specialty_prob_series</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span>
            <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">specialty_prob_series</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.predictors" class="doc doc-heading">
            <code>predictors</code>


</h2>

    <div class="doc doc-contents ">

        <p>Predictor models for patient flow analysis.</p>
<p>This module contains various predictor model implementations, including sequence-based
predictors and weighted Poisson predictors for modeling patient flow patterns.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.predictors.incoming_admission_predictors" class="doc doc-heading">
            <code>incoming_admission_predictors</code>


</h3>

    <div class="doc doc-contents ">

        <p>Hospital Admissions Forecasting Predictors.</p>
<p>This module implements custom predictors to estimate the number of hospital admissions
within a specified prediction window using historical admission data. It provides two
approaches: parametric curves with Poisson-binomial distributions and empirical survival
curves with convolution of Poisson distributions. Both predictors accommodate different
data filters for tailored predictions across various hospital settings.</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor : BaseEstimator, TransformerMixin">IncomingAdmissionPredictor : BaseEstimator, TransformerMixin</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>Base class for admission predictors that handles filtering and arrival rate calculation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor : IncomingAdmissionPredictor">ParametricIncomingAdmissionPredictor : IncomingAdmissionPredictor</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>Predicts the number of admissions within a given prediction window based on historical
data and Poisson-binomial distribution using parametric aspirational curves.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor : IncomingAdmissionPredictor">EmpiricalIncomingAdmissionPredictor : IncomingAdmissionPredictor</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>Predicts the number of admissions using empirical survival curves and convolution
of Poisson distributions instead of parametric curves.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The ParametricIncomingAdmissionPredictor uses a combination of Poisson and binomial distributions to
model the probability of admissions within a prediction window using parametric curves
defined by transition points (x1, y1, x2, y2).</p>
<p>The EmpiricalIncomingAdmissionPredictor inherits the arrival rate calculation and filtering logic
but replaces the parametric approach with empirical survival probabilities and convolution
of individual Poisson distributions for each time interval.</p>
<p>Both predictors take into account historical data patterns and can be filtered for
specific hospital settings or specialties.</p>
</details>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor" class="doc doc-heading">
            <code>EmpiricalIncomingAdmissionPredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="IncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor">IncomingAdmissionPredictor</a></code></p>


        <p>A predictor that uses empirical survival curves instead of parameterised curves.</p>
<p>This predictor inherits all the arrival rate calculation and filtering logic from
IncomingAdmissionPredictor but uses empirical survival probabilities and convolution
of Poisson distributions for prediction instead of the Poisson-binomial approach.</p>
<p>The survival curve is automatically calculated from the training data during the
fit process by analysing time-to-admission patterns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filters for data categorization. If None, no filtering is applied.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable verbose logging.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.survival_df">survival_df</span></code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The survival data calculated from training data, containing time-to-event
information for empirical probability calculations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EmpiricalIncomingAdmissionPredictor</span><span class="p">(</span><span class="n">IncomingAdmissionPredictor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A predictor that uses empirical survival curves instead of parameterised curves.</span>

<span class="sd">    This predictor inherits all the arrival rate calculation and filtering logic from</span>
<span class="sd">    IncomingAdmissionPredictor but uses empirical survival probabilities and convolution</span>
<span class="sd">    of Poisson distributions for prediction instead of the Poisson-binomial approach.</span>

<span class="sd">    The survival curve is automatically calculated from the training data during the</span>
<span class="sd">    fit process by analysing time-to-admission patterns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filters : dict, optional</span>
<span class="sd">        Optional filters for data categorization. If None, no filtering is applied.</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to enable verbose logging.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    survival_df : pandas.DataFrame</span>
<span class="sd">        The survival data calculated from training data, containing time-to-event</span>
<span class="sd">        information for empirical probability calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the EmpiricalIncomingAdmissionPredictor.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">start_time_col</span><span class="o">=</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
        <span class="n">end_time_col</span><span class="o">=</span><span class="s2">&quot;departure_datetime&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EmpiricalIncomingAdmissionPredictor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the model to the training data and calculate empirical survival curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_df : pandas.DataFrame</span>
<span class="sd">            The training dataset with historical admission data.</span>
<span class="sd">            Expected to have start_time_col as the index and end_time_col as a column.</span>
<span class="sd">            Alternatively, both can be regular columns.</span>
<span class="sd">        prediction_window : int or timedelta</span>
<span class="sd">            The prediction window in minutes. If timedelta, will be converted to minutes.</span>
<span class="sd">            If int, assumed to be in minutes.</span>
<span class="sd">        yta_time_interval : int or timedelta</span>
<span class="sd">            The interval in minutes for splitting the prediction window. If timedelta, will be converted to minutes.</span>
<span class="sd">            If int, assumed to be in minutes.</span>
<span class="sd">        prediction_times : list</span>
<span class="sd">            Times of day at which predictions are made, in hours.</span>
<span class="sd">        num_days : int</span>
<span class="sd">            The number of days that the train_df spans.</span>
<span class="sd">        epsilon : float, default=1e-7</span>
<span class="sd">            A small value representing acceptable error rate to enable calculation</span>
<span class="sd">            of the maximum value of the random variable representing number of beds.</span>
<span class="sd">        y : None, optional</span>
<span class="sd">            Ignored, present for compatibility with scikit-learn&#39;s fit method.</span>
<span class="sd">        start_time_col : str, default=&#39;arrival_datetime&#39;</span>
<span class="sd">            Name of the column containing the start time (e.g., arrival time).</span>
<span class="sd">            Expected to be the DataFrame index, but can also be a regular column.</span>
<span class="sd">        end_time_col : str, default=&#39;departure_datetime&#39;</span>
<span class="sd">            Name of the column containing the end time (e.g., departure time).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EmpiricalIncomingAdmissionPredictor</span>
<span class="sd">            The instance itself, fitted with the training data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate survival curve from training data using existing function</span>
        <span class="c1"># Handle case where start_time_col is in the index</span>
        <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># start_time_col is a regular column</span>
            <span class="n">df_for_survival</span> <span class="o">=</span> <span class="n">train_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># start_time_col is likely the index, reset it to make it a column</span>
            <span class="n">df_for_survival</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="c1"># Verify that start_time_col is now available</span>
            <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_for_survival</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">start_time_col</span><span class="si">}</span><span class="s2">&#39; not found in DataFrame columns or index&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="o">=</span> <span class="n">calculate_survival_curve</span><span class="p">(</span>
            <span class="n">df_for_survival</span><span class="p">,</span> <span class="n">start_time_col</span><span class="o">=</span><span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="o">=</span><span class="n">end_time_col</span>
        <span class="p">)</span>

        <span class="c1"># Verify survival curve was calculated and saved successfully</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to calculate survival curve from training data&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure train_df has start_time_col as index for parent fit method</span>
        <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">start_time_col</span><span class="p">)</span>

        <span class="c1"># Call parent fit method to handle arrival rate calculation and validation</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_df</span><span class="p">,</span>
            <span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">yta_time_interval</span><span class="p">,</span>
            <span class="n">prediction_times</span><span class="p">,</span>
            <span class="n">num_days</span><span class="p">,</span>
            <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;EmpiricalIncomingAdmissionPredictor has been fitted with survival curve containing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> time points&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_survival_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the survival curve calculated during fitting.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            DataFrame containing the survival curve with columns:</span>
<span class="sd">            - time_hours: Time points in hours</span>
<span class="sd">            - survival_probability: Survival probabilities at each time point</span>
<span class="sd">            - event_probability: Event probabilities (1 - survival_probability)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the model has not been fitted yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been fitted yet. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_survival_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate survival probabilities for each time interval.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prediction_window : int or timedelta</span>
<span class="sd">            The prediction window.</span>
<span class="sd">        yta_time_interval : int or timedelta</span>
<span class="sd">            The time interval for splitting the prediction window.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Array of admission probabilities for each time interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate number of time intervals</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span>
        <span class="p">):</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="p">(</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span>

        <span class="c1"># Convert to hours for survival probability calculation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">prediction_window_hours</span> <span class="o">=</span> <span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prediction_window_hours</span> <span class="o">=</span> <span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">yta_time_interval_hours</span> <span class="o">=</span> <span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yta_time_interval_hours</span> <span class="o">=</span> <span class="n">yta_time_interval</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># Calculate admission probabilities for each time interval</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NTimes</span><span class="p">):</span>
            <span class="c1"># Time remaining until end of prediction window</span>
            <span class="n">time_remaining</span> <span class="o">=</span> <span class="n">prediction_window_hours</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">yta_time_interval_hours</span><span class="p">)</span>

            <span class="c1"># Interpolate survival probability from survival curve</span>
            <span class="k">if</span> <span class="n">time_remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prob_admission</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mf">1.0</span>  <span class="c1"># If time remaining is 0 or negative, probability is 1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find the survival probability at this time point</span>
                <span class="c1"># Linear interpolation between points in survival curve</span>
                <span class="n">survival_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span>
                <span class="k">if</span> <span class="n">time_remaining</span> <span class="o">&gt;=</span> <span class="n">survival_curve</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="c1"># If time is beyond our data, use the last survival probability</span>
                    <span class="n">survival_prob</span> <span class="o">=</span> <span class="n">survival_curve</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">time_remaining</span> <span class="o">&lt;=</span> <span class="n">survival_curve</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                    <span class="c1"># If time is before our data, use the first survival probability</span>
                    <span class="n">survival_prob</span> <span class="o">=</span> <span class="n">survival_curve</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Interpolate between points</span>
                    <span class="n">survival_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                        <span class="n">time_remaining</span><span class="p">,</span>
                        <span class="n">survival_curve</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">],</span>
                        <span class="n">survival_curve</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">],</span>
                    <span class="p">)</span>

                <span class="c1"># Probability of admission = 1 - survival probability</span>
                <span class="n">prob_admission</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">survival_prob</span>

            <span class="n">probabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob_admission</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convolve_poisson_distributions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">20</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convolve Poisson distributions for each time interval.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arrival_rates : numpy.ndarray</span>
<span class="sd">            Array of arrival rates for each time interval.</span>
<span class="sd">        probabilities : numpy.ndarray</span>
<span class="sd">            Array of admission probabilities for each time interval.</span>
<span class="sd">        max_value : int, default=20</span>
<span class="sd">            Maximum value for the discrete distribution support.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            DataFrame with &#39;sum&#39; and &#39;agg_proba&#39; columns representing the final distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

        <span class="c1"># Create weighted Poisson distributions for each time interval</span>
        <span class="n">weighted_rates</span> <span class="o">=</span> <span class="n">arrival_rates</span> <span class="o">*</span> <span class="n">probabilities</span>
        <span class="n">poisson_dists</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">weighted_rates</span><span class="p">]</span>

        <span class="c1"># Get PMF for each distribution</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
        <span class="n">pmfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">poisson_dists</span><span class="p">]</span>

        <span class="c1"># Convolve all distributions together</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pmfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Handle edge case of no distributions</span>
            <span class="n">combined_pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
            <span class="n">combined_pmf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># All probability at 0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_pmf</span> <span class="o">=</span> <span class="n">pmfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pmf</span> <span class="ow">in</span> <span class="n">pmfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">combined_pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">combined_pmf</span><span class="p">,</span> <span class="n">pmf</span><span class="p">)</span>

        <span class="c1"># Create result DataFrame</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_pmf</span><span class="p">)),</span> <span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="n">combined_pmf</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Filter out near-zero probabilities and normalize</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">]</span>
        <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the number of admissions using empirical survival curves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prediction_context : dict</span>
<span class="sd">            A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">            It should specify either a general context or one based on the applied filters.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments for prediction configuration:</span>

<span class="sd">            max_value : int, default=20</span>
<span class="sd">                Maximum value for the discrete distribution support.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with predictions for each specified context.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If filter key is not recognized or prediction_time is not provided.</span>
<span class="sd">        KeyError</span>
<span class="sd">            If required keys are missing from the prediction context.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If survival_df was not provided during fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No survival data available. Please call fit() method first to calculate survival curve from training data.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract parameters from kwargs with defaults</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_value&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Calculate survival probabilities once (they&#39;re the same for all contexts)</span>
        <span class="n">survival_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_survival_probabilities</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">filter_values</span> <span class="ow">in</span> <span class="n">prediction_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Filter key &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39; is not recognized in the model weights.&quot;</span>
                    <span class="p">)</span>

                <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">filter_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No &#39;prediction_time&#39; provided for filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span><span class="p">:</span>
                    <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span>
                        <span class="n">prediction_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span>
                    <span class="p">)</span>

                <span class="n">arrival_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">filter_key</span><span class="p">][</span><span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;arrival_rates&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">arrival_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No arrival_rates found for the time of day &#39;</span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&#39; under filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Convert arrival rates to numpy array</span>
                <span class="n">arrival_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)</span>

                <span class="c1"># Generate prediction using convolution approach</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_poisson_distributions</span><span class="p">(</span>
                    <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">survival_probabilities</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span>
                <span class="p">)</span>

                <span class="c1"># if self.verbose:</span>
                <span class="c1">#     total_expected = (arrival_rates * survival_probabilities).sum()</span>
                <span class="c1">#     self.logger.info(</span>
                <span class="c1">#         f&quot;Prediction for {filter_key} at {prediction_time}: &quot;</span>
                <span class="c1">#         f&quot;Expected value ≈ {total_expected:.2f}&quot;</span>
                <span class="c1">#     )</span>

            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Initialize the EmpiricalIncomingAdmissionPredictor.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the EmpiricalIncomingAdmissionPredictor.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time_col</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">end_time_col</span><span class="o">=</span><span class="s1">&#39;departure_datetime&#39;</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fit the model to the training data and calculate empirical survival curve.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The training dataset with historical admission data.
Expected to have start_time_col as the index and end_time_col as a column.
Alternatively, both can be regular columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a> or <a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prediction window in minutes. If timedelta, will be converted to minutes.
If int, assumed to be in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a> or <a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interval in minutes for splitting the prediction window. If timedelta, will be converted to minutes.
If int, assumed to be in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Times of day at which predictions are made, in hours.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days that the train_df spans.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A small value representing acceptable error rate to enable calculation
of the maximum value of the random variable representing number of beds.</p>
              </div>
            </td>
            <td>
                  <code>1e-7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored, present for compatibility with scikit-learn's fit method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the start time (e.g., arrival time).
Expected to be the DataFrame index, but can also be a regular column.</p>
              </div>
            </td>
            <td>
                  <code>&#39;arrival_datetime&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the end time (e.g., departure time).</p>
              </div>
            </td>
            <td>
                  <code>&#39;departure_datetime&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="EmpiricalIncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor">EmpiricalIncomingAdmissionPredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The instance itself, fitted with the training data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">train_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">start_time_col</span><span class="o">=</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">end_time_col</span><span class="o">=</span><span class="s2">&quot;departure_datetime&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EmpiricalIncomingAdmissionPredictor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the model to the training data and calculate empirical survival curve.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_df : pandas.DataFrame</span>
<span class="sd">        The training dataset with historical admission data.</span>
<span class="sd">        Expected to have start_time_col as the index and end_time_col as a column.</span>
<span class="sd">        Alternatively, both can be regular columns.</span>
<span class="sd">    prediction_window : int or timedelta</span>
<span class="sd">        The prediction window in minutes. If timedelta, will be converted to minutes.</span>
<span class="sd">        If int, assumed to be in minutes.</span>
<span class="sd">    yta_time_interval : int or timedelta</span>
<span class="sd">        The interval in minutes for splitting the prediction window. If timedelta, will be converted to minutes.</span>
<span class="sd">        If int, assumed to be in minutes.</span>
<span class="sd">    prediction_times : list</span>
<span class="sd">        Times of day at which predictions are made, in hours.</span>
<span class="sd">    num_days : int</span>
<span class="sd">        The number of days that the train_df spans.</span>
<span class="sd">    epsilon : float, default=1e-7</span>
<span class="sd">        A small value representing acceptable error rate to enable calculation</span>
<span class="sd">        of the maximum value of the random variable representing number of beds.</span>
<span class="sd">    y : None, optional</span>
<span class="sd">        Ignored, present for compatibility with scikit-learn&#39;s fit method.</span>
<span class="sd">    start_time_col : str, default=&#39;arrival_datetime&#39;</span>
<span class="sd">        Name of the column containing the start time (e.g., arrival time).</span>
<span class="sd">        Expected to be the DataFrame index, but can also be a regular column.</span>
<span class="sd">    end_time_col : str, default=&#39;departure_datetime&#39;</span>
<span class="sd">        Name of the column containing the end time (e.g., departure time).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    EmpiricalIncomingAdmissionPredictor</span>
<span class="sd">        The instance itself, fitted with the training data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate survival curve from training data using existing function</span>
    <span class="c1"># Handle case where start_time_col is in the index</span>
    <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># start_time_col is a regular column</span>
        <span class="n">df_for_survival</span> <span class="o">=</span> <span class="n">train_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># start_time_col is likely the index, reset it to make it a column</span>
        <span class="n">df_for_survival</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># Verify that start_time_col is now available</span>
        <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_for_survival</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">start_time_col</span><span class="si">}</span><span class="s2">&#39; not found in DataFrame columns or index&quot;</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="o">=</span> <span class="n">calculate_survival_curve</span><span class="p">(</span>
        <span class="n">df_for_survival</span><span class="p">,</span> <span class="n">start_time_col</span><span class="o">=</span><span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="o">=</span><span class="n">end_time_col</span>
    <span class="p">)</span>

    <span class="c1"># Verify survival curve was calculated and saved successfully</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to calculate survival curve from training data&quot;</span><span class="p">)</span>

    <span class="c1"># Ensure train_df has start_time_col as index for parent fit method</span>
    <span class="k">if</span> <span class="n">start_time_col</span> <span class="ow">in</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">start_time_col</span><span class="p">)</span>

    <span class="c1"># Call parent fit method to handle arrival rate calculation and validation</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_df</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">num_days</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;EmpiricalIncomingAdmissionPredictor has been fitted with survival curve containing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> time points&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.get_survival_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_survival_curve</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get the survival curve calculated during fitting.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing the survival curve with columns:
- time_hours: Time points in hours
- survival_probability: Survival probabilities at each time point
- event_probability: Event probabilities (1 - survival_probability)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#RuntimeError">RuntimeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the model has not been fitted yet.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_survival_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the survival curve calculated during fitting.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame containing the survival curve with columns:</span>
<span class="sd">        - time_hours: Time points in hours</span>
<span class="sd">        - survival_probability: Survival probabilities at each time point</span>
<span class="sd">        - event_probability: Event probabilities (1 - survival_probability)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the model has not been fitted yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been fitted yet. Call fit() first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.EmpiricalIncomingAdmissionPredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">prediction_context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Predict the number of admissions using empirical survival curves.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary defining the context for which predictions are to be made.
It should specify either a general context or one based on the applied filters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for prediction configuration:</p>
<p>max_value : int, default=20
    Maximum value for the discrete distribution support.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary with predictions for each specified context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filter key is not recognized or prediction_time is not provided.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#KeyError">KeyError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required keys are missing from the prediction context.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#RuntimeError">RuntimeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If survival_df was not provided during fitting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict the number of admissions using empirical survival curves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_context : dict</span>
<span class="sd">        A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">        It should specify either a general context or one based on the applied filters.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments for prediction configuration:</span>

<span class="sd">        max_value : int, default=20</span>
<span class="sd">            Maximum value for the discrete distribution support.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary with predictions for each specified context.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If filter key is not recognized or prediction_time is not provided.</span>
<span class="sd">    KeyError</span>
<span class="sd">        If required keys are missing from the prediction context.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If survival_df was not provided during fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;No survival data available. Please call fit() method first to calculate survival curve from training data.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Extract parameters from kwargs with defaults</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_value&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Calculate survival probabilities once (they&#39;re the same for all contexts)</span>
    <span class="n">survival_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_survival_probabilities</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">filter_values</span> <span class="ow">in</span> <span class="n">prediction_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Filter key &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39; is not recognized in the model weights.&quot;</span>
                <span class="p">)</span>

            <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">filter_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No &#39;prediction_time&#39; provided for filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span><span class="p">:</span>
                <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span>
                    <span class="n">prediction_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span>
                <span class="p">)</span>

            <span class="n">arrival_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">filter_key</span><span class="p">][</span><span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;arrival_rates&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">arrival_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No arrival_rates found for the time of day &#39;</span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&#39; under filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Convert arrival rates to numpy array</span>
            <span class="n">arrival_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)</span>

            <span class="c1"># Generate prediction using convolution approach</span>
            <span class="n">predictions</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_poisson_distributions</span><span class="p">(</span>
                <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">survival_probabilities</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span>
            <span class="p">)</span>

            <span class="c1"># if self.verbose:</span>
            <span class="c1">#     total_expected = (arrival_rates * survival_probabilities).sum()</span>
            <span class="c1">#     self.logger.info(</span>
            <span class="c1">#         f&quot;Prediction for {filter_key} at {prediction_time}: &quot;</span>
            <span class="c1">#         f&quot;Expected value ≈ {total_expected:.2f}&quot;</span>
            <span class="c1">#     )</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor" class="doc doc-heading">
            <code>IncomingAdmissionPredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>, <code><span title="sklearn.base.TransformerMixin">TransformerMixin</span></code>, <code><a class="autorefs autorefs-external" title="abc.ABC" href="https://docs.python.org/3/library/abc.html#abc.ABC">ABC</a></code></p>


        <p>Base class for admission predictors that handles filtering and arrival rate calculation.</p>
<p>This abstract base class provides the common functionality for predicting hospital
admissions, including data filtering, arrival rate calculation, and basic prediction
infrastructure. Subclasses implement specific prediction strategies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filters for data categorization. If None, no filtering is applied.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable verbose logging.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.filters">filters</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filters for data categorization.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.verbose">verbose</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verbose logging flag.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores metadata about the model and training data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.weights">weights</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model parameters computed during fitting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The predictor implements scikit-learn's BaseEstimator and TransformerMixin
interfaces for compatibility with scikit-learn pipelines.</p>
</details>






              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IncomingAdmissionPredictor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for admission predictors that handles filtering and arrival rate calculation.</span>

<span class="sd">    This abstract base class provides the common functionality for predicting hospital</span>
<span class="sd">    admissions, including data filtering, arrival rate calculation, and basic prediction</span>
<span class="sd">    infrastructure. Subclasses implement specific prediction strategies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filters : dict, optional</span>
<span class="sd">        Optional filters for data categorization. If None, no filtering is applied.</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to enable verbose logging.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    filters : dict</span>
<span class="sd">        Filters for data categorization.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Verbose logging flag.</span>
<span class="sd">    metrics : dict</span>
<span class="sd">        Stores metadata about the model and training data.</span>
<span class="sd">    weights : dict</span>
<span class="sd">        Model parameters computed during fitting.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The predictor implements scikit-learn&#39;s BaseEstimator and TransformerMixin</span>
<span class="sd">    interfaces for compatibility with scikit-learn pipelines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the IncomingAdmissionPredictor with optional filters.</span>

<span class="sd">        Args:</span>
<span class="sd">            filters (dict, optional): A dictionary defining filters for different categories or specialties.</span>
<span class="sd">                                    If None or empty, no filtering will be applied.</span>
<span class="sd">            verbose (bool, optional): If True, enable info-level logging. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Add metrics dictionary to store metadata</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># Configure logging for Jupyter notebook compatibility</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

            <span class="c1"># Create logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Only set up handlers if they don&#39;t exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

                <span class="c1"># Create handler that writes to sys.stdout</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

                <span class="c1"># Create a formatting configuration</span>
                <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

                <span class="c1"># Add the handler to the logger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

                <span class="c1"># Prevent propagation to root logger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Apply filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a set of filters to a dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            The DataFrame to filter.</span>
<span class="sd">        filters : dict</span>
<span class="sd">            A dictionary where keys are column names and values are the criteria</span>
<span class="sd">            or function to filter by.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A filtered DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">criteria</span><span class="p">):</span>  <span class="c1"># If the criteria is a function, apply it directly</span>
                <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, assume the criteria is a value or list of values for equality check</span>
                <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="n">criteria</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">filtered_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">num_days</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate parameters required for the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            The data frame to process.</span>
<span class="sd">        prediction_window : timedelta</span>
<span class="sd">            The total prediction window for prediction.</span>
<span class="sd">        yta_time_interval : timedelta</span>
<span class="sd">            The interval for splitting the prediction window.</span>
<span class="sd">        prediction_times : list</span>
<span class="sd">            Times of day at which predictions are made.</span>
<span class="sd">        num_days : int</span>
<span class="sd">            Number of days over which to calculate time-varying arrival rates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Calculated arrival_rates parameters organized by time of day.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Calculate Ntimes - Python handles the division naturally</span>
        <span class="n">Ntimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span><span class="p">)</span>

        <span class="c1"># Pass original type to time_varying_arrival_rates</span>
        <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="n">prediction_time_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">prediction_time_</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
            <span class="n">prediction_time_hr</span><span class="p">,</span> <span class="n">prediction_time_min</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prediction_time_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_time_</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">prediction_time_</span>
            <span class="p">)</span>
            <span class="n">arrival_rates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">arrival_rates_dict</span><span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prediction_time_hr</span><span class="p">,</span> <span class="n">prediction_time_min</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">yta_time_interval</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntimes</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">prediction_time_dict</span><span class="p">[(</span><span class="n">prediction_time_hr</span><span class="p">,</span> <span class="n">prediction_time_min</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;arrival_rates&quot;</span><span class="p">:</span> <span class="n">arrival_rates</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">prediction_time_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IncomingAdmissionPredictor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the model to the training data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_df : pandas.DataFrame</span>
<span class="sd">            The training dataset with historical admission data.</span>
<span class="sd">        prediction_window : timedelta</span>
<span class="sd">            The prediction window as a timedelta object.</span>
<span class="sd">        yta_time_interval : timedelta</span>
<span class="sd">            The interval for splitting the prediction window as a timedelta object.</span>
<span class="sd">        prediction_times : list</span>
<span class="sd">            Times of day at which predictions are made, in hours.</span>
<span class="sd">        num_days : int</span>
<span class="sd">            The number of days that the train_df spans.</span>
<span class="sd">        epsilon : float, default=1e-7</span>
<span class="sd">            A small value representing acceptable error rate to enable calculation</span>
<span class="sd">            of the maximum value of the random variable representing number of beds.</span>
<span class="sd">        y : None, optional</span>
<span class="sd">            Ignored, present for compatibility with scikit-learn&#39;s fit method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        IncomingAdmissionPredictor</span>
<span class="sd">            The instance itself, fitted with the training data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If prediction_window or yta_time_interval are not timedelta objects.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If prediction_window/yta_time_interval is not greater than 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate inputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be a timedelta object&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be a timedelta object&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># 4 hours in seconds</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;yta_time_interval appears to be longer than 4 hours&quot;</span><span class="p">)</span>

        <span class="c1"># Validate the ratio makes sense</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;prediction_window must be significantly larger than yta_time_interval&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Store original types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">=</span> <span class="n">prediction_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
            <span class="k">else</span> <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prediction_times</span>
        <span class="p">]</span>

        <span class="c1"># Initialize yet_to_arrive_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If there are filters specified, calculate and store the parameters directly with the respective spec keys</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">filters</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filter_dataframe</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">filters</span><span class="p">),</span>
                    <span class="n">prediction_window</span><span class="p">,</span>
                    <span class="n">yta_time_interval</span><span class="p">,</span>
                    <span class="n">prediction_times</span><span class="p">,</span>
                    <span class="n">num_days</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If there are no filters, store the parameters with a generic key of &#39;unfiltered&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s2">&quot;unfiltered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
                <span class="n">train_df</span><span class="p">,</span>
                <span class="n">prediction_window</span><span class="p">,</span>
                <span class="n">yta_time_interval</span><span class="p">,</span>
                <span class="n">prediction_times</span><span class="p">,</span>
                <span class="n">num_days</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> trained for these times: </span><span class="si">{</span><span class="n">prediction_times</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;using prediction window of </span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2"> after the time of prediction&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;and time interval of </span><span class="si">{</span><span class="n">yta_time_interval</span><span class="si">}</span><span class="s2"> within the prediction window.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error value for prediction will be </span><span class="si">{</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;To see the weights saved by this model, used the get_weights() method&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Store metrics about the training data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;num_days&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_days</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the weights computed by the fit method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The weights computed during model fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the number of admissions for the given context.</span>

<span class="sd">        This is an abstract method that must be implemented by subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prediction_context : dict</span>
<span class="sd">            A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">            It should specify either a general context or one based on the applied filters.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments specific to the prediction method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with predictions for each specified context.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If filter key is not recognized or prediction_time is not provided.</span>
<span class="sd">        KeyError</span>
<span class="sd">            If required keys are missing from the prediction context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Initialize the IncomingAdmissionPredictor with optional filters.</p>
<p>Args:
    filters (dict, optional): A dictionary defining filters for different categories or specialties.
                            If None or empty, no filtering will be applied.
    verbose (bool, optional): If True, enable info-level logging. Defaults to False.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the IncomingAdmissionPredictor with optional filters.</span>

<span class="sd">    Args:</span>
<span class="sd">        filters (dict, optional): A dictionary defining filters for different categories or specialties.</span>
<span class="sd">                                If None or empty, no filtering will be applied.</span>
<span class="sd">        verbose (bool, optional): If True, enable info-level logging. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Add metrics dictionary to store metadata</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># Configure logging for Jupyter notebook compatibility</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

        <span class="c1"># Create logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Only set up handlers if they don&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="c1"># Create handler that writes to sys.stdout</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="c1"># Create a formatting configuration</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

            <span class="c1"># Add the handler to the logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

            <span class="c1"># Prevent propagation to root logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Apply filters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.filter_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Apply a set of filters to a dataframe.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataFrame to filter.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are column names and values are the criteria
or function to filter by.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A filtered DataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a set of filters to a dataframe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The DataFrame to filter.</span>
<span class="sd">    filters : dict</span>
<span class="sd">        A dictionary where keys are column names and values are the criteria</span>
<span class="sd">        or function to filter by.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A filtered DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">criteria</span><span class="p">):</span>  <span class="c1"># If the criteria is a function, apply it directly</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, assume the criteria is a value or list of values for equality check</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="n">criteria</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">filtered_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fit the model to the training data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The training dataset with historical admission data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prediction window as a timedelta object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interval for splitting the prediction window as a timedelta object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Times of day at which predictions are made, in hours.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days that the train_df spans.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A small value representing acceptable error rate to enable calculation
of the maximum value of the random variable representing number of beds.</p>
              </div>
            </td>
            <td>
                  <code>1e-7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored, present for compatibility with scikit-learn's fit method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="IncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor">IncomingAdmissionPredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The instance itself, fitted with the training data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prediction_window or yta_time_interval are not timedelta objects.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prediction_window/yta_time_interval is not greater than 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">train_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IncomingAdmissionPredictor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the model to the training data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_df : pandas.DataFrame</span>
<span class="sd">        The training dataset with historical admission data.</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        The prediction window as a timedelta object.</span>
<span class="sd">    yta_time_interval : timedelta</span>
<span class="sd">        The interval for splitting the prediction window as a timedelta object.</span>
<span class="sd">    prediction_times : list</span>
<span class="sd">        Times of day at which predictions are made, in hours.</span>
<span class="sd">    num_days : int</span>
<span class="sd">        The number of days that the train_df spans.</span>
<span class="sd">    epsilon : float, default=1e-7</span>
<span class="sd">        A small value representing acceptable error rate to enable calculation</span>
<span class="sd">        of the maximum value of the random variable representing number of beds.</span>
<span class="sd">    y : None, optional</span>
<span class="sd">        Ignored, present for compatibility with scikit-learn&#39;s fit method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    IncomingAdmissionPredictor</span>
<span class="sd">        The instance itself, fitted with the training data.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If prediction_window or yta_time_interval are not timedelta objects.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If prediction_window/yta_time_interval is not greater than 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be a timedelta object&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be a timedelta object&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be positive&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be positive&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># 4 hours in seconds</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;yta_time_interval appears to be longer than 4 hours&quot;</span><span class="p">)</span>

    <span class="c1"># Validate the ratio makes sense</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">prediction_window</span> <span class="o">/</span> <span class="n">yta_time_interval</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;prediction_window must be significantly larger than yta_time_interval&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Store original types</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">=</span> <span class="n">prediction_window</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">=</span> <span class="n">yta_time_interval</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="k">else</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prediction_times</span>
    <span class="p">]</span>

    <span class="c1"># Initialize yet_to_arrive_dict</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># If there are filters specified, calculate and store the parameters directly with the respective spec keys</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">filters</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter_dataframe</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">filters</span><span class="p">),</span>
                <span class="n">prediction_window</span><span class="p">,</span>
                <span class="n">yta_time_interval</span><span class="p">,</span>
                <span class="n">prediction_times</span><span class="p">,</span>
                <span class="n">num_days</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If there are no filters, store the parameters with a generic key of &#39;unfiltered&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s2">&quot;unfiltered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_parameters</span><span class="p">(</span>
            <span class="n">train_df</span><span class="p">,</span>
            <span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">yta_time_interval</span><span class="p">,</span>
            <span class="n">prediction_times</span><span class="p">,</span>
            <span class="n">num_days</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> trained for these times: </span><span class="si">{</span><span class="n">prediction_times</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;using prediction window of </span><span class="si">{</span><span class="n">prediction_window</span><span class="si">}</span><span class="s2"> after the time of prediction&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;and time interval of </span><span class="si">{</span><span class="n">yta_time_interval</span><span class="si">}</span><span class="s2"> within the prediction window.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error value for prediction will be </span><span class="si">{</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;To see the weights saved by this model, used the get_weights() method&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Store metrics about the training data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;num_days&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_days</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.get_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_weights</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get the weights computed by the fit method.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The weights computed during model fitting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the weights computed by the fit method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The weights computed during model fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">prediction_context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Predict the number of admissions for the given context.</p>
<p>This is an abstract method that must be implemented by subclasses.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary defining the context for which predictions are to be made.
It should specify either a general context or one based on the applied filters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments specific to the prediction method.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary with predictions for each specified context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filter key is not recognized or prediction_time is not provided.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#KeyError">KeyError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required keys are missing from the prediction context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict the number of admissions for the given context.</span>

<span class="sd">    This is an abstract method that must be implemented by subclasses.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_context : dict</span>
<span class="sd">        A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">        It should specify either a general context or one based on the applied filters.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments specific to the prediction method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary with predictions for each specified context.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If filter key is not recognized or prediction_time is not provided.</span>
<span class="sd">    KeyError</span>
<span class="sd">        If required keys are missing from the prediction context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor" class="doc doc-heading">
            <code>ParametricIncomingAdmissionPredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="IncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.IncomingAdmissionPredictor">IncomingAdmissionPredictor</a></code></p>


        <p>A predictor for estimating hospital admissions using parametric curves.</p>
<p>This predictor uses a combination of Poisson and binomial distributions to forecast
future admissions, excluding patients who have already arrived. The prediction is
based on historical data and can be filtered for specific hospital settings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filters for data categorization. If None, no filtering is applied.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable verbose logging.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.filters">filters</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filters for data categorization.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.verbose">verbose</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verbose logging flag.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores metadata about the model and training data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.weights">weights</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model parameters computed during fitting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The predictor implements scikit-learn's BaseEstimator and TransformerMixin
interfaces for compatibility with scikit-learn pipelines.</p>
</details>






              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParametricIncomingAdmissionPredictor</span><span class="p">(</span><span class="n">IncomingAdmissionPredictor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A predictor for estimating hospital admissions using parametric curves.</span>

<span class="sd">    This predictor uses a combination of Poisson and binomial distributions to forecast</span>
<span class="sd">    future admissions, excluding patients who have already arrived. The prediction is</span>
<span class="sd">    based on historical data and can be filtered for specific hospital settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filters : dict, optional</span>
<span class="sd">        Optional filters for data categorization. If None, no filtering is applied.</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to enable verbose logging.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    filters : dict</span>
<span class="sd">        Filters for data categorization.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Verbose logging flag.</span>
<span class="sd">    metrics : dict</span>
<span class="sd">        Stores metadata about the model and training data.</span>
<span class="sd">    weights : dict</span>
<span class="sd">        Model parameters computed during fitting.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The predictor implements scikit-learn&#39;s BaseEstimator and TransformerMixin</span>
<span class="sd">    interfaces for compatibility with scikit-learn pipelines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the number of admissions for the given context using parametric curves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prediction_context : dict</span>
<span class="sd">            A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">            It should specify either a general context or one based on the applied filters.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments for parametric curve configuration:</span>

<span class="sd">            x1 : float</span>
<span class="sd">                The x-coordinate of the first transition point on the aspirational curve,</span>
<span class="sd">                where the growth phase ends and the decay phase begins.</span>
<span class="sd">            y1 : float</span>
<span class="sd">                The y-coordinate of the first transition point (x1), representing the target</span>
<span class="sd">                proportion of patients admitted by time x1.</span>
<span class="sd">            x2 : float</span>
<span class="sd">                The x-coordinate of the second transition point on the curve, beyond which</span>
<span class="sd">                all but a few patients are expected to be admitted.</span>
<span class="sd">            y2 : float</span>
<span class="sd">                The y-coordinate of the second transition point (x2), representing the target</span>
<span class="sd">                proportion of patients admitted by time x2.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with predictions for each specified context.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If filter key is not recognized or prediction_time is not provided.</span>
<span class="sd">        KeyError</span>
<span class="sd">            If required keys are missing from the prediction context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract required parameters from kwargs</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">)</span>

        <span class="c1"># Validate that required parameters are provided</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">x2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;x1, y1, x2, and y2 parameters are required for parametric prediction&quot;</span>
            <span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Calculate Ntimes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span>
        <span class="p">):</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">)</span>

        <span class="c1"># Convert to hours only for numpy operations (which require numeric types)</span>
        <span class="n">prediction_window_hours</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="p">)</span>
        <span class="n">yta_time_interval_hours</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="p">)</span>

        <span class="c1"># Calculate theta, probability of admission in prediction window</span>
        <span class="c1"># for each time interval, calculate time remaining before end of window</span>
        <span class="n">time_remaining_before_end_of_window</span> <span class="o">=</span> <span class="n">prediction_window_hours</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">prediction_window_hours</span><span class="p">,</span> <span class="n">yta_time_interval_hours</span>
        <span class="p">)</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
            <span class="n">time_remaining_before_end_of_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">filter_values</span> <span class="ow">in</span> <span class="n">prediction_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Filter key &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39; is not recognized in the model weights.&quot;</span>
                    <span class="p">)</span>

                <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">filter_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No &#39;prediction_time&#39; provided for filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span><span class="p">:</span>
                    <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span>
                        <span class="n">prediction_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span>
                    <span class="p">)</span>

                <span class="n">arrival_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">filter_key</span><span class="p">][</span><span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;arrival_rates&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">arrival_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No arrival_rates found for the time of day &#39;</span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&#39; under filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="n">predictions</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">poisson_binom_generating_function</span><span class="p">(</span>
                    <span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">prediction_context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Predict the number of admissions for the given context using parametric curves.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary defining the context for which predictions are to be made.
It should specify either a general context or one based on the applied filters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for parametric curve configuration:</p>
<p>x1 : float
    The x-coordinate of the first transition point on the aspirational curve,
    where the growth phase ends and the decay phase begins.
y1 : float
    The y-coordinate of the first transition point (x1), representing the target
    proportion of patients admitted by time x1.
x2 : float
    The x-coordinate of the second transition point on the curve, beyond which
    all but a few patients are expected to be admitted.
y2 : float
    The y-coordinate of the second transition point (x2), representing the target
    proportion of patients admitted by time x2.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary with predictions for each specified context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filter key is not recognized or prediction_time is not provided.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#KeyError">KeyError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required keys are missing from the prediction context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict the number of admissions for the given context using parametric curves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_context : dict</span>
<span class="sd">        A dictionary defining the context for which predictions are to be made.</span>
<span class="sd">        It should specify either a general context or one based on the applied filters.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments for parametric curve configuration:</span>

<span class="sd">        x1 : float</span>
<span class="sd">            The x-coordinate of the first transition point on the aspirational curve,</span>
<span class="sd">            where the growth phase ends and the decay phase begins.</span>
<span class="sd">        y1 : float</span>
<span class="sd">            The y-coordinate of the first transition point (x1), representing the target</span>
<span class="sd">            proportion of patients admitted by time x1.</span>
<span class="sd">        x2 : float</span>
<span class="sd">            The x-coordinate of the second transition point on the curve, beyond which</span>
<span class="sd">            all but a few patients are expected to be admitted.</span>
<span class="sd">        y2 : float</span>
<span class="sd">            The y-coordinate of the second transition point (x2), representing the target</span>
<span class="sd">            proportion of patients admitted by time x2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary with predictions for each specified context.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If filter key is not recognized or prediction_time is not provided.</span>
<span class="sd">    KeyError</span>
<span class="sd">        If required keys are missing from the prediction context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract required parameters from kwargs</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">)</span>

    <span class="c1"># Validate that required parameters are provided</span>
    <span class="k">if</span> <span class="n">x1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">x2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;x1, y1, x2, and y2 parameters are required for parametric prediction&quot;</span>
        <span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Calculate Ntimes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span>
    <span class="p">):</span>
        <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">NTimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">)</span>

    <span class="c1"># Convert to hours only for numpy operations (which require numeric types)</span>
    <span class="n">prediction_window_hours</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_window</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="p">)</span>
    <span class="n">yta_time_interval_hours</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">yta_time_interval</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="p">)</span>

    <span class="c1"># Calculate theta, probability of admission in prediction window</span>
    <span class="c1"># for each time interval, calculate time remaining before end of window</span>
    <span class="n">time_remaining_before_end_of_window</span> <span class="o">=</span> <span class="n">prediction_window_hours</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">prediction_window_hours</span><span class="p">,</span> <span class="n">yta_time_interval_hours</span>
    <span class="p">)</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">get_y_from_aspirational_curve</span><span class="p">(</span>
        <span class="n">time_remaining_before_end_of_window</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">filter_values</span> <span class="ow">in</span> <span class="n">prediction_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Filter key &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39; is not recognized in the model weights.&quot;</span>
                <span class="p">)</span>

            <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">filter_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No &#39;prediction_time&#39; provided for filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">prediction_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span><span class="p">:</span>
                <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span>
                    <span class="n">prediction_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_times</span>
                <span class="p">)</span>

            <span class="n">arrival_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">filter_key</span><span class="p">][</span><span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;arrival_rates&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">arrival_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No arrival_rates found for the time of day &#39;</span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&#39; under filter &#39;</span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="n">predictions</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">poisson_binom_generating_function</span><span class="p">(</span>
                <span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.incoming_admission_predictors.aggregate_probabilities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_probabilities</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate probabilities for a range of values using the weighted Poisson-Binomial distribution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lam</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of lambda values for each time interval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kmax</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of events to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of theta values for each time interval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_index</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current time index for which to calculate probabilities.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregated probabilities for the given time index.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If kmax &lt; 0, time_index &lt; 0, or array lengths are invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_probabilities</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate probabilities for a range of values using the weighted Poisson-Binomial distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lam : numpy.ndarray</span>
<span class="sd">        An array of lambda values for each time interval.</span>
<span class="sd">    kmax : int</span>
<span class="sd">        The maximum number of events to consider.</span>
<span class="sd">    theta : numpy.ndarray</span>
<span class="sd">        An array of theta values for each time interval.</span>
<span class="sd">    time_index : int</span>
<span class="sd">        The current time index for which to calculate probabilities.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Aggregated probabilities for the given time index.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If kmax &lt; 0, time_index &lt; 0, or array lengths are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kmax</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">time_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">time_index</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">time_index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid kmax, time_index, or array lengths.&quot;</span><span class="p">)</span>

    <span class="n">probabilities_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">probabilities_matrix</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_poisson_binomial</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">[</span><span class="n">time_index</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">probabilities_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.incoming_admission_predictors.convolute_distributions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convolute_distributions</span><span class="p">(</span><span class="n">dist_a</span><span class="p">,</span> <span class="n">dist_b</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convolutes two probability distributions represented as dataframes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dist_a</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first distribution with columns ['sum', 'prob'].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dist_b</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second distribution with columns ['sum', 'prob'].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The convoluted distribution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DataFrames do not contain required 'sum' and 'prob' columns.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convolute_distributions</span><span class="p">(</span><span class="n">dist_a</span><span class="p">,</span> <span class="n">dist_b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convolutes two probability distributions represented as dataframes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dist_a : pd.DataFrame</span>
<span class="sd">        The first distribution with columns [&#39;sum&#39;, &#39;prob&#39;].</span>
<span class="sd">    dist_b : pd.DataFrame</span>
<span class="sd">        The second distribution with columns [&#39;sum&#39;, &#39;prob&#39;].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        The convoluted distribution.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If DataFrames do not contain required &#39;sum&#39; and &#39;prob&#39; columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">dist_a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">{</span>
        <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prob&quot;</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">dist_b</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataFrames must contain &#39;sum&#39; and &#39;prob&#39; columns.&quot;</span><span class="p">)</span>

    <span class="n">sums</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dist_a</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dist_b</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]]</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dist_a</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dist_b</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sums</span><span class="p">,</span> <span class="n">probs</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.incoming_admission_predictors.find_nearest_previous_prediction_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_nearest_previous_prediction_time</span><span class="p">(</span><span class="n">requested_time</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Find the nearest previous time of day in prediction_times relative to requested time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>requested_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The requested time as (hour, minute).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available prediction times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The closest previous time of day from prediction_times.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>If the requested time is earlier than all times in prediction_times,
returns the latest time in prediction_times.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_nearest_previous_prediction_time</span><span class="p">(</span><span class="n">requested_time</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the nearest previous time of day in prediction_times relative to requested time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    requested_time : tuple</span>
<span class="sd">        The requested time as (hour, minute).</span>
<span class="sd">    prediction_times : list</span>
<span class="sd">        List of available prediction times.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        The closest previous time of day from prediction_times.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If the requested time is earlier than all times in prediction_times,</span>
<span class="sd">    returns the latest time in prediction_times.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">requested_time</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">requested_time</span>

    <span class="n">original_prediction_time</span> <span class="o">=</span> <span class="n">requested_time</span>
    <span class="n">requested_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">requested_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">requested_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span>
    <span class="p">)</span>
    <span class="n">closest_prediction_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">prediction_time_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;%H:%M&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">min_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prediction_time_time</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
        <span class="n">prediction_time_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prediction_time_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;%H:%M&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">requested_datetime</span> <span class="o">-</span> <span class="n">prediction_time_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># If the difference is negative, it means the prediction_time_time is ahead of the requested_time,</span>
        <span class="c1"># hence we calculate the difference by considering a day&#39;s wrap around.</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">+=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># Add 24 hours in seconds</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_diff</span><span class="p">:</span>
            <span class="n">closest_prediction_time</span> <span class="o">=</span> <span class="n">prediction_time_time</span>
            <span class="n">min_diff</span> <span class="o">=</span> <span class="n">diff</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Time of day requested of </span><span class="si">{</span><span class="n">original_prediction_time</span><span class="si">}</span><span class="s2"> was not in model training. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Reverting to predictions for </span><span class="si">{</span><span class="n">closest_prediction_time</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">closest_prediction_time</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.incoming_admission_predictors.poisson_binom_generating_function" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">poisson_binom_generating_function</span><span class="p">(</span><span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate a distribution based on the aggregate of Poisson and Binomial distributions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>NTimes</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of time intervals.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>arrival_rates</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of lambda values for each time interval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of theta values for each time interval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The desired error threshold.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The generated distribution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If NTimes &lt;= 0 or epsilon is not between 0 and 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">poisson_binom_generating_function</span><span class="p">(</span><span class="n">NTimes</span><span class="p">,</span> <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a distribution based on the aggregate of Poisson and Binomial distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NTimes : int</span>
<span class="sd">        The number of time intervals.</span>
<span class="sd">    arrival_rates : numpy.ndarray</span>
<span class="sd">        An array of lambda values for each time interval.</span>
<span class="sd">    theta : numpy.ndarray</span>
<span class="sd">        An array of theta values for each time interval.</span>
<span class="sd">    epsilon : float</span>
<span class="sd">        The desired error threshold.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        The generated distribution.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If NTimes &lt;= 0 or epsilon is not between 0 and 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">NTimes</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epsilon</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epsilon</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ensure NTimes &gt; 0 and 0 &lt; epsilon &lt; 1.&quot;</span><span class="p">)</span>

    <span class="n">maxlam</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)</span>
    <span class="n">kmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">maxlam</span><span class="p">))</span>
    <span class="n">distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NTimes</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NTimes</span><span class="p">):</span>
        <span class="n">distribution</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate_probabilities</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="n">distribution</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]})</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NTimes</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">total_distribution</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">total_distribution</span> <span class="o">=</span> <span class="n">convolute_distributions</span><span class="p">(</span><span class="n">total_distribution</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">total_distribution</span> <span class="o">=</span> <span class="n">total_distribution</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="s2">&quot;agg_proba&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">total_distribution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.predictors.incoming_admission_predictors.weighted_poisson_binomial" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weighted_poisson_binomial</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate weighted probabilities using Poisson and Binomial distributions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>i</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The upper bound of the range for the binomial distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lam</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The lambda parameter for the Poisson distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability of success for the binomial distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of weighted probabilities.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If i &lt; 0, lam &lt; 0, or theta is not between 0 and 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/incoming_admission_predictors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">weighted_poisson_binomial</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate weighted probabilities using Poisson and Binomial distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        The upper bound of the range for the binomial distribution.</span>
<span class="sd">    lam : float</span>
<span class="sd">        The lambda parameter for the Poisson distribution.</span>
<span class="sd">    theta : float</span>
<span class="sd">        The probability of success for the binomial distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        An array of weighted probabilities.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If i &lt; 0, lam &lt; 0, or theta is not between 0 and 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lam</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">theta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ensure i &gt;= 0, lam &gt;= 0, and 0 &lt;= theta &lt;= 1.&quot;</span><span class="p">)</span>

    <span class="n">arr_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">arr_seq</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span> <span class="o">*</span> <span class="n">probabilities</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.predictors.sequence_to_outcome_predictor" class="doc doc-heading">
            <code>sequence_to_outcome_predictor</code>


</h3>

    <div class="doc doc-contents ">

        <p>This module implements a <code>SequenceToOutcomePredictor</code> class that models and predicts the probability distribution
of sequences in categorical data. The class builds a model based on training data, where input sequences
are mapped to specific outcome categories. It provides methods to fit the model, compute sequence-based
probabilities, and make predictions on an unseen datatset of input sequences.</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor : sklearn.base.BaseEstimator, sklearn.base.TransformerMixin">SequenceToOutcomePredictor : sklearn.base.BaseEstimator, sklearn.base.TransformerMixin</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>A model that predicts the probability of ending in different outcome categories based on input sequences.
Note: All sequence inputs are expected to be tuples. Lists will be automatically converted to tuples,
and None values will be converted to empty tuples.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor" class="doc doc-heading">
            <code>SequenceToOutcomePredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>, <code><span title="sklearn.base.TransformerMixin">TransformerMixin</span></code></p>


        <p>A class to model sequence-based predictions for categorical data using input and grouping sequences.
This class implements both the <code>fit</code> and <code>predict</code> methods from the parent sklearn classes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column representing the input sequence in the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column representing the grouping sequence in the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outcome_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column representing the outcome category in the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_special_category_filtering</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to filter out special categories of patients before fitting the model.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>admit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column indicating whether a patient was admitted.</p>
              </div>
            </td>
            <td>
                  <code>&#39;is_admitted&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.weights">weights</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary storing the probabilities of different input sequences leading to specific outcome categories.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.input_to_grouping_probs">input_to_grouping_probs</span></code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame that stores the computed probabilities of input sequences being associated with different grouping sequences.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.special_params">special_params</span></code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <span title="optional">optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The special category parameters used for filtering, only populated if apply_special_category_filtering=True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary to store metrics related to the training process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/sequence_to_outcome_predictor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SequenceToOutcomePredictor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to model sequence-based predictions for categorical data using input and grouping sequences.</span>
<span class="sd">    This class implements both the `fit` and `predict` methods from the parent sklearn classes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_var : str</span>
<span class="sd">        Name of the column representing the input sequence in the DataFrame.</span>
<span class="sd">    grouping_var : str</span>
<span class="sd">        Name of the column representing the grouping sequence in the DataFrame.</span>
<span class="sd">    outcome_var : str</span>
<span class="sd">        Name of the column representing the outcome category in the DataFrame.</span>
<span class="sd">    apply_special_category_filtering : bool, default=True</span>
<span class="sd">        Whether to filter out special categories of patients before fitting the model.</span>
<span class="sd">    admit_col : str, default=&#39;is_admitted&#39;</span>
<span class="sd">        Name of the column indicating whether a patient was admitted.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : dict</span>
<span class="sd">        A dictionary storing the probabilities of different input sequences leading to specific outcome categories.</span>
<span class="sd">    input_to_grouping_probs : pd.DataFrame</span>
<span class="sd">        A DataFrame that stores the computed probabilities of input sequences being associated with different grouping sequences.</span>
<span class="sd">    special_params : dict, optional</span>
<span class="sd">        The special category parameters used for filtering, only populated if apply_special_category_filtering=True.</span>
<span class="sd">    metrics : dict</span>
<span class="sd">        A dictionary to store metrics related to the training process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_var</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="p">,</span>
        <span class="n">apply_special_category_filtering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">admit_col</span><span class="o">=</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_var</span> <span class="o">=</span> <span class="n">input_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span> <span class="o">=</span> <span class="n">grouping_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span> <span class="o">=</span> <span class="n">outcome_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span> <span class="o">=</span> <span class="n">apply_special_category_filtering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span> <span class="o">=</span> <span class="n">admit_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the estimator.&quot;&quot;&quot;</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    input_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    grouping_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    outcome_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    apply_special_category_filtering=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    admit_col=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a sequence to tuple if it&#39;s not already a tuple.</span>
<span class="sd">        Handles string cleaning to avoid double-quoting issues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sequence : tuple, list, or None</span>
<span class="sd">            The sequence to convert</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The input sequence as a tuple, or an empty tuple if input was None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="c1"># Clean any quoted strings in the sequence</span>
            <span class="n">cleaned_sequence</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cleaned_sequence</span><span class="p">)</span> <span class="k">if</span> <span class="n">cleaned_sequence</span> <span class="k">else</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># Clean any quoted strings in the tuple</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">sequence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocesses the input data before fitting the model.</span>

<span class="sd">        Steps include:</span>
<span class="sd">        1. Selecting only admitted patients with a non-null specialty</span>
<span class="sd">        2. Optionally filtering out special categories</span>
<span class="sd">        3. Converting sequence columns to tuple format if they aren&#39;t already</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            DataFrame containing patient data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Preprocessed DataFrame ready for model fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make a copy to avoid modifying the original</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Step 1: Select only admitted patients with a non-null specialty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

        <span class="c1"># Step 2: Optionally apply filtering for special categories</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="p">:</span>
            <span class="c1"># Get configuration for categorizing patients based on columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="c1"># Extract function that identifies non-special category patients</span>
            <span class="n">opposite_special_category_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">][</span>
                <span class="s2">&quot;default&quot;</span>
            <span class="p">]</span>

            <span class="c1"># Determine which category is the special category</span>
            <span class="n">special_category_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">key</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span>
            <span class="p">)</span>

            <span class="c1"># Filter out special category patients</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">opposite_special_category_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">special_category_key</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># Step 3: Convert sequence columns to tuple format</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_var</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SequenceToOutcomePredictor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the predictor based on training data by computing the proportion of each input variable sequence</span>
<span class="sd">        ending in specific outcome variable categories.</span>

<span class="sd">        Automatically preprocesses the data before fitting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            A pandas DataFrame containing at least the columns specified by `input_var`, `grouping_var`, and `outcome_var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : SequenceToOutcomePredictor</span>
<span class="sd">            The fitted SequenceToOutcomePredictor model with calculated probabilities for each sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store metrics about the training data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Preprocess the data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># derive the names of the observed outcome variables from the data</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="c1"># For each sequence count the number of observed categories</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the total number of times each grouping sequence occurred</span>
        <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate for each grouping sequence, the proportion of ending with each observed specialty</span>
        <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the probability of each grouping sequence occurring in the original data</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Reweight probabilities of ending with each observed specialty</span>
        <span class="c1"># by the likelihood of each grouping sequence occurring</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">proportions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
            <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">]:</span>  <span class="c1"># Avoid the last column which is the &#39;probability_of_grouping_sequence&#39;</span>
            <span class="n">proportions</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span>

        <span class="c1"># Convert final sequence to a string in order to conduct string searches on it</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;grouping_sequence_to_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proportions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Row-wise function to return, for each input sequence,</span>
        <span class="c1"># the proportion that end up in each final sequence and thereby</span>
        <span class="c1"># the probability of it ending in any observed category</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span>
            <span class="s2">&quot;grouping_sequence_to_string&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_match_input_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">proportions</span><span class="p">,</span> <span class="n">prop_keys</span><span class="p">))</span>

        <span class="c1"># Convert the prob_input_var_ends_in_observed_specialty column to a dictionary</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Clean the key to remove excess strint quotes</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">clean_tuple_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">item</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="n">cleaned_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clean_tuple_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># save prob_input_var_ends_in_observed_specialty as weights within the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cleaned_dict</span>

        <span class="c1"># save the input to grouping probabilities for use as a reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_to_grouping_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_of_input_to_grouping_sequence</span><span class="p">(</span>
            <span class="n">X</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_string_match_input_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_var_string</span><span class="p">,</span> <span class="n">proportions</span><span class="p">,</span> <span class="n">prop_keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches a given input sequence string with grouped sequences (expressed as strings) in the dataset and aggregates</span>
<span class="sd">        their probabilities for each outcome category. This function filters the data to</span>
<span class="sd">        match only those rows where the *beginning* of the grouped sequence string</span>
<span class="sd">        matches the given input sequence string, allowing for partial matches.</span>
<span class="sd">        For instance, the sequence &#39;medical&#39; will match &#39;medical, elderly&#39; and &#39;medical, surgical&#39;</span>
<span class="sd">        as well as &#39;medical&#39; on its own. It computes the total probabilities of any input sequence ending</span>
<span class="sd">        in each outcome category, and normalizes these totals if possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_var_string : str</span>
<span class="sd">            The sequence of inputs represented as a string, used to match against sequences in the proportions DataFrame.</span>
<span class="sd">        proportions : pd.DataFrame</span>
<span class="sd">            DataFrame containing proportions data with an additional column &#39;grouping_sequence_to_string&#39;</span>
<span class="sd">            which includes string representations of sequences.</span>
<span class="sd">        prop_keys : np.array</span>
<span class="sd">            Array of unique outcomes to consider in calculations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary where keys are outcome names and values are the aggregated and normalized probabilities</span>
<span class="sd">            of an input sequence ending in those outcomes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter rows where the grouped sequence string starts with the input sequence string</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span>
            <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;grouping_sequence_to_string&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">input_var_string</span><span class="p">)</span>
        <span class="p">][</span><span class="n">prop_keys</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Sum of all probabilities to normalize them</span>
        <span class="n">props_total</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Handle cases where the total probability is zero to avoid division by zero</span>
        <span class="k">if</span> <span class="n">props_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">normalized_props</span> <span class="o">=</span> <span class="n">props</span> <span class="o">/</span> <span class="n">props_total</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalized_props</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">props</span> <span class="o">*</span> <span class="mi">0</span>
            <span class="p">)</span>  <span class="c1"># Returns zero probabilities if no matches found</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prop_keys</span><span class="p">,</span> <span class="n">normalized_props</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_probability_of_input_to_grouping_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the probabilities of different input sequences leading to specific grouping sequences.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            A pandas DataFrame containing at least the columns specified by `input_var` and `grouping_var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame containing the probabilities of input sequences leading to grouping sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For each input sequence count the number of grouping sequences</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># # Calculate the total number of times each input sequence occurred</span>
        <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># # Calculate for each grouping sequence, the proportion of ending with each grouping sequence</span>
        <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># # Calculate the probability of each input sequence occurring in the original data</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">proportions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_sequence</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts the probabilities of ending in various outcome categories for a given input sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_sequence : tuple[str, ...]</span>
<span class="sd">            A tuple containing the categories that have been observed for an entity in the order they</span>
<span class="sd">            have been encountered. An empty tuple represents an entity with no observed categories.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of categories and the probabilities that the input sequence will end in them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>

        <span class="c1"># Return a direct lookup of probabilities if possible.</span>
        <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

        <span class="c1"># Otherwise, if the sequence has multiple elements, work back looking for a match</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">input_sequence_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>
            <span class="n">input_sequence</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_sequence_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># remove last element</span>

            <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

        <span class="c1"># If no relevant data is found:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return a string representation of the estimator.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/sequence_to_outcome_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation of the estimator.&quot;&quot;&quot;</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    input_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    grouping_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    outcome_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    apply_special_category_filtering=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    admit_col=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fits the predictor based on training data by computing the proportion of each input variable sequence
ending in specific outcome variable categories.</p>
<p>Automatically preprocesses the data before fitting.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pandas DataFrame containing at least the columns specified by <code>input_var</code>, <code>grouping_var</code>, and <code>outcome_var</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>self</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="SequenceToOutcomePredictor (patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor)" href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor">SequenceToOutcomePredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted SequenceToOutcomePredictor model with calculated probabilities for each sequence.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/sequence_to_outcome_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SequenceToOutcomePredictor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits the predictor based on training data by computing the proportion of each input variable sequence</span>
<span class="sd">    ending in specific outcome variable categories.</span>

<span class="sd">    Automatically preprocesses the data before fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing at least the columns specified by `input_var`, `grouping_var`, and `outcome_var`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    self : SequenceToOutcomePredictor</span>
<span class="sd">        The fitted SequenceToOutcomePredictor model with calculated probabilities for each sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store metrics about the training data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Preprocess the data</span>
    <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># derive the names of the observed outcome variables from the data</span>
    <span class="n">prop_keys</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1"># For each sequence count the number of observed categories</span>
    <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
        <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the total number of times each grouping sequence occurred</span>
    <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate for each grouping sequence, the proportion of ending with each observed specialty</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Calculate the probability of each grouping sequence occurring in the original data</span>
    <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Reweight probabilities of ending with each observed specialty</span>
    <span class="c1"># by the likelihood of each grouping sequence occurring</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">proportions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
        <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
    <span class="p">]:</span>  <span class="c1"># Avoid the last column which is the &#39;probability_of_grouping_sequence&#39;</span>
        <span class="n">proportions</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_grouping_sequence&quot;</span><span class="p">]</span>

    <span class="c1"># Convert final sequence to a string in order to conduct string searches on it</span>
    <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;grouping_sequence_to_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proportions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Row-wise function to return, for each input sequence,</span>
    <span class="c1"># the proportion that end up in each final sequence and thereby</span>
    <span class="c1"># the probability of it ending in any observed category</span>
    <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span>
        <span class="s2">&quot;grouping_sequence_to_string&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_match_input_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">proportions</span><span class="p">,</span> <span class="n">prop_keys</span><span class="p">))</span>

    <span class="c1"># Convert the prob_input_var_ends_in_observed_specialty column to a dictionary</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;prob_input_var_ends_in_observed_specialty&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># Clean the key to remove excess strint quotes</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_tuple_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="n">cleaned_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clean_tuple_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># save prob_input_var_ends_in_observed_specialty as weights within the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cleaned_dict</span>

    <span class="c1"># save the input to grouping probabilities for use as a reference</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_to_grouping_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_of_input_to_grouping_sequence</span><span class="p">(</span>
        <span class="n">X</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Predicts the probabilities of ending in various outcome categories for a given input sequence.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_sequence</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing the categories that have been observed for an entity in the order they
have been encountered. An empty tuple represents an entity with no observed categories.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of categories and the probabilities that the input sequence will end in them.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/sequence_to_outcome_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_sequence</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predicts the probabilities of ending in various outcome categories for a given input sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_sequence : tuple[str, ...]</span>
<span class="sd">        A tuple containing the categories that have been observed for an entity in the order they</span>
<span class="sd">        have been encountered. An empty tuple represents an entity with no observed categories.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of categories and the probabilities that the input sequence will end in them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tuple</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>

    <span class="c1"># Return a direct lookup of probabilities if possible.</span>
    <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

    <span class="c1"># Otherwise, if the sequence has multiple elements, work back looking for a match</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">input_sequence_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_sequence</span><span class="p">)</span>
        <span class="n">input_sequence</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_sequence_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># remove last element</span>

        <span class="k">if</span> <span class="n">input_sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_sequence</span><span class="p">]</span>

    <span class="c1"># If no relevant data is found:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.predictors.value_to_outcome_predictor" class="doc doc-heading">
            <code>value_to_outcome_predictor</code>


</h3>

    <div class="doc doc-contents ">

        <p>This module implements a <code>ValueToOutcomePredictor</code> class that models and predicts the probability distribution
of outcomes based on a single categorical input. The class builds a model based on training data, where
input values are mapped to specific outcome categories through an intermediate grouping variable. It provides
methods to fit the model, compute probabilities, and make predictions on unseen data.</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor : sklearn.base.BaseEstimator, sklearn.base.TransformerMixin">ValueToOutcomePredictor : sklearn.base.BaseEstimator, sklearn.base.TransformerMixin</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>A model that predicts the probability of ending in different outcome categories based on a single input value.
Note: All inputs are expected to be strings. None values will be converted to empty strings during preprocessing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor" class="doc doc-heading">
            <code>ValueToOutcomePredictor</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>, <code><span title="sklearn.base.TransformerMixin">TransformerMixin</span></code></p>


        <p>A class to model predictions for categorical data using a single input value and grouping variable.
This class implements both the <code>fit</code> and <code>predict</code> methods from the parent sklearn classes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column representing the input value in the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column representing the grouping value in the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outcome_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column representing the outcome category in the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_special_category_filtering</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to filter out special categories of patients before fitting the model.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>admit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column indicating whether a patient was admitted.</p>
              </div>
            </td>
            <td>
                  <code>&#39;is_admitted&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.weights">weights</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary storing the probabilities of different input values leading to specific outcome categories.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.input_to_grouping_probs">input_to_grouping_probs</span></code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame that stores the computed probabilities of input values being associated with different grouping values.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.special_params">special_params</span></code></td>
            <td>
                  <code>(<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <span title="optional">optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The special category parameters used for filtering, only populated if apply_special_category_filtering=True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary to store metrics related to the training process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/predictors/value_to_outcome_predictor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ValueToOutcomePredictor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to model predictions for categorical data using a single input value and grouping variable.</span>
<span class="sd">    This class implements both the `fit` and `predict` methods from the parent sklearn classes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_var : str</span>
<span class="sd">        Name of the column representing the input value in the DataFrame.</span>
<span class="sd">    grouping_var : str</span>
<span class="sd">        Name of the column representing the grouping value in the DataFrame.</span>
<span class="sd">    outcome_var : str</span>
<span class="sd">        Name of the column representing the outcome category in the DataFrame.</span>
<span class="sd">    apply_special_category_filtering : bool, default=True</span>
<span class="sd">        Whether to filter out special categories of patients before fitting the model.</span>
<span class="sd">    admit_col : str, default=&#39;is_admitted&#39;</span>
<span class="sd">        Name of the column indicating whether a patient was admitted.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : dict</span>
<span class="sd">        A dictionary storing the probabilities of different input values leading to specific outcome categories.</span>
<span class="sd">    input_to_grouping_probs : pd.DataFrame</span>
<span class="sd">        A DataFrame that stores the computed probabilities of input values being associated with different grouping values.</span>
<span class="sd">    special_params : dict, optional</span>
<span class="sd">        The special category parameters used for filtering, only populated if apply_special_category_filtering=True.</span>
<span class="sd">    metrics : dict</span>
<span class="sd">        A dictionary to store metrics related to the training process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_var</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="p">,</span>
        <span class="n">apply_special_category_filtering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">admit_col</span><span class="o">=</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_var</span> <span class="o">=</span> <span class="n">input_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span> <span class="o">=</span> <span class="n">grouping_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span> <span class="o">=</span> <span class="n">outcome_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span> <span class="o">=</span> <span class="n">apply_special_category_filtering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span> <span class="o">=</span> <span class="n">admit_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the estimator.&quot;&quot;&quot;</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    input_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    grouping_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    outcome_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    apply_special_category_filtering=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    admit_col=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocesses the input data before fitting the model.</span>

<span class="sd">        Steps include:</span>
<span class="sd">        1. Selecting only admitted patients with a non-null specialty</span>
<span class="sd">        2. Optionally filtering out special categories</span>
<span class="sd">        3. Converting input values to strings and handling nulls</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            DataFrame containing patient data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Preprocessed DataFrame ready for model fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make a copy to avoid modifying the original</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Step 1: Select only admitted patients with a non-null specialty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

        <span class="c1"># Step 2: Optionally apply filtering for special categories</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="p">:</span>
            <span class="c1"># Get configuration for categorizing patients based on columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="c1"># Extract function that identifies non-special category patients</span>
            <span class="n">opposite_special_category_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">][</span>
                <span class="s2">&quot;default&quot;</span>
            <span class="p">]</span>

            <span class="c1"># Determine which category is the special category</span>
            <span class="n">special_category_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">key</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span>
            <span class="p">)</span>

            <span class="c1"># Filter out special category patients</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">opposite_special_category_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">special_category_key</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># Step 3: Convert input values to strings and handle nulls</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_var</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ValueToOutcomePredictor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the predictor based on training data by computing the proportion of each input value</span>
<span class="sd">        ending in specific outcome variable categories.</span>

<span class="sd">        Automatically preprocesses the data before fitting. During preprocessing, any null values in the</span>
<span class="sd">        input and grouping variables are converted to empty strings. These empty strings are then used</span>
<span class="sd">        as keys in the model&#39;s weights dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            A pandas DataFrame containing at least the columns specified by `input_var`, `grouping_var`, and `outcome_var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : ValueToOutcomePredictor</span>
<span class="sd">            The fitted ValueToOutcomePredictor model with calculated probabilities for each input value.</span>
<span class="sd">            The weights dictionary will contain an empty string key (&#39;&#39;) for any null values from the input data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Store metrics about the training data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Preprocess the data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># For each grouping value count the number of observed categories</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the total number of times each grouping value occurred</span>
        <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate for each grouping value, the proportion of ending with each observed specialty</span>
        <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate probabilities for each input value</span>
        <span class="n">input_probs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">input_val</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># Get all grouping values associated with this input value</span>
            <span class="n">grouping_vals</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_val</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span>
            <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="c1"># Calculate probability distribution of grouping values for this input value</span>
            <span class="n">input_to_group_probs</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_val</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span>
            <span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Get the probability distribution of outcomes for all relevant grouping values</span>
            <span class="c1"># This includes all rows in proportions where the grouping value appears for this input</span>
            <span class="n">group_to_outcome_probs</span> <span class="o">=</span> <span class="n">proportions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_vals</span><span class="p">]</span>

            <span class="c1"># Ensure the rows are aligned by reindexing group_to_outcome_probs</span>
            <span class="n">aligned_group_to_outcome</span> <span class="o">=</span> <span class="n">group_to_outcome_probs</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span>
                <span class="n">input_to_group_probs</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>

            <span class="c1"># Create outer product matrix of probabilities:</span>
            <span class="c1"># - Rows represent grouping values</span>
            <span class="c1"># - Columns represent outcome categories</span>
            <span class="c1"># Each cell contains the joint probability of the grouping value and outcome</span>
            <span class="n">input_to_outcome_probs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">input_to_group_probs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">aligned_group_to_outcome</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">input_to_group_probs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">group_to_outcome_probs</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Sum across grouping values to get final probability distribution for this input value</span>
            <span class="n">input_probs</span><span class="p">[</span><span class="n">input_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_to_outcome_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Clean the keys to remove excess string quotes</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">clean_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Remove surrounding quotes if they exist</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="c1"># Note: cleaned_dict will contain an empty string key (&#39;&#39;) for any null values from the input data</span>
        <span class="c1"># This is because null values are converted to empty strings during preprocessing</span>
        <span class="n">cleaned_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clean_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_probs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># save probabilities as weights within the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cleaned_dict</span>

        <span class="c1"># save the input to grouping probabilities for use as a reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_to_grouping_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_of_input_to_grouping_value</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_probability_of_input_to_grouping_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the probabilities of different input values leading to specific grouping values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            A pandas DataFrame containing at least the columns specified by `input_var` and `grouping_var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame containing the probabilities of input values leading to grouping values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For each input value count the number of grouping values</span>
        <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the total number of times each input value occurred</span>
        <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate for each grouping value, the proportion of ending with each grouping value</span>
        <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the probability of each input value occurring in the original data</span>
        <span class="n">proportions</span><span class="p">[</span><span class="s2">&quot;probability_of_input_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_totals</span> <span class="o">/</span> <span class="n">row_totals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">proportions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts the probabilities of ending in various outcome categories for a given input value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_value : str</span>
<span class="sd">            The input value to predict outcomes for. None values will be handled appropriately.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of categories and the probabilities that the input value will end in them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">input_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_value</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Convert input to string if it isn&#39;t already</span>
        <span class="n">input_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span>

        <span class="c1"># Return a direct lookup of probabilities if possible</span>
        <span class="k">if</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_value</span><span class="p">]</span>

        <span class="c1"># If no relevant data is found, return null probabilities</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return a string representation of the estimator.</p>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/value_to_outcome_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation of the estimator.&quot;&quot;&quot;</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    input_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    grouping_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    outcome_var=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    apply_special_category_filtering=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_special_category_filtering</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;    admit_col=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">admit_col</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Fits the predictor based on training data by computing the proportion of each input value
ending in specific outcome variable categories.</p>
<p>Automatically preprocesses the data before fitting. During preprocessing, any null values in the
input and grouping variables are converted to empty strings. These empty strings are then used
as keys in the model's weights dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pandas DataFrame containing at least the columns specified by <code>input_var</code>, <code>grouping_var</code>, and <code>outcome_var</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>self</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="ValueToOutcomePredictor (patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor)" href="#patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor">ValueToOutcomePredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted ValueToOutcomePredictor model with calculated probabilities for each input value.
The weights dictionary will contain an empty string key ('') for any null values from the input data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/value_to_outcome_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ValueToOutcomePredictor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits the predictor based on training data by computing the proportion of each input value</span>
<span class="sd">    ending in specific outcome variable categories.</span>

<span class="sd">    Automatically preprocesses the data before fitting. During preprocessing, any null values in the</span>
<span class="sd">    input and grouping variables are converted to empty strings. These empty strings are then used</span>
<span class="sd">    as keys in the model&#39;s weights dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing at least the columns specified by `input_var`, `grouping_var`, and `outcome_var`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    self : ValueToOutcomePredictor</span>
<span class="sd">        The fitted ValueToOutcomePredictor model with calculated probabilities for each input value.</span>
<span class="sd">        The weights dictionary will contain an empty string key (&#39;&#39;) for any null values from the input data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Store metrics about the training data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_dttm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;train_set_no&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Preprocess the data</span>
    <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># For each grouping value count the number of observed categories</span>
    <span class="n">X_grouped</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_var</span><span class="p">]</span>
        <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the total number of times each grouping value occurred</span>
    <span class="n">row_totals</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate for each grouping value, the proportion of ending with each observed specialty</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="n">X_grouped</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">row_totals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Calculate probabilities for each input value</span>
    <span class="n">input_probs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">input_val</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="c1"># Get all grouping values associated with this input value</span>
        <span class="n">grouping_vals</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_val</span><span class="p">][</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="c1"># Calculate probability distribution of grouping values for this input value</span>
        <span class="n">input_to_group_probs</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_val</span><span class="p">][</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grouping_var</span>
        <span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get the probability distribution of outcomes for all relevant grouping values</span>
        <span class="c1"># This includes all rows in proportions where the grouping value appears for this input</span>
        <span class="n">group_to_outcome_probs</span> <span class="o">=</span> <span class="n">proportions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_vals</span><span class="p">]</span>

        <span class="c1"># Ensure the rows are aligned by reindexing group_to_outcome_probs</span>
        <span class="n">aligned_group_to_outcome</span> <span class="o">=</span> <span class="n">group_to_outcome_probs</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span>
            <span class="n">input_to_group_probs</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>

        <span class="c1"># Create outer product matrix of probabilities:</span>
        <span class="c1"># - Rows represent grouping values</span>
        <span class="c1"># - Columns represent outcome categories</span>
        <span class="c1"># Each cell contains the joint probability of the grouping value and outcome</span>
        <span class="n">input_to_outcome_probs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">input_to_group_probs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">aligned_group_to_outcome</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">input_to_group_probs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">group_to_outcome_probs</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Sum across grouping values to get final probability distribution for this input value</span>
        <span class="n">input_probs</span><span class="p">[</span><span class="n">input_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_to_outcome_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># Clean the keys to remove excess string quotes</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Remove surrounding quotes if they exist</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="c1"># Note: cleaned_dict will contain an empty string key (&#39;&#39;) for any null values from the input data</span>
    <span class="c1"># This is because null values are converted to empty strings during preprocessing</span>
    <span class="n">cleaned_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clean_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_probs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># save probabilities as weights within the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cleaned_dict</span>

    <span class="c1"># save the input to grouping probabilities for use as a reference</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_to_grouping_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_of_input_to_grouping_value</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="patientflow.predictors.value_to_outcome_predictor.ValueToOutcomePredictor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Predicts the probabilities of ending in various outcome categories for a given input value.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_value</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input value to predict outcomes for. None values will be handled appropriately.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of categories and the probabilities that the input value will end in them.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/predictors/value_to_outcome_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predicts the probabilities of ending in various outcome categories for a given input value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_value : str</span>
<span class="sd">        The input value to predict outcomes for. None values will be handled appropriately.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of categories and the probabilities that the input value will end in them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Convert input to string if it isn&#39;t already</span>
    <span class="n">input_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span>

    <span class="c1"># Return a direct lookup of probabilities if possible</span>
    <span class="k">if</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">input_value</span><span class="p">]</span>

    <span class="c1"># If no relevant data is found, return null probabilities</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.prepare" class="doc doc-heading">
            <code>prepare</code>


</h2>

    <div class="doc doc-contents ">

        <p>Module for preparing data, loading models, and organizing snapshots for inference.</p>
<p>This module provides functionality to load a trained model, prepare data for
making predictions, calculate arrival rates, and organize snapshot data. It allows for selecting one
snapshot per visit, filtering snapshots by prediction time, and mapping
snapshot dates to corresponding indices.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.prepare.git select_one_snapshot_per_visit">git select_one_snapshot_per_visit</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Selects one snapshot per visit based on a random number and returns the filtered DataFrame.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="prepare_patient_snapshots(df, prediction_time, exclude_columns=[], single_snapshot_per_visit=True, visit_col=None, label_col='is_admitted') (patientflow.prepare.prepare_patient_snapshots)" href="#patientflow.prepare.prepare_patient_snapshots">prepare_patient_snapshots</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Filters the DataFrame by prediction time and optionally selects one snapshot per visit.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="prepare_group_snapshot_dict(df, start_dt=None, end_dt=None) (patientflow.prepare.prepare_group_snapshot_dict)" href="#patientflow.prepare.prepare_group_snapshot_dict">prepare_group_snapshot_dict</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Prepares a dictionary mapping snapshot dates to their corresponding snapshot indices.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.prepare.calculate_time_varying_arrival_rates">calculate_time_varying_arrival_rates</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculates the time-varying arrival rates for a dataset indexed by datetime.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="patientflow.prepare.SpecialCategoryParams" class="doc doc-heading">
            <code>SpecialCategoryParams</code>


</h3>


    <div class="doc doc-contents ">


        <p>A picklable implementation of special category parameters for patient classification.</p>
<p>This class identifies pediatric patients based on available age-related columns
in the dataset and provides functions to categorise patients accordingly.
It's designed to be serializable with pickle by implementing the <strong>reduce</strong> method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>columns</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a> or <span title="pandas.Index">Index</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column names from the dataset used to determine the appropriate age identification method</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.prepare.SpecialCategoryParams.columns">columns</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of column names from the dataset</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.prepare.SpecialCategoryParams.method_type">method_type</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The method used for age detection ('age_on_arrival' or 'age_group')</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="patientflow.prepare.SpecialCategoryParams.special_category_dict">special_category_dict</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default category values mapping</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If neither 'age_on_arrival' nor 'age_group' columns are found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpecialCategoryParams</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A picklable implementation of special category parameters for patient classification.</span>

<span class="sd">    This class identifies pediatric patients based on available age-related columns</span>
<span class="sd">    in the dataset and provides functions to categorise patients accordingly.</span>
<span class="sd">    It&#39;s designed to be serializable with pickle by implementing the __reduce__ method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    columns : list or pandas.Index</span>
<span class="sd">        Column names from the dataset used to determine the appropriate age identification method</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    columns : list</span>
<span class="sd">        List of column names from the dataset</span>
<span class="sd">    method_type : str</span>
<span class="sd">        The method used for age detection (&#39;age_on_arrival&#39; or &#39;age_group&#39;)</span>
<span class="sd">    special_category_dict : dict</span>
<span class="sd">        Default category values mapping</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If neither &#39;age_on_arrival&#39; nor &#39;age_group&#39; columns are found</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the SpecialCategoryParams object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        columns : list or pandas.Index</span>
<span class="sd">            Column names from the dataset used to determine the appropriate age identification method</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If neither &#39;age_on_arrival&#39; nor &#39;age_group&#39; columns are found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;medical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;surgical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;haem/onc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;age_on_arrival&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_on_arrival&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;age_group&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_group&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown data format: could not find expected age columns&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify if a patient is pediatric based on age data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        row : Union[dict, pd.Series]</span>
<span class="sd">            A row of patient data containing either &#39;age_on_arrival&#39; or &#39;age_group&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the patient is pediatric (age &lt; 18 or age_group is &#39;0-17&#39;),</span>
<span class="sd">            False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">18</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># age_group</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0-17&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">opposite_special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify if a patient is NOT pediatric.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        row : Union[dict, pd.Series]</span>
<span class="sd">            A row of patient data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the patient is NOT pediatric, False if they are pediatric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_params_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the special parameter dictionary in the format expected by the SequencePredictor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Union[Callable, Dict[str, float], Dict[str, Callable]]]</span>
<span class="sd">            A dictionary containing:</span>
<span class="sd">            - &#39;special_category_func&#39;: Function to identify pediatric patients</span>
<span class="sd">            - &#39;special_category_dict&#39;: Default category values (float)</span>
<span class="sd">            - &#39;special_func_map&#39;: Mapping of category names to detection functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;special_category_func&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
            <span class="s2">&quot;special_category_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span><span class="p">,</span>
            <span class="s2">&quot;special_func_map&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_special_category_func</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;SpecialCategoryParams&quot;</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Support for pickle serialization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[Type[&#39;SpecialCategoryParams&#39;], Tuple[list]]</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - The class itself (to be called as a function)</span>
<span class="sd">            - A tuple of arguments to pass to the class constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the SpecialCategoryParams object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>columns</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a> or <span title="pandas.Index">Index</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column names from the dataset used to determine the appropriate age identification method</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If neither 'age_on_arrival' nor 'age_group' columns are found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the SpecialCategoryParams object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    columns : list or pandas.Index</span>
<span class="sd">        Column names from the dataset used to determine the appropriate age identification method</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If neither &#39;age_on_arrival&#39; nor &#39;age_group&#39; columns are found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;surgical&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;haem/onc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;age_on_arrival&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_on_arrival&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;age_group&quot;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;age_group&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown data format: could not find expected age columns&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.__reduce__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__reduce__</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Support for pickle serialization.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" title="typing.Type" href="https://docs.python.org/3/library/typing.html#typing.Type">Type</a>[<a class="autorefs autorefs-internal" title="SpecialCategoryParams (patientflow.prepare.SpecialCategoryParams)" href="#patientflow.prepare.SpecialCategoryParams">SpecialCategoryParams</a>], <a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
- The class itself (to be called as a function)
- A tuple of arguments to pass to the class constructor</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;SpecialCategoryParams&quot;</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Support for pickle serialization.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[Type[&#39;SpecialCategoryParams&#39;], Tuple[list]]</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - The class itself (to be called as a function)</span>
<span class="sd">        - A tuple of arguments to pass to the class constructor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.get_params_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_params_dict</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the special parameter dictionary in the format expected by the SequencePredictor.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>], <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing:
- 'special_category_func': Function to identify pediatric patients
- 'special_category_dict': Default category values (float)
- 'special_func_map': Mapping of category names to detection functions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_params_dict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the special parameter dictionary in the format expected by the SequencePredictor.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Union[Callable, Dict[str, float], Dict[str, Callable]]]</span>
<span class="sd">        A dictionary containing:</span>
<span class="sd">        - &#39;special_category_func&#39;: Function to identify pediatric patients</span>
<span class="sd">        - &#39;special_category_dict&#39;: Default category values (float)</span>
<span class="sd">        - &#39;special_func_map&#39;: Mapping of category names to detection functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;special_category_func&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
        <span class="s2">&quot;special_category_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_dict</span><span class="p">,</span>
        <span class="s2">&quot;special_func_map&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;paediatric&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_special_category_func</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.opposite_special_category_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">opposite_special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Identify if a patient is NOT pediatric.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>row</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <span title="pandas.Series">Series</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A row of patient data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the patient is NOT pediatric, False if they are pediatric</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">opposite_special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify if a patient is NOT pediatric.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : Union[dict, pd.Series]</span>
<span class="sd">        A row of patient data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the patient is NOT pediatric, False if they are pediatric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.prepare.SpecialCategoryParams.special_category_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">special_category_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Identify if a patient is pediatric based on age data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>row</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <span title="pandas.Series">Series</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A row of patient data containing either 'age_on_arrival' or 'age_group'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the patient is pediatric (age &lt; 18 or age_group is '0-17'),
False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">special_category_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify if a patient is pediatric based on age data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : Union[dict, pd.Series]</span>
<span class="sd">        A row of patient data containing either &#39;age_on_arrival&#39; or &#39;age_group&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the patient is pediatric (age &lt; 18 or age_group is &#39;0-17&#39;),</span>
<span class="sd">        False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">18</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># age_group</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0-17&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.additional_details" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">additional_details</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate additional statistical details about a column's contents.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>column</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>col_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column (used for context)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string containing statistical details about the column's contents, including:
- For dates: Date range
- For categorical data: Frequency of values
- For numeric data: Range, mean, standard deviation, and NA count
- For datetime: Date range with time</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">additional_details</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">col_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate additional statistical details about a column&#39;s contents.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    column : pandas.Series</span>
<span class="sd">        The column to analyze</span>
<span class="sd">    col_name : str</span>
<span class="sd">        Name of the column (used for context)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A string containing statistical details about the column&#39;s contents, including:</span>
<span class="sd">        - For dates: Date range</span>
<span class="sd">        - For categorical data: Frequency of values</span>
<span class="sd">        - For numeric data: Range, mean, standard deviation, and NA count</span>
<span class="sd">        - For datetime: Date range with time</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_date</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to parse the string using the strptime method</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
            <span class="p">)</span>  <span class="c1"># You can adjust the format to match your date format</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Convert to datetime if it&#39;s an object but formatted as a date</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">is_date</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Date Range: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">]:</span>
        <span class="c1"># Categorical data: Frequency of unique values</span>
        <span class="c1"># Handle enum instances</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Enum</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                <span class="c1"># Convert enum instances to their values for counting</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Enum</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">value_counts</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">value_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">value_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">value_counts_formatted</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Frequencies: </span><span class="si">{</span><span class="n">value_counts_formatted</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">value_counts</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">value_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">value_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">value_counts_formatted</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Frequencies (highest 12): </span><span class="si">{</span><span class="n">value_counts_formatted</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_float_dtype</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
        <span class="c1"># Float data: Range with rounding</span>
        <span class="n">na_count</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Range: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,  Mean: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Std Dev: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, NA: </span><span class="si">{</span><span class="n">na_count</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
        <span class="c1"># Float data: Range without rounding</span>
        <span class="n">na_count</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Range: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">, Mean: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Std Dev: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, NA: </span><span class="si">{</span><span class="n">na_count</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
        <span class="c1"># Datetime data: Minimum and Maximum dates</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Date Range: </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.apply_set" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_set</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Randomly assign a set label based on weighted probabilities.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>row</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Series containing 'training_set', 'validation_set', and 'test_set' weights</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>One of 'train', 'valid', or 'test' based on weighted random choice</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_set</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Randomly assign a set label based on weighted probabilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : pandas.Series</span>
<span class="sd">        Series containing &#39;training_set&#39;, &#39;validation_set&#39;, and &#39;test_set&#39; weights</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        One of &#39;train&#39;, &#39;valid&#39;, or &#39;test&#39; based on weighted random choice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">training_set</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">validation_set</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">test_set</span><span class="p">],</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.assign_patient_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">assign_patient_ids</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_training_set</span><span class="p">,</span> <span class="n">start_validation_set</span><span class="p">,</span> <span class="n">start_test_set</span><span class="p">,</span> <span class="n">end_test_set</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">patient_id</span><span class="o">=</span><span class="s1">&#39;mrn&#39;</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Probabilistically assign patient IDs to train/validation/test sets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with patient_id, encounter, and temporal columns</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_training_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for training period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_validation_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for validation period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_test_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for test period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_test_set</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End date for test period</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>date_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for temporal splitting, by default "arrival_datetime"</p>
              </div>
            </td>
            <td>
                  <code>&#39;arrival_datetime&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for patient identifier, by default "mrn"</p>
              </div>
            </td>
            <td>
                  <code>&#39;mrn&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for visit identifier, by default "encounter"</p>
              </div>
            </td>
            <td>
                  <code>&#39;encounter&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducible results, by default 42</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with patient ID assignments based on weighted random sampling</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Counts encounters in each time period per patient ID</li>
<li>Randomly assigns each patient ID to one set, weighted by their temporal distribution</li>
<li>Patient with 70% encounters in training, 30% in validation has 70% chance of training assignment</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">assign_patient_ids</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">start_training_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_validation_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_test_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">end_test_set</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mrn&quot;</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;encounter&quot;</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Probabilistically assign patient IDs to train/validation/test sets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with patient_id, encounter, and temporal columns</span>
<span class="sd">    start_training_set : datetime.date</span>
<span class="sd">        Start date for training period</span>
<span class="sd">    start_validation_set : datetime.date</span>
<span class="sd">        Start date for validation period</span>
<span class="sd">    start_test_set : datetime.date</span>
<span class="sd">        Start date for test period</span>
<span class="sd">    end_test_set : datetime.date</span>
<span class="sd">        End date for test period</span>
<span class="sd">    date_col : str, optional</span>
<span class="sd">        Column name for temporal splitting, by default &quot;arrival_datetime&quot;</span>
<span class="sd">    patient_id : str, optional</span>
<span class="sd">        Column name for patient identifier, by default &quot;mrn&quot;</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Column name for visit identifier, by default &quot;encounter&quot;</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Random seed for reproducible results, by default 42</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with patient ID assignments based on weighted random sampling</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Counts encounters in each time period per patient ID</span>
<span class="sd">    - Randomly assigns each patient ID to one set, weighted by their temporal distribution</span>
<span class="sd">    - Patient with 70% encounters in training, 30% in validation has 70% chance of training assignment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set random seed for reproducibility</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">patients</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">])[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Handle date_col as string, datetime, or date type</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]):</span>
        <span class="c1"># Already datetime, extract date if needed</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;date&quot;</span><span class="p">):</span>
            <span class="n">date_series</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Already date type</span>
            <span class="n">date_series</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Try to convert string to datetime</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">])</span>
            <span class="n">date_series</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not convert column &#39;</span><span class="si">{</span><span class="n">date_col</span><span class="si">}</span><span class="s2">&#39; to datetime format: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Filter out patient IDs outside temporal bounds</span>
    <span class="n">pre_training_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">start_training_set</span><span class="p">]</span>
    <span class="n">post_test_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">end_test_set</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_training_patients</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_training_patients</span><span class="p">)</span><span class="si">}</span><span class="s2"> patients with only pre-training visits&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_test_patients</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">post_test_patients</span><span class="p">)</span><span class="si">}</span><span class="s2"> patients with only post-test visits&quot;</span>
        <span class="p">)</span>

    <span class="n">valid_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span>
        <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_training_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">end_test_set</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">valid_patients</span>

    <span class="c1"># Use the date_series for set assignment</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;training_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_training_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">start_validation_set</span>
    <span class="p">)</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;validation_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_validation_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">start_test_set</span>
    <span class="p">)</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;test_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_series</span> <span class="o">&gt;=</span> <span class="n">start_test_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">date_series</span> <span class="o">&lt;</span> <span class="n">end_test_set</span>
    <span class="p">)</span>

    <span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)[</span>
        <span class="p">[</span><span class="s2">&quot;training_set&quot;</span><span class="p">,</span> <span class="s2">&quot;validation_set&quot;</span><span class="p">,</span> <span class="s2">&quot;test_set&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">patients</span><span class="p">[</span><span class="s2">&quot;training_validation_test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">apply_set</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Patient Set Overlaps (before random assignment):&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train-Valid: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valid-Test: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train-Test: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All Sets: </span><span class="si">{</span><span class="n">patients</span><span class="p">[</span><span class="n">patients</span><span class="o">.</span><span class="n">training_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">validation_set</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">patients</span><span class="o">.</span><span class="n">test_set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">patients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> total patients&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">patients</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.convert_dict_to_values" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_dict_to_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert a column containing dictionaries into separate columns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input DataFrame containing the dictionary column</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing dictionaries to convert</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix to use for the new column names</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing separate columns for each dictionary key,
with values extracted from 'value_as_real' or 'value_as_text' if present</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convert_dict_to_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a column containing dictionaries into separate columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing the dictionary column</span>
<span class="sd">    column : str</span>
<span class="sd">        Name of the column containing dictionaries to convert</span>
<span class="sd">    prefix : str</span>
<span class="sd">        Prefix to use for the new column names</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame containing separate columns for each dictionary key,</span>
<span class="sd">        with values extracted from &#39;value_as_real&#39; or &#39;value_as_text&#39; if present</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_relevant_value</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;value_as_real&quot;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">or</span> <span class="s2">&quot;value_as_text&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_as_real&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_as_real&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_as_text&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">d</span>  <span class="c1"># Return the dictionary as is if it does not contain &#39;value_as_real&#39; or &#39;value_as_text&#39;</span>
        <span class="k">return</span> <span class="n">d</span>  <span class="c1"># Return the value as is if it is not a dictionary</span>

    <span class="c1"># Apply the extraction function to each entry in the dictionary column</span>
    <span class="n">extracted_values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">extract_relevant_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="p">)</span>

    <span class="c1"># Create a DataFrame from the processed dictionary column</span>
    <span class="n">dict_df</span> <span class="o">=</span> <span class="n">extracted_values</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

    <span class="c1"># Add a prefix to the column names</span>
    <span class="n">dict_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dict_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dict_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.convert_set_to_dummies" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_set_to_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert a column containing sets into dummy variables.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input DataFrame containing the set column</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing sets to convert</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix to use for the dummy variable column names</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing dummy variables for each unique item in the sets</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convert_set_to_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a column containing sets into dummy variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing the set column</span>
<span class="sd">    column : str</span>
<span class="sd">        Name of the column containing sets to convert</span>
<span class="sd">    prefix : str</span>
<span class="sd">        Prefix to use for the dummy variable column names</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame containing dummy variables for each unique item in the sets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Explode the set into rows</span>
    <span class="n">exploded_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

    <span class="c1"># Create dummy variables for each unique item with a specified prefix</span>
    <span class="n">dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">exploded_df</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

    <span class="c1"># # Sum the dummies back to the original DataFrame&#39;s index</span>
    <span class="n">dummies</span> <span class="o">=</span> <span class="n">dummies</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">dummies</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Convert dummy variables to boolean</span>
    <span class="n">dummies</span> <span class="o">=</span> <span class="n">dummies</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dummies</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.create_special_category_objects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a configuration for categorising patients with special handling for pediatric cases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>columns</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a> or <span title="pandas.Index">Index</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column names available in the dataset. Used to determine which age format is present.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing special category configuration with:
- 'special_category_func': Function to identify pediatric patients
- 'special_category_dict': Default category values
- 'special_func_map': Mapping of category names to detection functions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_special_category_objects</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a configuration for categorising patients with special handling for pediatric cases.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    columns : list or pandas.Index</span>
<span class="sd">        The column names available in the dataset. Used to determine which age format is present.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing special category configuration with:</span>
<span class="sd">        - &#39;special_category_func&#39;: Function to identify pediatric patients</span>
<span class="sd">        - &#39;special_category_dict&#39;: Default category values</span>
<span class="sd">        - &#39;special_func_map&#39;: Mapping of category names to detection functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the class instance and return its parameter dictionary</span>
    <span class="n">params_obj</span> <span class="o">=</span> <span class="n">SpecialCategoryParams</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params_obj</span><span class="o">.</span><span class="n">get_params_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.create_temporal_splits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_temporal_splits</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_train</span><span class="p">,</span> <span class="n">start_valid</span><span class="p">,</span> <span class="n">start_test</span><span class="p">,</span> <span class="n">end_test</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">patient_id</span><span class="o">=</span><span class="s1">&#39;mrn&#39;</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Split dataset into temporal train/validation/test sets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_train</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training start (inclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_valid</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation start (inclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test start (inclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test end (exclusive)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>col_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Primary datetime column for splitting, by default "arrival_datetime"</p>
              </div>
            </td>
            <td>
                  <code>&#39;arrival_datetime&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for patient identifier, by default "mrn"</p>
              </div>
            </td>
            <td>
                  <code>&#39;mrn&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for visit identifier, by default "encounter"</p>
              </div>
            </td>
            <td>
                  <code>&#39;encounter&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducible results, by default 42</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing (train_df, valid_df, test_df) split dataframes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>Creates temporal data splits using primary datetime column and optional snapshot dates.
Handles patient ID grouping if present to prevent data leakage.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_temporal_splits</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">start_train</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_valid</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">start_test</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">end_test</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
    <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mrn&quot;</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;encounter&quot;</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split dataset into temporal train/validation/test sets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input dataframe</span>
<span class="sd">    start_train : datetime.date</span>
<span class="sd">        Training start (inclusive)</span>
<span class="sd">    start_valid : datetime.date</span>
<span class="sd">        Validation start (inclusive)</span>
<span class="sd">    start_test : datetime.date</span>
<span class="sd">        Test start (inclusive)</span>
<span class="sd">    end_test : datetime.date</span>
<span class="sd">        Test end (exclusive)</span>
<span class="sd">    col_name : str, optional</span>
<span class="sd">        Primary datetime column for splitting, by default &quot;arrival_datetime&quot;</span>
<span class="sd">    patient_id : str, optional</span>
<span class="sd">        Column name for patient identifier, by default &quot;mrn&quot;</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Column name for visit identifier, by default &quot;encounter&quot;</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Random seed for reproducible results, by default 42</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[pandas.DataFrame, pandas.DataFrame, pandas.DataFrame]</span>
<span class="sd">        Tuple containing (train_df, valid_df, test_df) split dataframes</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Creates temporal data splits using primary datetime column and optional snapshot dates.</span>
<span class="sd">    Handles patient ID grouping if present to prevent data leakage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_date_value</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert timestamp or date column to date, handling both types.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series : pandas.Series</span>
<span class="sd">            Series containing datetime or date values</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.Series</span>
<span class="sd">            Series with date values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">series</span>

    <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">set_assignment</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">assign_patient_ids</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">start_train</span><span class="p">,</span>
            <span class="n">start_valid</span><span class="p">,</span>
            <span class="n">start_test</span><span class="p">,</span>
            <span class="n">end_test</span><span class="p">,</span>
            <span class="n">col_name</span><span class="p">,</span>
            <span class="n">patient_id</span><span class="p">,</span>
            <span class="n">visit_col</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patient_sets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">set_assignment</span><span class="p">[</span><span class="n">set_assignment</span><span class="o">.</span><span class="n">training_validation_test</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="n">splits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">set_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">start_train</span><span class="p">,</span> <span class="n">start_valid</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">start_valid</span><span class="p">,</span> <span class="n">start_test</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">start_test</span><span class="p">,</span> <span class="n">end_test</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">end</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;snapshot_date&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">get_date_value</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">snapshot_date</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">df</span><span class="p">[</span><span class="n">patient_id</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">patient_sets</span><span class="p">[</span><span class="n">set_key</span><span class="p">])</span>

        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split sizes: </span><span class="si">{</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">splits</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.create_yta_filters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create specialty filters for categorizing patients by specialty and age group.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data with columns that include either
'age_on_arrival' or 'age_group' for pediatric classification</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping specialty names to filter configurations.
Each configuration contains:
- For pediatric specialty: {"is_child": True}
- For other specialties: {"specialty": specialty_name, "is_child": False}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;patient_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;age_on_arrival&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filters</span> <span class="o">=</span> <span class="n">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;paediatric&#39;</span><span class="p">])</span>
<span class="go">{&#39;is_child&#39;: True}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;medical&#39;</span><span class="p">])</span>
<span class="go">{&#39;specialty&#39;: &#39;medical&#39;, &#39;is_child&#39;: False}</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create specialty filters for categorizing patients by specialty and age group.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data with columns that include either</span>
<span class="sd">        &#39;age_on_arrival&#39; or &#39;age_group&#39; for pediatric classification</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping specialty names to filter configurations.</span>
<span class="sd">        Each configuration contains:</span>
<span class="sd">        - For pediatric specialty: {&quot;is_child&quot;: True}</span>
<span class="sd">        - For other specialties: {&quot;specialty&quot;: specialty_name, &quot;is_child&quot;: False}</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;patient_id&#39;: [1, 2], &#39;age_on_arrival&#39;: [10, 40]})</span>
<span class="sd">    &gt;&gt;&gt; filters = create_yta_filters(df)</span>
<span class="sd">    &gt;&gt;&gt; print(filters[&#39;paediatric&#39;])</span>
<span class="sd">    {&#39;is_child&#39;: True}</span>
<span class="sd">    &gt;&gt;&gt; print(filters[&#39;medical&#39;])</span>
<span class="sd">    {&#39;specialty&#39;: &#39;medical&#39;, &#39;is_child&#39;: False}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the special category parameters using the picklable implementation</span>
    <span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Extract necessary data from the special_params</span>
    <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span>

    <span class="c1"># Create the specialty_filters dictionary</span>
    <span class="n">specialty_filters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">specialty</span><span class="p">,</span> <span class="n">is_paediatric_flag</span> <span class="ow">in</span> <span class="n">special_category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_paediatric_flag</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="c1"># For the paediatric specialty, set `is_child` to True</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For other specialties, set `is_child` to False</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="n">specialty</span><span class="p">,</span> <span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">specialty_filters</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.find_group_for_colname" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_group_for_colname</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">dict_col_groups</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Find the group name that a column belongs to in the column groups dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>column</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column to find the group for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dict_col_groups</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping group names to lists of column names</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the group the column belongs to, or None if not found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_group_for_colname</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">dict_col_groups</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the group name that a column belongs to in the column groups dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    column : str</span>
<span class="sd">        Name of the column to find the group for</span>
<span class="sd">    dict_col_groups : dict</span>
<span class="sd">        Dictionary mapping group names to lists of column names</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        The name of the group the column belongs to, or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values_list</span> <span class="ow">in</span> <span class="n">dict_col_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.generate_description" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_description</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a description for a column based on its name and manual descriptions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>col_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column to generate a description for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A descriptive string explaining the column's purpose and content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_description</span><span class="p">(</span><span class="n">col_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a description for a column based on its name and manual descriptions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    col_name : str</span>
<span class="sd">        Name of the column to generate a description for</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A descriptive string explaining the column&#39;s purpose and content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manual_descriptions</span> <span class="o">=</span> <span class="n">get_manual_descriptions</span><span class="p">()</span>

    <span class="c1"># Check if manual description is provided</span>
    <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">manual_descriptions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">manual_descriptions</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;num_orders&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Number of times &quot;</span> <span class="o">+</span> <span class="n">col_name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot; has been recorded&quot;</span>
    <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Number of observations of &quot;</span> <span class="o">+</span> <span class="n">col_name</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;latest_obs&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Latest result for &quot;</span> <span class="o">+</span> <span class="n">col_name</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;latest_lab&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Latest result for &quot;</span> <span class="o">+</span> <span class="n">col_name</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lab_orders&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Request for lab battery &quot;</span> <span class="o">+</span> <span class="n">col_name</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot; has been placed&quot;</span>
    <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;visited&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Patient visited &quot;</span> <span class="o">+</span> <span class="n">col_name</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot; previously or is there now&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">col_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.prepare_group_snapshot_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_group_snapshot_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepare a dictionary mapping snapshot dates to their corresponding snapshot indices.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing at least a 'snapshot_date' column</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_dt</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date for filtering snapshots, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_dt</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End date for filtering snapshots, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where:
- Keys are dates
- Values are arrays of indices corresponding to each date's snapshots
- Empty arrays for dates with no snapshots (if start_dt and end_dt are provided)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If 'snapshot_date' column is not present in the DataFrame</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_group_snapshot_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_dt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare a dictionary mapping snapshot dates to their corresponding snapshot indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing at least a &#39;snapshot_date&#39; column</span>
<span class="sd">    start_dt : datetime.date, optional</span>
<span class="sd">        Start date for filtering snapshots, by default None</span>
<span class="sd">    end_dt : datetime.date, optional</span>
<span class="sd">        End date for filtering snapshots, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary where:</span>
<span class="sd">        - Keys are dates</span>
<span class="sd">        - Values are arrays of indices corresponding to each date&#39;s snapshots</span>
<span class="sd">        - Empty arrays for dates with no snapshots (if start_dt and end_dt are provided)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If &#39;snapshot_date&#39; column is not present in the DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure &#39;snapshot_date&#39; is in the DataFrame</span>
    <span class="k">if</span> <span class="s2">&quot;snapshot_date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataFrame must include a &#39;snapshot_date&#39; column&quot;</span><span class="p">)</span>

    <span class="c1"># Filter DataFrame to date range if provided</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">start_dt</span> <span class="ow">and</span> <span class="n">end_dt</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_dt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end_dt</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># Group the DataFrame by &#39;snapshot_date&#39; and collect the indices for each group</span>
    <span class="n">snapshots_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">date</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># If start_dt and end_dt are specified, add any missing keys from prediction_dates</span>
    <span class="k">if</span> <span class="n">start_dt</span><span class="p">:</span>
        <span class="n">prediction_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prediction_dates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshots_dict</span><span class="p">:</span>
                <span class="n">snapshots_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">snapshots_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.prepare_patient_snapshots" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_patient_snapshots</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepare patient snapshots for model training or prediction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input DataFrame containing patient visit data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The specific prediction time to filter for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_columns</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of columns to exclude from the final DataFrame, by default []</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>single_snapshot_per_visit</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to select only one snapshot per visit, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing visit identifiers, required if single_snapshot_per_visit is True</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels, by default "is_admitted"</p>
              </div>
            </td>
            <td>
                  <code>&#39;is_admitted&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.Series">Series</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
- DataFrame: Processed DataFrame with features
- Series: Corresponding labels</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If single_snapshot_per_visit is True but visit_col is not provided</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_patient_snapshots</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare patient snapshots for model training or prediction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing patient visit data</span>
<span class="sd">    prediction_time : str or datetime</span>
<span class="sd">        The specific prediction time to filter for</span>
<span class="sd">    exclude_columns : list, optional</span>
<span class="sd">        List of columns to exclude from the final DataFrame, by default []</span>
<span class="sd">    single_snapshot_per_visit : bool, optional</span>
<span class="sd">        Whether to select only one snapshot per visit, by default True</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of the column containing visit identifiers, required if single_snapshot_per_visit is True</span>
<span class="sd">    label_col : str, optional</span>
<span class="sd">        Name of the column containing the target labels, by default &quot;is_admitted&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[pandas.DataFrame, pandas.Series]</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - DataFrame: Processed DataFrame with features</span>
<span class="sd">        - Series: Corresponding labels</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If single_snapshot_per_visit is True but visit_col is not provided</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">single_snapshot_per_visit</span> <span class="ow">and</span> <span class="n">visit_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;visit_col must be provided when single_snapshot_per_visit is True&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Filter by the time of day while keeping the original index</span>
    <span class="n">df_tod</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">single_snapshot_per_visit</span><span class="p">:</span>
        <span class="c1"># Select one row for each visit</span>
        <span class="n">df_single</span> <span class="o">=</span> <span class="n">select_one_snapshot_per_visit</span><span class="p">(</span><span class="n">df_tod</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">)</span>
        <span class="c1"># Create label array with the same index</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_single</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Drop specified columns and ensure we do not reset the index</span>
        <span class="n">df_single</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_single</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Directly modify df_tod without resetting the index</span>
        <span class="n">df_tod</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;random_number&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">exclude_columns</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_tod</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_tod</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.select_one_snapshot_per_visit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select_one_snapshot_per_visit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Select one random snapshot per visit from a DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input DataFrame containing visit snapshots</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing visit identifiers</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducibility, by default 42</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing one randomly selected snapshot per visit</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_one_snapshot_per_visit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select one random snapshot per visit from a DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing visit snapshots</span>
<span class="sd">    visit_col : str</span>
<span class="sd">        Name of the column containing visit identifiers</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Random seed for reproducibility, by default 42</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame containing one randomly selected snapshot per visit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate random numbers if not present</span>
    <span class="k">if</span> <span class="s2">&quot;random_number&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;random_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

    <span class="c1"># Select the row with the maximum random_number for each visit</span>
    <span class="n">max_indices</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">visit_col</span><span class="p">)[</span><span class="s2">&quot;random_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_indices</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;random_number&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.validate_special_category_objects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_special_category_objects</span><span class="p">(</span><span class="n">special_params</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate that a special category parameters dictionary contains all required keys.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>special_params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of special category parameters to validate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="MissingKeysError (patientflow.errors.MissingKeysError)" href="#patientflow.errors.MissingKeysError">MissingKeysError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any required keys are missing from the dictionary</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_special_category_objects</span><span class="p">(</span><span class="n">special_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that a special category parameters dictionary contains all required keys.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    special_params : Dict[str, Any]</span>
<span class="sd">        Dictionary of special category parameters to validate</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    MissingKeysError</span>
<span class="sd">        If any required keys are missing from the dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;special_category_func&quot;</span><span class="p">,</span>
        <span class="s2">&quot;special_category_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;special_func_map&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">special_params</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingKeysError</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="patientflow.prepare.write_data_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_data_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dict_name</span><span class="p">,</span> <span class="n">dict_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Write a data dictionary for a DataFrame to both Markdown and CSV formats.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input DataFrame to create a data dictionary for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dict_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base name for the output files (without extension)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dict_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where the data dictionary files will be written</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The created data dictionary as a DataFrame</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>Creates two files:
- {dict_name}.md: Markdown format data dictionary
- {dict_name}.csv: CSV format data dictionary</p>
<p>For visit data, includes separate statistics for admitted and non-admitted patients.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/prepare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_data_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dict_name</span><span class="p">,</span> <span class="n">dict_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a data dictionary for a DataFrame to both Markdown and CSV formats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame to create a data dictionary for</span>
<span class="sd">    dict_name : str</span>
<span class="sd">        Base name for the output files (without extension)</span>
<span class="sd">    dict_path : str or pathlib.Path</span>
<span class="sd">        Directory path where the data dictionary files will be written</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The created data dictionary as a DataFrame</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Creates two files:</span>
<span class="sd">    - {dict_name}.md: Markdown format data dictionary</span>
<span class="sd">    - {dict_name}.csv: CSV format data dictionary</span>

<span class="sd">    For visit data, includes separate statistics for admitted and non-admitted patients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cols_to_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit_number&quot;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;visits&quot;</span> <span class="ow">in</span> <span class="n">dict_name</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">consultation_sequence</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">consultation_sequence</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">final_sequence</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">final_sequence</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">df_admitted</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_admitted</span><span class="p">]</span>
        <span class="n">df_not_admitted</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">is_admitted</span><span class="p">]</span>
        <span class="n">dict_col_groups</span> <span class="o">=</span> <span class="n">get_dict_cols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Variable type&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">find_group_for_colname</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">dict_col_groups</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">],</span>
                <span class="s2">&quot;Column Name&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                <span class="s2">&quot;Data Type&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span>
                <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generate_description</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
                <span class="s2">&quot;Whole dataset&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">additional_details</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_exclude</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">],</span>
                <span class="s2">&quot;Admitted&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">additional_details</span><span class="p">(</span><span class="n">df_admitted</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_exclude</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_admitted</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">],</span>
                <span class="s2">&quot;Not admitted&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">additional_details</span><span class="p">(</span><span class="n">df_not_admitted</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_exclude</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_not_admitted</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Whole dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Whole dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Admitted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Admitted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Not admitted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Not admitted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Column Name&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                <span class="s2">&quot;Data Type&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span>
                <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generate_description</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
                <span class="s2">&quot;Additional Details&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">additional_details</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_exclude</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Additional Details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;Additional Details&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Export to Markdown and csv for data dictionary</span>
    <span class="n">data_dict</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">dict_name</span> <span class="o">+</span> <span class="s2">&quot;.md&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_dict</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">dict_name</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.survival_curve" class="doc doc-heading">
            <code>survival_curve</code>


</h2>

    <div class="doc doc-contents ">

        <p>Core survival curve calculation functions for patient flow analysis.</p>
<p>This module provides the mathematical computation functions for survival analysis
without visualization dependencies.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.survival_curve.calculate_survival_curve : function">calculate_survival_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate survival curve data from patient visit data</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="patientflow.survival_curve.calculate_survival_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_survival_curve</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate survival curve data from patient visit data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient visit data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the start time (e.g., arrival time)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_time_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the end time (e.g., admission time)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>tuple of (numpy.ndarray, numpy.ndarray, pandas.DataFrame)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>unique_times: Array of time points in hours</li>
<li>survival_prob: Array of survival probabilities at each time point</li>
<li>df_clean: Cleaned DataFrame with wait_time_hours column added</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/survival_curve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_survival_curve</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate survival curve data from patient visit data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient visit data</span>
<span class="sd">    start_time_col : str</span>
<span class="sd">        Name of the column containing the start time (e.g., arrival time)</span>
<span class="sd">    end_time_col : str</span>
<span class="sd">        Name of the column containing the end time (e.g., admission time)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of (numpy.ndarray, numpy.ndarray, pandas.DataFrame)</span>
<span class="sd">        - unique_times: Array of time points in hours</span>
<span class="sd">        - survival_prob: Array of survival probabilities at each time point</span>
<span class="sd">        - df_clean: Cleaned DataFrame with wait_time_hours column added</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the wait time in hours</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">end_time_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">start_time_col</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="c1"># Drop any rows with missing wait times</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Sort the data by wait time</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate the number of patients</span>
    <span class="n">n_patients</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span>

    <span class="c1"># Calculate the survival function manually</span>
    <span class="c1"># For each time point, calculate proportion of patients who are still waiting</span>
    <span class="n">unique_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">survival_prob</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">unique_times</span><span class="p">:</span>
        <span class="c1"># Number of patients who experienced the event after this time point</span>
        <span class="n">n_event_after</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="s2">&quot;wait_time_hours&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span>
        <span class="c1"># Proportion of patients still waiting</span>
        <span class="n">survival_prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_event_after</span> <span class="o">/</span> <span class="n">n_patients</span><span class="p">)</span>

    <span class="c1"># Add zero hours wait time (everyone is waiting at time 0)</span>
    <span class="n">unique_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">unique_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">survival_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">survival_prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">unique_times</span><span class="p">,</span> <span class="n">survival_prob</span><span class="p">,</span> <span class="n">df_clean</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.train" class="doc doc-heading">
            <code>train</code>


</h2>

    <div class="doc doc-contents ">

        <p>Training module for patient flow models.</p>
<p>This module provides functionality for training various predictive models used in
patient flow analysis, including classifiers and demand forecasting models.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.train.classifiers" class="doc doc-heading">
            <code>classifiers</code>


</h3>

    <div class="doc doc-contents ">

        <p>Machine learning classifiers for patient flow prediction.</p>
<p>This module provides functions for training and evaluating machine learning
classifiers for patient admission prediction. It includes utilities for
data preparation, model training, hyperparameter tuning, and evaluation
using time series cross-validation.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="evaluate_predictions(y_true, y_pred) (patientflow.train.classifiers.evaluate_predictions)" href="#patientflow.train.classifiers.evaluate_predictions">evaluate_predictions</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate multiple metrics (AUC, log loss, AUPRC) for given predictions</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="chronological_cross_validation(pipeline, X, y, n_splits=5) (patientflow.train.classifiers.chronological_cross_validation)" href="#patientflow.train.classifiers.chronological_cross_validation">chronological_cross_validation</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Perform time series cross-validation with multiple metrics</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="initialise_model(model_class, params, xgb_specific_params={'n_jobs': -1, 'eval_metric': 'logloss', 'enable_categorical': True}) (patientflow.train.classifiers.initialise_model)" href="#patientflow.train.classifiers.initialise_model">initialise_model</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a model with given hyperparameters</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="create_column_transformer(df, ordinal_mappings=None) (patientflow.train.classifiers.create_column_transformer)" href="#patientflow.train.classifiers.create_column_transformer">create_column_transformer</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create a column transformer for a dataframe with dynamic column handling</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="calculate_class_balance(y) (patientflow.train.classifiers.calculate_class_balance)" href="#patientflow.train.classifiers.calculate_class_balance">calculate_class_balance</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Calculate class balance ratios for target labels</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_feature_metadata(pipeline) (patientflow.train.classifiers.get_feature_metadata)" href="#patientflow.train.classifiers.get_feature_metadata">get_feature_metadata</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Extract feature names and importances from pipeline</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_dataset_metadata(X_train, X_valid, y_train, y_valid, X_test=None, y_test=None) (patientflow.train.classifiers.get_dataset_metadata)" href="#patientflow.train.classifiers.get_dataset_metadata">get_dataset_metadata</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get dataset sizes and class balances</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="create_balance_info(is_balanced, original_size, balanced_size, original_positive_rate, balanced_positive_rate, majority_to_minority_ratio) (patientflow.train.classifiers.create_balance_info)" href="#patientflow.train.classifiers.create_balance_info">create_balance_info</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create a dictionary with balance information</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="evaluate_model(pipeline, X_test, y_test) (patientflow.train.classifiers.evaluate_model)" href="#patientflow.train.classifiers.evaluate_model">evaluate_model</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Evaluate model on test set</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="train_classifier(train_visits, valid_visits, prediction_time, exclude_from_training_data, grid, ordinal_mappings, test_visits=None, visit_col=None, model_class=XGBClassifier, use_balanced_training=True, majority_to_minority_ratio=1.0, calibrate_probabilities=True, calibration_method='sigmoid', single_snapshot_per_visit=True, label_col='is_admitted', evaluate_on_test=False) (patientflow.train.classifiers.train_classifier)" href="#patientflow.train.classifiers.train_classifier">train_classifier</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Train a single model including data preparation and balancing</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="train_multiple_classifiers(train_visits, valid_visits, grid, exclude_from_training_data, ordinal_mappings, prediction_times, test_visits=None, model_name='admissions', visit_col='visit_number', calibrate_probabilities=True, calibration_method='isotonic', use_balanced_training=True, majority_to_minority_ratio=1.0, label_col='is_admitted', evaluate_on_test=False) (patientflow.train.classifiers.train_multiple_classifiers)" href="#patientflow.train.classifiers.train_multiple_classifiers">train_multiple_classifiers</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Train admission prediction models for multiple prediction times</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.calculate_class_balance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate class balance ratios for target labels.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target labels</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping each class to its proportion</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_class_balance</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate class balance ratios for target labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : Series</span>
<span class="sd">        Target labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[Any, float]</span>
<span class="sd">        Dictionary mapping each class to its proportion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">count</span> <span class="o">/</span> <span class="n">total</span> <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.chronological_cross_validation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">chronological_cross_validation</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform time series cross-validation with multiple metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pipeline</code>
            </td>
            <td>
                  <code><span title="sklearn.pipeline.Pipeline">Pipeline</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sklearn pipeline to evaluate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Feature matrix</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target labels</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_splits</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of time series splits, by default 5</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing training and validation metrics</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">chronological_cross_validation</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">n_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform time series cross-validation with multiple metrics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline : Pipeline</span>
<span class="sd">        Sklearn pipeline to evaluate</span>
<span class="sd">    X : DataFrame</span>
<span class="sd">        Feature matrix</span>
<span class="sd">    y : Series</span>
<span class="sd">        Target labels</span>
<span class="sd">    n_splits : int, optional</span>
<span class="sd">        Number of time series splits, by default 5</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, float]</span>
<span class="sd">        Dictionary containing training and validation metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">)</span>

    <span class="n">train_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FoldResults</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FoldResults</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">valid_preds</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">train_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">))</span>
        <span class="n">valid_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">valid_preds</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FoldResults</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics_list</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">FoldResults</span><span class="o">.</span><span class="n">__dataclass_fields__</span>
        <span class="p">}</span>

    <span class="n">train_means</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">train_metrics</span><span class="p">)</span>
    <span class="n">valid_means</span> <span class="o">=</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;train_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">train_means</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="o">|</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;valid_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">valid_means</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.create_balance_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_balance_info</span><span class="p">(</span><span class="n">is_balanced</span><span class="p">,</span> <span class="n">original_size</span><span class="p">,</span> <span class="n">balanced_size</span><span class="p">,</span> <span class="n">original_positive_rate</span><span class="p">,</span> <span class="n">balanced_positive_rate</span><span class="p">,</span> <span class="n">majority_to_minority_ratio</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a dictionary with balance information.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>is_balanced</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the dataset was balanced</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original dataset size</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>balanced_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size after balancing</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_positive_rate</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positive class rate before balancing</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>balanced_positive_rate</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positive class rate after balancing</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>majority_to_minority_ratio</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ratio of majority to minority class samples</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing balance information</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_balance_info</span><span class="p">(</span>
    <span class="n">is_balanced</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">balanced_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">original_positive_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">balanced_positive_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">majority_to_minority_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a dictionary with balance information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    is_balanced : bool</span>
<span class="sd">        Whether the dataset was balanced</span>
<span class="sd">    original_size : int</span>
<span class="sd">        Original dataset size</span>
<span class="sd">    balanced_size : int</span>
<span class="sd">        Size after balancing</span>
<span class="sd">    original_positive_rate : float</span>
<span class="sd">        Positive class rate before balancing</span>
<span class="sd">    balanced_positive_rate : float</span>
<span class="sd">        Positive class rate after balancing</span>
<span class="sd">    majority_to_minority_ratio : float</span>
<span class="sd">        Ratio of majority to minority class samples</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Union[bool, int, float]]</span>
<span class="sd">        Dictionary containing balance information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;is_balanced&quot;</span><span class="p">:</span> <span class="n">is_balanced</span><span class="p">,</span>
        <span class="s2">&quot;original_size&quot;</span><span class="p">:</span> <span class="n">original_size</span><span class="p">,</span>
        <span class="s2">&quot;balanced_size&quot;</span><span class="p">:</span> <span class="n">balanced_size</span><span class="p">,</span>
        <span class="s2">&quot;original_positive_rate&quot;</span><span class="p">:</span> <span class="n">original_positive_rate</span><span class="p">,</span>
        <span class="s2">&quot;balanced_positive_rate&quot;</span><span class="p">:</span> <span class="n">balanced_positive_rate</span><span class="p">,</span>
        <span class="s2">&quot;majority_to_minority_ratio&quot;</span><span class="p">:</span> <span class="n">majority_to_minority_ratio</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.create_column_transformer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_column_transformer</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a column transformer for a dataframe with dynamic column handling.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ordinal_mappings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mappings for ordinal categorical features, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="sklearn.compose.ColumnTransformer">ColumnTransformer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configured column transformer</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_column_transformer</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnTransformer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a column transformer for a dataframe with dynamic column handling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : DataFrame</span>
<span class="sd">        Input dataframe</span>
<span class="sd">    ordinal_mappings : Dict[str, List[Any]], optional</span>
<span class="sd">        Mappings for ordinal categorical features, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ColumnTransformer</span>
<span class="sd">        Configured column transformer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">ordinal_mappings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ordinal_mappings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ordinal_mappings</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">col</span><span class="p">,</span>
                    <span class="n">OrdinalEncoder</span><span class="p">(</span>
                        <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">ordinal_mappings</span><span class="p">[</span><span class="n">col</span><span class="p">]],</span>
                        <span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;use_encoded_value&quot;</span><span class="p">,</span>
                        <span class="n">unknown_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="p">[</span><span class="n">col</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">):</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">col</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="p">[</span><span class="n">col</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.evaluate_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate model on test set.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pipeline</code>
            </td>
            <td>
                  <code><span title="sklearn.pipeline.Pipeline">Pipeline</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained sklearn pipeline</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>X_test</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test features</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_test</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test labels</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing test metrics</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">Series</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate model on test set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline : Pipeline</span>
<span class="sd">        Trained sklearn pipeline</span>
<span class="sd">    X_test : DataFrame</span>
<span class="sd">        Test features</span>
<span class="sd">    y_test : Series</span>
<span class="sd">        Test labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, float]</span>
<span class="sd">        Dictionary containing test metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;test_auc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)),</span>
        <span class="s2">&quot;test_logloss&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)),</span>
        <span class="s2">&quot;test_auprc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.evaluate_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate multiple metrics for given predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y_true</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True binary labels</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float64">float64</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted probabilities</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="FoldResults


  
      dataclass
   (patientflow.model_artifacts.FoldResults)" href="#patientflow.model_artifacts.FoldResults">FoldResults</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object containing AUC, log loss, and AUPRC metrics</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_predictions</span><span class="p">(</span>
    <span class="n">y_true</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FoldResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate multiple metrics for given predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_true : npt.NDArray[np.int_]</span>
<span class="sd">        True binary labels</span>
<span class="sd">    y_pred : npt.NDArray[np.float64]</span>
<span class="sd">        Predicted probabilities</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FoldResults</span>
<span class="sd">        Object containing AUC, log loss, and AUPRC metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">FoldResults</span><span class="p">(</span>
        <span class="n">auc</span><span class="o">=</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="n">logloss</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="n">auprc</span><span class="o">=</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.get_dataset_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dataset_metadata</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get dataset sizes and class balances.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X_train</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training features</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>X_valid</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation features</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_train</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training labels</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_valid</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation labels</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>X_test</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test features. If None, test set information will be set to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_test</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test labels. If None, test set information will be set to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="patientflow.train.classifiers.DatasetMetadata">DatasetMetadata</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing dataset sizes and class balances</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dataset_metadata</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">X_valid</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span>
    <span class="n">y_valid</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">y_test</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetMetadata</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get dataset sizes and class balances.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_train : DataFrame</span>
<span class="sd">        Training features</span>
<span class="sd">    X_valid : DataFrame</span>
<span class="sd">        Validation features</span>
<span class="sd">    y_train : Series</span>
<span class="sd">        Training labels</span>
<span class="sd">    y_valid : Series</span>
<span class="sd">        Validation labels</span>
<span class="sd">    X_test : DataFrame, optional</span>
<span class="sd">        Test features. If None, test set information will be set to None.</span>
<span class="sd">    y_test : Series, optional</span>
<span class="sd">        Test labels. If None, test set information will be set to None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DatasetMetadata</span>
<span class="sd">        Dictionary containing dataset sizes and class balances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">DatasetMetadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train_valid_test_set_no&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;train_set_no&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
            <span class="s2">&quot;valid_set_no&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span>
            <span class="s2">&quot;test_set_no&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;train_valid_test_class_balance&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;y_train_class_balance&quot;</span><span class="p">:</span> <span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span>
            <span class="s2">&quot;y_valid_class_balance&quot;</span><span class="p">:</span> <span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y_valid</span><span class="p">),</span>
            <span class="s2">&quot;y_test_class_balance&quot;</span><span class="p">:</span> <span class="n">calculate_class_balance</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.get_feature_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_feature_metadata</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Extract feature names and importances from pipeline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pipeline</code>
            </td>
            <td>
                  <code><span title="sklearn.pipeline.Pipeline">Pipeline</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sklearn pipeline containing feature transformer and classifier</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="patientflow.train.classifiers.FeatureMetadata">FeatureMetadata</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing feature names and their importance scores (if available)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#AttributeError">AttributeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the classifier doesn't support feature importance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_feature_metadata</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureMetadata</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract feature names and importances from pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline : Pipeline</span>
<span class="sd">        Sklearn pipeline containing feature transformer and classifier</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FeatureMetadata</span>
<span class="sd">        Dictionary containing feature names and their importance scores (if available)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AttributeError</span>
<span class="sd">        If the classifier doesn&#39;t support feature importance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformed_cols</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
        <span class="s2">&quot;feature_transformer&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span>

    <span class="c1"># Try different common feature importance attributes</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;feature_importances_&quot;</span><span class="p">):</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;coef_&quot;</span><span class="p">):</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Classifier doesn&#39;t provide feature importance scores&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;feature_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">transformed_cols</span><span class="p">],</span>
        <span class="s2">&quot;feature_importances&quot;</span><span class="p">:</span> <span class="n">importances</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.initialise_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialise_model</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xgb_specific_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="s1">&#39;enable_categorical&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize a model with given hyperparameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_class</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Type" href="https://docs.python.org/3/library/typing.html#typing.Type">Type</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The classifier class to instantiate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model-specific parameters to set</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>xgb_specific_params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>XGBoost-specific default parameters</p>
              </div>
            </td>
            <td>
                  <code>{&#39;n_jobs&#39;: -1, &#39;eval_metric&#39;: &#39;logloss&#39;, &#39;enable_categorical&#39;: True}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialized model instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialise_model</span><span class="p">(</span>
    <span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">xgb_specific_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n_jobs&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="s2">&quot;logloss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enable_categorical&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a model with given hyperparameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_class : Type</span>
<span class="sd">        The classifier class to instantiate</span>
<span class="sd">    params : Dict[str, Any]</span>
<span class="sd">        Model-specific parameters to set</span>
<span class="sd">    xgb_specific_params : Dict[str, Any], optional</span>
<span class="sd">        XGBoost-specific default parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        Initialized model instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_class</span> <span class="o">==</span> <span class="n">XGBClassifier</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">xgb_specific_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.train_classifier" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_classifier</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">valid_visits</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">,</span> <span class="n">test_visits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="n">XGBClassifier</span><span class="p">,</span> <span class="n">use_balanced_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">calibrate_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calibration_method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">,</span> <span class="n">evaluate_on_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train a single model including data preparation and balancing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training visits dataset</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>valid_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation visits dataset</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prediction time point to use</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to exclude from training</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grid</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameter grid for hyperparameter tuning</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ordinal_mappings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mappings for ordinal categorical features</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test visits dataset. Required only when evaluate_on_test=True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the visit column. Required if single_snapshot_per_visit is True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_class</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Type" href="https://docs.python.org/3/library/typing.html#typing.Type">Type</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The classifier class to use. Must be sklearn-compatible with fit() and predict_proba().
Defaults to XGBClassifier.</p>
              </div>
            </td>
            <td>
                  <code><span title="xgboost.XGBClassifier">XGBClassifier</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_balanced_training</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use balanced training data</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>majority_to_minority_ratio</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ratio of majority to minority class samples</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calibrate_probabilities</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply probability calibration to the best model</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calibration_method</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method for probability calibration ('isotonic' or 'sigmoid')</p>
              </div>
            </td>
            <td>
                  <code>&#39;sigmoid&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>single_snapshot_per_visit</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to select only one snapshot per visit. If True, visit_col must be provided.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels</p>
              </div>
            </td>
            <td>
                  <code>&#34;is_admitted&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>evaluate_on_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to evaluate the final model on the test set. Set to True only when
satisfied with validation performance to avoid test set contamination.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained model, including metrics, and feature information</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_classifier</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">valid_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">exclude_from_training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">ordinal_mappings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">,</span>
    <span class="n">use_balanced_training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">majority_to_minority_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">calibrate_probabilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">calibration_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">single_snapshot_per_visit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
    <span class="n">evaluate_on_test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainedClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a single model including data preparation and balancing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_visits : DataFrame</span>
<span class="sd">        Training visits dataset</span>
<span class="sd">    valid_visits : DataFrame</span>
<span class="sd">        Validation visits dataset</span>
<span class="sd">    prediction_time : Tuple[int, int]</span>
<span class="sd">        The prediction time point to use</span>
<span class="sd">    exclude_from_training_data : List[str]</span>
<span class="sd">        Columns to exclude from training</span>
<span class="sd">    grid : Dict[str, List[Any]]</span>
<span class="sd">        Parameter grid for hyperparameter tuning</span>
<span class="sd">    ordinal_mappings : Dict[str, List[Any]]</span>
<span class="sd">        Mappings for ordinal categorical features</span>
<span class="sd">    test_visits : DataFrame, optional</span>
<span class="sd">        Test visits dataset. Required only when evaluate_on_test=True.</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of the visit column. Required if single_snapshot_per_visit is True.</span>
<span class="sd">    model_class : Type, optional</span>
<span class="sd">        The classifier class to use. Must be sklearn-compatible with fit() and predict_proba().</span>
<span class="sd">        Defaults to XGBClassifier.</span>
<span class="sd">    use_balanced_training : bool, default=True</span>
<span class="sd">        Whether to use balanced training data</span>
<span class="sd">    majority_to_minority_ratio : float, default=1.0</span>
<span class="sd">        Ratio of majority to minority class samples</span>
<span class="sd">    calibrate_probabilities : bool, default=True</span>
<span class="sd">        Whether to apply probability calibration to the best model</span>
<span class="sd">    calibration_method : str, default=&#39;sigmoid&#39;</span>
<span class="sd">        Method for probability calibration (&#39;isotonic&#39; or &#39;sigmoid&#39;)</span>
<span class="sd">    single_snapshot_per_visit : bool, default=True</span>
<span class="sd">        Whether to select only one snapshot per visit. If True, visit_col must be provided.</span>
<span class="sd">    label_col : str, default=&quot;is_admitted&quot;</span>
<span class="sd">        Name of the column containing the target labels</span>
<span class="sd">    evaluate_on_test : bool, default=False</span>
<span class="sd">        Whether to evaluate the final model on the test set. Set to True only when</span>
<span class="sd">        satisfied with validation performance to avoid test set contamination.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TrainedClassifier</span>
<span class="sd">        Trained model, including metrics, and feature information</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">single_snapshot_per_visit</span> <span class="ow">and</span> <span class="n">visit_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;visit_col must be provided when single_snapshot_per_visit is True&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">evaluate_on_test</span> <span class="ow">and</span> <span class="n">test_visits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test_visits must be provided when evaluate_on_test=True&quot;</span><span class="p">)</span>

    <span class="c1"># Get snapshots for each set</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
        <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="n">single_snapshot_per_visit</span><span class="p">,</span>
        <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
        <span class="n">valid_visits</span><span class="p">,</span>
        <span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
        <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="n">single_snapshot_per_visit</span><span class="p">,</span>
        <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Only prepare test data if evaluation is requested</span>
    <span class="k">if</span> <span class="n">evaluate_on_test</span><span class="p">:</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
            <span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
            <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="n">single_snapshot_per_visit</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Get dataset metadata before any balancing</span>
    <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="n">get_dataset_metadata</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span>
    <span class="p">)</span>

    <span class="c1"># Store original size and positive rate before any balancing</span>
    <span class="n">original_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">original_positive_rate</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">use_balanced_training</span><span class="p">:</span>
        <span class="n">pos_indices</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">neg_indices</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">n_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_indices</span><span class="p">)</span>
        <span class="n">n_neg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_pos</span> <span class="o">*</span> <span class="n">majority_to_minority_ratio</span><span class="p">)</span>

        <span class="n">neg_indices_sampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">neg_indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">n_neg</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_indices</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">train_balanced_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos_indices</span><span class="p">,</span> <span class="n">neg_indices_sampled</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">train_balanced_indices</span><span class="p">)</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_balanced_indices</span><span class="p">]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_balanced_indices</span><span class="p">]</span>

    <span class="c1"># Create balance info after any balancing is done</span>
    <span class="n">balance_info</span> <span class="o">=</span> <span class="n">create_balance_info</span><span class="p">(</span>
        <span class="n">is_balanced</span><span class="o">=</span><span class="n">use_balanced_training</span><span class="p">,</span>
        <span class="n">original_size</span><span class="o">=</span><span class="n">original_size</span><span class="p">,</span>
        <span class="n">balanced_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
        <span class="n">original_positive_rate</span><span class="o">=</span><span class="n">original_positive_rate</span><span class="p">,</span>
        <span class="n">balanced_positive_rate</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="n">majority_to_minority_ratio</span>
        <span class="k">if</span> <span class="n">use_balanced_training</span>
        <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Initialize best training results with default values</span>
    <span class="n">best_training</span> <span class="o">=</span> <span class="n">TrainingResults</span><span class="p">(</span>
        <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
        <span class="n">balance_info</span><span class="o">=</span><span class="n">balance_info</span><span class="p">,</span>
        <span class="c1"># Other fields will use their default empty dictionaries</span>
    <span class="p">)</span>

    <span class="c1"># Initialize best model container</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">TrainedClassifier</span><span class="p">(</span>
        <span class="n">training_results</span><span class="o">=</span><span class="n">best_training</span><span class="p">,</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">calibrated_pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">trials_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">HyperParameterTrial</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_logloss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">ParameterGrid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="c1"># Initialize model based on provided class</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">initialise_model</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">column_transformer</span> <span class="o">=</span> <span class="n">create_column_transformer</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">)</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
            <span class="p">[(</span><span class="s2">&quot;feature_transformer&quot;</span><span class="p">,</span> <span class="n">column_transformer</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">cv_results</span> <span class="o">=</span> <span class="n">chronological_cross_validation</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="c1"># Store trial results</span>
        <span class="n">trials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">HyperParameterTrial</span><span class="p">(</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Make a copy to ensure immutability</span>
                <span class="n">cv_results</span><span class="o">=</span><span class="n">cv_results</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cv_results</span><span class="p">[</span><span class="s2">&quot;valid_logloss&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_logloss</span><span class="p">:</span>
            <span class="n">best_logloss</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s2">&quot;valid_logloss&quot;</span><span class="p">]</span>
            <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>

            <span class="c1"># Get feature metadata if available</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">feature_metadata</span> <span class="o">=</span> <span class="n">get_feature_metadata</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
                <span class="n">has_feature_importance</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
                <span class="n">feature_metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;feature_names&quot;</span><span class="p">:</span> <span class="n">column_transformer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;feature_importances&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
                <span class="n">has_feature_importance</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Update training results</span>
            <span class="n">best_training</span><span class="o">.</span><span class="n">training_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv_trials&quot;</span><span class="p">:</span> <span class="n">trials_list</span><span class="p">,</span>
                <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">feature_metadata</span><span class="p">[</span><span class="s2">&quot;feature_names&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;importances&quot;</span><span class="p">:</span> <span class="n">feature_metadata</span><span class="p">[</span><span class="s2">&quot;feature_importances&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;has_importance_values&quot;</span><span class="p">:</span> <span class="n">has_feature_importance</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;dataset_info&quot;</span><span class="p">:</span> <span class="n">dataset_metadata</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">calibrate_probabilities</span><span class="p">:</span>
                <span class="n">best_training</span><span class="o">.</span><span class="n">calibration_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">calibration_method</span><span class="p">}</span>

    <span class="c1"># Apply probability calibration to the best model if requested</span>
    <span class="k">if</span> <span class="n">calibrate_probabilities</span> <span class="ow">and</span> <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">best_feature_transformer</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
            <span class="s2">&quot;feature_transformer&quot;</span>
        <span class="p">]</span>
        <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span>

        <span class="n">X_valid_transformed</span> <span class="o">=</span> <span class="n">best_feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sk_version</span> <span class="o">&gt;=</span> <span class="s2">&quot;1.6.0&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.frozen</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrozenEstimator</span>

            <span class="n">calibrated_classifier</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
                <span class="n">estimator</span><span class="o">=</span><span class="n">FrozenEstimator</span><span class="p">(</span><span class="n">best_classifier</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="n">calibration_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calibrated_classifier</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
                <span class="n">estimator</span><span class="o">=</span><span class="n">best_classifier</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">calibration_method</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span>
            <span class="p">)</span>
        <span class="n">calibrated_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_valid_transformed</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>

        <span class="n">calibrated_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;feature_transformer&quot;</span><span class="p">,</span> <span class="n">best_feature_transformer</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">calibrated_classifier</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">best_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="o">=</span> <span class="n">calibrated_pipeline</span>

        <span class="c1"># Only evaluate on test set if requested</span>
        <span class="k">if</span> <span class="n">evaluate_on_test</span><span class="p">:</span>
            <span class="n">best_training</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span>
                <span class="n">calibrated_pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_training</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Only evaluate on test set if requested</span>
        <span class="k">if</span> <span class="n">evaluate_on_test</span><span class="p">:</span>
            <span class="n">best_training</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span>
                <span class="n">best_model</span><span class="o">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_training</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">best_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.classifiers.train_multiple_classifiers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_multiple_classifiers</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">valid_visits</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">test_visits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;visit_number&#39;</span><span class="p">,</span> <span class="n">calibrate_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calibration_method</span><span class="o">=</span><span class="s1">&#39;isotonic&#39;</span><span class="p">,</span> <span class="n">use_balanced_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">,</span> <span class="n">evaluate_on_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train admission prediction models for multiple prediction times.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training visits dataset</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>valid_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation visits dataset</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grid</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameter grid for hyperparameter tuning</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to exclude from training</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ordinal_mappings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mappings for ordinal categorical features</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of prediction time points</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Test visits dataset, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name prefix for models, by default "admissions"</p>
              </div>
            </td>
            <td>
                  <code>&#39;admissions&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the visit column, by default "visit_number"</p>
              </div>
            </td>
            <td>
                  <code>&#39;visit_number&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calibrate_probabilities</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to calibrate probabilities, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calibration_method</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibration method, by default "isotonic"</p>
              </div>
            </td>
            <td>
                  <code>&#39;isotonic&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_balanced_training</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use balanced training, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>majority_to_minority_ratio</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ratio for class balancing, by default 1.0</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the label column, by default "is_admitted"</p>
              </div>
            </td>
            <td>
                  <code>&#39;is_admitted&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>evaluate_on_test</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to evaluate on test set, by default False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping model keys to trained classifiers</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/classifiers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_multiple_classifiers</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">valid_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">exclude_from_training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">ordinal_mappings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
    <span class="n">calibrate_probabilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">calibration_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;isotonic&quot;</span><span class="p">,</span>
    <span class="n">use_balanced_training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">majority_to_minority_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
    <span class="n">evaluate_on_test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train admission prediction models for multiple prediction times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_visits : DataFrame</span>
<span class="sd">        Training visits dataset</span>
<span class="sd">    valid_visits : DataFrame</span>
<span class="sd">        Validation visits dataset</span>
<span class="sd">    grid : Dict[str, List[Any]]</span>
<span class="sd">        Parameter grid for hyperparameter tuning</span>
<span class="sd">    exclude_from_training_data : List[str]</span>
<span class="sd">        Columns to exclude from training</span>
<span class="sd">    ordinal_mappings : Dict[str, List[Any]]</span>
<span class="sd">        Mappings for ordinal categorical features</span>
<span class="sd">    prediction_times : List[Tuple[int, int]]</span>
<span class="sd">        List of prediction time points</span>
<span class="sd">    test_visits : DataFrame, optional</span>
<span class="sd">        Test visits dataset, by default None</span>
<span class="sd">    model_name : str, optional</span>
<span class="sd">        Name prefix for models, by default &quot;admissions&quot;</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of the visit column, by default &quot;visit_number&quot;</span>
<span class="sd">    calibrate_probabilities : bool, optional</span>
<span class="sd">        Whether to calibrate probabilities, by default True</span>
<span class="sd">    calibration_method : str, optional</span>
<span class="sd">        Calibration method, by default &quot;isotonic&quot;</span>
<span class="sd">    use_balanced_training : bool, optional</span>
<span class="sd">        Whether to use balanced training, by default True</span>
<span class="sd">    majority_to_minority_ratio : float, optional</span>
<span class="sd">        Ratio for class balancing, by default 1.0</span>
<span class="sd">    label_col : str, optional</span>
<span class="sd">        Name of the label column, by default &quot;is_admitted&quot;</span>
<span class="sd">    evaluate_on_test : bool, optional</span>
<span class="sd">        Whether to evaluate on test set, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, TrainedClassifier]</span>
<span class="sd">        Dictionary mapping model keys to trained classifiers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">evaluate_on_test</span> <span class="ow">and</span> <span class="n">test_visits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test_visits must be provided when evaluate_on_test=True&quot;</span><span class="p">)</span>

    <span class="n">trained_models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">prediction_time</span> <span class="ow">in</span> <span class="n">prediction_times</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing: </span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>

        <span class="c1"># Train model with the new simplified interface</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
            <span class="n">train_visits</span><span class="p">,</span>
            <span class="n">valid_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">grid</span><span class="p">,</span>
            <span class="n">ordinal_mappings</span><span class="p">,</span>
            <span class="n">test_visits</span><span class="p">,</span>
            <span class="n">visit_col</span><span class="p">,</span>
            <span class="n">use_balanced_training</span><span class="o">=</span><span class="n">use_balanced_training</span><span class="p">,</span>
            <span class="n">majority_to_minority_ratio</span><span class="o">=</span><span class="n">majority_to_minority_ratio</span><span class="p">,</span>
            <span class="n">calibrate_probabilities</span><span class="o">=</span><span class="n">calibrate_probabilities</span><span class="p">,</span>
            <span class="n">calibration_method</span><span class="o">=</span><span class="n">calibration_method</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
            <span class="n">evaluate_on_test</span><span class="o">=</span><span class="n">evaluate_on_test</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">trained_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_model</span>

    <span class="k">return</span> <span class="n">trained_models</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.emergency_demand" class="doc doc-heading">
            <code>emergency_demand</code>


</h3>

    <div class="doc doc-contents ">

        <p>Emergency demand prediction training module.</p>
<p>This module provides functionality that is specific to the implementation of the
patientflow package at University College London Hospital (ULCH). It trains models
to predict emergency bed demand.</p>
<p>The module trains three model types:
1. Admission prediction models (multiple classifiers, one for each prediction time)
2. Specialty prediction models (sequence-based)
3. Yet-to-arrive prediction models (aspirational)</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.train.emergency_demand.test_real_time_predictions : Test real-time prediction functionality">test_real_time_predictions : Test real-time prediction functionality</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Selects random test cases and validates that the trained models can
generate predictions as if it where making a real-time prediction.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.train.emergency_demand.train_all_models : Complete training pipeline">train_all_models : Complete training pipeline</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Trains all three model types (admissions, specialty, yet-to-arrive)
with proper validation and optional model saving.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.train.emergency_demand.main : Entry point for training pipeline">main : Entry point for training pipeline</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Loads configuration, data, and runs the complete training process.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.emergency_demand.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">data_folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main entry point for training patient flow models.</p>
<p>This function orchestrates the complete training pipeline for emergency demand
prediction models. It loads configuration, data, and trains all three model
types: admission prediction models, specialty prediction models, and
yet-to-arrive prediction models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_folder_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the data folder containing the training datasets.
If None, will be extracted from command line arguments.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function trains and optionally saves models but does not return
any values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function performs the following steps:
1. Loads configuration from config.yaml
2. Loads ED visits and inpatient arrivals data
3. Sets up model parameters and hyperparameters
4. Trains admission prediction classifiers
5. Trains specialty prediction sequence model
6. Trains yet-to-arrive prediction model
7. Optionally saves trained models
8. Optionally tests real-time prediction functionality</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">data_folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point for training patient flow models.</span>

<span class="sd">    This function orchestrates the complete training pipeline for emergency demand</span>
<span class="sd">    prediction models. It loads configuration, data, and trains all three model</span>
<span class="sd">    types: admission prediction models, specialty prediction models, and</span>
<span class="sd">    yet-to-arrive prediction models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_folder_name : str, optional</span>
<span class="sd">        Name of the data folder containing the training datasets.</span>
<span class="sd">        If None, will be extracted from command line arguments.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        The function trains and optionally saves models but does not return</span>
<span class="sd">        any values.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function performs the following steps:</span>
<span class="sd">    1. Loads configuration from config.yaml</span>
<span class="sd">    2. Loads ED visits and inpatient arrivals data</span>
<span class="sd">    3. Sets up model parameters and hyperparameters</span>
<span class="sd">    4. Trains admission prediction classifiers</span>
<span class="sd">    5. Trains specialty prediction sequence model</span>
<span class="sd">    6. Trains yet-to-arrive prediction model</span>
<span class="sd">    7. Optionally saves trained models</span>
<span class="sd">    8. Optionally tests real-time prediction functionality</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse arguments if not provided</span>
    <span class="k">if</span> <span class="n">data_folder_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
        <span class="n">data_folder_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data_folder_name</span> <span class="k">if</span> <span class="n">data_folder_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">data_folder_name</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data from folder: </span><span class="si">{</span><span class="n">data_folder_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">project_root</span> <span class="o">=</span> <span class="n">set_project_root</span><span class="p">()</span>

    <span class="c1"># Set file locations</span>
    <span class="n">data_file_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">,</span> <span class="n">config_path</span> <span class="o">=</span> <span class="n">set_file_paths</span><span class="p">(</span>
        <span class="n">project_root</span><span class="o">=</span><span class="n">project_root</span><span class="p">,</span>
        <span class="n">inference_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">train_dttm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_folder_name</span><span class="o">=</span><span class="n">data_folder_name</span><span class="p">,</span>
        <span class="n">config_file</span><span class="o">=</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Load parameters</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config_file</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

    <span class="c1"># Extract parameters</span>
    <span class="n">prediction_times</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_times&quot;</span><span class="p">]</span>
    <span class="n">start_training_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;start_training_set&quot;</span><span class="p">]</span>
    <span class="n">start_validation_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;start_validation_set&quot;</span><span class="p">]</span>
    <span class="n">start_test_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;start_test_set&quot;</span><span class="p">]</span>
    <span class="n">end_test_set</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;end_test_set&quot;</span><span class="p">]</span>
    <span class="n">prediction_window</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_window&quot;</span><span class="p">])</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">])</span>
    <span class="n">yta_time_interval</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;yta_time_interval&quot;</span><span class="p">])</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span>

    <span class="c1"># Load data</span>
    <span class="n">ed_visits</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
        <span class="n">data_file_path</span><span class="o">=</span><span class="n">data_file_path</span><span class="p">,</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;ed_visits.csv&quot;</span><span class="p">,</span>
        <span class="n">index_column</span><span class="o">=</span><span class="s2">&quot;snapshot_id&quot;</span><span class="p">,</span>
        <span class="n">sort_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span> <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_time&quot;</span><span class="p">],</span>
        <span class="n">eval_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;final_sequence&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">inpatient_arrivals</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
        <span class="n">data_file_path</span><span class="o">=</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;inpatient_arrivals.csv&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create snapshot date</span>
    <span class="n">ed_visits</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
        <span class="n">ed_visits</span><span class="p">[</span><span class="s2">&quot;snapshot_date&quot;</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Set up model parameters</span>
    <span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="s2">&quot;subsample&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">],</span> <span class="s2">&quot;colsample_bytree&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">]}</span>

    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;snapshot_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;specialty&quot;</span><span class="p">,</span>
        <span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_sequence&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">ordinal_mappings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;0-17&quot;</span><span class="p">,</span>
            <span class="s2">&quot;18-24&quot;</span><span class="p">,</span>
            <span class="s2">&quot;25-34&quot;</span><span class="p">,</span>
            <span class="s2">&quot;35-44&quot;</span><span class="p">,</span>
            <span class="s2">&quot;45-54&quot;</span><span class="p">,</span>
            <span class="s2">&quot;55-64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;65-74&quot;</span><span class="p">,</span>
            <span class="s2">&quot;75-115&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latest_acvpu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">],</span>
        <span class="s2">&quot;latest_obs_manchester_triage_acuity&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Yellow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Orange&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Red&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latest_obs_objective_pain_score&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Nil&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Mild&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Moderate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Severe</span><span class="se">\\</span><span class="s2">E</span><span class="se">\\</span><span class="s2">Very Severe&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latest_obs_level_of_consciousness&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">specialties</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;surgical&quot;</span><span class="p">,</span> <span class="s2">&quot;haem/onc&quot;</span><span class="p">,</span> <span class="s2">&quot;medical&quot;</span><span class="p">,</span> <span class="s2">&quot;paediatric&quot;</span><span class="p">]</span>
    <span class="n">cdf_cut_points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
    <span class="n">curve_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="c1"># Call train_all_models with prepared parameters</span>
    <span class="n">train_all_models</span><span class="p">(</span>
        <span class="n">visits</span><span class="o">=</span><span class="n">ed_visits</span><span class="p">,</span>
        <span class="n">start_training_set</span><span class="o">=</span><span class="n">start_training_set</span><span class="p">,</span>
        <span class="n">start_validation_set</span><span class="o">=</span><span class="n">start_validation_set</span><span class="p">,</span>
        <span class="n">start_test_set</span><span class="o">=</span><span class="n">start_test_set</span><span class="p">,</span>
        <span class="n">end_test_set</span><span class="o">=</span><span class="n">end_test_set</span><span class="p">,</span>
        <span class="n">yta</span><span class="o">=</span><span class="n">inpatient_arrivals</span><span class="p">,</span>
        <span class="n">model_file_path</span><span class="o">=</span><span class="n">model_file_path</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">curve_params</span><span class="o">=</span><span class="n">curve_params</span><span class="p">,</span>
        <span class="n">grid_params</span><span class="o">=</span><span class="n">grid_params</span><span class="p">,</span>
        <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span>
        <span class="n">ordinal_mappings</span><span class="o">=</span><span class="n">ordinal_mappings</span><span class="p">,</span>
        <span class="n">specialties</span><span class="o">=</span><span class="n">specialties</span><span class="p">,</span>
        <span class="n">cdf_cut_points</span><span class="o">=</span><span class="n">cdf_cut_points</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.emergency_demand.test_real_time_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">test_real_time_predictions</span><span class="p">(</span><span class="n">visits</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">specialties</span><span class="p">,</span> <span class="n">cdf_cut_points</span><span class="p">,</span> <span class="n">curve_params</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Test real-time predictions by selecting a random sample from the visits dataset
and generating predictions using the trained models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing visit data with columns including 'prediction_time',
'snapshot_date', and other required features for predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>], <a class="autorefs autorefs-internal" title="SequenceToOutcomePredictor (patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor)" href="#patientflow.predictors.sequence_to_outcome_predictor.SequenceToOutcomePredictor">SequenceToOutcomePredictor</a>, <a class="autorefs autorefs-internal" title="ParametricIncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor">ParametricIncomingAdmissionPredictor</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing:
- trained_classifiers: TrainedClassifier containing admission predictions
- spec_model: SequenceToOutcomePredictor for specialty predictions
- yet_to_arrive_model: ParametricIncomingAdmissionPredictor for yet-to-arrive predictions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the prediction window in minutes for which to generate forecasts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>specialties</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of specialty names to generate predictions for (e.g., ['surgical',
'medical', 'paediatric']).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cdf_cut_points</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of probability thresholds for cumulative distribution function
cut points (e.g., [0.9, 0.7]).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>curve_params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters (x1, y1, x2, y2) defining the curve used for predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducible sampling of test cases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
- 'prediction_time': str, The time point for which predictions were made
- 'prediction_date': str, The date for which predictions were made
- 'realtime_preds': dict, The generated predictions for the sample</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#Exception">Exception</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If real-time inference fails, with detailed error message printed before
system exit.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function selects a single random row from the visits DataFrame and
generates predictions for that specific time point using all provided models.
The predictions are made using the create_predictions() function with the
specified parameters.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_real_time_predictions</span><span class="p">(</span>
    <span class="n">visits</span><span class="p">,</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
        <span class="n">SequenceToOutcomePredictor</span><span class="p">,</span>
        <span class="n">ParametricIncomingAdmissionPredictor</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">prediction_window</span><span class="p">,</span>
    <span class="n">specialties</span><span class="p">,</span>
    <span class="n">cdf_cut_points</span><span class="p">,</span>
    <span class="n">curve_params</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test real-time predictions by selecting a random sample from the visits dataset</span>
<span class="sd">    and generating predictions using the trained models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    visits : pd.DataFrame</span>
<span class="sd">        DataFrame containing visit data with columns including &#39;prediction_time&#39;,</span>
<span class="sd">        &#39;snapshot_date&#39;, and other required features for predictions.</span>
<span class="sd">    models : Tuple[Dict[str, TrainedClassifier], SequenceToOutcomePredictor, ParametricIncomingAdmissionPredictor]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - trained_classifiers: TrainedClassifier containing admission predictions</span>
<span class="sd">        - spec_model: SequenceToOutcomePredictor for specialty predictions</span>
<span class="sd">        - yet_to_arrive_model: ParametricIncomingAdmissionPredictor for yet-to-arrive predictions</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Size of the prediction window in minutes for which to generate forecasts.</span>
<span class="sd">    specialties : list[str]</span>
<span class="sd">        List of specialty names to generate predictions for (e.g., [&#39;surgical&#39;,</span>
<span class="sd">        &#39;medical&#39;, &#39;paediatric&#39;]).</span>
<span class="sd">    cdf_cut_points : list[float]</span>
<span class="sd">        List of probability thresholds for cumulative distribution function</span>
<span class="sd">        cut points (e.g., [0.9, 0.7]).</span>
<span class="sd">    curve_params : tuple[float, float, float, float]</span>
<span class="sd">        Parameters (x1, y1, x2, y2) defining the curve used for predictions.</span>
<span class="sd">    random_seed : int</span>
<span class="sd">        Random seed for reproducible sampling of test cases.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">        - &#39;prediction_time&#39;: str, The time point for which predictions were made</span>
<span class="sd">        - &#39;prediction_date&#39;: str, The date for which predictions were made</span>
<span class="sd">        - &#39;realtime_preds&#39;: dict, The generated predictions for the sample</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If real-time inference fails, with detailed error message printed before</span>
<span class="sd">        system exit.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function selects a single random row from the visits DataFrame and</span>
<span class="sd">    generates predictions for that specific time point using all provided models.</span>
<span class="sd">    The predictions are made using the create_predictions() function with the</span>
<span class="sd">    specified parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select random test set row</span>
    <span class="n">random_row</span> <span class="o">=</span> <span class="n">visits</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">random_row</span><span class="o">.</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">prediction_date</span> <span class="o">=</span> <span class="n">random_row</span><span class="o">.</span><span class="n">snapshot_date</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get prediction snapshots</span>
    <span class="n">prediction_snapshots</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span>
        <span class="p">(</span><span class="n">visits</span><span class="o">.</span><span class="n">prediction_time</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">visits</span><span class="o">.</span><span class="n">snapshot_date</span> <span class="o">==</span> <span class="n">prediction_date</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">trained_classifiers</span><span class="p">,</span> <span class="n">spec_model</span><span class="p">,</span> <span class="n">yet_to_arrive_model</span> <span class="o">=</span> <span class="n">models</span>

    <span class="c1"># Find the model matching the required prediction time</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="n">trained_classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span> <span class="o">==</span> <span class="n">prediction_time</span><span class="p">:</span>
            <span class="n">classifier</span> <span class="o">=</span> <span class="n">trained_model</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">classifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model found for prediction time </span><span class="si">{</span><span class="n">prediction_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">curve_params</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">create_predictions</span><span class="p">(</span>
            <span class="n">models</span><span class="o">=</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">spec_model</span><span class="p">,</span> <span class="n">yet_to_arrive_model</span><span class="p">),</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">prediction_snapshots</span><span class="o">=</span><span class="n">prediction_snapshots</span><span class="p">,</span>
            <span class="n">specialties</span><span class="o">=</span><span class="n">specialties</span><span class="p">,</span>
            <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">cdf_cut_points</span><span class="o">=</span><span class="n">cdf_cut_points</span><span class="p">,</span>
            <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span>
            <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
            <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span>
            <span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real-time inference ran correctly&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real-time inference failed due to this error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.emergency_demand.train_all_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_all_models</span><span class="p">(</span><span class="n">visits</span><span class="p">,</span> <span class="n">start_training_set</span><span class="p">,</span> <span class="n">start_validation_set</span><span class="p">,</span> <span class="n">start_test_set</span><span class="p">,</span> <span class="n">end_test_set</span><span class="p">,</span> <span class="n">yta</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="p">,</span> <span class="n">ordinal_mappings</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">,</span> <span class="n">visit_col</span><span class="o">=</span><span class="s1">&#39;visit_number&#39;</span><span class="p">,</span> <span class="n">specialties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cdf_cut_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_models</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_realtime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train and evaluate patient flow models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing visit data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing yet-to-arrive data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of times for making predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window size in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval size for yet-to-arrive predictions in minutes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Epsilon parameter for model training.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grid_params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hyperparameter grid for model training.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_columns</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to exclude during training.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ordinal_mappings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ordinal variable mappings for categorical features.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducibility.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of column in dataset that is used to identify a hospital visit (eg visit_number, csn).</p>
              </div>
            </td>
            <td>
                  <code>&#39;visit_number&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>specialties</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of specialties to consider. Required if test_realtime is True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cdf_cut_points</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CDF cut points for predictions. Required if test_realtime is True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>curve_params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Curve parameters (x1, y1, x2, y2). Required if test_realtime is True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save trained models. Required if save_models is True.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to save the trained models to disk. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_realtime</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to run real-time prediction tests. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If save_models is True but model_file_path is not provided,
or if test_realtime is True but any of specialties, cdf_cut_points, or curve_params are not provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function generates model names internally:
- "admissions": "admissions"
- "specialty": "ed_specialty"
- "yet_to_arrive": f"yet_to_arrive_{int(prediction_window.total_seconds()/3600)}_hours"</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/emergency_demand.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_all_models</span><span class="p">(</span>
    <span class="n">visits</span><span class="p">,</span>
    <span class="n">start_training_set</span><span class="p">,</span>
    <span class="n">start_validation_set</span><span class="p">,</span>
    <span class="n">start_test_set</span><span class="p">,</span>
    <span class="n">end_test_set</span><span class="p">,</span>
    <span class="n">yta</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">,</span>
    <span class="n">grid_params</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="p">,</span>
    <span class="n">ordinal_mappings</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="o">=</span><span class="s2">&quot;visit_number&quot;</span><span class="p">,</span>
    <span class="n">specialties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cdf_cut_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_models</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">test_realtime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train and evaluate patient flow models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    visits : pd.DataFrame</span>
<span class="sd">        DataFrame containing visit data.</span>
<span class="sd">    yta : pd.DataFrame</span>
<span class="sd">        DataFrame containing yet-to-arrive data.</span>
<span class="sd">    prediction_times : list</span>
<span class="sd">        List of times for making predictions.</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Prediction window size in minutes.</span>
<span class="sd">    yta_time_interval : int</span>
<span class="sd">        Interval size for yet-to-arrive predictions in minutes.</span>
<span class="sd">    epsilon : float</span>
<span class="sd">        Epsilon parameter for model training.</span>
<span class="sd">    grid_params : dict</span>
<span class="sd">        Hyperparameter grid for model training.</span>
<span class="sd">    exclude_columns : list</span>
<span class="sd">        Columns to exclude during training.</span>
<span class="sd">    ordinal_mappings : dict</span>
<span class="sd">        Ordinal variable mappings for categorical features.</span>
<span class="sd">    random_seed : int</span>
<span class="sd">        Random seed for reproducibility.</span>
<span class="sd">    visit_col : str, optional</span>
<span class="sd">        Name of column in dataset that is used to identify a hospital visit (eg visit_number, csn).</span>
<span class="sd">    specialties : list, optional</span>
<span class="sd">        List of specialties to consider. Required if test_realtime is True.</span>
<span class="sd">    cdf_cut_points : list, optional</span>
<span class="sd">        CDF cut points for predictions. Required if test_realtime is True.</span>
<span class="sd">    curve_params : tuple, optional</span>
<span class="sd">        Curve parameters (x1, y1, x2, y2). Required if test_realtime is True.</span>
<span class="sd">    model_file_path : Path, optional</span>
<span class="sd">        Path to save trained models. Required if save_models is True.</span>
<span class="sd">    save_models : bool, optional</span>
<span class="sd">        Whether to save the trained models to disk. Defaults to True.</span>
<span class="sd">    test_realtime : bool, optional</span>
<span class="sd">        Whether to run real-time prediction tests. Defaults to True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If save_models is True but model_file_path is not provided,</span>
<span class="sd">        or if test_realtime is True but any of specialties, cdf_cut_points, or curve_params are not provided.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function generates model names internally:</span>
<span class="sd">    - &quot;admissions&quot;: &quot;admissions&quot;</span>
<span class="sd">    - &quot;specialty&quot;: &quot;ed_specialty&quot;</span>
<span class="sd">    - &quot;yet_to_arrive&quot;: f&quot;yet_to_arrive_{int(prediction_window.total_seconds()/3600)}_hours&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate parameters</span>
    <span class="k">if</span> <span class="n">save_models</span> <span class="ow">and</span> <span class="n">model_file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model_file_path must be provided when save_models is True&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_realtime</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">specialties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;specialties must be provided when test_realtime is True&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdf_cut_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;cdf_cut_points must be provided when test_realtime is True&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">curve_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;curve_params must be provided when test_realtime is True&quot;</span><span class="p">)</span>

    <span class="c1"># Set random seed</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="c1"># Define model names internally</span>
    <span class="n">model_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;admissions&quot;</span><span class="p">:</span> <span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="s2">&quot;ed_specialty&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;yet_to_arrive_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span><span class="si">}</span><span class="s2">_hours&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;arrival_datetime&quot;</span> <span class="ow">in</span> <span class="n">visits</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="s2">&quot;arrival_datetime&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="s2">&quot;snapshot_date&quot;</span>

    <span class="n">train_visits</span><span class="p">,</span> <span class="n">valid_visits</span><span class="p">,</span> <span class="n">test_visits</span> <span class="o">=</span> <span class="n">create_temporal_splits</span><span class="p">(</span>
        <span class="n">visits</span><span class="p">,</span>
        <span class="n">start_training_set</span><span class="p">,</span>
        <span class="n">start_validation_set</span><span class="p">,</span>
        <span class="n">start_test_set</span><span class="p">,</span>
        <span class="n">end_test_set</span><span class="p">,</span>
        <span class="n">col_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">train_yta</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_temporal_splits</span><span class="p">(</span>
        <span class="n">yta</span><span class="p">[(</span><span class="o">~</span><span class="n">yta</span><span class="o">.</span><span class="n">specialty</span><span class="o">.</span><span class="n">isnull</span><span class="p">())],</span>
        <span class="n">start_training_set</span><span class="p">,</span>
        <span class="n">start_validation_set</span><span class="p">,</span>
        <span class="n">start_test_set</span><span class="p">,</span>
        <span class="n">end_test_set</span><span class="p">,</span>
        <span class="n">col_name</span><span class="o">=</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Use predicted_times from visits if not explicitly provided</span>
    <span class="k">if</span> <span class="n">prediction_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prediction_times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">visits</span><span class="o">.</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="c1"># Train admission models</span>
    <span class="n">admission_models</span> <span class="o">=</span> <span class="n">train_multiple_classifiers</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="o">=</span><span class="n">train_visits</span><span class="p">,</span>
        <span class="n">valid_visits</span><span class="o">=</span><span class="n">valid_visits</span><span class="p">,</span>
        <span class="n">test_visits</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="n">grid_params</span><span class="p">,</span>
        <span class="n">exclude_from_training_data</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span>
        <span class="n">ordinal_mappings</span><span class="o">=</span><span class="n">ordinal_mappings</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;admissions&quot;</span><span class="p">],</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save admission models if requested</span>

    <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
        <span class="n">save_model</span><span class="p">(</span><span class="n">admission_models</span><span class="p">,</span> <span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;admissions&quot;</span><span class="p">],</span> <span class="n">model_file_path</span><span class="p">)</span>

    <span class="c1"># Train specialty model</span>
    <span class="n">specialty_model</span> <span class="o">=</span> <span class="n">train_sequence_predictor</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="o">=</span><span class="n">train_visits</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;specialty&quot;</span><span class="p">],</span>
        <span class="n">input_var</span><span class="o">=</span><span class="s2">&quot;consultation_sequence&quot;</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="o">=</span><span class="s2">&quot;final_sequence&quot;</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="o">=</span><span class="s2">&quot;specialty&quot;</span><span class="p">,</span>
        <span class="n">visit_col</span><span class="o">=</span><span class="n">visit_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save specialty model if requested</span>
    <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
        <span class="n">save_model</span><span class="p">(</span><span class="n">specialty_model</span><span class="p">,</span> <span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;specialty&quot;</span><span class="p">],</span> <span class="n">model_file_path</span><span class="p">)</span>

    <span class="c1"># Train yet-to-arrive model</span>
    <span class="n">yta_model_name</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">[</span><span class="s2">&quot;yet_to_arrive&quot;</span><span class="p">]</span>

    <span class="n">num_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_validation_set</span> <span class="o">-</span> <span class="n">start_training_set</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="n">yta_model</span> <span class="o">=</span> <span class="n">train_parametric_admission_predictor</span><span class="p">(</span>
        <span class="n">train_visits</span><span class="o">=</span><span class="n">train_visits</span><span class="p">,</span>
        <span class="n">train_yta</span><span class="o">=</span><span class="n">train_yta</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save yet-to-arrive model if requested</span>
    <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
        <span class="n">save_model</span><span class="p">(</span><span class="n">yta_model</span><span class="p">,</span> <span class="n">yta_model_name</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Models have been saved to </span><span class="si">{</span><span class="n">model_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test real-time predictions if requested</span>
    <span class="k">if</span> <span class="n">test_realtime</span><span class="p">:</span>
        <span class="n">visits</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span><span class="s2">&quot;elapsed_los&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">test_real_time_predictions</span><span class="p">(</span>
            <span class="n">visits</span><span class="o">=</span><span class="n">visits</span><span class="p">,</span>
            <span class="n">models</span><span class="o">=</span><span class="p">(</span><span class="n">admission_models</span><span class="p">,</span> <span class="n">specialty_model</span><span class="p">,</span> <span class="n">yta_model</span><span class="p">),</span>
            <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">specialties</span><span class="o">=</span><span class="n">specialties</span><span class="p">,</span>
            <span class="n">cdf_cut_points</span><span class="o">=</span><span class="n">cdf_cut_points</span><span class="p">,</span>
            <span class="n">curve_params</span><span class="o">=</span><span class="n">curve_params</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.incoming_admission_predictor" class="doc doc-heading">
            <code>incoming_admission_predictor</code>


</h3>

    <div class="doc doc-contents ">

        <p>Training utility for parametric admission prediction models.</p>
<p>This module provides functions for training parametric admission prediction models,
specifically for predicting yet-to-arrive (YTA) patient volumes using parametric curves.
It includes utilities for creating specialty filters and training parametric admission predictors.</p>
<p>The logic in this module is specific to the implementation at UCLH.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.incoming_admission_predictor.create_yta_filters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create specialty filters for categorizing patients by specialty and age group.</p>
<p>This function generates a dictionary of filters based on specialty categories,
with special handling for pediatric patients. It uses the SpecialCategoryParams
class to determine which specialties correspond to pediatric care.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing patient data with columns that include either
'age_on_arrival' or 'age_group' for pediatric classification.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping specialty names to filter configurations.
Each configuration contains:
- For pediatric specialty: {"is_child": True}
- For other specialties: {"specialty": specialty_name, "is_child": False}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/incoming_admission_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_yta_filters</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create specialty filters for categorizing patients by specialty and age group.</span>

<span class="sd">    This function generates a dictionary of filters based on specialty categories,</span>
<span class="sd">    with special handling for pediatric patients. It uses the SpecialCategoryParams</span>
<span class="sd">    class to determine which specialties correspond to pediatric care.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing patient data with columns that include either</span>
<span class="sd">        &#39;age_on_arrival&#39; or &#39;age_group&#39; for pediatric classification.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary mapping specialty names to filter configurations.</span>
<span class="sd">        Each configuration contains:</span>
<span class="sd">        - For pediatric specialty: {&quot;is_child&quot;: True}</span>
<span class="sd">        - For other specialties: {&quot;specialty&quot;: specialty_name, &quot;is_child&quot;: False}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the special category parameters using the picklable implementation</span>
    <span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Extract necessary data from the special_params</span>
    <span class="n">special_category_dict</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span>

    <span class="c1"># Create the specialty_filters dictionary</span>
    <span class="n">specialty_filters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">specialty</span><span class="p">,</span> <span class="n">is_paediatric_flag</span> <span class="ow">in</span> <span class="n">special_category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_paediatric_flag</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="c1"># For the paediatric specialty, set `is_child` to True</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For other specialties, set `is_child` to False</span>
            <span class="n">specialty_filters</span><span class="p">[</span><span class="n">specialty</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specialty&quot;</span><span class="p">:</span> <span class="n">specialty</span><span class="p">,</span> <span class="s2">&quot;is_child&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">specialty_filters</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.incoming_admission_predictor.train_parametric_admission_predictor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_parametric_admission_predictor</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">train_yta</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">prediction_times</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train a parametric yet-to-arrive prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Visits dataset (used for identifying special categories).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_yta</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training data for yet-to-arrive predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time window for predictions as a timedelta.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval for predictions as a timedelta.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of prediction times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of days to consider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Epsilon parameter for model, by default 10e-7.</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ParametricIncomingAdmissionPredictor (patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor)" href="#patientflow.predictors.incoming_admission_predictors.ParametricIncomingAdmissionPredictor">ParametricIncomingAdmissionPredictor</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained ParametricIncomingAdmissionPredictor model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prediction_window or yta_time_interval are not timedelta objects.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/incoming_admission_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_parametric_admission_predictor</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">train_yta</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">num_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10e-7</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParametricIncomingAdmissionPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a parametric yet-to-arrive prediction model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_visits : DataFrame</span>
<span class="sd">        Visits dataset (used for identifying special categories).</span>
<span class="sd">    train_yta : DataFrame</span>
<span class="sd">        Training data for yet-to-arrive predictions.</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        Time window for predictions as a timedelta.</span>
<span class="sd">    yta_time_interval : timedelta</span>
<span class="sd">        Time interval for predictions as a timedelta.</span>
<span class="sd">    prediction_times : List[float]</span>
<span class="sd">        List of prediction times.</span>
<span class="sd">    num_days : int</span>
<span class="sd">        Number of days to consider.</span>
<span class="sd">    epsilon : float, optional</span>
<span class="sd">        Epsilon parameter for model, by default 10e-7.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ParametricIncomingAdmissionPredictor</span>
<span class="sd">        Trained ParametricIncomingAdmissionPredictor model.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If prediction_window or yta_time_interval are not timedelta objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;prediction_window must be a timedelta object&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yta_time_interval</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;yta_time_interval must be a timedelta object&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;arrival_datetime&quot;</span> <span class="ow">in</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Convert to datetime using the actual values, not pandas objects</span>
            <span class="n">train_yta</span> <span class="o">=</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">train_yta</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">train_yta</span><span class="p">[</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">train_yta</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">train_yta</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;arrival_datetime&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset needs arrival_datetime column&quot;</span><span class="p">)</span>

    <span class="n">specialty_filters</span> <span class="o">=</span> <span class="n">create_yta_filters</span><span class="p">(</span><span class="n">train_visits</span><span class="p">)</span>

    <span class="n">yta_model</span> <span class="o">=</span> <span class="n">ParametricIncomingAdmissionPredictor</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">specialty_filters</span><span class="p">)</span>
    <span class="n">yta_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_df</span><span class="o">=</span><span class="n">train_yta</span><span class="p">,</span>
        <span class="n">prediction_window</span><span class="o">=</span><span class="n">prediction_window</span><span class="p">,</span>
        <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">yta_time_interval</span><span class="p">,</span>
        <span class="n">prediction_times</span><span class="o">=</span><span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">yta_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.sequence_predictor" class="doc doc-heading">
            <code>sequence_predictor</code>


</h3>

    <div class="doc doc-contents ">

        <p>Training utility for sequence prediction models.</p>
<p>This module provides functions for training sequence-based prediction models,
specifically for predicting patient outcomes based on visit sequences. It includes
utilities for filtering patient data and training specialized sequence predictors.</p>
<p>The logic in this module is specific to the implementation at UCLH.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.sequence_predictor.get_default_visits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_default_visits</span><span class="p">(</span><span class="n">admitted</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Filter a dataframe of patient visits to include only non-pediatric patients.</p>
<p>This function identifies and removes pediatric patients from the dataset based on
both age criteria and specialty assignment. It automatically detects the appropriate
age column format from the provided dataframe.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>admitted</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pandas DataFrame containing patient visit information. Must include either
'age_on_arrival' or 'age_group' columns, and a 'specialty' column.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A filtered DataFrame containing only non-pediatric patients (adults).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function automatically detects which age-related columns are present in the
dataframe and configures the appropriate filtering logic. It removes patients who
are either:
1. Identified as pediatric based on age criteria, or
2. Assigned to a pediatric specialty</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_default_visits</span><span class="p">(</span><span class="n">admitted</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter a dataframe of patient visits to include only non-pediatric patients.</span>

<span class="sd">    This function identifies and removes pediatric patients from the dataset based on</span>
<span class="sd">    both age criteria and specialty assignment. It automatically detects the appropriate</span>
<span class="sd">    age column format from the provided dataframe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    admitted : DataFrame</span>
<span class="sd">        A pandas DataFrame containing patient visit information. Must include either</span>
<span class="sd">        &#39;age_on_arrival&#39; or &#39;age_group&#39; columns, and a &#39;specialty&#39; column.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame</span>
<span class="sd">        A filtered DataFrame containing only non-pediatric patients (adults).</span>

<span class="sd">    Notes</span>
<span class="sd">    ------</span>
<span class="sd">    The function automatically detects which age-related columns are present in the</span>
<span class="sd">    dataframe and configures the appropriate filtering logic. It removes patients who</span>
<span class="sd">    are either:</span>
<span class="sd">    1. Identified as pediatric based on age criteria, or</span>
<span class="sd">    2. Assigned to a pediatric specialty</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get configuration for categorizing patients based on age columns</span>
    <span class="n">special_params</span> <span class="o">=</span> <span class="n">create_special_category_objects</span><span class="p">(</span><span class="n">admitted</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Extract function that identifies non-pediatric patients</span>
    <span class="n">opposite_special_category_func</span> <span class="o">=</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_func_map&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>

    <span class="c1"># Determine which category is the special category (should be &quot;paediatric&quot;)</span>
    <span class="n">special_category_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="n">key</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">special_params</span><span class="p">[</span><span class="s2">&quot;special_category_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span>
    <span class="p">)</span>

    <span class="c1"># Filter out pediatric patients based on both age criteria and specialty</span>
    <span class="n">filtered_admitted</span> <span class="o">=</span> <span class="n">admitted</span><span class="p">[</span>
        <span class="n">admitted</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">opposite_special_category_func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">admitted</span><span class="p">[</span><span class="s2">&quot;specialty&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">special_category_key</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">filtered_admitted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.train.sequence_predictor.train_sequence_predictor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_sequence_predictor</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">,</span> <span class="n">input_var</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">,</span> <span class="n">outcome_var</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Train a specialty prediction model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training data containing visit information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name identifier for the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visit_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name containing visit identifiers.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for input sequence.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for grouping sequence.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outcome_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for target variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="SequencePredictor">SequencePredictor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained SequencePredictor model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/sequence_predictor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_sequence_predictor</span><span class="p">(</span>
    <span class="n">train_visits</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">visit_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">outcome_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SequenceToOutcomePredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a specialty prediction model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_visits : DataFrame</span>
<span class="sd">        Training data containing visit information.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name identifier for the model.</span>
<span class="sd">    visit_col : str</span>
<span class="sd">        Column name containing visit identifiers.</span>
<span class="sd">    input_var : str</span>
<span class="sd">        Column name for input sequence.</span>
<span class="sd">    grouping_var : str</span>
<span class="sd">        Column name for grouping sequence.</span>
<span class="sd">    outcome_var : str</span>
<span class="sd">        Column name for target variable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SequencePredictor</span>
<span class="sd">        Trained SequencePredictor model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">visits_single</span> <span class="o">=</span> <span class="n">select_one_snapshot_per_visit</span><span class="p">(</span><span class="n">train_visits</span><span class="p">,</span> <span class="n">visit_col</span><span class="p">)</span>
    <span class="n">admitted</span> <span class="o">=</span> <span class="n">visits_single</span><span class="p">[</span>
        <span class="p">(</span><span class="n">visits_single</span><span class="o">.</span><span class="n">is_admitted</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">visits_single</span><span class="o">.</span><span class="n">specialty</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="n">filtered_admitted</span> <span class="o">=</span> <span class="n">get_default_visits</span><span class="p">(</span><span class="n">admitted</span><span class="p">)</span>

    <span class="n">filtered_admitted</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">input_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_admitted</span><span class="p">[</span><span class="n">input_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="p">()</span>
    <span class="p">)</span>
    <span class="n">filtered_admitted</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_admitted</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="p">()</span>
    <span class="p">)</span>

    <span class="n">spec_model</span> <span class="o">=</span> <span class="n">SequenceToOutcomePredictor</span><span class="p">(</span>
        <span class="n">input_var</span><span class="o">=</span><span class="n">input_var</span><span class="p">,</span>
        <span class="n">grouping_var</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
        <span class="n">outcome_var</span><span class="o">=</span><span class="n">outcome_var</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">spec_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">filtered_admitted</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spec_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.train.utils" class="doc doc-heading">
            <code>utils</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.train.utils.save_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save trained model(s) to disk.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#object">object</a> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A single model instance or a dictionary of models to save.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base name to use for saving the model(s).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where the model(s) will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/train/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save trained model(s) to disk.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : object or dict</span>
<span class="sd">        A single model instance or a dictionary of models to save.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Base name to use for saving the model(s).</span>
<span class="sd">    model_file_path : Path</span>
<span class="sd">        Directory path where the model(s) will be saved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># Handle dictionary of models (e.g., admission models)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="n">name</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.joblib&quot;</span><span class="p">)</span>
            <span class="n">dump</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Handle single model (e.g., specialty or yet-to-arrive model)</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">model_file_path</span> <span class="o">/</span> <span class="n">model_name</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.joblib&quot;</span><span class="p">)</span>
        <span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="patientflow.viz" class="doc doc-heading">
            <code>viz</code>


</h2>

    <div class="doc doc-contents ">

        <p>Visualization module for patient flow analysis.</p>
<p>This module provides various plotting and visualization functions for analyzing
patient flow data, model results, and evaluation metrics.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.arrival_rates" class="doc doc-heading">
            <code>arrival_rates</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualization functions for inpatient arrival rates and cumulative statistics.</p>
<p>This module provides functions to visualize time-varying arrival rates and cumulative arrivals,
over the course of a day.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.arrival_rates.annotate_hour_line : function">annotate_hour_line : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Annotate hour lines on a matplotlib plot</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.arrival_rates.plot_arrival_rates : function">plot_arrival_rates : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot arrival rates for one or two datasets</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.arrival_rates.plot_cumulative_arrival_rates : function">plot_cumulative_arrival_rates : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot cumulative arrival rates with statistical distributions</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.arrival_rates.annotate_hour_line" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">annotate_hour_line</span><span class="p">(</span><span class="n">hour_line</span><span class="p">,</span> <span class="n">y_value</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">,</span> <span class="n">start_plot_index</span><span class="p">,</span> <span class="n">line_styles</span><span class="p">,</span> <span class="n">x_margin</span><span class="p">,</span> <span class="n">annotation_prefix</span><span class="p">,</span> <span class="n">text_y_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text_x_position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Annotate hour lines on a matplotlib plot with consistent formatting.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hour_line</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The hour to annotate on the plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_value</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The y-coordinate for annotation positioning.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hour_values</code>
            </td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour values corresponding to the x-axis positions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_plot_index</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting index for the plot's data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>line_styles</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line styles for annotations keyed by hour.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x_margin</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Margin added to x-axis for annotation positioning.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>annotation_prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for the annotation text (e.g., "On average").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_y_offset</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical offset for the annotation text from the line, by default 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_x_position</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Horizontal position for annotation text, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slope</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Slope of a line for extended annotations, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference x-coordinate for slope-based annotation, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference y-coordinate for slope-based annotation, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">annotate_hour_line</span><span class="p">(</span>
    <span class="n">hour_line</span><span class="p">,</span>
    <span class="n">y_value</span><span class="p">,</span>
    <span class="n">hour_values</span><span class="p">,</span>
    <span class="n">start_plot_index</span><span class="p">,</span>
    <span class="n">line_styles</span><span class="p">,</span>
    <span class="n">x_margin</span><span class="p">,</span>
    <span class="n">annotation_prefix</span><span class="p">,</span>
    <span class="n">text_y_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">text_x_position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">slope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Annotate hour lines on a matplotlib plot with consistent formatting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hour_line : int</span>
<span class="sd">        The hour to annotate on the plot.</span>
<span class="sd">    y_value : float</span>
<span class="sd">        The y-coordinate for annotation positioning.</span>
<span class="sd">    hour_values : list of int</span>
<span class="sd">        Hour values corresponding to the x-axis positions.</span>
<span class="sd">    start_plot_index : int</span>
<span class="sd">        Starting index for the plot&#39;s data.</span>
<span class="sd">    line_styles : dict</span>
<span class="sd">        Line styles for annotations keyed by hour.</span>
<span class="sd">    x_margin : float</span>
<span class="sd">        Margin added to x-axis for annotation positioning.</span>
<span class="sd">    annotation_prefix : str</span>
<span class="sd">        Prefix for the annotation text (e.g., &quot;On average&quot;).</span>
<span class="sd">    text_y_offset : float, optional</span>
<span class="sd">        Vertical offset for the annotation text from the line, by default 1.</span>
<span class="sd">    text_x_position : float, optional</span>
<span class="sd">        Horizontal position for annotation text, by default None.</span>
<span class="sd">    slope : float, optional</span>
<span class="sd">        Slope of a line for extended annotations, by default None.</span>
<span class="sd">    x1 : float, optional</span>
<span class="sd">        Reference x-coordinate for slope-based annotation, by default None.</span>
<span class="sd">    y1 : float, optional</span>
<span class="sd">        Reference y-coordinate for slope-based annotation, by default None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">hour_values</span><span class="p">[</span><span class="n">hour_line</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">slope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y_a</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">y1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_a</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">hour_line</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span> <span class="o">-</span> <span class="n">x_margin</span><span class="p">,</span> <span class="n">a</span><span class="p">],</span>
            <span class="p">[</span><span class="n">y_a</span><span class="p">,</span> <span class="n">y_a</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">hour_line</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">annotation_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_prefix</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">y_a</span><span class="p">)</span><span class="si">}</span><span class="s2"> beds needed by </span><span class="si">{</span><span class="n">hour_line</span><span class="si">}</span><span class="s2">:00&quot;</span>
        <span class="p">)</span>
        <span class="n">y_position</span> <span class="o">=</span> <span class="n">y_a</span> <span class="o">+</span> <span class="n">text_y_offset</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">y_value</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">hour_line</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">y_value</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">hour_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_margin</span><span class="p">,</span> <span class="n">y_value</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">hour_line</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">annotation_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_prefix</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">y_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> beds needed by </span><span class="si">{</span><span class="n">hour_line</span><span class="si">}</span><span class="s2">:00&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># strip() removes leading comma if prefix is empty</span>
        <span class="n">y_position</span> <span class="o">=</span> <span class="n">y_value</span> <span class="o">+</span> <span class="n">text_y_offset</span>

    <span class="c1"># Use custom text x position if provided, otherwise use default</span>
    <span class="n">x_position</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">text_x_position</span> <span class="k">if</span> <span class="n">text_x_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">hour_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_margin</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="n">annotation_text</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">slope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">a</span><span class="p">,</span> <span class="n">y_value</span><span class="p">),</span>
        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x_position</span><span class="p">,</span> <span class="n">y_position</span><span class="p">),</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.arrival_rates.draw_window_visualization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">draw_window_visualization</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">,</span> <span class="n">window_params</span><span class="p">,</span> <span class="n">annotation_prefix</span><span class="p">,</span> <span class="n">start_window</span><span class="p">,</span> <span class="n">end_window</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Draw the window visualization with annotations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.axes.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axes to draw on</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hour_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hour labels for x-axis</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(slope, x1, y1, y2) from get_window_parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>annotation_prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for annotations</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start hour for window</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End hour for window</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">draw_window_visualization</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">,</span> <span class="n">window_params</span><span class="p">,</span> <span class="n">annotation_prefix</span><span class="p">,</span> <span class="n">start_window</span><span class="p">,</span> <span class="n">end_window</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw the window visualization with annotations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The axes to draw on</span>
<span class="sd">    hour_values : array-like</span>
<span class="sd">        Hour labels for x-axis</span>
<span class="sd">    window_params : tuple</span>
<span class="sd">        (slope, x1, y1, y2) from get_window_parameters</span>
<span class="sd">    annotation_prefix : str</span>
<span class="sd">        Prefix for annotations</span>
<span class="sd">    start_window : int</span>
<span class="sd">        Start hour for window</span>
<span class="sd">    end_window : int</span>
<span class="sd">        End hour for window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">window_params</span>

    <span class="c1"># Draw horizontal line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">hour_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

    <span class="c1"># Draw diagonal line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

    <span class="c1"># Add annotation</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_prefix</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> beds need to be vacated</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;each hour between </span><span class="si">{</span><span class="n">start_window</span><span class="si">}</span><span class="s2">:00 and </span><span class="si">{</span><span class="n">end_window</span><span class="si">}</span><span class="s2">:00</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;to create capacity for all overnight arrivals</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;by </span><span class="si">{</span><span class="n">end_window</span><span class="si">}</span><span class="s2">:00&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">hour_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y2</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">),</span>
        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">hour_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y2</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">),</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.arrival_rates.get_window_parameters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_window_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start_window</span><span class="p">,</span> <span class="n">end_window</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate window parameters for visualization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reindexed cumulative data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start position in reindexed space</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End position in reindexed space</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hour_values</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original hour values for display</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(slope, x1, y1, x2, y2) where:
- slope: float, The calculated slope of the line
- x1: float, Start hour value
- y1: float, Start y-value
- x2: float, End hour value
- y2: float, End y-value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_window_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start_window</span><span class="p">,</span> <span class="n">end_window</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate window parameters for visualization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array-like</span>
<span class="sd">        Reindexed cumulative data</span>
<span class="sd">    start_window : int</span>
<span class="sd">        Start position in reindexed space</span>
<span class="sd">    end_window : int</span>
<span class="sd">        End position in reindexed space</span>
<span class="sd">    hour_values : array-like</span>
<span class="sd">        Original hour values for display</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (slope, x1, y1, x2, y2) where:</span>
<span class="sd">        - slope: float, The calculated slope of the line</span>
<span class="sd">        - x1: float, Start hour value</span>
<span class="sd">        - y1: float, Start y-value</span>
<span class="sd">        - x2: float, End hour value</span>
<span class="sd">        - y2: float, End y-value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start_window</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">hour_values</span><span class="p">[</span><span class="n">start_window</span><span class="p">]</span>  <span class="c1"># Get display hour</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">hour_values</span><span class="p">[</span><span class="n">end_window</span><span class="p">]</span>  <span class="c1"># Get display hour</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">slope</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.arrival_rates.plot_arrival_rates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_arrival_rates</span><span class="p">(</span><span class="n">inpatient_arrivals</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">inpatient_arrivals_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lagged_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">start_plot_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_margin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">file_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_days_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot arrival rates for one or two datasets with optional lagged and spread rates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inpatient_arrivals</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Primary dataset of inpatient arrivals.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title of the plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inpatient_arrivals_2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional second dataset for comparison, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code>tuple of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Labels for the datasets when comparing two datasets, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lagged_by</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time lag in hours to apply to the arrival rates, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>curve_params</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters for spread arrival rates as (x1, y1, x2, y2), by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in minutes for arrival rate calculations, by default 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_plot_index</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting hour index for plotting, by default 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x_margin</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Margin on the x-axis, by default 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for the saved file name, by default "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path to save the plot, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, uses file_prefix + cleaned title.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of days in the first dataset, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days_2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of days in the second dataset, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the matplotlib figure instead of displaying it, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns the figure if return_figure is True, otherwise displays the plot.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_arrival_rates</span><span class="p">(</span>
    <span class="n">inpatient_arrivals</span><span class="p">,</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">inpatient_arrivals_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lagged_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">start_plot_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">x_margin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">file_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_days_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot arrival rates for one or two datasets with optional lagged and spread rates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inpatient_arrivals : array-like</span>
<span class="sd">        Primary dataset of inpatient arrivals.</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the plot.</span>
<span class="sd">    inpatient_arrivals_2 : array-like, optional</span>
<span class="sd">        Optional second dataset for comparison, by default None.</span>
<span class="sd">    labels : tuple of str, optional</span>
<span class="sd">        Labels for the datasets when comparing two datasets, by default None.</span>
<span class="sd">    lagged_by : int, optional</span>
<span class="sd">        Time lag in hours to apply to the arrival rates, by default None.</span>
<span class="sd">    curve_params : tuple of float, optional</span>
<span class="sd">        Parameters for spread arrival rates as (x1, y1, x2, y2), by default None.</span>
<span class="sd">    time_interval : int, optional</span>
<span class="sd">        Time interval in minutes for arrival rate calculations, by default 60.</span>
<span class="sd">    start_plot_index : int, optional</span>
<span class="sd">        Starting hour index for plotting, by default 0.</span>
<span class="sd">    x_margin : float, optional</span>
<span class="sd">        Margin on the x-axis, by default 0.5.</span>
<span class="sd">    file_prefix : str, optional</span>
<span class="sd">        Prefix for the saved file name, by default &quot;&quot;.</span>
<span class="sd">    media_file_path : str or Path, optional</span>
<span class="sd">        Directory path to save the plot, by default None.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, uses file_prefix + cleaned title.</span>
<span class="sd">    num_days : int, optional</span>
<span class="sd">        Number of days in the first dataset, by default None.</span>
<span class="sd">    num_days_2 : int, optional</span>
<span class="sd">        Number of days in the second dataset, by default None.</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        If True, returns the matplotlib figure instead of displaying it, by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        Returns the figure if return_figure is True, otherwise displays the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_dual_plot</span> <span class="o">=</span> <span class="n">inpatient_arrivals_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_dual_plot</span> <span class="ow">and</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Dataset 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset 2&quot;</span><span class="p">)</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">inpatient_arrivals</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">is_dual_plot</span><span class="p">:</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">inpatient_arrivals_2</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">num_days_2</span><span class="p">))</span>

    <span class="c1"># Calculate and process arrival rates for all datasets</span>
    <span class="n">processed_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_y_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">num_days</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="c1"># Calculate base arrival rates</span>
        <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
        <span class="p">)</span>
        <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">hour_labels</span><span class="p">,</span> <span class="n">hour_values</span> <span class="o">=</span> <span class="n">process_arrival_rates</span><span class="p">(</span>
            <span class="n">arrival_rates_dict</span>
        <span class="p">)</span>
        <span class="n">max_y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">))</span>

        <span class="c1"># Calculate lagged rates if needed</span>
        <span class="n">arrival_rates_lagged</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">lagged_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arrival_rates_lagged_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates_lagged</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">lagged_by</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
            <span class="p">)</span>
            <span class="n">arrival_rates_lagged</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process_arrival_rates</span><span class="p">(</span>
                <span class="n">arrival_rates_lagged_dict</span>
            <span class="p">)</span>
            <span class="n">max_y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">arrival_rates_lagged</span><span class="p">))</span>

        <span class="c1"># Calculate spread rates if needed</span>
        <span class="n">arrival_rates_spread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">curve_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">curve_params</span>
            <span class="n">arrival_rates_spread_dict</span> <span class="o">=</span> <span class="n">unfettered_demand_by_hour</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
            <span class="p">)</span>
            <span class="n">arrival_rates_spread</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process_arrival_rates</span><span class="p">(</span>
                <span class="n">arrival_rates_spread_dict</span>
            <span class="p">)</span>
            <span class="n">max_y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">arrival_rates_spread</span><span class="p">))</span>

        <span class="n">processed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;arrival_rates&quot;</span><span class="p">:</span> <span class="n">arrival_rates</span><span class="p">,</span>
                <span class="s2">&quot;arrival_rates_lagged&quot;</span><span class="p">:</span> <span class="n">arrival_rates_lagged</span><span class="p">,</span>
                <span class="s2">&quot;arrival_rates_spread&quot;</span><span class="p">:</span> <span class="n">arrival_rates_spread</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
                <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="n">marker</span><span class="p">,</span>
                <span class="s2">&quot;dataset_label&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_data</span><span class="p">)]</span> <span class="k">if</span> <span class="n">is_dual_plot</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Helper function to create cyclic data</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cyclic_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">start_plot_index</span><span class="p">:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">start_plot_index</span><span class="p">]</span>

    <span class="c1"># Plot setup</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="n">get_cyclic_data</span><span class="p">(</span><span class="n">hour_labels</span><span class="p">)</span>

    <span class="c1"># Plot data for each dataset</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">processed_data</span><span class="p">:</span>
        <span class="n">dataset_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dataset_label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dataset_label&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Base arrival rates</span>
        <span class="n">base_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Arrival rates of admitted patients</span><span class="si">{</span><span class="n">dataset_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">x_values</span><span class="p">,</span>
            <span class="n">get_cyclic_data</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;arrival_rates&quot;</span><span class="p">]),</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">curve_params</span> <span class="ow">or</span> <span class="n">lagged_by</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">curve_params</span> <span class="ow">or</span> <span class="n">lagged_by</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">base_label</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">lagged_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Lagged arrival rates</span>
            <span class="n">lagged_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Average number of beds needed assuming admission</span><span class="se">\n</span><span class="s2">exactly </span><span class="si">{</span><span class="n">lagged_by</span><span class="si">}</span><span class="s2"> hours after arrival</span><span class="si">{</span><span class="n">dataset_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_values</span><span class="p">,</span>
                <span class="n">get_cyclic_data</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;arrival_rates_lagged&quot;</span><span class="p">]),</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">lagged_label</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">curve_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;arrival_rates_spread&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Spread arrival rates</span>
            <span class="n">spread_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Average number of beds applying ED targets of </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">% in </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="si">}</span><span class="s2"> hours</span><span class="si">{</span><span class="n">dataset_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_values</span><span class="p">,</span>
                <span class="n">get_cyclic_data</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;arrival_rates_spread&quot;</span><span class="p">]),</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>  <span class="c1"># Keep original dataset marker</span>
                <span class="n">color</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>  <span class="c1"># Keep original dataset color</span>
                <span class="n">label</span><span class="o">=</span><span class="n">spread_label</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Set plot limits and labels</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_y_values</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">hour_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_margin</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_margin</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of day&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Arrival Rate (patients per hour)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Always show legend if there are multiple datasets or multiple rate types</span>
    <span class="k">if</span> <span class="n">is_dual_plot</span> <span class="ow">or</span> <span class="n">lagged_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">curve_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save if path provided</span>
    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}{</span><span class="n">clean_title_for_filename</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.arrival_rates.plot_cumulative_arrival_rates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_cumulative_arrival_rates</span><span class="p">(</span><span class="n">inpatient_arrivals</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lagged_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">start_plot_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">draw_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_margin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">file_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">set_y_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hour_lines</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span> <span class="n">line_styles</span><span class="o">=</span><span class="p">{</span><span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span> <span class="s1">&#39;--&#39;</span><span class="p">},</span> <span class="n">annotation_prefix</span><span class="o">=</span><span class="s1">&#39;On average&#39;</span><span class="p">,</span> <span class="n">line_colour</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_centiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">highlight_centile</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">centiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span> <span class="n">markers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">line_styles_centiles</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">],</span> <span class="n">bed_type_spec</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text_y_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot cumulative arrival rates with optional statistical distributions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inpatient_arrivals</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/array.html#module-array">array</a> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset of inpatient arrivals.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title of the plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>curve_params</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters for spread rates as (x1, y1, x2, y2), by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lagged_by</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time lag in hours for cumulative rates, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in minutes for rate calculations, by default 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_plot_index</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting hour index for plotting, by default 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>draw_window</code>
            </td>
            <td>
                  <code>tuple of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time window for detailed annotation, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x_margin</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Margin on the x-axis, by default 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for the saved file name, by default "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>set_y_lim</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upper limit for the y-axis, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hour_lines</code>
            </td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific hours to annotate, by default [12, 17].</p>
              </div>
            </td>
            <td>
                  <code>[12, 17]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>line_styles</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line styles for hour annotations keyed by hour, by default {12: "--", 17: ":", 20: "--"}.</p>
              </div>
            </td>
            <td>
                  <code>{12: &#39;--&#39;, 17: &#39;:&#39;, 20: &#39;--&#39;}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>annotation_prefix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for annotations, by default "On average".</p>
              </div>
            </td>
            <td>
                  <code>&#39;On average&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>line_colour</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color for the main line plot, by default "red".</p>
              </div>
            </td>
            <td>
                  <code>&#39;red&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path to save the plot, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, uses file_prefix + cleaned title.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_centiles</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include percentile visualization, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highlight_centile</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentile to emphasize, by default 0.9. If 1.0 is provided, will use 0.9999 instead.</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>centiles</code>
            </td>
            <td>
                  <code>list of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of percentiles to calculate, by default [0.3, 0.5, 0.7, 0.9, 0.99].</p>
              </div>
            </td>
            <td>
                  <code>[0.3, 0.5, 0.7, 0.9, 0.99]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>markers</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Marker styles for percentile lines, by default ["D", "s", "^", "o", "v"].</p>
              </div>
            </td>
            <td>
                  <code>[&#39;D&#39;, &#39;s&#39;, &#39;^&#39;, &#39;o&#39;, &#39;v&#39;]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>line_styles_centiles</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line styles for percentile visualization, by default ["-.", "--", ":", "-", "-"].</p>
              </div>
            </td>
            <td>
                  <code>[&#39;-.&#39;, &#39;--&#39;, &#39;:&#39;, &#39;-&#39;, &#39;-&#39;]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bed_type_spec</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specification for bed type in annotations, by default "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_y_offset</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical offset for text annotations, by default 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_days</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of days in the dataset, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the matplotlib figure instead of displaying it, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns the figure if return_figure is True, otherwise displays the plot.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/arrival_rates.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_cumulative_arrival_rates</span><span class="p">(</span>
    <span class="n">inpatient_arrivals</span><span class="p">,</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">curve_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lagged_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">start_plot_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">draw_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x_margin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">file_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">set_y_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hour_lines</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span>
    <span class="n">line_styles</span><span class="o">=</span><span class="p">{</span><span class="mi">12</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
    <span class="n">annotation_prefix</span><span class="o">=</span><span class="s2">&quot;On average&quot;</span><span class="p">,</span>
    <span class="n">line_colour</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_centiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">highlight_centile</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
    <span class="n">centiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>
    <span class="n">markers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">],</span>
    <span class="n">line_styles_centiles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">],</span>
    <span class="n">bed_type_spec</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">text_y_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot cumulative arrival rates with optional statistical distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inpatient_arrivals : array-like</span>
<span class="sd">        Dataset of inpatient arrivals.</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the plot.</span>
<span class="sd">    curve_params : tuple of float, optional</span>
<span class="sd">        Parameters for spread rates as (x1, y1, x2, y2), by default None.</span>
<span class="sd">    lagged_by : int, optional</span>
<span class="sd">        Time lag in hours for cumulative rates, by default None.</span>
<span class="sd">    time_interval : int, optional</span>
<span class="sd">        Time interval in minutes for rate calculations, by default 60.</span>
<span class="sd">    start_plot_index : int, optional</span>
<span class="sd">        Starting hour index for plotting, by default 0.</span>
<span class="sd">    draw_window : tuple of int, optional</span>
<span class="sd">        Time window for detailed annotation, by default None.</span>
<span class="sd">    x_margin : float, optional</span>
<span class="sd">        Margin on the x-axis, by default 0.5.</span>
<span class="sd">    file_prefix : str, optional</span>
<span class="sd">        Prefix for the saved file name, by default &quot;&quot;.</span>
<span class="sd">    set_y_lim : float, optional</span>
<span class="sd">        Upper limit for the y-axis, by default None.</span>
<span class="sd">    hour_lines : list of int, optional</span>
<span class="sd">        Specific hours to annotate, by default [12, 17].</span>
<span class="sd">    line_styles : dict, optional</span>
<span class="sd">        Line styles for hour annotations keyed by hour, by default {12: &quot;--&quot;, 17: &quot;:&quot;, 20: &quot;--&quot;}.</span>
<span class="sd">    annotation_prefix : str, optional</span>
<span class="sd">        Prefix for annotations, by default &quot;On average&quot;.</span>
<span class="sd">    line_colour : str, optional</span>
<span class="sd">        Color for the main line plot, by default &quot;red&quot;.</span>
<span class="sd">    media_file_path : str or Path, optional</span>
<span class="sd">        Directory path to save the plot, by default None.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, uses file_prefix + cleaned title.</span>
<span class="sd">    plot_centiles : bool, optional</span>
<span class="sd">        Whether to include percentile visualization, by default False.</span>
<span class="sd">    highlight_centile : float, optional</span>
<span class="sd">        Percentile to emphasize, by default 0.9. If 1.0 is provided, will use 0.9999 instead.</span>
<span class="sd">    centiles : list of float, optional</span>
<span class="sd">        List of percentiles to calculate, by default [0.3, 0.5, 0.7, 0.9, 0.99].</span>
<span class="sd">    markers : list of str, optional</span>
<span class="sd">        Marker styles for percentile lines, by default [&quot;D&quot;, &quot;s&quot;, &quot;^&quot;, &quot;o&quot;, &quot;v&quot;].</span>
<span class="sd">    line_styles_centiles : list of str, optional</span>
<span class="sd">        Line styles for percentile visualization, by default [&quot;-.&quot;, &quot;--&quot;, &quot;:&quot;, &quot;-&quot;, &quot;-&quot;].</span>
<span class="sd">    bed_type_spec : str, optional</span>
<span class="sd">        Specification for bed type in annotations, by default &quot;&quot;.</span>
<span class="sd">    text_y_offset : float, optional</span>
<span class="sd">        Vertical offset for text annotations, by default 1.</span>
<span class="sd">    num_days : int, optional</span>
<span class="sd">        Number of days in the dataset, by default None.</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        If True, returns the matplotlib figure instead of displaying it, by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        Returns the figure if return_figure is True, otherwise displays the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Handle edge case for highlight_centile = 1.0</span>
    <span class="n">original_highlight_centile</span> <span class="o">=</span> <span class="n">highlight_centile</span>
    <span class="k">if</span> <span class="n">highlight_centile</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">highlight_centile</span> <span class="o">=</span> <span class="mf">0.9999</span>  <span class="c1"># Use a very high but not exactly 1.0 value</span>

    <span class="c1"># Ensure centiles are all valid (no 1.0 values)</span>
    <span class="n">processed_centiles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centiles</span><span class="p">]</span>

    <span class="c1"># Data processing</span>
    <span class="k">if</span> <span class="n">curve_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">curve_params</span>
        <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">unfettered_demand_by_hour</span><span class="p">(</span>
            <span class="n">inpatient_arrivals</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">lagged_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates_lagged</span><span class="p">(</span>
            <span class="n">inpatient_arrivals</span><span class="p">,</span> <span class="n">lagged_by</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arrival_rates_dict</span> <span class="o">=</span> <span class="n">time_varying_arrival_rates</span><span class="p">(</span>
            <span class="n">inpatient_arrivals</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span>
        <span class="p">)</span>

    <span class="c1"># Process arrival rates</span>
    <span class="n">arrival_rates</span><span class="p">,</span> <span class="n">hour_labels</span><span class="p">,</span> <span class="n">hour_values</span> <span class="o">=</span> <span class="n">process_arrival_rates</span><span class="p">(</span><span class="n">arrival_rates_dict</span><span class="p">)</span>

    <span class="c1"># Reindex based on start_plot_index</span>
    <span class="n">rates_reindexed</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)[</span><span class="n">start_plot_index</span><span class="p">:]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrival_rates</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">start_plot_index</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">labels_reindexed</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">hour_labels</span><span class="p">)[</span><span class="n">start_plot_index</span><span class="p">:]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">hour_labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">start_plot_index</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Calculate percentiles</span>
    <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">))]</span>
    <span class="n">cumulative_value_at_centile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rates_reindexed</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">centile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">):</span>
            <span class="n">value_at_centile</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">centile</span><span class="p">,</span> <span class="n">rates_reindexed</span><span class="p">[</span><span class="n">hour</span><span class="p">])</span>
            <span class="n">cumulative_value_at_centile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value_at_centile</span>
            <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_at_centile</span><span class="p">)</span>

    <span class="c1"># Set up plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># Plot mean line</span>
    <span class="n">label_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">bed_type_spec</span><span class="si">}</span><span class="s2"> beds needed&quot;</span> <span class="k">if</span> <span class="n">bed_type_spec</span> <span class="k">else</span> <span class="s2">&quot; beds needed&quot;</span>
    <span class="n">cumsum_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rates_reindexed</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">labels_reindexed</span><span class="p">,</span>
        <span class="n">cumsum_rates</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">line_colour</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Average number of</span><span class="si">{</span><span class="n">label_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># set max y value assuming centiles not plotted</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="n">cumsum_rates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">plot_centiles</span><span class="p">:</span>
        <span class="c1"># Calculate and plot percentiles</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">))]</span>
        <span class="n">cumulative_value_at_centile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">))</span>
        <span class="n">highlight_percentile_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Find the index of highlight_centile in processed_centiles</span>
        <span class="n">highlight_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">highlight_centile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span>
            <span class="p">):</span>  <span class="c1"># Use small epsilon for float comparison</span>
                <span class="n">highlight_index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="c1"># If highlight_centile is not in processed_centiles, add it</span>
        <span class="k">if</span> <span class="n">highlight_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">processed_centiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">highlight_centile</span><span class="p">)</span>
            <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">cumulative_value_at_centile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cumulative_value_at_centile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rates_reindexed</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">centile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Add error handling for ppf calculation</span>
                    <span class="n">value_at_centile</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">centile</span><span class="p">,</span> <span class="n">rates_reindexed</span><span class="p">[</span><span class="n">hour</span><span class="p">])</span>

                    <span class="c1"># Apply a reasonable upper limit if the value is extremely large</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value_at_centile</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">value_at_centile</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">rates_reindexed</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">value_at_centile</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">rates_reindexed</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span>

                    <span class="n">cumulative_value_at_centile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value_at_centile</span>
                    <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_at_centile</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                    <span class="c1"># Fallback if calculation fails</span>
                    <span class="n">fallback_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">rates_reindexed</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span>
                    <span class="n">cumulative_value_at_centile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fallback_value</span>
                    <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback_value</span><span class="p">)</span>

                <span class="c1"># Match the highlight centile to the processed value</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">centile</span> <span class="o">-</span> <span class="n">highlight_centile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span>
                <span class="p">):</span>  <span class="c1"># Use a small epsilon for floating point comparison</span>
                    <span class="n">highlight_percentile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Plot percentile lines</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">centile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processed_centiles</span><span class="p">):</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="n">markers</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)]</span>
            <span class="n">line_style</span> <span class="o">=</span> <span class="n">line_styles_centiles</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_styles_centiles</span><span class="p">)]</span>
            <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">centile</span> <span class="o">==</span> <span class="n">highlight_centile</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">centile</span> <span class="o">==</span> <span class="n">highlight_centile</span> <span class="k">else</span> <span class="mf">0.7</span>

            <span class="c1"># If the user requested 1.0, display as 99.99% since a Poisson distribution</span>
            <span class="c1"># cannot provide exact 100% probability with any finite value</span>
            <span class="n">display_centile</span> <span class="o">=</span> <span class="n">processed_centiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">centile</span> <span class="o">==</span> <span class="n">highlight_centile</span> <span class="ow">and</span> <span class="n">original_highlight_centile</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">display_centile</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mf">0.9999</span>  <span class="c1"># Use 99.99% as the highest displayable probability</span>
                <span class="p">)</span>

            <span class="c1"># Format the label text with appropriate precision</span>
            <span class="k">if</span> <span class="n">display_centile</span> <span class="o">&gt;=</span> <span class="mf">0.999</span><span class="p">:</span>
                <span class="c1"># For very high probabilities, show as 99.9% or 99.99% to avoid implying exact 100%</span>
                <span class="n">label_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_centile</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% probability&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_centile</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% probability&quot;</span>

            <span class="n">cumsum_percentile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">labels_reindexed</span><span class="p">,</span>
                <span class="n">cumsum_percentile</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label_text</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># update max y</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cumulative_value_at_centile</span><span class="p">)</span>

        <span class="c1"># Draw window visualization if requested</span>
        <span class="k">if</span> <span class="n">draw_window</span><span class="p">:</span>
            <span class="n">start_window</span><span class="p">,</span> <span class="n">end_window</span> <span class="o">=</span> <span class="n">draw_window</span>
            <span class="n">reindexed_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_window</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">highlight_percentile_data</span>
            <span class="p">)</span>
            <span class="n">reindexed_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_window</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">highlight_percentile_data</span>
            <span class="p">)</span>
            <span class="n">window_params</span> <span class="o">=</span> <span class="n">get_window_parameters</span><span class="p">(</span>
                <span class="n">highlight_percentile_data</span><span class="p">,</span> <span class="n">reindexed_start</span><span class="p">,</span> <span class="n">reindexed_end</span><span class="p">,</span> <span class="n">hour_values</span>
            <span class="p">)</span>
            <span class="n">draw_window_visualization</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span>
                <span class="n">hour_values</span><span class="p">,</span>
                <span class="n">window_params</span><span class="p">,</span>
                <span class="n">annotation_prefix</span><span class="p">,</span>
                <span class="n">start_window</span><span class="p">,</span>
                <span class="n">end_window</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">slope</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">window_params</span>
            <span class="k">for</span> <span class="n">hour_line</span> <span class="ow">in</span> <span class="n">hour_lines</span><span class="p">:</span>
                <span class="n">annotate_hour_line</span><span class="p">(</span>
                    <span class="n">hour_line</span><span class="o">=</span><span class="n">hour_line</span><span class="p">,</span>
                    <span class="n">y_value</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
                    <span class="n">hour_values</span><span class="o">=</span><span class="n">hour_values</span><span class="p">,</span>
                    <span class="n">start_plot_index</span><span class="o">=</span><span class="n">start_plot_index</span><span class="p">,</span>
                    <span class="n">line_styles</span><span class="o">=</span><span class="n">line_styles</span><span class="p">,</span>
                    <span class="n">x_margin</span><span class="o">=</span><span class="n">x_margin</span><span class="p">,</span>
                    <span class="n">annotation_prefix</span><span class="o">=</span><span class="n">annotation_prefix</span><span class="p">,</span>
                    <span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
                    <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span>
                    <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Regular percentile annotations</span>
            <span class="k">for</span> <span class="n">hour_line</span> <span class="ow">in</span> <span class="n">hour_lines</span><span class="p">:</span>
                <span class="c1"># Check if highlight_percentile_data is available</span>
                <span class="k">if</span> <span class="n">highlight_percentile_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Fall back to mean line if no highlight data</span>
                    <span class="n">cumsum_at_hour</span> <span class="o">=</span> <span class="n">cumsum_rates</span><span class="p">[</span><span class="n">hour_line</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cumsum_at_hour</span> <span class="o">=</span> <span class="n">highlight_percentile_data</span><span class="p">[</span>
                        <span class="n">hour_line</span> <span class="o">-</span> <span class="n">start_plot_index</span>
                    <span class="p">]</span>
                <span class="n">annotate_hour_line</span><span class="p">(</span>
                    <span class="n">hour_line</span><span class="o">=</span><span class="n">hour_line</span><span class="p">,</span>
                    <span class="n">y_value</span><span class="o">=</span><span class="n">cumsum_at_hour</span><span class="p">,</span>
                    <span class="n">hour_values</span><span class="o">=</span><span class="n">hour_values</span><span class="p">,</span>
                    <span class="n">start_plot_index</span><span class="o">=</span><span class="n">start_plot_index</span><span class="p">,</span>
                    <span class="n">line_styles</span><span class="o">=</span><span class="n">line_styles</span><span class="p">,</span>
                    <span class="n">x_margin</span><span class="o">=</span><span class="n">x_margin</span><span class="p">,</span>
                    <span class="n">annotation_prefix</span><span class="o">=</span><span class="n">annotation_prefix</span><span class="p">,</span>
                    <span class="n">text_y_offset</span><span class="o">=</span><span class="n">text_y_offset</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Reverse legend order</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">draw_window</span><span class="p">:</span>
            <span class="n">start_window</span><span class="p">,</span> <span class="n">end_window</span> <span class="o">=</span> <span class="n">draw_window</span>
            <span class="n">reindexed_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_window</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumsum_rates</span><span class="p">)</span>
            <span class="n">reindexed_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_window</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumsum_rates</span><span class="p">)</span>
            <span class="n">window_params</span> <span class="o">=</span> <span class="n">get_window_parameters</span><span class="p">(</span>
                <span class="n">cumsum_rates</span><span class="p">,</span> <span class="n">reindexed_start</span><span class="p">,</span> <span class="n">reindexed_end</span><span class="p">,</span> <span class="n">hour_values</span>
            <span class="p">)</span>
            <span class="n">draw_window_visualization</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span>
                <span class="n">hour_values</span><span class="p">,</span>
                <span class="n">window_params</span><span class="p">,</span>
                <span class="n">annotation_prefix</span><span class="p">,</span>
                <span class="n">start_window</span><span class="p">,</span>
                <span class="n">end_window</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">slope</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">window_params</span>
            <span class="k">for</span> <span class="n">hour_line</span> <span class="ow">in</span> <span class="n">hour_lines</span><span class="p">:</span>
                <span class="n">annotate_hour_line</span><span class="p">(</span>
                    <span class="n">hour_line</span><span class="o">=</span><span class="n">hour_line</span><span class="p">,</span>
                    <span class="n">y_value</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
                    <span class="n">hour_values</span><span class="o">=</span><span class="n">hour_values</span><span class="p">,</span>
                    <span class="n">start_plot_index</span><span class="o">=</span><span class="n">start_plot_index</span><span class="p">,</span>
                    <span class="n">line_styles</span><span class="o">=</span><span class="n">line_styles</span><span class="p">,</span>
                    <span class="n">x_margin</span><span class="o">=</span><span class="n">x_margin</span><span class="p">,</span>
                    <span class="n">annotation_prefix</span><span class="o">=</span><span class="n">annotation_prefix</span><span class="p">,</span>
                    <span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
                    <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span>
                    <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Regular mean line annotations</span>
            <span class="k">for</span> <span class="n">hour_line</span> <span class="ow">in</span> <span class="n">hour_lines</span><span class="p">:</span>
                <span class="n">annotate_hour_line</span><span class="p">(</span>
                    <span class="n">hour_line</span><span class="o">=</span><span class="n">hour_line</span><span class="p">,</span>
                    <span class="n">y_value</span><span class="o">=</span><span class="n">cumsum_rates</span><span class="p">[</span><span class="n">hour_line</span> <span class="o">-</span> <span class="n">start_plot_index</span><span class="p">],</span>
                    <span class="n">hour_values</span><span class="o">=</span><span class="n">hour_values</span><span class="p">,</span>
                    <span class="n">start_plot_index</span><span class="o">=</span><span class="n">start_plot_index</span><span class="p">,</span>
                    <span class="n">line_styles</span><span class="o">=</span><span class="n">line_styles</span><span class="p">,</span>
                    <span class="n">x_margin</span><span class="o">=</span><span class="n">x_margin</span><span class="p">,</span>
                    <span class="n">annotation_prefix</span><span class="o">=</span><span class="n">annotation_prefix</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of day&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative number of beds needed&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">hour_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_margin</span><span class="p">,</span> <span class="n">hour_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_margin</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">set_y_lim</span> <span class="k">if</span> <span class="n">set_y_lim</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}{</span><span class="n">clean_title_for_filename</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.aspirational_curve" class="doc doc-heading">
            <code>aspirational_curve</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualization module for plotting aspirational curves in patient flow analysis.</p>
<p>This module provides functionality for creating and customizing plots of aspirational
curves, which represent the probability of admission over time. These curves are
useful for setting aspirational targets in healthcare settings.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.aspirational_curve.plot_curve : function">plot_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot an aspirational curve with specified points and optional annotations</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">plot_curve</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Admission Probability Curve&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">x1</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">y1</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">x2</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">y2</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">include_titles</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.aspirational_curve.plot_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_curve</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">include_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">text_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotate_points</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot an aspirational curve with specified points and optional annotations.</p>
<p>This function creates a plot of an aspirational curve between two points,
with options for customization of the visualization including titles,
annotations, and saving to a file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The title of the plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>x-coordinate of the first point.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>y-coordinate of the first point (probability value).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>x-coordinate of the second point.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>y-coordinate of the second point (probability value).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code>tuple of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size in inches (width, height), by default (10, 5).</p>
              </div>
            </td>
            <td>
                  <code>(10, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_titles</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include axis labels and title, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Font size for text elements, by default 14.</p>
              </div>
            </td>
            <td>
                  <code>14</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot image, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename for saving the plot. If not provided, uses a cleaned version of the title.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return the figure object instead of displaying it, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>annotate_points</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add coordinate annotations to the points, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure object if return_figure is True, otherwise None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function creates a curve between two points using the create_curve function
and adds various visualization elements including grid lines, annotations,
and optional titles.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/aspirational_curve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_curve</span><span class="p">(</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">x1</span><span class="p">,</span>
    <span class="n">y1</span><span class="p">,</span>
    <span class="n">x2</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">include_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">text_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">annotate_points</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot an aspirational curve with specified points and optional annotations.</span>

<span class="sd">    This function creates a plot of an aspirational curve between two points,</span>
<span class="sd">    with options for customization of the visualization including titles,</span>
<span class="sd">    annotations, and saving to a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        The title of the plot.</span>
<span class="sd">    x1 : float</span>
<span class="sd">        x-coordinate of the first point.</span>
<span class="sd">    y1 : float</span>
<span class="sd">        y-coordinate of the first point (probability value).</span>
<span class="sd">    x2 : float</span>
<span class="sd">        x-coordinate of the second point.</span>
<span class="sd">    y2 : float</span>
<span class="sd">        y-coordinate of the second point (probability value).</span>
<span class="sd">    figsize : tuple of int, optional</span>
<span class="sd">        Figure size in inches (width, height), by default (10, 5).</span>
<span class="sd">    include_titles : bool, optional</span>
<span class="sd">        Whether to include axis labels and title, by default False.</span>
<span class="sd">    text_size : int, optional</span>
<span class="sd">        Font size for text elements, by default 14.</span>
<span class="sd">    media_file_path : str or Path, optional</span>
<span class="sd">        Path to save the plot image, by default None.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename for saving the plot. If not provided, uses a cleaned version of the title.</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        Whether to return the figure object instead of displaying it, by default False.</span>
<span class="sd">    annotate_points : bool, optional</span>
<span class="sd">        Whether to add coordinate annotations to the points, by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        The figure object if return_figure is True, otherwise None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function creates a curve between two points using the create_curve function</span>
<span class="sd">    and adds various visualization elements including grid lines, annotations,</span>
<span class="sd">    and optional titles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span><span class="p">,</span> <span class="n">lamda</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span> <span class="o">=</span> <span class="n">create_curve</span><span class="p">(</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">generate_values</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Plot the curve</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>  <span class="c1"># Mark the point (x1, y1)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>  <span class="c1"># Mark the point (x2, y2)</span>

    <span class="k">if</span> <span class="n">annotate_points</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">),</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">x2</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">),</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">text_size</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>

    <span class="n">x_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x_ticks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_titles</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Hours since admission&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability of admission by this point&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;y =</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x = 4 hours&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">media_file_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">clean_title_for_filename</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.calibration" class="doc doc-heading">
            <code>calibration</code>


</h3>

    <div class="doc doc-contents ">

        <p>Calibration plot visualization module.</p>
<p>This module creates calibration plots for trained models,
showing how well the predicted probabilities align with actual outcomes.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.calibration.plot_calibration : function">plot_calibration : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot calibration curves for multiple models</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.calibration.plot_calibration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_calibration</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot calibration curves for multiple models.</p>
<p>A calibration plot shows how well the predicted probabilities from a model
align with the actual outcomes. The plot compares the mean predicted probability
with the fraction of positive outcomes for different probability bins.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trained_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>] or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of TrainedClassifier objects or dictionary with TrainedClassifier values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing test visit data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to exclude from the test data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy</code>
            </td>
            <td>
                  <code>(<span title="uniform">uniform</span>, <span title="quantile">quantile</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy for calibration curve binning.
- 'uniform': Bins are of equal width
- 'quantile': Bins have equal number of samples</p>
              </div>
            </td>
            <td>
                  <code>&#39;uniform&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the plot should be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "calibration_plot.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional super title for the entire figure.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels.</p>
              </div>
            </td>
            <td>
                  <code>&#39;is_admitted&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_figure is True, returns the figure object. Otherwise, displays
the plot and returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function creates a subplot for each trained model, sorted by prediction time.
Each subplot shows the calibration curve and a reference line for perfect calibration.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/calibration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_calibration</span><span class="p">(</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
    <span class="n">test_visits</span><span class="p">,</span>
    <span class="n">exclude_from_training_data</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot calibration curves for multiple models.</span>

<span class="sd">    A calibration plot shows how well the predicted probabilities from a model</span>
<span class="sd">    align with the actual outcomes. The plot compares the mean predicted probability</span>
<span class="sd">    with the fraction of positive outcomes for different probability bins.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trained_models : list[TrainedClassifier] or dict[str, TrainedClassifier]</span>
<span class="sd">        List of TrainedClassifier objects or dictionary with TrainedClassifier values.</span>
<span class="sd">    test_visits : pandas.DataFrame</span>
<span class="sd">        DataFrame containing test visit data.</span>
<span class="sd">    exclude_from_training_data : list</span>
<span class="sd">        Columns to exclude from the test data.</span>
<span class="sd">    strategy : {&#39;uniform&#39;, &#39;quantile&#39;}, default=&#39;uniform&#39;</span>
<span class="sd">        Strategy for calibration curve binning.</span>
<span class="sd">        - &#39;uniform&#39;: Bins are of equal width</span>
<span class="sd">        - &#39;quantile&#39;: Bins have equal number of samples</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path where the plot should be saved.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;calibration_plot.png&quot;.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Optional super title for the entire figure.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it.</span>
<span class="sd">    label_col : str, default=&#39;is_admitted&#39;</span>
<span class="sd">        Name of the column containing the target labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        If return_figure is True, returns the figure object. Otherwise, displays</span>
<span class="sd">        the plot and returns None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function creates a subplot for each trained model, sorted by prediction time.</span>
<span class="sd">    Each subplot shows the calibration curve and a reference line for perfect calibration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict to list if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trained_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trained_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Sort trained_models by prediction time</span>
    <span class="n">trained_models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">trained_models</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Handle case of single prediction time</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">):</span>
        <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">trained_model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

        <span class="c1"># Get test data for this prediction time</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

        <span class="n">prob_true</span><span class="p">,</span> <span class="n">prob_pred</span> <span class="o">=</span> <span class="n">calibration_curve</span><span class="p">(</span>
            <span class="n">y_test</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span>
        <span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">prediction_time</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">prob_pred</span><span class="p">,</span>
            <span class="n">prob_true</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predictions&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">primary_color</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Perfectly calibrated&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">secondary_color</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibration Plot for </span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean Estimated Probability&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction of Positives&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Add suptitle if provided</span>
    <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">calib_plot_path</span> <span class="o">=</span> <span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calib_plot_path</span> <span class="o">=</span> <span class="n">media_file_path</span> <span class="o">/</span> <span class="s2">&quot;calibration_plot.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">calib_plot_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.data_distribution" class="doc doc-heading">
            <code>data_distribution</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualisation module for plotting data distributions.</p>
<p>This module provides functions for creating distribution plots of data variables
grouped by categories.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.data_distribution.plot_data_distribution : function">plot_data_distribution : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot distributions of data variables grouped by categories</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.data_distribution.plot_data_distribution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_data_distribution</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">,</span> <span class="n">grouping_var_name</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotate_x_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ordinal_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">truncate_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outlier_method</span><span class="o">=</span><span class="s1">&#39;zscore&#39;</span><span class="p">,</span> <span class="n">outlier_threshold</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot distributions of data variables grouped by categories.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input DataFrame containing the data to plot</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>col_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column to plot distributions for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column to group the data by</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Display name for the grouping variable</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_type</code>
            </td>
            <td>
                  <code>(<span title="both">both</span>, <span title="hist">hist</span>, <span title="kde">kde</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of plot to create. 'both' shows histogram with KDE, 'hist' shows
only histogram, 'kde' shows only KDE plot</p>
              </div>
            </td>
            <td>
                  <code>&#39;both&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title for the plot</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rotate_x_labels</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to rotate x-axis labels by 90 degrees</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_discrete</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the data is discrete</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ordinal_order</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Order of categories for ordinal data</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the plot should be saved</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "data_distributions.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>truncate_outliers</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to truncate the x-axis to exclude extreme outliers</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_method</code>
            </td>
            <td>
                  <code>(<span title="iqr">iqr</span>, <span title="zscore">zscore</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method to detect outliers. 'iqr' uses interquartile range, 'zscore' uses z-score</p>
              </div>
            </td>
            <td>
                  <code>&#39;iqr&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_threshold</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for outlier detection. For IQR method, this is the multiplier.
For z-score method, this is the number of standard deviations.</p>
              </div>
            </td>
            <td>
                  <code>1.5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="seaborn.FacetGrid">FacetGrid</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_figure is True, returns the FacetGrid object. Otherwise,
displays the plot and returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If plot_type is not one of 'both', 'hist', or 'kde'
If outlier_method is not one of 'iqr' or 'zscore'</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/data_distribution.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_data_distribution</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">col_name</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">,</span>
    <span class="n">grouping_var_name</span><span class="p">,</span>
    <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rotate_x_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">is_discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ordinal_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">truncate_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">outlier_method</span><span class="o">=</span><span class="s2">&quot;zscore&quot;</span><span class="p">,</span>
    <span class="n">outlier_threshold</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot distributions of data variables grouped by categories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing the data to plot</span>
<span class="sd">    col_name : str</span>
<span class="sd">        Name of the column to plot distributions for</span>
<span class="sd">    grouping_var : str</span>
<span class="sd">        Name of the column to group the data by</span>
<span class="sd">    grouping_var_name : str</span>
<span class="sd">        Display name for the grouping variable</span>
<span class="sd">    plot_type : {&#39;both&#39;, &#39;hist&#39;, &#39;kde&#39;}, default=&#39;both&#39;</span>
<span class="sd">        Type of plot to create. &#39;both&#39; shows histogram with KDE, &#39;hist&#39; shows</span>
<span class="sd">        only histogram, &#39;kde&#39; shows only KDE plot</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Title for the plot</span>
<span class="sd">    rotate_x_labels : bool, default=False</span>
<span class="sd">        Whether to rotate x-axis labels by 90 degrees</span>
<span class="sd">    is_discrete : bool, default=False</span>
<span class="sd">        Whether the data is discrete</span>
<span class="sd">    ordinal_order : list, optional</span>
<span class="sd">        Order of categories for ordinal data</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path where the plot should be saved</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;data_distributions.png&quot;.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it</span>
<span class="sd">    truncate_outliers : bool, default=True</span>
<span class="sd">        Whether to truncate the x-axis to exclude extreme outliers</span>
<span class="sd">    outlier_method : {&#39;iqr&#39;, &#39;zscore&#39;}, default=&#39;zscore&#39;</span>
<span class="sd">        Method to detect outliers. &#39;iqr&#39; uses interquartile range, &#39;zscore&#39; uses z-score</span>
<span class="sd">    outlier_threshold : float, default=1.5</span>
<span class="sd">        Threshold for outlier detection. For IQR method, this is the multiplier.</span>
<span class="sd">        For z-score method, this is the number of standard deviations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    seaborn.FacetGrid or None</span>
<span class="sd">        If return_figure is True, returns the FacetGrid object. Otherwise,</span>
<span class="sd">        displays the plot and returns None.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If plot_type is not one of &#39;both&#39;, &#39;hist&#39;, or &#39;kde&#39;</span>
<span class="sd">        If outlier_method is not one of &#39;iqr&#39; or &#39;zscore&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ordinal_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">ordinal_order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Calculate outlier bounds if truncation is requested</span>
    <span class="n">x_limits</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">truncate_outliers</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Check if data is actually discrete (all values are integers)</span>
            <span class="n">is_actually_discrete</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">round</span><span class="p">())</span>

            <span class="c1"># Apply outlier truncation to continuous data OR discrete data with outliers</span>
            <span class="c1"># For discrete data, we still want to truncate if there are extreme outliers</span>
            <span class="k">if</span> <span class="n">outlier_method</span> <span class="o">==</span> <span class="s2">&quot;iqr&quot;</span><span class="p">:</span>
                <span class="n">Q1</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="n">Q3</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
                <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
                <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="n">outlier_threshold</span> <span class="o">*</span> <span class="n">IQR</span>
                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="n">outlier_threshold</span> <span class="o">*</span> <span class="n">IQR</span>
            <span class="k">elif</span> <span class="n">outlier_method</span> <span class="o">==</span> <span class="s2">&quot;zscore&quot;</span><span class="p">:</span>
                <span class="n">mean_val</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">std_val</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">mean_val</span> <span class="o">-</span> <span class="n">outlier_threshold</span> <span class="o">*</span> <span class="n">std_val</span>
                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">mean_val</span> <span class="o">+</span> <span class="n">outlier_threshold</span> <span class="o">*</span> <span class="n">std_val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid outlier_method. Choose from &#39;iqr&#39; or &#39;zscore&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Only apply truncation if there are actual outliers</span>
            <span class="c1"># For discrete data, ensure lower bound is at least 0</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">lower_bound</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_actually_discrete</span><span class="p">:</span>
                    <span class="c1"># For discrete data, ensure bounds are reasonable</span>
                    <span class="n">lower_bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lower_bound</span><span class="p">)</span>
                <span class="n">x_limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_discrete</span><span class="p">:</span>
        <span class="n">valid_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>
        <span class="n">min_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_val</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Handle numeric data</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">round</span><span class="p">()):</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)))))</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">n_bins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>

    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;hist&quot;</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;kde&quot;</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid plot_type. Choose from &#39;both&#39;, &#39;hist&#39;, or &#39;kde&#39;.&quot;</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span>
        <span class="n">col_name</span><span class="p">,</span> <span class="s2">&quot;Frequency&quot;</span> <span class="k">if</span> <span class="n">plot_type</span> <span class="o">!=</span> <span class="s2">&quot;kde&quot;</span> <span class="k">else</span> <span class="s2">&quot;Density&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>

    <span class="c1"># Set facet titles with smaller font</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_titles</span><span class="p">(</span><span class="n">col_template</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">: </span><span class="se">{{</span><span class="s2">col_name</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="c1"># Add thousands separators to y-axis</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">rotate_x_labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_discrete</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="c1"># Apply outlier truncation if available, otherwise use default discrete limits</span>
            <span class="k">if</span> <span class="n">x_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Ensure discrete limits are reasonable: min ≥ 0, max ≥ 1, and use integers</span>
                <span class="n">lower_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">upper_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># Round up to ensure we include the max value</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lower_limit</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">upper_limit</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ensure default discrete limits are reasonable: min ≥ 0, max ≥ 1</span>
                <span class="c1"># Use the actual min/max values to center the bars properly</span>
                <span class="n">lower_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_val</span><span class="p">)</span>
                <span class="n">upper_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lower_limit</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">upper_limit</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Apply outlier truncation to x-axis</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_limits</span><span class="p">)</span>
            <span class="c1"># Ensure integer tick marks for numeric data with outliers</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Let matplotlib auto-scale the x-axis</span>
        <span class="k">pass</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.80</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Distribution of </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">grouping_var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;data_distributions.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.epudd" class="doc doc-heading">
            <code>epudd</code>


</h3>

    <div class="doc doc-contents ">

        <p>Generate plots comparing observed values with model predictions for discrete distributions.</p>
<p>An Evaluating Predictions for Unique, Discrete, Distributions (EPUDD) plot displays the
model's predicted CDF values alongside the actual observed values'
positions within their predicted CDF intervals. For discrete distributions, each predicted
value has an associated probability, and the CDF is calculated by sorting the values and
computing cumulative probabilities.</p>
<p>The plot can show three possible positions for each observation within its predicted interval:</p>
<pre><code>* lower bound of the interval
* midpoint of the interval
* upper bound of the interval
</code></pre>
<p>By default, the plot only shows the midpoint of the interval.</p>
<p>For a well-calibrated model, the observed values should fall within their predicted
intervals, with the distribution of positions showing appropriate uncertainty.</p>
<p>The visualisation helps assess model calibration by comparing:
1. The predicted cumulative distribution function (CDF) values
2. The actual positions of observations within their predicted intervals
3. The spread and distribution of these positions</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.epudd.plot_epudd : function">plot_epudd : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generates and plots the comparison of model predictions with observed values.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.epudd.plot_epudd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_epudd</span><span class="p">(</span><span class="n">prediction_times</span><span class="p">,</span> <span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_all_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generates plots comparing model predictions with observed values for discrete distributions.</p>
<p>For discrete distributions, each predicted value has an associated probability. The CDF
is calculated by sorting the values and computing cumulative probabilities, normalized
by the number of time points.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code>list of tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (hour, minute) tuples representing times for which predictions were made.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of probability distributions keyed by model_key. Each entry contains
information about predicted distributions and observed values for different
snapshot dates. The predicted distributions should be discrete probability mass
functions, with each value having an associated probability.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base name of the model to construct model keys, by default "admissions".</p>
              </div>
            </td>
            <td>
                  <code>&#39;admissions&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure object instead of displaying it, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_dataframe</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns a dictionary of observation dataframes by model_key, by default False.
The dataframes contain the merged observation and prediction data for analysis.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code>tuple of (float, float)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the figure in inches as (width, height). If None, calculated automatically
based on number of plots, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Super title for the entire figure, displayed above all subplots, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot, by default None. If provided, saves the plot as a PNG file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "plot_epudd.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_all_bounds</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, plots all bounds (lower, mid, upper). If False, only plots mid bounds.
By default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure object containing the plots, if return_figure is True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of observation dataframes by model_key, if return_dataframe is True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (figure, dataframes_dict) if both return_figure and return_dataframe are True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If neither return_figure nor return_dataframe is True, displays the plots and returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>For discrete distributions, the CDF is calculated by:</p>
<pre><code>1. Sorting the predicted values
2. Computing cumulative probabilities for each value
3. Normalizing by the number of time points
</code></pre>
<p>The plot shows three possible positions for each observation:</p>
<pre><code>* lower_cdf (pink): Uses the lower bound of the CDF interval
* mid_cdf (green): Uses the midpoint of the CDF interval
* upper_cdf (light blue): Uses the upper bound of the CDF interval
</code></pre>
<p>The black points represent the model's predicted CDF values, calculated from the sorted
values and their associated probabilities, while the colored points show where the actual
observations fall within their predicted intervals. For a well-calibrated model, the
observed values should fall within their predicted intervals, with the distribution of
positions showing appropriate uncertainty.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/epudd.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_epudd</span><span class="p">(</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_all_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">Figure</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]],</span> <span class="kc">None</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates plots comparing model predictions with observed values for discrete distributions.</span>

<span class="sd">    For discrete distributions, each predicted value has an associated probability. The CDF</span>
<span class="sd">    is calculated by sorting the values and computing cumulative probabilities, normalized</span>
<span class="sd">    by the number of time points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_times : list of tuple</span>
<span class="sd">        List of (hour, minute) tuples representing times for which predictions were made.</span>
<span class="sd">    prob_dist_dict_all : dict</span>
<span class="sd">        Dictionary of probability distributions keyed by model_key. Each entry contains</span>
<span class="sd">        information about predicted distributions and observed values for different</span>
<span class="sd">        snapshot dates. The predicted distributions should be discrete probability mass</span>
<span class="sd">        functions, with each value having an associated probability.</span>
<span class="sd">    model_name : str, optional</span>
<span class="sd">        Base name of the model to construct model keys, by default &quot;admissions&quot;.</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        If True, returns the figure object instead of displaying it, by default False.</span>
<span class="sd">    return_dataframe : bool, optional</span>
<span class="sd">        If True, returns a dictionary of observation dataframes by model_key, by default False.</span>
<span class="sd">        The dataframes contain the merged observation and prediction data for analysis.</span>
<span class="sd">    figsize : tuple of (float, float), optional</span>
<span class="sd">        Size of the figure in inches as (width, height). If None, calculated automatically</span>
<span class="sd">        based on number of plots, by default None.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Super title for the entire figure, displayed above all subplots, by default None.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path to save the plot, by default None. If provided, saves the plot as a PNG file.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;plot_epudd.png&quot;.</span>
<span class="sd">    plot_all_bounds : bool, optional</span>
<span class="sd">        If True, plots all bounds (lower, mid, upper). If False, only plots mid bounds.</span>
<span class="sd">        By default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure</span>
<span class="sd">        The figure object containing the plots, if return_figure is True.</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of observation dataframes by model_key, if return_dataframe is True.</span>
<span class="sd">    tuple</span>
<span class="sd">        Tuple of (figure, dataframes_dict) if both return_figure and return_dataframe are True.</span>
<span class="sd">    None</span>
<span class="sd">        If neither return_figure nor return_dataframe is True, displays the plots and returns None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    For discrete distributions, the CDF is calculated by:</span>

<span class="sd">        1. Sorting the predicted values</span>
<span class="sd">        2. Computing cumulative probabilities for each value</span>
<span class="sd">        3. Normalizing by the number of time points</span>

<span class="sd">    The plot shows three possible positions for each observation:</span>

<span class="sd">        * lower_cdf (pink): Uses the lower bound of the CDF interval</span>
<span class="sd">        * mid_cdf (green): Uses the midpoint of the CDF interval</span>
<span class="sd">        * upper_cdf (light blue): Uses the upper bound of the CDF interval</span>

<span class="sd">    The black points represent the model&#39;s predicted CDF values, calculated from the sorted</span>
<span class="sd">    values and their associated probabilities, while the colored points show where the actual</span>
<span class="sd">    observations fall within their predicted intervals. For a well-calibrated model, the</span>
<span class="sd">    observed values should fall within their predicted intervals, with the distribution of</span>
<span class="sd">    positions showing appropriate uncertainty.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort prediction times by converting to minutes since midnight</span>
    <span class="n">prediction_times_sorted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Calculate figure parameters</span>
    <span class="n">num_plots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">)</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Create subplot layout</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">Figure</span>
    <span class="n">axs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axs</span>

    <span class="c1"># Define plotting types and colors</span>
    <span class="n">all_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">]</span>
    <span class="n">plot_types</span> <span class="o">=</span> <span class="n">all_types</span> <span class="k">if</span> <span class="n">plot_all_bounds</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]</span>
    <span class="n">colors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF1493&quot;</span><span class="p">,</span>  <span class="c1"># deeppink</span>
        <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="s2">&quot;#228B22&quot;</span><span class="p">,</span>  <span class="c1"># chartreuse4/forest green</span>
        <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="s2">&quot;#ADD8E6&quot;</span><span class="p">,</span>  <span class="c1"># lightblue</span>
    <span class="p">}</span>

    <span class="n">all_obs_dfs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process each subplot</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prediction_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">):</span>
        <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>
        <span class="n">prob_dist_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">prob_dist_dict</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Create distribution and observation dataframes</span>
        <span class="n">all_distributions</span> <span class="o">=</span> <span class="n">_create_distribution_records</span><span class="p">(</span><span class="n">prob_dist_dict</span><span class="p">,</span> <span class="n">all_types</span><span class="p">)</span>
        <span class="n">distr_coll</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_distributions</span><span class="p">)</span>

        <span class="n">all_observations</span> <span class="o">=</span> <span class="n">_create_observation_records</span><span class="p">(</span><span class="n">prob_dist_dict</span><span class="p">)</span>
        <span class="n">adm_coll</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_observations</span><span class="p">)</span>

        <span class="c1"># For each actual observation, find its position in the predicted CDF</span>
        <span class="c1"># by matching datetime and admission count to get lower/mid/upper bounds</span>
        <span class="n">merged_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">adm_coll</span><span class="p">,</span>
            <span class="n">distr_coll</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;num_adm_pred&quot;</span><span class="p">:</span> <span class="s2">&quot;num_adm&quot;</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">_predicted_cdf&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">_observed_cdf&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_types</span><span class="p">},</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;num_adm&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">all_obs_dfs</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">num_time_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob_dist_dict</span><span class="p">)</span>

        <span class="c1"># Plot predictions and observations</span>
        <span class="n">_plot_predictions</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">distr_coll</span><span class="p">,</span> <span class="n">num_time_points</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">)</span>
        <span class="n">_plot_observations</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged_df</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">_setup_subplot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Final plot configuration</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;plot_epudd.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="c1"># Return based on flags</span>
    <span class="k">if</span> <span class="n">return_figure</span> <span class="ow">and</span> <span class="n">return_dataframe</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">all_obs_dfs</span>
    <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">return_dataframe</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_obs_dfs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.estimated_probabilities" class="doc doc-heading">
            <code>estimated_probabilities</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualization module for plotting estimated probabilities from trained models.</p>
<p>This module provides functions for creating distribution plots of estimated
probabilities from trained classification models.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.estimated_probabilities.plot_estimated_probabilities : function">plot_estimated_probabilities : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot estimated probability distributions for multiple models</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.estimated_probabilities.plot_estimated_probabilities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_estimated_probabilities</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot estimated probability distributions for multiple models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trained_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>] or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of TrainedClassifier objects or dict with TrainedClassifier values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing test visit data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to exclude from the test data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bins</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins for the histograms</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the plot should be saved</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "estimated_probabilities.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional super title for the entire figure</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels</p>
              </div>
            </td>
            <td>
                  <code>&#34;is_admitted&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_figure is True, returns the figure object. Otherwise, displays
the plot and returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/estimated_probabilities.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_estimated_probabilities</span><span class="p">(</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
    <span class="n">test_visits</span><span class="p">,</span>
    <span class="n">exclude_from_training_data</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot estimated probability distributions for multiple models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trained_models : list[TrainedClassifier] or dict[str, TrainedClassifier]</span>
<span class="sd">        List of TrainedClassifier objects or dict with TrainedClassifier values</span>
<span class="sd">    test_visits : pandas.DataFrame</span>
<span class="sd">        DataFrame containing test visit data</span>
<span class="sd">    exclude_from_training_data : list</span>
<span class="sd">        Columns to exclude from the test data</span>
<span class="sd">    bins : int, default=30</span>
<span class="sd">        Number of bins for the histograms</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path where the plot should be saved</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;estimated_probabilities.png&quot;.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Optional super title for the entire figure</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it</span>
<span class="sd">    label_col : str, default=&quot;is_admitted&quot;</span>
<span class="sd">        Name of the column containing the target labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        If return_figure is True, returns the figure object. Otherwise, displays</span>
<span class="sd">        the plot and returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict to list if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trained_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trained_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Sort trained_models by prediction time</span>
    <span class="n">trained_models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">trained_models</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Handle case of single prediction time</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">):</span>
        <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">trained_model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

        <span class="c1"># Get test data for this prediction time</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

        <span class="c1"># Get predictions</span>
        <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Separate predictions for positive and negative cases</span>
        <span class="n">pos_preds</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">neg_preds</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">prediction_time</span>

        <span class="c1"># Plot distributions</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">neg_preds</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">primary_color</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Negative Cases&quot;</span><span class="p">,</span>
            <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">pos_preds</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">secondary_color</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Positive Cases&quot;</span><span class="p">,</span>
            <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Optional: Fill with lower opacity</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">neg_preds</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">primary_color</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">pos_preds</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">secondary_color</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Distribution of Estimated Probabilities at </span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Estimated Probability&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Add suptitle if provided</span>
    <span class="k">if</span> <span class="n">suptitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;estimated_probabilities.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.features" class="doc doc-heading">
            <code>features</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualisation module for plotting feature importances from trained models.</p>
<p>This module provides functionality to visualize feature importances from trained
classifiers, allowing for comparison across different prediction time points.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.features.plot_features : function">plot_features : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot feature importance for multiple models</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.features.plot_features" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_features</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot feature importance for multiple models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trained_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>] or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of TrainedClassifier objects or dictionary with TrainedClassifier values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the plot should be saved. If None, the plot is only displayed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "feature_importance_plots.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_n</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of top features to display.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Super title for the entire figure.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.pyplot.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The matplotlib figure if return_figure is True, otherwise None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function sorts models by prediction time and creates a horizontal bar plot
for each model showing the top N most important features. Feature names are
truncated to 25 characters for better display.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/features.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_features</span><span class="p">(</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot feature importance for multiple models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trained_models : list[TrainedClassifier] or dict[str, TrainedClassifier]</span>
<span class="sd">        List of TrainedClassifier objects or dictionary with TrainedClassifier values.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path where the plot should be saved. If None, the plot is only displayed.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;feature_importance_plots.png&quot;.</span>
<span class="sd">    top_n : int, default=20</span>
<span class="sd">        Number of top features to display.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Super title for the entire figure.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Figure or None</span>
<span class="sd">        The matplotlib figure if return_figure is True, otherwise None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function sorts models by prediction time and creates a horizontal bar plot</span>
<span class="sd">    for each model showing the top N most important features. Feature names are</span>
<span class="sd">    truncated to 25 characters for better display.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict to list if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trained_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trained_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Sort trained_models by prediction time</span>
    <span class="n">trained_models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">trained_models</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># Handle case of single prediction time</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">):</span>
        <span class="c1"># Always use regular pipeline</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>
        <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

        <span class="c1"># Get feature names from the pipeline</span>
        <span class="n">transformed_cols</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
            <span class="s2">&quot;feature_transformer&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
        <span class="n">transformed_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">transformed_cols</span><span class="p">]</span>
        <span class="n">truncated_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[:</span><span class="mi">25</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">transformed_cols</span><span class="p">]</span>

        <span class="c1"># Get feature importances</span>
        <span class="n">feature_importances</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">feature_importances</span><span class="p">)[</span>
            <span class="o">-</span><span class="n">top_n</span><span class="p">:</span>
        <span class="p">]</span>  <span class="c1"># Get indices of the top N features</span>

        <span class="c1"># Plot for this prediction time</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">prediction_time</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="n">feature_importances</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">truncated_cols</span><span class="p">)[</span><span class="n">indices</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Importance&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Features&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature Importances for </span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Add suptitle if provided</span>
    <span class="k">if</span> <span class="n">suptitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="c1"># Save and display plot</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">feature_plot_path</span> <span class="o">=</span> <span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_plot_path</span> <span class="o">=</span> <span class="n">media_file_path</span> <span class="o">/</span> <span class="s2">&quot;feature_importance_plots.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">feature_plot_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.madcap" class="doc doc-heading">
            <code>madcap</code>


</h3>

    <div class="doc doc-contents ">

        <p>Module for generating MADCAP (Model Accuracy and Discriminative Calibration Plots) visualizations.</p>
<p>MADCAP plots compare model-predicted probabilities to observed outcomes, helping to assess
model calibration and discrimination. The plots can be generated for individual
prediction times or for specific groups (e.g., age groups).</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.madcap.classify_age : function">classify_age : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Classifies age into categories based on numeric values or age group strings.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.madcap.plot_madcap : function">plot_madcap : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generates MADCAP plots for a list of trained models, comparing estimated probabilities
to observed values.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.madcap._plot_madcap_subplot : function">_plot_madcap_subplot : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plots a single MADCAP subplot showing cumulative predicted and observed values.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.madcap._plot_madcap_by_group_single : function">_plot_madcap_by_group_single : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generates MADCAP plots for specific groups at a given prediction time.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="plot_madcap_by_group(trained_models, test_visits, exclude_from_training_data, grouping_var, grouping_var_name, media_file_path=None, file_name=None, plot_difference=False, return_figure=False, label_col='is_admitted') (patientflow.viz.madcap.plot_madcap_by_group)" href="#patientflow.viz.madcap.plot_madcap_by_group">plot_madcap_by_group</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generates MADCAP plots for groups (e.g., age groups) across a series of prediction times.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.madcap.classify_age" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">classify_age</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">age_categories</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Classify age into categories based on numeric values or age group strings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>age</code>
            </td>
            <td>
                  <code>int, float, or str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Age value (e.g., 30) or age group string (e.g., '18-24').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>age_categories</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary defining age categories and their ranges. If not provided, uses DEFAULT_AGE_CATEGORIES.
Expected format:
{
    "category_name": {
        "numeric": {"min": min_age, "max": max_age},
        "groups": ["age_group1", "age_group2", ...]
    }
}</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Category name based on the age or age group, or 'unknown' for unexpected or invalid values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">classify_age</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="go">&#39;adults&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">classify_age</span><span class="p">(</span><span class="s1">&#39;65-74&#39;</span><span class="p">)</span>
<span class="go">&#39;65 or over&#39;</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/madcap.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">classify_age</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">age_categories</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Classify age into categories based on numeric values or age group strings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    age : int, float, or str</span>
<span class="sd">        Age value (e.g., 30) or age group string (e.g., &#39;18-24&#39;).</span>
<span class="sd">    age_categories : dict, optional</span>
<span class="sd">        Dictionary defining age categories and their ranges. If not provided, uses DEFAULT_AGE_CATEGORIES.</span>
<span class="sd">        Expected format:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;category_name&quot;: {</span>
<span class="sd">                &quot;numeric&quot;: {&quot;min&quot;: min_age, &quot;max&quot;: max_age},</span>
<span class="sd">                &quot;groups&quot;: [&quot;age_group1&quot;, &quot;age_group2&quot;, ...]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Category name based on the age or age group, or &#39;unknown&#39; for unexpected or invalid values.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; classify_age(25)</span>
<span class="sd">    &#39;adults&#39;</span>
<span class="sd">    &gt;&gt;&gt; classify_age(&#39;65-74&#39;)</span>
<span class="sd">    &#39;65 or over&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">age_categories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">age_categories</span> <span class="o">=</span> <span class="n">DEFAULT_AGE_CATEGORIES</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">age_categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">numeric_rules</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;numeric&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">min_age</span> <span class="o">=</span> <span class="n">numeric_rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">))</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="n">numeric_rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">min_age</span> <span class="o">&lt;=</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="n">max_age</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">category</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">age_categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;groups&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">return</span> <span class="n">category</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.madcap.plot_madcap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_madcap</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate MADCAP plots for a list of trained models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trained_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>] or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trained classifier objects or dictionary with TrainedClassifier values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing test visit data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of columns to exclude from training data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where the generated plots will be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "madcap_plot.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suptitle for the plot.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure object instead of displaying it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels.</p>
              </div>
            </td>
            <td>
                  <code>&#34;is_admitted&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<span title="matplotlib.pyplot.Figure">Figure</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure if return_figure is True, None otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/madcap.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_madcap</span><span class="p">(</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">exclude_from_training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate MADCAP plots for a list of trained models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trained_models : list[TrainedClassifier] or dict[str, TrainedClassifier]</span>
<span class="sd">        List of trained classifier objects or dictionary with TrainedClassifier values.</span>
<span class="sd">    test_visits : pd.DataFrame</span>
<span class="sd">        DataFrame containing test visit data.</span>
<span class="sd">    exclude_from_training_data : List[str]</span>
<span class="sd">        List of columns to exclude from training data.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Directory path where the generated plots will be saved.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;madcap_plot.png&quot;.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Suptitle for the plot.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure object instead of displaying it.</span>
<span class="sd">    label_col : str, default=&quot;is_admitted&quot;</span>
<span class="sd">        Name of the column containing the target labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Optional[plt.Figure]</span>
<span class="sd">        The figure if return_figure is True, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict to list if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trained_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trained_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Sort trained_models by prediction time</span>
    <span class="n">trained_models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">trained_models</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">)</span>

    <span class="c1"># Calculate the number of rows and columns for the subplots</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_plots</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Maximum 5 columns</span>
    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">/</span> <span class="n">num_cols</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Handle the case of a single plot differently</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># When there&#39;s only one plot, axes is a single Axes object, not an array</span>
        <span class="n">trained_model</span> <span class="o">=</span> <span class="n">trained_models_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">trained_model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

        <span class="c1"># Get test data for this prediction time</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
        <span class="n">predict_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Plot directly on the single axes</span>
        <span class="n">_plot_madcap_subplot</span><span class="p">(</span><span class="n">predict_proba</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For multiple plots, ensure axes is always a 2D array</span>
        <span class="k">if</span> <span class="n">num_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trained_models_sorted</span><span class="p">):</span>
            <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">trained_model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>

            <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

            <span class="c1"># Get test data for this prediction time</span>
            <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
                <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
                <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_from_training_data</span><span class="p">,</span>
                <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">X_test</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
            <span class="n">predict_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">num_cols</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">num_cols</span>
            <span class="n">_plot_madcap_subplot</span><span class="p">(</span><span class="n">predict_proba</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>

        <span class="c1"># Hide any unused subplots</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_rows</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">j</span> <span class="o">//</span> <span class="n">num_cols</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">j</span> <span class="o">%</span> <span class="n">num_cols</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Add suptitle if provided</span>
    <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
        <span class="c1"># Adjust layout to accommodate suptitle</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">plot_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="k">if</span> <span class="n">file_name</span> <span class="k">else</span> <span class="s2">&quot;madcap_plot.png&quot;</span>
        <span class="n">madcap_plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">media_file_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">plot_name</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">madcap_plot_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.madcap.plot_madcap_by_group" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_madcap_by_group</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">,</span> <span class="n">grouping_var_name</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_difference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate MADCAP plots for different groups across multiple prediction times.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trained_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>] or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trained classifier objects or dictionary with TrainedClassifier values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing the test visit data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of columns to exclude from training data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The column name in the dataset that defines the grouping variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grouping_var_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A descriptive name for the grouping variable, used in plot titles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where the generated plots will be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to a generated name based on group and time.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_difference</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, includes difference plot between predicted and observed outcomes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns a list of figure objects instead of displaying them.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels.</p>
              </div>
            </td>
            <td>
                  <code>&#34;is_admitted&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<span title="matplotlib.pyplot.Figure">Figure</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of figures if return_figure is True, None otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/madcap.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_madcap_by_group</span><span class="p">(</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
    <span class="n">test_visits</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">exclude_from_training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_difference</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate MADCAP plots for different groups across multiple prediction times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trained_models : list[TrainedClassifier] or dict[str, TrainedClassifier]</span>
<span class="sd">        List of trained classifier objects or dictionary with TrainedClassifier values.</span>
<span class="sd">    test_visits : pd.DataFrame</span>
<span class="sd">        DataFrame containing the test visit data.</span>
<span class="sd">    exclude_from_training_data : List[str]</span>
<span class="sd">        List of columns to exclude from training data.</span>
<span class="sd">    grouping_var : str</span>
<span class="sd">        The column name in the dataset that defines the grouping variable.</span>
<span class="sd">    grouping_var_name : str</span>
<span class="sd">        A descriptive name for the grouping variable, used in plot titles.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Directory path where the generated plots will be saved.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to a generated name based on group and time.</span>
<span class="sd">    plot_difference : bool, default=False</span>
<span class="sd">        If True, includes difference plot between predicted and observed outcomes.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns a list of figure objects instead of displaying them.</span>
<span class="sd">    label_col : str, default=&quot;is_admitted&quot;</span>
<span class="sd">        Name of the column containing the target labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Optional[List[plt.Figure]]</span>
<span class="sd">        List of figures if return_figure is True, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict to list if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trained_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trained_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Sort trained_models by prediction time</span>
    <span class="n">trained_models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">trained_models</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">figures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="n">trained_models_sorted</span><span class="p">:</span>
        <span class="c1"># Use calibrated pipeline if available, otherwise use regular pipeline</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">trained_model</span><span class="p">,</span> <span class="s2">&quot;calibrated_pipeline&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">calibrated_pipeline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

        <span class="c1"># Get test data for this prediction time</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check if the grouping variable exists in X_test columns</span>
        <span class="k">if</span> <span class="n">grouping_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&#39; not found in the dataset columns.&quot;</span><span class="p">)</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
        <span class="n">predict_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Apply classification based on the grouping variable</span>
        <span class="k">if</span> <span class="n">grouping_var</span> <span class="o">==</span> <span class="s2">&quot;age_group&quot;</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">classify_age</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">grouping_var</span> <span class="o">==</span> <span class="s2">&quot;age_on_arrival&quot;</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s2">&quot;age_on_arrival&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">classify_age</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plot_madcap_by_group_single</span><span class="p">(</span>
            <span class="n">predict_proba</span><span class="p">,</span>
            <span class="n">y_test</span><span class="p">,</span>
            <span class="n">group</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">grouping_var_name</span><span class="p">,</span>
            <span class="n">media_file_path</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
            <span class="n">plot_difference</span><span class="o">=</span><span class="n">plot_difference</span><span class="p">,</span>
            <span class="n">return_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
            <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">figures</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.observed_against_expected" class="doc doc-heading">
            <code>observed_against_expected</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualisation utilities for evaluating patient flow predictions.</p>
<p>This module provides functions for creating visualizations to evaluate the accuracy
and performance of patient flow predictions, particularly focusing on comparing
observed versus expected values.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.observed_against_expected.plot_deltas : function">plot_deltas : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot histograms of observed minus expected values</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.observed_against_expected.plot_arrival_delta_single_instance : function">plot_arrival_delta_single_instance : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot comparison between observed arrivals and expected arrival rates</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.observed_against_expected.plot_arrival_deltas : function">plot_arrival_deltas : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot delta charts for multiple snapshot dates on the same figure</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.observed_against_expected.plot_arrival_delta_single_instance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_arrival_delta_single_instance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">snapshot_date</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span> <span class="n">show_delta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_only_delta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot comparison between observed arrivals and expected arrival rates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing arrival data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(hour, minute) of prediction time</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>snapshot_date</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Date to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window in minutes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_delta</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, plot the difference between actual and expected arrivals</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_only_delta</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only plot the delta between actual and expected arrivals</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in minutes for calculating arrival rates</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "arrival_comparison.png"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fig_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height) in inches</p>
              </div>
            </td>
            <td>
                  <code>(10, 4)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure object if return_figure is True, otherwise None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/observed_against_expected.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_arrival_delta_single_instance</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">snapshot_date</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
    <span class="n">show_delta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_only_delta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot comparison between observed arrivals and expected arrival rates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame containing arrival data</span>
<span class="sd">    prediction_time : tuple</span>
<span class="sd">        (hour, minute) of prediction time</span>
<span class="sd">    snapshot_date : datetime.date</span>
<span class="sd">        Date to analyze</span>
<span class="sd">    prediction_window : int</span>
<span class="sd">        Prediction window in minutes</span>
<span class="sd">    show_delta : bool, default=True</span>
<span class="sd">        If True, plot the difference between actual and expected arrivals</span>
<span class="sd">    show_only_delta : bool, default=False</span>
<span class="sd">        If True, only plot the delta between actual and expected arrivals</span>
<span class="sd">    yta_time_interval : int, default=15</span>
<span class="sd">        Time interval in minutes for calculating arrival rates</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path to save the plot</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;arrival_comparison.png&quot;</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it</span>
<span class="sd">    fig_size : tuple, default=(10, 4)</span>
<span class="sd">        Figure size as (width, height) in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        The figure object if return_figure is True, otherwise None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare data</span>
    <span class="n">df_copy</span><span class="p">,</span> <span class="n">snapshot_datetime</span><span class="p">,</span> <span class="n">default_datetime</span><span class="p">,</span> <span class="n">prediction_time_obj</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_prepare_arrival_data</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">snapshot_date</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get arrivals within the prediction window</span>
    <span class="n">arrivals</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df_copy</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_copy</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span> <span class="o">+</span> <span class="n">prediction_window</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Sort arrivals by time and create cumulative count</span>
    <span class="n">arrivals</span> <span class="o">=</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">)</span>
    <span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate arrival rates and prepare time points</span>
    <span class="n">mean_arrival_rates</span> <span class="o">=</span> <span class="n">_calculate_arrival_rates</span><span class="p">(</span>
        <span class="n">df_copy</span><span class="p">,</span> <span class="n">prediction_time_obj</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span>
    <span class="p">)</span>

    <span class="c1"># Prepare arrival times</span>
    <span class="n">arrival_times_piecewise</span> <span class="o">=</span> <span class="n">_prepare_arrival_times</span><span class="p">(</span>
        <span class="n">mean_arrival_rates</span><span class="p">,</span> <span class="n">prediction_time_obj</span><span class="p">,</span> <span class="n">default_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Calculate cumulative rates</span>
    <span class="n">cumulative_rates</span> <span class="o">=</span> <span class="n">_calculate_cumulative_rates</span><span class="p">(</span>
        <span class="n">arrival_times_piecewise</span><span class="p">,</span> <span class="n">mean_arrival_rates</span>
    <span class="p">)</span>

    <span class="c1"># Create figure with subplots if showing delta</span>
    <span class="k">if</span> <span class="n">show_delta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">show_only_delta</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fig_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># Ensure arrivals index is timezone-aware</span>
    <span class="k">if</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arrivals</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>

    <span class="c1"># Convert arrival times to use default date for plotting</span>
    <span class="n">arrival_times_plot</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">default_datetime</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">snapshot_datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">index</span>
    <span class="p">]</span>

    <span class="c1"># Create combined timeline</span>
    <span class="n">all_times</span> <span class="o">=</span> <span class="n">_create_combined_timeline</span><span class="p">(</span>
        <span class="n">default_datetime</span><span class="p">,</span> <span class="n">arrival_times_plot</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">arrival_times_piecewise</span>
    <span class="p">)</span>

    <span class="c1"># Interpolate both actual and expected to the combined timeline</span>
    <span class="n">actual_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
        <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">default_datetime</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">arrival_times_plot</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">default_datetime</span> <span class="o">+</span> <span class="n">prediction_window</span><span class="p">]</span>
        <span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">])</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">expected_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
        <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">],</span>
        <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arrival_times_piecewise</span><span class="p">],</span>
        <span class="n">cumulative_rates</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Calculate delta</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">actual_counts</span> <span class="o">-</span> <span class="n">expected_counts</span>
    <span class="n">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Ensure delta starts at 0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">show_only_delta</span><span class="p">:</span>
        <span class="c1"># Plot actual and expected arrivals</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
            <span class="p">[</span><span class="n">default_datetime</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">arrival_times_plot</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">default_datetime</span> <span class="o">+</span> <span class="n">prediction_window</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">])</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual Arrivals&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">arrival_times_piecewise</span><span class="p">,</span>
            <span class="n">cumulative_rates</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected Arrivals&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cumulative Arrivals in the </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span><span class="si">}</span><span class="s2"> hours after </span><span class="si">{</span><span class="n">format_prediction_time</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">)</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">snapshot_date</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">show_delta</span> <span class="ow">or</span> <span class="n">show_only_delta</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show_only_delta</span><span class="p">:</span>
            <span class="n">_plot_arrival_delta_chart</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span> <span class="n">all_times</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">snapshot_date</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_plot_arrival_delta_chart</span><span class="p">(</span>
                <span class="n">ax2</span><span class="p">,</span> <span class="n">all_times</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">snapshot_date</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Format time axis for all subplots</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">get_axes</span><span class="p">():</span>
        <span class="n">_format_time_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">all_times</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span> <span class="k">if</span> <span class="n">file_name</span> <span class="k">else</span> <span class="s2">&quot;arrival_comparison.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.observed_against_expected.plot_arrival_deltas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_arrival_deltas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">snapshot_dates</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot delta charts for multiple snapshot dates on the same figure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing arrival data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(hour, minute) of prediction time</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>snapshot_dates</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of datetime.date objects to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_window</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.timedelta" href="https://docs.python.org/3/library/datetime.html#datetime.timedelta">timedelta</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prediction window in minutes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yta_time_interval</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in minutes for calculating arrival rates</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "multiple_deltas.png"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fig_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height) in inches</p>
              </div>
            </td>
            <td>
                  <code>(15, 6)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure object if return_figure is True, otherwise None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/observed_against_expected.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_arrival_deltas</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">snapshot_dates</span><span class="p">,</span>
    <span class="n">prediction_window</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
    <span class="n">yta_time_interval</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot delta charts for multiple snapshot dates on the same figure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame containing arrival data</span>
<span class="sd">    prediction_time : tuple</span>
<span class="sd">        (hour, minute) of prediction time</span>
<span class="sd">    snapshot_dates : list</span>
<span class="sd">        List of datetime.date objects to analyze</span>
<span class="sd">    prediction_window : timedelta</span>
<span class="sd">        Prediction window in minutes</span>
<span class="sd">    yta_time_interval : int, default=15</span>
<span class="sd">        Time interval in minutes for calculating arrival rates</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path to save the plot</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;multiple_deltas.png&quot;</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it</span>
<span class="sd">    fig_size : tuple, default=(15, 6)</span>
<span class="sd">        Figure size as (width, height) in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        The figure object if return_figure is True, otherwise None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create figure with subplots</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Store all deltas for averaging</span>
    <span class="n">all_deltas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_times_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">final_deltas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store final delta values for histogram</span>

    <span class="c1"># Calculate common values once</span>
    <span class="n">prediction_time_obj</span><span class="p">,</span> <span class="n">default_datetime</span> <span class="o">=</span> <span class="n">_prepare_common_values</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">snapshot_date</span> <span class="ow">in</span> <span class="n">snapshot_dates</span><span class="p">:</span>
        <span class="c1"># Prepare data for this date</span>
        <span class="n">df_copy</span><span class="p">,</span> <span class="n">snapshot_datetime</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_prepare_arrival_data</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">,</span> <span class="n">snapshot_date</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span>
        <span class="p">)</span>

        <span class="c1"># Get arrivals within the prediction window</span>
        <span class="n">arrivals</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_copy</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">snapshot_datetime</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_copy</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">snapshot_datetime</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Sort arrivals by time and create cumulative count</span>
        <span class="n">arrivals</span> <span class="o">=</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">)</span>
        <span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate arrival rates and prepare time points</span>
        <span class="n">mean_arrival_rates</span> <span class="o">=</span> <span class="n">_calculate_arrival_rates</span><span class="p">(</span>
            <span class="n">df_copy</span><span class="p">,</span> <span class="n">prediction_time_obj</span><span class="p">,</span> <span class="n">prediction_window</span><span class="p">,</span> <span class="n">yta_time_interval</span>
        <span class="p">)</span>

        <span class="c1"># Prepare arrival times</span>
        <span class="n">arrival_times_piecewise</span> <span class="o">=</span> <span class="n">_prepare_arrival_times</span><span class="p">(</span>
            <span class="n">mean_arrival_rates</span><span class="p">,</span> <span class="n">prediction_time_obj</span><span class="p">,</span> <span class="n">default_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Calculate cumulative rates</span>
        <span class="n">cumulative_rates</span> <span class="o">=</span> <span class="n">_calculate_cumulative_rates</span><span class="p">(</span>
            <span class="n">arrival_times_piecewise</span><span class="p">,</span> <span class="n">mean_arrival_rates</span>
        <span class="p">)</span>

        <span class="c1"># Convert arrival times to use default date for plotting</span>
        <span class="n">arrival_times_plot</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">default_datetime</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">snapshot_datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">index</span>
        <span class="p">]</span>

        <span class="c1"># Create combined timeline</span>
        <span class="n">all_times</span> <span class="o">=</span> <span class="n">_create_combined_timeline</span><span class="p">(</span>
            <span class="n">default_datetime</span><span class="p">,</span>
            <span class="n">arrival_times_plot</span><span class="p">,</span>
            <span class="n">prediction_window</span><span class="p">,</span>
            <span class="n">arrival_times_piecewise</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Interpolate both actual and expected to the combined timeline</span>
        <span class="n">actual_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">],</span>
            <span class="p">[</span>
                <span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">default_datetime</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">arrival_times_plot</span>
                <span class="o">+</span> <span class="p">[</span><span class="n">default_datetime</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">prediction_window</span><span class="p">)]</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">])</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">arrivals</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">)</span>

        <span class="n">expected_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">],</span>
            <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arrival_times_piecewise</span><span class="p">],</span>
            <span class="n">cumulative_rates</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Calculate delta</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">actual_counts</span> <span class="o">-</span> <span class="n">expected_counts</span>
        <span class="n">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Ensure delta starts at 0</span>

        <span class="c1"># Store for averaging</span>
        <span class="n">all_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
        <span class="n">all_times_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_times</span><span class="p">)</span>

        <span class="c1"># Store final delta value for histogram</span>
        <span class="n">final_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Plot delta for this snapshot date</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">all_times</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Calculate and plot average delta</span>
    <span class="k">if</span> <span class="n">all_deltas</span><span class="p">:</span>
        <span class="c1"># Find the common time points across all dates</span>
        <span class="n">common_times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">for</span> <span class="n">times</span> <span class="ow">in</span> <span class="n">all_times_list</span><span class="p">]))</span>

        <span class="c1"># Interpolate all deltas to common time points</span>
        <span class="n">interpolated_deltas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">times</span><span class="p">,</span> <span class="n">delta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_times_list</span><span class="p">,</span> <span class="n">all_deltas</span><span class="p">):</span>
            <span class="c1"># Only interpolate within the actual time range for each date</span>
            <span class="n">min_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
            <span class="n">max_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
            <span class="n">valid_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">common_times</span> <span class="k">if</span> <span class="n">min_time</span> <span class="o">&lt;=</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">max_time</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">valid_times</span><span class="p">:</span>
                <span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">valid_times</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">],</span>
                    <span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Pad with NaN for times outside the valid range</span>
                <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_times</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">common_times</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">valid_times</span>
                <span class="p">]</span>
                <span class="n">padded</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolated</span>
                <span class="n">interpolated_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded</span><span class="p">)</span>

        <span class="c1"># Calculate average delta, ignoring NaN values</span>
        <span class="n">avg_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interpolated_deltas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Plot average delta as a solid line</span>
        <span class="c1"># Only plot where we have valid data (not NaN)</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_delta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">common_times</span><span class="p">,</span> <span class="n">valid_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span><span class="p">],</span>
                <span class="n">avg_delta</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span>
                <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Add horizontal line at y=0</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Format the main plot</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Difference (Actual - Expected)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Difference Between Actual and Expected Arrivals in the </span><span class="si">{</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">prediction_window</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">))</span><span class="si">}</span><span class="s2"> hours after </span><span class="si">{</span><span class="n">format_prediction_time</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">)</span><span class="si">}</span><span class="s2"> on all dates&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Format time axis</span>
    <span class="n">_format_time_axis</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">common_times</span><span class="p">)</span>

    <span class="c1"># Create histogram of final delta values</span>
    <span class="k">if</span> <span class="n">final_deltas</span><span class="p">:</span>
        <span class="c1"># Round values to nearest integer for binning</span>
        <span class="n">rounded_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">final_deltas</span><span class="p">)</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rounded_deltas</span><span class="p">)</span>

        <span class="c1"># Create bins centered on integer values</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">unique_values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">unique_values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">final_deltas</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Final Difference (Actual - Expected)&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Distribution of Final Differences&quot;</span><span class="p">)</span>

        <span class="c1"># Set x-axis ticks to integer values with appropriate spacing</span>
        <span class="n">value_range</span> <span class="o">=</span> <span class="n">unique_values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">unique_values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_range</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Aim for about 10 ticks</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">unique_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">unique_values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span> <span class="k">if</span> <span class="n">file_name</span> <span class="k">else</span> <span class="s2">&quot;multiple_deltas.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.observed_against_expected.plot_deltas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_deltas</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="n">results2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;Histograms of Observed - Expected Values&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Observed minus expected&#39;</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot histograms of observed minus expected values.</p>
<p>Creates a grid of histograms showing the distribution of differences between
observed and expected values for different prediction times. Optionally compares
two sets of results side by side.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>results1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First set of results containing observed and expected values for different
prediction times. Keys are prediction times, values are dicts with 'observed'
and 'expected' arrays.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>results2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second set of results for comparison, following the same format as results1.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title for the first set of results.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title for the second set of results.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Super title for the entire plot.</p>
              </div>
            </td>
            <td>
                  <code>&#34;Histograms of Observed - Expected Values&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>xlabel</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Label for the x-axis of each histogram.</p>
              </div>
            </td>
            <td>
                  <code>&#34;Observed minus expected&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the plot should be saved. If provided, saves the plot as a PNG file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "observed_vs_expected.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the matplotlib figure object instead of displaying it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure object if return_figure is True, otherwise None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function creates a grid of histograms with a maximum of 5 columns.
Each histogram shows the distribution of differences between observed and
expected values for a specific prediction time. A red dashed line at x=0
indicates where observed equals expected.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/observed_against_expected.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_deltas</span><span class="p">(</span>
    <span class="n">results1</span><span class="p">,</span>
    <span class="n">results2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="o">=</span><span class="s2">&quot;Histograms of Observed - Expected Values&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Observed minus expected&quot;</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot histograms of observed minus expected values.</span>

<span class="sd">    Creates a grid of histograms showing the distribution of differences between</span>
<span class="sd">    observed and expected values for different prediction times. Optionally compares</span>
<span class="sd">    two sets of results side by side.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results1 : dict</span>
<span class="sd">        First set of results containing observed and expected values for different</span>
<span class="sd">        prediction times. Keys are prediction times, values are dicts with &#39;observed&#39;</span>
<span class="sd">        and &#39;expected&#39; arrays.</span>
<span class="sd">    results2 : dict, optional</span>
<span class="sd">        Second set of results for comparison, following the same format as results1.</span>
<span class="sd">    title1 : str, optional</span>
<span class="sd">        Title for the first set of results.</span>
<span class="sd">    title2 : str, optional</span>
<span class="sd">        Title for the second set of results.</span>
<span class="sd">    suptitle : str, default=&quot;Histograms of Observed - Expected Values&quot;</span>
<span class="sd">        Super title for the entire plot.</span>
<span class="sd">    xlabel : str, default=&quot;Observed minus expected&quot;</span>
<span class="sd">        Label for the x-axis of each histogram.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path where the plot should be saved. If provided, saves the plot as a PNG file.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;observed_vs_expected.png&quot;.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the matplotlib figure object instead of displaying it.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        The figure object if return_figure is True, otherwise None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function creates a grid of histograms with a maximum of 5 columns.</span>
<span class="sd">    Each histogram shows the distribution of differences between observed and</span>
<span class="sd">    expected values for a specific prediction time. A red dashed line at x=0</span>
<span class="sd">    indicates where observed equals expected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the number of subplots needed</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">)</span>

    <span class="c1"># Calculate the number of rows and columns for the subplots</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">)</span>  <span class="c1"># Maximum of 5 columns</span>
    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">/</span> <span class="n">num_cols</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">results2</span><span class="p">:</span>
        <span class="n">num_rows</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Double the number of rows if we have two result sets</span>

    <span class="c1"># Set a minimum width for the figure</span>
    <span class="n">min_width</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># minimum width in inches</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_width</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">num_rows</span>

    <span class="c1"># Create the plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Flatten the axes array</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">result_title</span><span class="p">,</span> <span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">):</span>
        <span class="c1"># Convert prediction times to minutes for sorting</span>
        <span class="n">prediction_times_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span>
        <span class="p">)</span>

        <span class="c1"># Create symmetric bins around zero</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_prediction_time</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">):</span>
            <span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">])</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;expected&quot;</span><span class="p">])</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">observed</span> <span class="o">-</span> <span class="n">expected</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">start_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">difference</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Format the prediction time</span>
            <span class="n">formatted_time</span> <span class="o">=</span> <span class="n">format_prediction_time</span><span class="p">(</span><span class="n">_prediction_time</span><span class="p">)</span>

            <span class="c1"># Combine the result_title and formatted_time</span>
            <span class="k">if</span> <span class="n">result_title</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_title</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">formatted_time</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">global_min</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">global_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Calculate global min and max differences for consistent x-axis across both result sets</span>
    <span class="n">all_differences</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Gather all differences for consistent x-axis scaling</span>
    <span class="k">for</span> <span class="n">results</span> <span class="ow">in</span> <span class="p">[</span><span class="n">results1</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="n">results2</span><span class="p">]</span> <span class="k">if</span> <span class="n">results2</span> <span class="k">else</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">])</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;expected&quot;</span><span class="p">])</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="n">observed</span> <span class="o">-</span> <span class="n">expected</span>
            <span class="n">all_differences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>

    <span class="c1"># Find the symmetric range around zero</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">all_differences</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">all_differences</span><span class="p">)))</span>
    <span class="n">global_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">abs_max</span><span class="p">)</span>
    <span class="n">global_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">abs_max</span><span class="p">)</span>

    <span class="c1"># Plot the first results set</span>
    <span class="n">plot_results</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">title1</span><span class="p">,</span> <span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">)</span>

    <span class="c1"># Plot the second results set if provided</span>
    <span class="k">if</span> <span class="n">results2</span><span class="p">:</span>
        <span class="n">plot_results</span><span class="p">(</span><span class="n">results2</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">title2</span><span class="p">,</span> <span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">)</span>

    <span class="c1"># Hide any unused subplots</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="n">results2</span> <span class="k">else</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="s2">&quot;observed_vs_expected.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.probability_distribution" class="doc doc-heading">
            <code>probability_distribution</code>


</h3>

    <div class="doc doc-contents ">

        <p>Module for generating probability distribution visualizations.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.probability_distribution.plot_prob_dist : Plot a probability distribution as a bar chart with enhanced plotting options.">plot_prob_dist : Plot a probability distribution as a bar chart with enhanced plotting options.</span></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.probability_distribution.plot_prob_dist" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_prob_dist</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">include_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">truncate_at_beds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bar_colour</span><span class="o">=</span><span class="s1">&#39;#5B9BD5&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">probability_thresholds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_probability_thresholds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">probability_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_bed_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Number of beds&#39;</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot a probability distribution as a bar chart with enhanced plotting options.</p>
<p>This function generates a bar plot for a given probability distribution, either
as a pandas DataFrame, a scipy.stats distribution object (e.g., Poisson), or a
dictionary. The plot can be customized with titles, axis labels, markers, and
additional visual properties.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_data</code>
            </td>
            <td>
                  <code>pandas.DataFrame, dict, scipy.stats distribution, or array-like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probability distribution data to be plotted. Can be:
- pandas DataFrame
- dictionary (keys are indices, values are probabilities)
- scipy.stats distribution (e.g., Poisson). If a <code>scipy.stats</code> distribution is provided,
the function computes probabilities for integer values within the specified range.
- array-like of probabilities (indices will be 0 to len(array)-1)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The title of the plot, used for display and optionally as the file name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the plot image will be saved. If not provided, the plot is
displayed without saving.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of the figure, specified as (width, height).
Default is (6, 3)</p>
              </div>
            </td>
            <td>
                  <code>(6, 3)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_titles</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include titles and axis labels in the plot.
Default is False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>truncate_at_beds</code>
            </td>
            <td>
                  <code>int or tuple of (int, int)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a single number specifying the upper bound, or a tuple of
(lower_bound, upper_bound) for the x-axis range. If None, the full
range of the data will be displayed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Font size for plot text, including titles and tick labels.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bar_colour</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The color of the bars in the plot.
Default is "#5B9BD5"</p>
              </div>
            </td>
            <td>
                  <code>&#39;#5B9BD5&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to a generated name based on the title.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>probability_thresholds</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are points on the cumulative distribution function (as decimals, e.g., 0.9 for 90%)
and values are the corresponding resource thresholds (bed counts).
For example, {0.9: 15} indicates there is a 90% probability that
at least 15 beds will be needed (represents the lower tail of the distribution).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_probability_thresholds</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show vertical lines indicating the resource requirements
at different points on the cumulative distribution function.
Default is True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>probability_levels</code>
            </td>
            <td>
                  <code>list of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of probability levels for automatic threshold calculation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_bed_base</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of bed balance lines to plot in red.
Keys are labels and values are x-axis positions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>xlabel</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A label for the x axis.
Default is "Number of beds"</p>
              </div>
            </td>
            <td>
                  <code>&#39;Number of beds&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the matplotlib figure instead of displaying it.
Default is False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns the figure if return_figure is True, otherwise displays the plot</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic usage with an array of probabilities:</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plot_prob_dist</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="s2">&quot;Bed Demand Distribution&quot;</span><span class="p">)</span>
</code></pre></div>
    <p>With thresholds:</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">_calculate_probability_thresholds</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plot_prob_dist</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="s2">&quot;Bed Demand with Confidence Levels&quot;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">probability_thresholds</span><span class="o">=</span><span class="n">thresholds</span><span class="p">)</span>
</code></pre></div>
    <p>Using with a scipy stats distribution:</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">poisson_dist</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Poisson with mean of 5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plot_prob_dist</span><span class="p">(</span><span class="n">poisson_dist</span><span class="p">,</span> <span class="s2">&quot;Poisson Distribution (μ=5)&quot;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">truncate_at_beds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/probability_distribution.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_prob_dist</span><span class="p">(</span>
    <span class="n">prob_dist_data</span><span class="p">,</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">include_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">truncate_at_beds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">text_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bar_colour</span><span class="o">=</span><span class="s2">&quot;#5B9BD5&quot;</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">probability_thresholds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_probability_thresholds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">probability_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_bed_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Number of beds&quot;</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot a probability distribution as a bar chart with enhanced plotting options.</span>

<span class="sd">    This function generates a bar plot for a given probability distribution, either</span>
<span class="sd">    as a pandas DataFrame, a scipy.stats distribution object (e.g., Poisson), or a</span>
<span class="sd">    dictionary. The plot can be customized with titles, axis labels, markers, and</span>
<span class="sd">    additional visual properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prob_dist_data : pandas.DataFrame, dict, scipy.stats distribution, or array-like</span>
<span class="sd">        The probability distribution data to be plotted. Can be:</span>
<span class="sd">        - pandas DataFrame</span>
<span class="sd">        - dictionary (keys are indices, values are probabilities)</span>
<span class="sd">        - scipy.stats distribution (e.g., Poisson). If a `scipy.stats` distribution is provided,</span>
<span class="sd">        the function computes probabilities for integer values within the specified range.</span>
<span class="sd">        - array-like of probabilities (indices will be 0 to len(array)-1)</span>
<span class="sd">    title : str</span>
<span class="sd">        The title of the plot, used for display and optionally as the file name.</span>
<span class="sd">    media_file_path : str or pathlib.Path, optional</span>
<span class="sd">        Directory where the plot image will be saved. If not provided, the plot is</span>
<span class="sd">        displayed without saving.</span>
<span class="sd">    figsize : tuple of float, optional</span>
<span class="sd">        The size of the figure, specified as (width, height).</span>
<span class="sd">        Default is (6, 3)</span>
<span class="sd">    include_titles : bool, optional</span>
<span class="sd">        Whether to include titles and axis labels in the plot.</span>
<span class="sd">        Default is False</span>
<span class="sd">    truncate_at_beds : int or tuple of (int, int), optional</span>
<span class="sd">        Either a single number specifying the upper bound, or a tuple of</span>
<span class="sd">        (lower_bound, upper_bound) for the x-axis range. If None, the full</span>
<span class="sd">        range of the data will be displayed.</span>
<span class="sd">    text_size : int, optional</span>
<span class="sd">        Font size for plot text, including titles and tick labels.</span>
<span class="sd">    bar_colour : str, optional</span>
<span class="sd">        The color of the bars in the plot.</span>
<span class="sd">        Default is &quot;#5B9BD5&quot;</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to a generated name based on the title.</span>
<span class="sd">    probability_thresholds : dict, optional</span>
<span class="sd">        A dictionary where keys are points on the cumulative distribution function (as decimals, e.g., 0.9 for 90%)</span>
<span class="sd">        and values are the corresponding resource thresholds (bed counts).</span>
<span class="sd">        For example, {0.9: 15} indicates there is a 90% probability that</span>
<span class="sd">        at least 15 beds will be needed (represents the lower tail of the distribution).</span>
<span class="sd">    show_probability_thresholds : bool, optional</span>
<span class="sd">        Whether to show vertical lines indicating the resource requirements</span>
<span class="sd">        at different points on the cumulative distribution function.</span>
<span class="sd">        Default is True</span>
<span class="sd">    probability_levels : list of float, optional</span>
<span class="sd">        List of probability levels for automatic threshold calculation.</span>
<span class="sd">    plot_bed_base : dict, optional</span>
<span class="sd">        Dictionary of bed balance lines to plot in red.</span>
<span class="sd">        Keys are labels and values are x-axis positions.</span>
<span class="sd">    xlabel : str, optional</span>
<span class="sd">        A label for the x axis.</span>
<span class="sd">        Default is &quot;Number of beds&quot;</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        If True, returns the matplotlib figure instead of displaying it.</span>
<span class="sd">        Default is False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        Returns the figure if return_figure is True, otherwise displays the plot</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Basic usage with an array of probabilities:</span>

<span class="sd">    &gt;&gt;&gt; probabilities = [0.05, 0.1, 0.2, 0.3, 0.2, 0.1, 0.05]</span>
<span class="sd">    &gt;&gt;&gt; plot_prob_dist(probabilities, &quot;Bed Demand Distribution&quot;)</span>

<span class="sd">    With thresholds:</span>

<span class="sd">    &gt;&gt;&gt; thresholds = _calculate_probability_thresholds(probabilities, [0.8, 0.95])</span>
<span class="sd">    &gt;&gt;&gt; plot_prob_dist(probabilities, &quot;Bed Demand with Confidence Levels&quot;,</span>
<span class="sd">    ...                probability_thresholds=thresholds)</span>

<span class="sd">    Using with a scipy stats distribution:</span>

<span class="sd">    &gt;&gt;&gt; from scipy import stats</span>
<span class="sd">    &gt;&gt;&gt; poisson_dist = stats.poisson(mu=5)  # Poisson with mean of 5</span>
<span class="sd">    &gt;&gt;&gt; plot_prob_dist(poisson_dist, &quot;Poisson Distribution (μ=5)&quot;,</span>
<span class="sd">    ...                truncate_at_beds=(0, 15))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Handle array-like input</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">array_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="p">)</span>
        <span class="n">prob_dist_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="n">prob_dist_data</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">array_length</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Handle scipy.stats distribution input</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="p">,</span> <span class="s2">&quot;pmf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="o">.</span><span class="n">pmf</span><span class="p">):</span>
        <span class="c1"># Determine range for the distribution</span>
        <span class="k">if</span> <span class="n">truncate_at_beds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default range for distributions if not specified</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Reasonable default for most discrete distributions</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncate_at_beds</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">truncate_at_beds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">truncate_at_beds</span>

        <span class="c1"># Generate x values and probabilities</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">prob_dist_data</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">prob_dist_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="n">probs</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># No need to filter later</span>
        <span class="n">truncate_at_beds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Handle dictionary input</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prob_dist_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="o">.</span><span class="n">values</span><span class="p">())},</span>
            <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">prob_dist_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">)</span>

    <span class="c1"># Apply truncation if specified</span>
    <span class="k">if</span> <span class="n">truncate_at_beds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine bounds</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncate_at_beds</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">truncate_at_beds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">truncate_at_beds</span>

        <span class="c1"># Apply filtering</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">prob_dist_data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">prob_dist_data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span>
        <span class="p">)</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">prob_dist_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use all available data</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">prob_dist_data</span>

    <span class="c1"># Calculate probability thresholds if probability_levels is provided</span>
    <span class="k">if</span> <span class="n">probability_thresholds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">probability_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">probability_thresholds</span> <span class="o">=</span> <span class="n">_calculate_probability_thresholds</span><span class="p">(</span>
            <span class="n">filtered_data</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">probability_levels</span>
        <span class="p">)</span>

    <span class="c1"># Create the plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/n&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Plot bars</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
        <span class="n">filtered_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">filtered_data</span><span class="p">[</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">bar_colour</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Generate appropriate ticks based on data range</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">filtered_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">data_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">data_range</span> <span class="o">=</span> <span class="n">data_max</span> <span class="o">-</span> <span class="n">data_min</span>

        <span class="k">if</span> <span class="n">data_range</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">tick_step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">data_range</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">tick_step</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tick_step</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">tick_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_min</span> <span class="o">//</span> <span class="n">tick_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">tick_step</span>
        <span class="n">tick_end</span> <span class="o">=</span> <span class="n">data_max</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tick_start</span><span class="p">,</span> <span class="n">tick_end</span><span class="p">,</span> <span class="n">tick_step</span><span class="p">))</span>

    <span class="c1"># Plot probability threshold lines</span>
    <span class="k">if</span> <span class="n">show_probability_thresholds</span> <span class="ow">and</span> <span class="n">probability_thresholds</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">probability_thresholds</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">probability</span><span class="p">,</span> <span class="n">bed_count</span> <span class="ow">in</span> <span class="n">probability_thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">bed_count</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">probability</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% probability of needing ≥ </span><span class="si">{</span><span class="n">bed_count</span><span class="si">}</span><span class="s2"> beds&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

    <span class="c1"># Add bed balance lines</span>
    <span class="k">if</span> <span class="n">plot_bed_base</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">plot_bed_base</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">plot_bed_base</span><span class="p">[</span><span class="n">point</span><span class="p">],</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bed balance: </span><span class="si">{</span><span class="n">point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

    <span class="c1"># Add text and labels</span>
    <span class="k">if</span> <span class="n">text_size</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_titles</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">text_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_titles</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save or display the figure</span>
    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.quantile_quantile" class="doc doc-heading">
            <code>quantile_quantile</code>


</h3>

    <div class="doc doc-contents ">

        <p>Generate Quantile-Quantile (QQ) plots to compare observed values with model predictions.</p>
<p>This module creates QQ plots for healthcare bed demand predictions, comparing observed
values with model predictions. A QQ plot is a graphical technique for determining if two
data sets come from populations with a common distribution. If the points form a line
approximately along the reference line y=x, this suggests the distributions are similar.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.quantile_quantile.qq_plot : function">qq_plot : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate multiple QQ plots comparing observed values with model predictions</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>To prepare the predicted distribution:
* Treat the predicted distributions (saved as cdfs) for all time points of interest as if they were one distribution
* Within this predicted distribution, because each probability is over a discrete rather than continuous number of input values, the upper and lower of values of the probability range are saved at each value
* The mid point between upper and lower is calculated and saved
* The distribution of cdf mid points (one for each horizon date) is sorted by value of the mid point and a cdf of this is calculated (this is a cdf of cdfs, in effect)
* These are weighted by the probability of each value occurring</p>
<p>To prepare the observed distribution:
* Take observed number each horizon date and save the cdf of that value from its predicted distribution
* The distribution of cdf values (one per horizon date) is sorted
* These are weighted by the probability of each value occurring, which is a uniform probability (1 / over the number of horizon dates)</p>
</details>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.quantile_quantile.qq_plot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">qq_plot</span><span class="p">(</span><span class="n">prediction_times</span><span class="p">,</span> <span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate multiple QQ plots comparing observed values with model predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code>list of tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (hour, minute) tuples for prediction times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of probability distributions keyed by model_key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base name of the model to construct model keys.</p>
              </div>
            </td>
            <td>
                  <code>&#34;admissions&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure object instead of displaying it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code>tuple of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the figure in inches as (width, height). If None, calculated automatically
based on number of plots.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Super title for the entire figure, displayed above all subplots.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><span title="Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "qq_plot.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns the figure if return_figure is True, otherwise displays the plot and returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function creates a QQ plot for each prediction time, comparing the observed
distribution with the predicted distribution. Each subplot shows how well the
model's predictions match the actual observations.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/quantile_quantile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">qq_plot</span><span class="p">(</span>
    <span class="n">prediction_times</span><span class="p">,</span>
    <span class="n">prob_dist_dict_all</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate multiple QQ plots comparing observed values with model predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_times : list of tuple</span>
<span class="sd">        List of (hour, minute) tuples for prediction times.</span>
<span class="sd">    prob_dist_dict_all : dict</span>
<span class="sd">        Dictionary of probability distributions keyed by model_key.</span>
<span class="sd">    model_name : str, default=&quot;admissions&quot;</span>
<span class="sd">        Base name of the model to construct model keys.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure object instead of displaying it.</span>
<span class="sd">    figsize : tuple of float, optional</span>
<span class="sd">        Size of the figure in inches as (width, height). If None, calculated automatically</span>
<span class="sd">        based on number of plots.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Super title for the entire figure, displayed above all subplots.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path to save the plot.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;qq_plot.png&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        Returns the figure if return_figure is True, otherwise displays the plot and returns None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function creates a QQ plot for each prediction time, comparing the observed</span>
<span class="sd">    distribution with the predicted distribution. Each subplot shows how well the</span>
<span class="sd">    model&#39;s predictions match the actual observations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort prediction times by converting to minutes since midnight</span>
    <span class="n">prediction_times_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Convert (hour, minute) to minutes since midnight</span>
    <span class="p">)</span>

    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Create subplot layout</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Handle case of single prediction time</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

    <span class="c1"># Loop through each subplot</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prediction_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">):</span>
        <span class="c1"># Initialize lists to store CDF and observed data</span>
        <span class="n">cdf_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">observed_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get model key and corresponding prob_dist_dict</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>
        <span class="n">prob_dist_dict</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="c1"># Process data for current subplot</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict</span><span class="p">:</span>
            <span class="n">agg_predicted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">][</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">])</span>
            <span class="n">agg_observed</span> <span class="o">=</span> <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">][</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span>

            <span class="n">upper</span> <span class="o">=</span> <span class="n">agg_predicted</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper</span> <span class="o">+</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="n">cdf_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">agg_predicted</span><span class="p">)))</span>
            <span class="c1"># Round the observed data to nearest integer before using as index</span>
            <span class="n">agg_observed_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">agg_observed</span><span class="p">))</span>
            <span class="n">observed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mid</span><span class="p">[</span><span class="n">agg_observed_int</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cdf_data</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Prepare data for plotting</span>
        <span class="n">cdf_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">cdf_data</span><span class="p">)</span>
        <span class="n">qq_model</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">cdf_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cdf_upper&quot;</span><span class="p">,</span> <span class="s2">&quot;cdf_mid&quot;</span><span class="p">,</span> <span class="s2">&quot;cdf_lower&quot;</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">qq_model</span> <span class="o">=</span> <span class="n">qq_model</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;cdf_mid&quot;</span><span class="p">)</span>
        <span class="n">qq_model</span><span class="p">[</span><span class="s2">&quot;cum_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qq_model</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">qq_model</span><span class="p">[</span><span class="s2">&quot;cum_weight_normed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">qq_model</span><span class="p">[</span><span class="s2">&quot;cum_weight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">qq_model</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">qq_observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">observed_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cdf_observed&quot;</span><span class="p">])</span>
        <span class="n">qq_observed</span> <span class="o">=</span> <span class="n">qq_observed</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;cdf_observed&quot;</span><span class="p">)</span>
        <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_data</span><span class="p">)</span>
        <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;cum_weight_normed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

        <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;max_model_cdf_at_this_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;cdf_observed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">qq_model</span><span class="p">[</span><span class="n">qq_model</span><span class="p">[</span><span class="s2">&quot;cdf_mid&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">][</span><span class="s2">&quot;cum_weight_normed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Plot on current subplot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Reference line y=x</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

        <span class="c1"># Plot QQ data points</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;max_model_cdf_at_this_value&quot;</span><span class="p">],</span>
            <span class="n">qq_observed</span><span class="p">[</span><span class="s2">&quot;cum_weight_normed&quot;</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set labels and title for subplot with hour:minute format</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">prediction_time</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Cdf of model distribution&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cdf of observed distribution&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QQ Plot for </span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Add suptitle if provided</span>
    <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="p">(</span><span class="n">file_name</span> <span class="ow">or</span> <span class="s2">&quot;qq_plot.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.randomised_pit" class="doc doc-heading">
            <code>randomised_pit</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.randomised_pit.plot_randomised_pit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_randomised_pit</span><span class="p">(</span><span class="n">prediction_times</span><span class="p">,</span> <span class="n">prob_dist_dict_all</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate randomised PIT histograms for multiple prediction times side by side.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_times</code>
            </td>
            <td>
                  <code>list of tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (hour, minute) tuples representing times for which predictions were made.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prob_dist_dict_all</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of probability distributions keyed by model_key. Each entry contains
information about predicted distributions and observed values for different
snapshot dates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base name of the model to construct model keys, by default "admissions".</p>
              </div>
            </td>
            <td>
                  <code>&#39;admissions&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure object instead of displaying it, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_dataframe</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns a dictionary of PIT values by model_key, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code>tuple of (float, float)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the figure in inches as (width, height). If None, calculated automatically
based on number of plots, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suptitle</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Super title for the entire figure, displayed above all subplots, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot, by default None. If provided, saves the plot as a PNG file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "plot_randomised_pit.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_bins</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of histogram bins, by default 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducibility, by default 42.</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure object containing the plots, if return_figure is True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of PIT values by model_key, if return_dataframe is True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (figure, pit_values_dict) if both return_figure and return_dataframe are True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If neither return_figure nor return_dataframe is True, displays the plots and returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/randomised_pit.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_randomised_pit</span><span class="p">(</span>
    <span class="n">prediction_times</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">prob_dist_dict_all</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">suptitle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span> <span class="kc">None</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate randomised PIT histograms for multiple prediction times side by side.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_times : list of tuple</span>
<span class="sd">        List of (hour, minute) tuples representing times for which predictions were made.</span>
<span class="sd">    prob_dist_dict_all : dict</span>
<span class="sd">        Dictionary of probability distributions keyed by model_key. Each entry contains</span>
<span class="sd">        information about predicted distributions and observed values for different</span>
<span class="sd">        snapshot dates.</span>
<span class="sd">    model_name : str, optional</span>
<span class="sd">        Base name of the model to construct model keys, by default &quot;admissions&quot;.</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        If True, returns the figure object instead of displaying it, by default False.</span>
<span class="sd">    return_dataframe : bool, optional</span>
<span class="sd">        If True, returns a dictionary of PIT values by model_key, by default False.</span>
<span class="sd">    figsize : tuple of (float, float), optional</span>
<span class="sd">        Size of the figure in inches as (width, height). If None, calculated automatically</span>
<span class="sd">        based on number of plots, by default None.</span>
<span class="sd">    suptitle : str, optional</span>
<span class="sd">        Super title for the entire figure, displayed above all subplots, by default None.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Path to save the plot, by default None. If provided, saves the plot as a PNG file.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;plot_randomised_pit.png&quot;.</span>
<span class="sd">    n_bins : int, optional</span>
<span class="sd">        Number of histogram bins, by default 10.</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Random seed for reproducibility, by default 42.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure</span>
<span class="sd">        The figure object containing the plots, if return_figure is True.</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of PIT values by model_key, if return_dataframe is True.</span>
<span class="sd">    tuple</span>
<span class="sd">        Tuple of (figure, pit_values_dict) if both return_figure and return_dataframe are True.</span>
<span class="sd">    None</span>
<span class="sd">        If neither return_figure nor return_dataframe is True, displays the plots and returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Sort prediction times by converting to minutes since midnight</span>
    <span class="n">prediction_times_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">prediction_times</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Calculate figure parameters</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">)</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Create subplot layout</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axs</span>

    <span class="n">all_pit_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">max_density</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Track maximum density across all histograms</span>

    <span class="c1"># Process each subplot</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prediction_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">):</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>
        <span class="n">prob_dist_dict</span> <span class="o">=</span> <span class="n">prob_dist_dict_all</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">prob_dist_dict</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cdf_functions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Extract data for each date</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">prob_dist_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">observation</span> <span class="o">=</span> <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">][</span><span class="s2">&quot;agg_observed&quot;</span><span class="p">]</span>
                <span class="n">predicted_dist</span> <span class="o">=</span> <span class="n">prob_dist_dict</span><span class="p">[</span><span class="n">dt</span><span class="p">][</span><span class="s2">&quot;agg_predicted&quot;</span><span class="p">][</span><span class="s2">&quot;agg_proba&quot;</span><span class="p">]</span>

                <span class="c1"># Convert probability distribution to CDF function</span>
                <span class="n">cdf_func</span> <span class="o">=</span> <span class="n">_prob_to_cdf</span><span class="p">(</span><span class="n">predicted_dist</span><span class="p">)</span>

                <span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
                <span class="n">cdf_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdf_func</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping date </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Generate PIT values</span>
        <span class="n">pit_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">obs</span><span class="p">,</span> <span class="n">cdf_func</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">cdf_functions</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Calculate PIT range bounds</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">cdf_func</span><span class="p">(</span><span class="n">obs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">cdf_func</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

                <span class="c1"># Sample randomly within the range</span>
                <span class="n">pit_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                <span class="n">pit_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pit_value</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing observation </span><span class="si">{</span><span class="n">obs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">all_pit_values</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pit_values</span>

        <span class="c1"># Calculate histogram to get density</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">pit_values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_density</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_density</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>

    <span class="c1"># Now plot with consistent y-axis scale</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prediction_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction_times_sorted</span><span class="p">):</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">get_model_key</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">)</span>
        <span class="n">pit_values</span> <span class="o">=</span> <span class="n">all_pit_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pit_values</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Plot histogram</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">pit_values</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Randomised PIT&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add uniform reference line</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Perfect Uniform&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Set labels and title</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">prediction_time</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PIT Value&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PIT Histogram for </span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_density</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># Add 10% padding</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only show legend on first subplot</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Final plot configuration</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="p">(</span><span class="n">file_name</span> <span class="ow">or</span> <span class="s2">&quot;plot_randomised_pit.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="c1"># Return based on flags</span>
    <span class="k">if</span> <span class="n">return_figure</span> <span class="ow">and</span> <span class="n">return_dataframe</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">all_pit_values</span>
    <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">return_dataframe</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_pit_values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.shap" class="doc doc-heading">
            <code>shap</code>


</h3>

    <div class="doc doc-contents ">

        <p>SHAP (SHapley Additive exPlanations) visualization module.</p>
<p>This module provides functionality for generating SHAP plots. These are useful for
visualizing feature importance and their impact on model decisions.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.shap.plot_shap : function">plot_shap : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate SHAP plots for multiple trained models.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.shap.plot_shap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_shap</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="n">test_visits</span><span class="p">,</span> <span class="n">exclude_from_training_data</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;is_admitted&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate SHAP plots for multiple trained models.</p>
<p>This function creates SHAP (SHapley Additive exPlanations) summary plots for each
trained model, showing the impact of features on model predictions. The plots can
be saved to a specified media file path or displayed directly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trained_models</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>] or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="TrainedClassifier


  
      dataclass
   (patientflow.model_artifacts.TrainedClassifier)" href="#patientflow.model_artifacts.TrainedClassifier">TrainedClassifier</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trained classifier objects or dictionary with TrainedClassifier values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_visits</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing the test visit data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude_from_training_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of columns to exclude from training data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where the generated plots will be saved. If None, plots are
only displayed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "shap_plot.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the figure instead of displaying it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_col</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the column containing the target labels.</p>
              </div>
            </td>
            <td>
                  <code>&#34;is_admitted&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_figure is True, returns the generated figure. Otherwise, returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/shap.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_shap</span><span class="p">(</span>
    <span class="n">trained_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TrainedClassifier</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrainedClassifier</span><span class="p">],</span>
    <span class="n">test_visits</span><span class="p">,</span>
    <span class="n">exclude_from_training_data</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;is_admitted&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate SHAP plots for multiple trained models.</span>

<span class="sd">    This function creates SHAP (SHapley Additive exPlanations) summary plots for each</span>
<span class="sd">    trained model, showing the impact of features on model predictions. The plots can</span>
<span class="sd">    be saved to a specified media file path or displayed directly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trained_models : list[TrainedClassifier] or dict[str, TrainedClassifier]</span>
<span class="sd">        List of trained classifier objects or dictionary with TrainedClassifier values.</span>
<span class="sd">    test_visits : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the test visit data.</span>
<span class="sd">    exclude_from_training_data : list[str]</span>
<span class="sd">        List of columns to exclude from training data.</span>
<span class="sd">    media_file_path : Path, optional</span>
<span class="sd">        Directory path where the generated plots will be saved. If None, plots are</span>
<span class="sd">        only displayed.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;shap_plot.png&quot;.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it.</span>
<span class="sd">    label_col : str, default=&quot;is_admitted&quot;</span>
<span class="sd">        Name of the column containing the target labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        If return_figure is True, returns the generated figure. Otherwise, returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict to list if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trained_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trained_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trained_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Sort trained_models by prediction time</span>
    <span class="n">trained_models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">trained_models</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">trained_model</span> <span class="ow">in</span> <span class="n">trained_models_sorted</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

        <span class="c1"># use non-calibrated pipeline</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">pipeline</span>
        <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">training_results</span><span class="o">.</span><span class="n">prediction_time</span>

        <span class="c1"># Get test data for this prediction time</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">prepare_patient_snapshots</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">test_visits</span><span class="p">,</span>
            <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
            <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_from_training_data</span><span class="p">,</span>
            <span class="n">single_snapshot_per_visit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">add_missing_columns</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
        <span class="n">transformed_cols</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
            <span class="s2">&quot;feature_transformer&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
        <span class="n">transformed_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">transformed_cols</span><span class="p">]</span>
        <span class="n">truncated_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[:</span><span class="mi">45</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">transformed_cols</span><span class="p">]</span>

        <span class="c1"># Transform features</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;feature_transformer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="c1"># Create SHAP explainer</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">])</span>

        <span class="c1"># Convert sparse matrix to dense if necessary</span>
        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X_test</span><span class="p">):</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="c1"># Print prediction distribution</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Predicted classification (not admitted, admitted): &quot;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Print mean SHAP values for each class</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHAP values shape:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">shap_values</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean SHAP values (class 0):&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean SHAP values (class 1):&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Create SHAP summary plot</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
        <span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span>
            <span class="n">shap_values</span><span class="p">,</span>
            <span class="n">X_test</span><span class="p">,</span>
            <span class="n">feature_names</span><span class="o">=</span><span class="n">truncated_cols</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">prediction_time</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP Values for Time of Day: </span><span class="si">{</span><span class="n">hour</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;SHAP Value&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
            <span class="c1"># Save plot</span>
            <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
                <span class="n">shap_plot_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shap_plot_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">media_file_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;shap_plot_</span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02</span><span class="si">}{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">shap_plot_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.survival_curve" class="doc doc-heading">
            <code>survival_curve</code>


</h3>

    <div class="doc doc-contents ">

        <p>Visualization tools for patient flow analysis using survival curves.</p>
<p>This module provides functions to create and analyze survival curves for
time-to-event analysis.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.survival_curve.plot_admission_time_survival_curve : function">plot_admission_time_survival_curve : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create single or multiple survival curves for ward admission times</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>The survival curves show the proportion of patients who have not yet
  experienced an event (e.g., admission to ward) over time</li>
<li>Time is measured in hours from the initial event (e.g., arrival)</li>
<li>A 4-hour target line is included by default to show performance
  against common healthcare targets</li>
<li>The curves are created without external survival analysis packages
  for simplicity and transparency</li>
<li>Multiple curves can be plotted on the same figure for comparison</li>
</ul>
</details>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.survival_curve.plot_admission_time_survival_curve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_admission_time_survival_curve</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_time_col</span><span class="o">=</span><span class="s1">&#39;arrival_datetime&#39;</span><span class="p">,</span> <span class="n">end_time_col</span><span class="o">=</span><span class="s1">&#39;departure_datetime&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Time to Event Survival Curve&#39;</span><span class="p">,</span> <span class="n">target_hours</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Elapsed time from start&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Proportion not yet experienced event&#39;</span><span class="p">,</span> <span class="n">annotation_string</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:.1%}</span><span class="s1"> experienced event</span><span class="se">\n</span><span class="s1">within </span><span class="si">{:.0f}</span><span class="s1"> hours&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a survival curve for time-to-event analysis.</p>
<pre><code>This function creates a survival curve showing the proportion of patients
who have not yet experienced an event over time. Can plot single or multiple
survival curves on the same plot.
</code></pre>


<details class="----parameters" open>
  <summary><pre><code>Parameters
</code></pre></summary>
  <pre><code>df : pandas.DataFrame or list of pandas.DataFrame
    DataFrame(s) containing patient visit data. If a list is provided,
    multiple survival curves will be plotted on the same figure.
start_time_col : str, default="arrival_datetime"
    Name of the column containing the start time (e.g., arrival time)
end_time_col : str, default="admitted_to_ward_datetime"
    Name of the column containing the end time (e.g., admission time)
title : str, default="Time to Event Survival Curve"
    Title for the plot
target_hours : list of float, default=[4]
    List of target times in hours to show on the plot
xlabel : str, default="Elapsed time from start"
    Label for the x-axis
ylabel : str, default="Proportion not yet experienced event"
    Label for the y-axis
annotation_string : str, default="{:.1%} experienced event
</code></pre>
<p>within {:.0f} hours"
        String template for the text annotation. Use {:.1%} for the proportion and {:.0f} for the hours.
        Annotations are only shown for the first curve when plotting multiple curves.
    labels : list of str, optional
        Labels for each survival curve when plotting multiple curves.
        If None and multiple dataframes are provided, default labels will be used.
        Ignored when plotting a single curve.
    media_file_path : pathlib.Path, optional
        Path to save the plot. If None, the plot is not saved.
    file_name : str, optional
        Custom filename to use when saving the plot. If not provided, defaults to "survival_curve.png".
    return_figure : bool, default=False
        If True, returns the figure instead of displaying it
    return_df : bool, default=False
        If True, returns a DataFrame containing the survival curve data.
        For multiple curves, returns a list of DataFrames.</p>
</details>

<details class="----returns" open>
  <summary><pre><code>Returns
</code></pre></summary>
  <pre><code>matplotlib.figure.Figure or pandas.DataFrame or list or tuple or None
    - If return_figure is True and return_df is False: returns the figure object
    - If return_figure is False and return_df is True: returns the DataFrame(s) with survival curve data
    - If both return_figure and return_df are True: returns a tuple of (figure, DataFrame(s))
    - If both are False: returns None
</code></pre>
</details>

<details class="----notes" open>
  <summary><pre><code>Notes
</code></pre></summary>
  <pre><code>The survival curve shows the proportion of patients who have not yet experienced
the event at each time point. Vertical lines are drawn at each target hour
to indicate the target times, with the corresponding proportion of patients
who experienced the event within these timeframes.

When plotting multiple curves, different colors are automatically assigned
and a legend is displayed. Target line annotations are only shown for the
first curve to avoid visual clutter.
</code></pre>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/survival_curve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_admission_time_survival_curve</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">start_time_col</span><span class="o">=</span><span class="s2">&quot;arrival_datetime&quot;</span><span class="p">,</span>
    <span class="n">end_time_col</span><span class="o">=</span><span class="s2">&quot;departure_datetime&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Time to Event Survival Curve&quot;</span><span class="p">,</span>
    <span class="n">target_hours</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Elapsed time from start&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Proportion not yet experienced event&quot;</span><span class="p">,</span>
    <span class="n">annotation_string</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:.1%}</span><span class="s2"> experienced event</span><span class="se">\n</span><span class="s2">within </span><span class="si">{:.0f}</span><span class="s2"> hours&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">return_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a survival curve for time-to-event analysis.</span>

<span class="sd">    This function creates a survival curve showing the proportion of patients</span>
<span class="sd">    who have not yet experienced an event over time. Can plot single or multiple</span>
<span class="sd">    survival curves on the same plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame or list of pandas.DataFrame</span>
<span class="sd">        DataFrame(s) containing patient visit data. If a list is provided,</span>
<span class="sd">        multiple survival curves will be plotted on the same figure.</span>
<span class="sd">    start_time_col : str, default=&quot;arrival_datetime&quot;</span>
<span class="sd">        Name of the column containing the start time (e.g., arrival time)</span>
<span class="sd">    end_time_col : str, default=&quot;admitted_to_ward_datetime&quot;</span>
<span class="sd">        Name of the column containing the end time (e.g., admission time)</span>
<span class="sd">    title : str, default=&quot;Time to Event Survival Curve&quot;</span>
<span class="sd">        Title for the plot</span>
<span class="sd">    target_hours : list of float, default=[4]</span>
<span class="sd">        List of target times in hours to show on the plot</span>
<span class="sd">    xlabel : str, default=&quot;Elapsed time from start&quot;</span>
<span class="sd">        Label for the x-axis</span>
<span class="sd">    ylabel : str, default=&quot;Proportion not yet experienced event&quot;</span>
<span class="sd">        Label for the y-axis</span>
<span class="sd">    annotation_string : str, default=&quot;{:.1%} experienced event\nwithin {:.0f} hours&quot;</span>
<span class="sd">        String template for the text annotation. Use {:.1%} for the proportion and {:.0f} for the hours.</span>
<span class="sd">        Annotations are only shown for the first curve when plotting multiple curves.</span>
<span class="sd">    labels : list of str, optional</span>
<span class="sd">        Labels for each survival curve when plotting multiple curves.</span>
<span class="sd">        If None and multiple dataframes are provided, default labels will be used.</span>
<span class="sd">        Ignored when plotting a single curve.</span>
<span class="sd">    media_file_path : pathlib.Path, optional</span>
<span class="sd">        Path to save the plot. If None, the plot is not saved.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;survival_curve.png&quot;.</span>
<span class="sd">    return_figure : bool, default=False</span>
<span class="sd">        If True, returns the figure instead of displaying it</span>
<span class="sd">    return_df : bool, default=False</span>
<span class="sd">        If True, returns a DataFrame containing the survival curve data.</span>
<span class="sd">        For multiple curves, returns a list of DataFrames.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or pandas.DataFrame or list or tuple or None</span>
<span class="sd">        - If return_figure is True and return_df is False: returns the figure object</span>
<span class="sd">        - If return_figure is False and return_df is True: returns the DataFrame(s) with survival curve data</span>
<span class="sd">        - If both return_figure and return_df are True: returns a tuple of (figure, DataFrame(s))</span>
<span class="sd">        - If both are False: returns None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The survival curve shows the proportion of patients who have not yet experienced</span>
<span class="sd">    the event at each time point. Vertical lines are drawn at each target hour</span>
<span class="sd">    to indicate the target times, with the corresponding proportion of patients</span>
<span class="sd">    who experienced the event within these timeframes.</span>

<span class="sd">    When plotting multiple curves, different colors are automatically assigned</span>
<span class="sd">    and a legend is displayed. Target line annotations are only shown for the</span>
<span class="sd">    first curve to avoid visual clutter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle single dataframe vs list of dataframes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">dataframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span>
        <span class="n">is_single_curve</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataframes</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">is_single_curve</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Handle labels</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_single_curve</span><span class="p">:</span>
            <span class="n">curve_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curve_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Curve </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframes</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curve_labels</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curve_labels</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of dataframes must match number of labels&quot;</span><span class="p">)</span>

    <span class="c1"># Create the plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Define colors for multiple curves</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)))</span>

    <span class="n">survival_dfs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each dataframe</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">current_df</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataframes</span><span class="p">,</span> <span class="n">curve_labels</span><span class="p">)):</span>
        <span class="c1"># Calculate survival curve using the extracted function</span>
        <span class="n">survival_df</span> <span class="o">=</span> <span class="n">calculate_survival_curve</span><span class="p">(</span><span class="n">current_df</span><span class="p">,</span> <span class="n">start_time_col</span><span class="p">,</span> <span class="n">end_time_col</span><span class="p">)</span>

        <span class="c1"># Extract arrays for plotting</span>
        <span class="n">unique_times</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;time_hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">survival_prob</span> <span class="o">=</span> <span class="n">survival_df</span><span class="p">[</span><span class="s2">&quot;survival_probability&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Store DataFrame if requested</span>
        <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
            <span class="n">survival_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survival_df</span><span class="p">)</span>

        <span class="c1"># Plot the survival curve</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_single_curve</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
            <span class="n">unique_times</span><span class="p">,</span>
            <span class="n">survival_prob</span><span class="p">,</span>
            <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_single_curve</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Plot target lines and annotations only for the first curve (or single curve)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Plot target lines for each target hour</span>
            <span class="k">for</span> <span class="n">target_hour</span> <span class="ow">in</span> <span class="n">target_hours</span><span class="p">:</span>
                <span class="c1"># Find the survival probability at target hours</span>
                <span class="n">closest_time_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unique_times</span> <span class="o">-</span> <span class="n">target_hour</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">closest_time_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">survival_prob</span><span class="p">):</span>
                    <span class="n">survival_at_target</span> <span class="o">=</span> <span class="n">survival_prob</span><span class="p">[</span><span class="n">closest_time_idx</span><span class="p">]</span>
                    <span class="n">event_at_target</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">survival_at_target</span>

                    <span class="c1"># Add text annotation to the plot (only for single curve or first curve)</span>
                    <span class="k">if</span> <span class="n">is_single_curve</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                            <span class="n">target_hour</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">survival_at_target</span><span class="p">,</span>
                            <span class="n">annotation_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_at_target</span><span class="p">,</span> <span class="n">target_hour</span><span class="p">),</span>
                            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
                        <span class="p">)</span>

                        <span class="c1"># Draw a vertical line from x-axis to the curve at target hours</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">target_hour</span><span class="p">,</span> <span class="n">target_hour</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">survival_at_target</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="c1"># Draw a horizontal line from the curve to the y-axis at the survival probability level</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_hour</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">survival_at_target</span><span class="p">,</span> <span class="n">survival_at_target</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>

    <span class="c1"># Configure the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Make axes meet at the origin</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Move spines to the origin</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Hide the top and right spines</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Add legend for multiple curves</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_single_curve</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="s2">&quot;survival_curve.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="c1"># Handle return values</span>
    <span class="n">return_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">survival_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">return_df</span> <span class="ow">and</span> <span class="n">is_single_curve</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">survival_dfs</span>
        <span class="k">if</span> <span class="n">return_df</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span> <span class="ow">and</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">return_data</span>
    <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.trial_results" class="doc doc-heading">
            <code>trial_results</code>


</h3>

    <div class="doc doc-contents ">

        <p>Charts for hyperparameter optimisation trials.</p>
<p>This module provides tools to visualise the performance metrics of multiple hyperparameter tuning trials,
highlighting the best trials for each metric.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.trial_results.plot_trial_results : function">plot_trial_results : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot selected performance metrics for a list of hyperparameter trials.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.trial_results.plot_trial_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_trial_results</span><span class="p">(</span><span class="n">trials_list</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot selected performance metrics from hyperparameter trials as scatter plots.</p>
<p>This function visualizes the performance metrics of a series of hyperparameter trials.
It creates scatter plots for each selected metric, with the best-performing trial
highlighted and annotated with its hyperparameters.</p>
<p>Optionally, the plot can be saved to disk or returned as a figure object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trials_list</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-internal" title="HyperParameterTrial


  
      dataclass
   (patientflow.model_artifacts.HyperParameterTrial)" href="#patientflow.model_artifacts.HyperParameterTrial">HyperParameterTrial</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of <code>HyperParameterTrial</code> instances containing validation set results
(not cross-validation fold results) and hyperparameter settings. Each trial's
<code>cv_results</code> dictionary contains metrics such as 'valid_auc' and 'valid_logloss',
which are computed on a held-out validation set for each hyperparameter configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of metric names to plot. If None, defaults to ["valid_auc", "valid_logloss"].
Each metric should be a key in the trial's cv_results dictionary.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>media_file_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="pathlib.Path" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path">Path</a> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where the generated plot image will be saved as "trial_results.png".
If None, the plot is not saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom filename to use when saving the plot. If not provided, defaults to "trial_results.png".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_figure</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the matplotlib figure is returned instead of being displayed directly.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="matplotlib.figure.Figure">Figure</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The matplotlib figure object if <code>return_figure</code> is True; otherwise, None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Assumes that each <code>HyperParameterTrial</code> in <code>trials_list</code> has a <code>cv_results</code> dictionary
  containing the requested metrics, which are computed on the validation set.</li>
<li>Parameters from the best-performing trials are shown in the plots.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/trial_results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_trial_results</span><span class="p">(</span>
    <span class="n">trials_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">HyperParameterTrial</span><span class="p">],</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">media_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot selected performance metrics from hyperparameter trials as scatter plots.</span>

<span class="sd">    This function visualizes the performance metrics of a series of hyperparameter trials.</span>
<span class="sd">    It creates scatter plots for each selected metric, with the best-performing trial</span>
<span class="sd">    highlighted and annotated with its hyperparameters.</span>

<span class="sd">    Optionally, the plot can be saved to disk or returned as a figure object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trials_list : List[HyperParameterTrial]</span>
<span class="sd">        A list of `HyperParameterTrial` instances containing validation set results</span>
<span class="sd">        (not cross-validation fold results) and hyperparameter settings. Each trial&#39;s</span>
<span class="sd">        `cv_results` dictionary contains metrics such as &#39;valid_auc&#39; and &#39;valid_logloss&#39;,</span>
<span class="sd">        which are computed on a held-out validation set for each hyperparameter configuration.</span>
<span class="sd">    metrics : List[str], optional</span>
<span class="sd">        List of metric names to plot. If None, defaults to [&quot;valid_auc&quot;, &quot;valid_logloss&quot;].</span>
<span class="sd">        Each metric should be a key in the trial&#39;s cv_results dictionary.</span>
<span class="sd">    media_file_path : pathlib.Path or None, optional</span>
<span class="sd">        Directory path where the generated plot image will be saved as &quot;trial_results.png&quot;.</span>
<span class="sd">        If None, the plot is not saved.</span>
<span class="sd">    file_name : str, optional</span>
<span class="sd">        Custom filename to use when saving the plot. If not provided, defaults to &quot;trial_results.png&quot;.</span>
<span class="sd">    return_figure : bool, optional</span>
<span class="sd">        If True, the matplotlib figure is returned instead of being displayed directly.</span>
<span class="sd">        Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure or None</span>
<span class="sd">        The matplotlib figure object if `return_figure` is True; otherwise, None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Assumes that each `HyperParameterTrial` in `trials_list` has a `cv_results` dictionary</span>
<span class="sd">      containing the requested metrics, which are computed on the validation set.</span>
<span class="sd">    - Parameters from the best-performing trials are shown in the plots.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set default metrics if none provided</span>
    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;valid_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_logloss&quot;</span><span class="p">]</span>

    <span class="c1"># Extract metrics from trials</span>
    <span class="n">metric_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">metric</span><span class="p">:</span> <span class="p">[</span><span class="n">trial</span><span class="o">.</span><span class="n">cv_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">trials_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span>
    <span class="p">}</span>

    <span class="c1"># Create trial indices</span>
    <span class="n">trial_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials_list</span><span class="p">)))</span>

    <span class="c1"># Create figure with subplots</span>
    <span class="n">n_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_metrics</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">n_metrics</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n_metrics</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

    <span class="c1"># Plot each metric</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metric_values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Plot metric as dots</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">trial_indices</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Trial Number&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;valid_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;valid_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c1"># Set x-axis to display integers</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">trial_indices</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>

        <span class="c1"># Set y-axis limits</span>
        <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>

        <span class="c1"># Highlight best value</span>
        <span class="n">highlight_color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;darkred&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="p">[</span><span class="n">best_idx</span><span class="p">],</span>
            <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">highlight_color</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add annotation with best parameters</span>
        <span class="n">best_trial</span> <span class="o">=</span> <span class="n">trials_list</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">param_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">best_trial</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="n">best_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Best </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;valid_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">best_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Parameters:</span><span class="se">\n</span><span class="si">{</span><span class="n">param_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Add overall title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Hyperparameter Trial Results&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Adjust layout</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">media_file_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">media_file_path</span> <span class="o">/</span> <span class="s2">&quot;trial_results.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="patientflow.viz.utils" class="doc doc-heading">
            <code>utils</code>


</h3>

    <div class="doc doc-contents ">

        <p>Utility functions for visualization and data formatting.</p>
<p>This module provides helper functions for cleaning and formatting data
for visualization purposes, including filename cleaning and prediction time formatting.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.utils.clean_title_for_filename : function">clean_title_for_filename : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Clean a title string to make it suitable for use in filenames</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="patientflow.viz.utils.format_prediction_time : function">format_prediction_time : function</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Format prediction time to 'HH:MM' format</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.utils.clean_title_for_filename" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_title_for_filename</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Clean a title string to make it suitable for use in filenames.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The title to clean.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cleaned title, safe for use in filenames.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_title_for_filename</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean a title string to make it suitable for use in filenames.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        The title to clean.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The cleaned title, safe for use in filenames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

    <span class="n">clean_title</span> <span class="o">=</span> <span class="n">title</span>
    <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">clean_title</span> <span class="o">=</span> <span class="n">clean_title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clean_title</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="patientflow.viz.utils.format_prediction_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">format_prediction_time</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Format prediction time to 'HH:MM' format.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prediction_time</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a> or <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either:
    - A string in 'HHMM' format, possibly containing underscores
    - A tuple of (hour, minute)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Formatted time string in 'HH:MM' format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/patientflow/viz/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_prediction_time</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format prediction time to &#39;HH:MM&#39; format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_time : str or tuple</span>
<span class="sd">        Either:</span>
<span class="sd">            - A string in &#39;HHMM&#39; format, possibly containing underscores</span>
<span class="sd">            - A tuple of (hour, minute)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Formatted time string in &#39;HH:MM&#39; format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">prediction_time</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minute</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Split the string by underscores and take the last element</span>
        <span class="n">last_part</span> <span class="o">=</span> <span class="n">prediction_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Add a colon in the middle</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">last_part</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">last_part</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2024 Zella King
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/zmek" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.action.edit"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>