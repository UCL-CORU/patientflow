
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation website for PatientFlow">
      
      
        <meta name="author" content="Zella King">
      
      
      
        <link rel="prev" href="../4a_Predict_probability_of_admission_from_ED/">
      
      
        <link rel="next" href="../4c_Predict_probability_of_admission_to_specialty/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Turning individual patient-level predictions into predictions of how many beds will be needed - PatientFlow</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#turning-individual-patient-level-predictions-into-predictions-of-how-many-beds-will-be-needed" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PatientFlow" class="md-header__button md-logo" aria-label="PatientFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PatientFlow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Turning individual patient-level predictions into predictions of how many beds will be needed
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zmek/patientflow/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zmek/patientflow
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PatientFlow" class="md-nav__button md-logo" aria-label="PatientFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PatientFlow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zmek/patientflow/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zmek/patientflow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PatientFlow: Predicting demand for hospital beds using real-time data
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../LICENSE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MIT License
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Notebooks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Notebooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About the notebooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0_Set_up_your_environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Set up your environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1_Meet_the_users_of_our_predictions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introducing our users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2a_Create_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2b_Predict_using_patient_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Make predictions using patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2c_Evaluate_patient_snapshot_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluate models trained on patient-level snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2d_Explore_the_datasets_provided/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2. Explore the datasets provided
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3a_Prepare_group_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create group snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4_Specify_emergency_demand_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Specify an emergency demand model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4a_Predict_probability_of_admission_from_ED/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Predict ED admission probability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Turning individual patient-level predictions into predictions of how many beds will be needed
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Turning individual patient-level predictions into predictions of how many beds will be needed
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-the-notebook-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Set up the notebook environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-parameters-and-set-file-paths-and-load-data" class="md-nav__link">
    <span class="md-ellipsis">
      Load parameters and set file paths, and load data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generate-aggregate-predictions-for-one-time-of-day-1530" class="md-nav__link">
    <span class="md-ellipsis">
      Generate aggregate predictions for one time of day 15:30
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generate aggregate predictions for one time of day 15:30">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reading-a-minimum-number-of-beds-needed-from-the-probability-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Reading a minimum number of beds needed from the probability distribution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4c_Predict_probability_of_admission_to_specialty/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modelling probability of admission to specialty, if admitted
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4d_Predict_demand_from_patients_yet_to_arrive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Predict yet to arrive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4e_Predict_probabiity_of_admission_using_minimal_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Predict Probabiity of Admission Using Minimal Data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4f_Bring_it_all_together/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Putting it all together
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Src
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Src
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Patientflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Patientflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../src/patientflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PatientFlow: A forthcoming Python package
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-the-notebook-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Set up the notebook environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-parameters-and-set-file-paths-and-load-data" class="md-nav__link">
    <span class="md-ellipsis">
      Load parameters and set file paths, and load data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generate-aggregate-predictions-for-one-time-of-day-1530" class="md-nav__link">
    <span class="md-ellipsis">
      Generate aggregate predictions for one time of day 15:30
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generate aggregate predictions for one time of day 15:30">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reading-a-minimum-number-of-beds-needed-from-the-probability-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Reading a minimum number of beds needed from the probability distribution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/zmek/patientflow/edit/main/docs/notebooks/4b_Predict_demand_from_patients_in_ED.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="turning-individual-patient-level-predictions-into-predictions-of-how-many-beds-will-be-needed">Turning individual patient-level predictions into predictions of how many beds will be needed</h1>
<p>In the previous notebook <a href="../4a_Predict_probability_of_admission_from_ED/">4a_Predict_probability_of_admission_from_ED.md</a>, we created a model that will generate a probability of admission for each individual patient in the ED or SDEC. Since the objective of this modelling is to predict number of beds needed for a group of patients in the ED at a prediction moment, this notebook shows how to convert the individual-level probabilities into aggregate predictions.</p>
<p>The patientflow python package includes a function called <code>get_prob_dist()</code> in a script called <code>aggregate.py</code> that will do the aggregating step. For each prediction moment, at which a set of patients were in ED or SDEC, this function generates a probability distribution showing how many beds will be needed by those patients. </p>
<p>The function expects several inputs, including a dictionary - here called <code>snapshots_dict</code> - in which each key is a snapshot datetime and the values are an array of <code>snapshot_id</code> for each patient in the ED/SDEC at that snapshot datetime. </p>
<p>The aspiration can be plotted as an inverted survival curve, as shown below. </p>
<p>The aspiration can be plotted as an inverted survival curve, as shown below. </p>
<h2 id="set-up-the-notebook-environment">Set up the notebook environment</h2>
<pre><code class="language-python"># Reload functions every time
%load_ext autoreload 
%autoreload 2
</code></pre>
<pre><code class="language-python">from patientflow.load import set_project_root
project_root = set_project_root()
</code></pre>
<pre><code>Inferred project root: /Users/zellaking/Repos/patientflow
</code></pre>
<h2 id="load-parameters-and-set-file-paths-and-load-data">Load parameters and set file paths, and load data</h2>
<pre><code class="language-python">import pandas as pd
from patientflow.load import load_data, set_file_paths
from patientflow.prepare import create_temporal_splits


# set file paths
data_folder_name = 'data-public'
data_file_path = project_root / data_folder_name

data_file_path, media_file_path, model_file_path, config_path = set_file_paths(project_root, 
               data_folder_name=data_folder_name)

# load data
ed_visits = load_data(data_file_path, 
                    file_name='ed_visits.csv', 
                    index_column = 'snapshot_id',
                    sort_columns = [&quot;visit_number&quot;, &quot;snapshot_date&quot;, &quot;prediction_time&quot;], 
                    eval_columns = [&quot;prediction_time&quot;, &quot;consultation_sequence&quot;, &quot;final_sequence&quot;])

# load params
from patientflow.load import load_config_file
params = load_config_file(config_path)

start_training_set, start_validation_set, start_test_set, end_test_set = params[&quot;start_training_set&quot;], params[&quot;start_validation_set&quot;], params[&quot;start_test_set&quot;], params[&quot;end_test_set&quot;]

# load params
from patientflow.load import load_config_file
params = load_config_file(config_path)

start_training_set, start_validation_set, start_test_set, end_test_set = params[&quot;start_training_set&quot;], params[&quot;start_validation_set&quot;], params[&quot;start_test_set&quot;], params[&quot;end_test_set&quot;]

# get test set from the original data
_, _, test_visits = create_temporal_splits(
    ed_visits,
    start_training_set,
    start_validation_set,
    start_test_set,
    end_test_set,
    col_name=&quot;snapshot_date&quot;,
)
</code></pre>
<pre><code>Configuration will be loaded from: /Users/zellaking/Repos/patientflow/config.yaml
Data files will be loaded from: /Users/zellaking/Repos/patientflow/data-public
Trained models will be saved to: /Users/zellaking/Repos/patientflow/trained-models/public
Images will be saved to: /Users/zellaking/Repos/patientflow/trained-models/public/media
Split sizes: [53801, 6519, 19494]
</code></pre>
<h2 id="generate-aggregate-predictions-for-one-time-of-day-1530">Generate aggregate predictions for one time of day 15:30</h2>
<p>In the previous step, shown in notebook <a href="../4a_Predict_probability_of_admission_from_ED/">4a_Predict_probability_of_admission_from_ED.md</a>, we trained five models, one for each prediction time. Here we'll focus on the 15:30 prediction time. </p>
<p>The first step is to retrieve data on patients in the ED at that time of day, and use a saved model to make a prediction for each of them. </p>
<p>The function in the cell below formats the name of the model based on the time of day</p>
<pre><code class="language-python">from patientflow.load import get_model_key
prediction_time = tuple([15,30])
model_name = 'admissions_balanced_calibrated'
model_key = get_model_key(model_name, prediction_time)
print(f'The name of the model to be loaded is {model_key}. It will be loaded from {model_file_path}')
</code></pre>
<pre><code>The name of the model to be loaded is admissions_balanced_calibrated_1530. It will be loaded from /Users/zellaking/Repos/patientflow/trained-models/public
</code></pre>
<p>Next we use the <code>prepare_for_inference()</code> function. This does several things:</p>
<ul>
<li>loads the trained model into a variable called <code>model</code></li>
<li>reloads the original data, selects the test set records only and takes the subset of snaphots at 15:30 in the afternoon</li>
<li>prepares this subset for input into the trained model, which is returned in a variable called <code>X_test</code>. (Note that here we are not using X_test for training the model, but for inference - inference means that we are asking atrained   model to make predictions. The model will expect the input data to be in the same format as it received when it was trained)</li>
<li>returns an array of values <code>y_test</code> which is a binary variable whether each patient was actually admitted. This will be used to evaluate the model. </li>
</ul>
<pre><code class="language-python">from patientflow.prepare import prepare_for_inference

exclude_from_training_data = [ 'snapshot_date', 'prediction_time','consultation_sequence', 'visit_number', 'specialty', 'final_sequence', 'training_validation_test']

X_test, y_test, pipeline = prepare_for_inference(
    model_file_path, 
    model_name,
    prediction_time,
    model_only=False,
    df=test_visits,
    single_snapshot_per_visit=False,
    exclude_from_training_data=exclude_from_training_data)
</code></pre>
<p>We can also view the data that was loaded for running inference on the model</p>
<pre><code class="language-python">X_test.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>elapsed_los</th>
      <th>sex</th>
      <th>age_group</th>
      <th>arrival_method</th>
      <th>current_location_type</th>
      <th>total_locations_visited</th>
      <th>num_obs</th>
      <th>num_obs_events</th>
      <th>num_obs_types</th>
      <th>num_lab_batteries_ordered</th>
      <th>...</th>
      <th>latest_lab_results_crea</th>
      <th>latest_lab_results_hctu</th>
      <th>latest_lab_results_k</th>
      <th>latest_lab_results_lac</th>
      <th>latest_lab_results_na</th>
      <th>latest_lab_results_pco2</th>
      <th>latest_lab_results_ph</th>
      <th>latest_lab_results_wcc</th>
      <th>latest_lab_results_alb</th>
      <th>latest_lab_results_htrt</th>
    </tr>
    <tr>
      <th>snapshot_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>9180</td>
      <td>M</td>
      <td>75-102</td>
      <td>NaN</td>
      <td>majors</td>
      <td>4</td>
      <td>127</td>
      <td>12</td>
      <td>37</td>
      <td>8</td>
      <td>...</td>
      <td>97.0</td>
      <td>0.483</td>
      <td>4.1</td>
      <td>1.2</td>
      <td>140.0</td>
      <td>4.82</td>
      <td>7.433</td>
      <td>6.59</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>59741</th>
      <td>25080</td>
      <td>F</td>
      <td>18-24</td>
      <td>NaN</td>
      <td>sdec</td>
      <td>5</td>
      <td>10</td>
      <td>1</td>
      <td>10</td>
      <td>5</td>
      <td>...</td>
      <td>79.0</td>
      <td>0.375</td>
      <td>3.9</td>
      <td>NaN</td>
      <td>140.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.41</td>
      <td>39.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>60002</th>
      <td>11160</td>
      <td>F</td>
      <td>65-74</td>
      <td>NaN</td>
      <td>sdec_waiting</td>
      <td>4</td>
      <td>14</td>
      <td>2</td>
      <td>14</td>
      <td>0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>60261</th>
      <td>16680</td>
      <td>F</td>
      <td>35-44</td>
      <td>NaN</td>
      <td>sdec_waiting</td>
      <td>3</td>
      <td>20</td>
      <td>2</td>
      <td>20</td>
      <td>0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>60278</th>
      <td>24060</td>
      <td>F</td>
      <td>75-102</td>
      <td>Ambulance</td>
      <td>majors</td>
      <td>5</td>
      <td>67</td>
      <td>7</td>
      <td>27</td>
      <td>8</td>
      <td>...</td>
      <td>71.0</td>
      <td>0.421</td>
      <td>4.4</td>
      <td>1.2</td>
      <td>138.0</td>
      <td>6.44</td>
      <td>7.394</td>
      <td>5.48</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 60 columns</p>
</div>

<p>Next we prepare a dictionary of snapshots (which is the term used here to refer to moments in time when we want to make predictions). The key for each dictionary entry is a snapshot datetime. The values are snapshot_ids for patients in the ED or SDEC at that time.</p>
<p>The output of the following cell shows the first 10 keys, and the first set of values - simply a list of snapshot_ids</p>
<pre><code class="language-python">from patientflow.prepare import prepare_group_snapshot_dict

# select the snapshots to include in the probability distribution, 
snapshots_dict = prepare_group_snapshot_dict(
    test_visits[test_visits.prediction_time == prediction_time]
    )

print(&quot;First 10 keys in the snapshots dictionary&quot;)
print(list(snapshots_dict.keys())[0:10])

first_record_key = list(snapshots_dict.keys())[0]
first_record_values = snapshots_dict[first_record_key]

print(&quot;\nRecord associated with the first key&quot;)
print(first_record_values)
</code></pre>
<pre><code>First 10 keys in the snapshots dictionary
['10/1/2031', '10/10/2031', '10/11/2031', '10/12/2031', '10/13/2031', '10/14/2031', '10/15/2031', '10/16/2031', '10/17/2031', '10/18/2031']

Record associated with the first key
[59741, 60002, 60261, 60278, 60317, 60324, 60335, 60351, 60358, 60363, 60375, 60380, 60383, 60385, 60387, 60389, 60400, 60405, 60408, 60409, 60410, 60411, 60412, 60413, 60414, 60415, 60416, 60417, 60418, 60419, 60420, 60421, 60422, 60423, 60424, 60425, 60426, 60427, 60428, 60429, 60430, 60431, 60432, 60433, 60434, 60435, 60436, 60437, 60438, 60443, 60444, 60445, 60448, 60449, 60451, 60452, 60453, 60454, 60455, 60456]
</code></pre>
<p>To see the snapshots associated with this first key in the snapshots dictionary, use the values it returns to retrieve the relevant rows in the original visits dataset.</p>
<pre><code class="language-python">ed_visits.loc[first_record_values].head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>snapshot_date</th>
      <th>prediction_time</th>
      <th>visit_number</th>
      <th>elapsed_los</th>
      <th>sex</th>
      <th>age_group</th>
      <th>arrival_method</th>
      <th>current_location_type</th>
      <th>total_locations_visited</th>
      <th>num_obs</th>
      <th>...</th>
      <th>latest_lab_results_pco2</th>
      <th>latest_lab_results_ph</th>
      <th>latest_lab_results_wcc</th>
      <th>latest_lab_results_alb</th>
      <th>latest_lab_results_htrt</th>
      <th>training_validation_test</th>
      <th>final_sequence</th>
      <th>is_admitted</th>
      <th>random_number</th>
      <th>specialty</th>
    </tr>
    <tr>
      <th>snapshot_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>59741</th>
      <td>10/1/2031</td>
      <td>(15, 30)</td>
      <td>135639</td>
      <td>25080</td>
      <td>F</td>
      <td>18-24</td>
      <td>NaN</td>
      <td>sdec</td>
      <td>5</td>
      <td>10</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.41</td>
      <td>39.0</td>
      <td>NaN</td>
      <td>test</td>
      <td>['medical']</td>
      <td>True</td>
      <td>15383</td>
      <td>medical</td>
    </tr>
    <tr>
      <th>60002</th>
      <td>10/1/2031</td>
      <td>(15, 30)</td>
      <td>135923</td>
      <td>11160</td>
      <td>F</td>
      <td>65-74</td>
      <td>NaN</td>
      <td>sdec_waiting</td>
      <td>4</td>
      <td>14</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>test</td>
      <td>['ambulatory']</td>
      <td>False</td>
      <td>71795</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>60261</th>
      <td>10/1/2031</td>
      <td>(15, 30)</td>
      <td>136201</td>
      <td>16680</td>
      <td>F</td>
      <td>35-44</td>
      <td>NaN</td>
      <td>sdec_waiting</td>
      <td>3</td>
      <td>20</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>test</td>
      <td>['ambulatory']</td>
      <td>False</td>
      <td>200</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>60278</th>
      <td>10/1/2031</td>
      <td>(15, 30)</td>
      <td>136221</td>
      <td>24060</td>
      <td>F</td>
      <td>75-102</td>
      <td>Ambulance</td>
      <td>majors</td>
      <td>5</td>
      <td>67</td>
      <td>...</td>
      <td>6.44</td>
      <td>7.394</td>
      <td>5.48</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>test</td>
      <td>['acute']</td>
      <td>True</td>
      <td>37734</td>
      <td>medical</td>
    </tr>
    <tr>
      <th>60317</th>
      <td>10/1/2031</td>
      <td>(15, 30)</td>
      <td>136275</td>
      <td>51810</td>
      <td>M</td>
      <td>45-54</td>
      <td>NaN</td>
      <td>sdec</td>
      <td>12</td>
      <td>84</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>test</td>
      <td>['surgical']</td>
      <td>False</td>
      <td>21593</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 69 columns</p>
</div>

<p>The following cell shows the number of patients who were in the ED at that snapshot datetime</p>
<pre><code class="language-python">print(len(ed_visits.loc[first_record_values]))
</code></pre>
<pre><code>60
</code></pre>
<p>With the model, the snapshot dictionary, X_test and y_test as inputs, the get_prob_dist() function is called. It returns a dictionary, with the same keys as before, and with a probability distribution for each snapshot date in the test set. As this processes each snapshot date separately, it may take some time. </p>
<pre><code class="language-python">from patientflow.aggregate import get_prob_dist
# get probability distribution for this time of day
prob_dist = get_prob_dist(
        snapshots_dict, X_test, y_test, pipeline
    )
</code></pre>
<pre><code>Calculating probability distributions for 92 snapshot dates
This may take a minute or more
Processed 10 snapshot dates
Processed 20 snapshot dates
Processed 30 snapshot dates
Processed 40 snapshot dates
Processed 50 snapshot dates
Processed 60 snapshot dates
Processed 70 snapshot dates
Processed 80 snapshot dates
Processed 90 snapshot dates
Processed 92 snapshot dates
</code></pre>
<p>The cell below shows the entry in the <code>prob_dist</code> dictionary (which is the first snapshot date in the test set) and the probability distribution associated with that date. </p>
<pre><code class="language-python">
print(&quot;First key in the prob dist dictionary&quot;)
print(list(prob_dist.keys())[0])

print(&quot;Probability distribution for first snapshot datetime&quot;)
prob_dist[first_record_key]
</code></pre>
<pre><code>First key in the prob dist dictionary
10/1/2031
Probability distribution for first snapshot datetime





{'agg_predicted':                agg_proba
 0    3.83000095709416e-8
 1    8.91447105034246e-7
 2    9.96474713480853e-6
 3    7.12986776280389e-5
 4   0.000367215548706615
 ..                   ...
 56  2.70016724906273e-41
 57  2.17495414369041e-43
 58  1.27411141069909e-45
 59  4.82803167661050e-48
 60  8.88078644945381e-51

 [61 rows x 1 columns],
 'agg_observed': 11}
</code></pre>
<p>To make this output more readable, we can redisplay it like this</p>
<pre><code class="language-python">first_date_prob_dist = prob_dist[first_record_key]['agg_predicted'].rename(columns = {'agg_proba': 'probability'})
first_date_prob_dist.index.name = 'number of beds'

print(f&quot;Probability of needing this number of beds on {first_record_key} at {prediction_time} based on EHR data from patients in the ED at that time&quot;)
display(first_date_prob_dist.head(15))

</code></pre>
<pre><code>Probability of needing this number of beds on 10/1/2031 at (15, 30) based on EHR data from patients in the ED at that time
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>probability</th>
    </tr>
    <tr>
      <th>number of beds</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.83000095709416e-8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8.91447105034246e-7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9.96474713480853e-6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.12986776280389e-5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000367215548706615</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.00145156182973333</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.00458531140812794</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.0119004455059500</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.0258924729749449</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.0479546989485299</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.0765094618936776</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.106161370669358</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.129109543666885</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.138509425956049</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.131784140162024</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can plot this probability distribution using a function from the patientflow package</p>
<pre><code class="language-python">from patientflow.viz.prob_dist_plot import prob_dist_plot

title_ = f'Probability distribution for number of beds needed by patients in ED at {first_record_key} {prediction_time[0]:02d}:{prediction_time[1]:02d}'
prob_dist_plot(prob_dist_data=prob_dist[first_record_key]['agg_predicted'], 
    title=title_,  
    include_titles=True)
</code></pre>
<p><img alt="png" src="../4b_Predict_demand_from_patients_in_ED_files/4b_Predict_demand_from_patients_in_ED_27_0.png" /></p>
<p>From the output above, we can see how many beds are predicted to be needed by the patients in the ED/SDEC at this particular snapshot. It gives a range of probability, rather than a single estimate.</p>
<h3 id="reading-a-minimum-number-of-beds-needed-from-the-probability-distribution">Reading a minimum number of beds needed from the probability distribution</h3>
<p>Our input for the UCLH output does not show a probability distribution like this. It shows 'at least this number of beds needed' with 90% and 70% probability. (Check back to notebook 2 for this). To calculate this from the distribution given, we illustrate first by added a cumulative probability to the dataframe created earlier.</p>
<pre><code class="language-python">first_date_prob_dist['cumulative probability'] = first_date_prob_dist['probability'].cumsum()
first_date_prob_dist['probability of needing at least this number or beds'] = first_date_prob_dist['cumulative probability'].apply(lambda x: 1 -x)
display(first_date_prob_dist.head(20))
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>probability</th>
      <th>cumulative probability</th>
      <th>probability of needing at least this number or beds</th>
    </tr>
    <tr>
      <th>number of beds</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.83000095709416e-8</td>
      <td>3.83000095709416e-8</td>
      <td>0.999999961699990</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8.91447105034246e-7</td>
      <td>9.29747114605188e-7</td>
      <td>0.999999070252885</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9.96474713480853e-6</td>
      <td>1.08944942494137e-5</td>
      <td>0.999989105505751</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.12986776280389e-5</td>
      <td>8.21931718774526e-5</td>
      <td>0.999917806828123</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000367215548706615</td>
      <td>0.000449408720584068</td>
      <td>0.999550591279416</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.00145156182973333</td>
      <td>0.00190097055031739</td>
      <td>0.998099029449683</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.00458531140812794</td>
      <td>0.00648628195844533</td>
      <td>0.993513718041555</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.0119004455059500</td>
      <td>0.0183867274643953</td>
      <td>0.981613272535605</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.0258924729749449</td>
      <td>0.0442792004393402</td>
      <td>0.955720799560660</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.0479546989485299</td>
      <td>0.0922338993878701</td>
      <td>0.907766100612130</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.0765094618936776</td>
      <td>0.168743361281548</td>
      <td>0.831256638718452</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.106161370669358</td>
      <td>0.274904731950905</td>
      <td>0.725095268049095</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.129109543666885</td>
      <td>0.404014275617790</td>
      <td>0.595985724382210</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.138509425956049</td>
      <td>0.542523701573839</td>
      <td>0.457476298426161</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.131784140162024</td>
      <td>0.674307841735864</td>
      <td>0.325692158264136</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.111707503010854</td>
      <td>0.786015344746718</td>
      <td>0.213984655253282</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.0846872810065416</td>
      <td>0.870702625753259</td>
      <td>0.129297374246741</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.0576121112605319</td>
      <td>0.928314737013791</td>
      <td>0.0716852629862087</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0.0352707916903104</td>
      <td>0.963585528704102</td>
      <td>0.0364144712958984</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.0194806642771849</td>
      <td>0.983066192981287</td>
      <td>0.0169338070187135</td>
    </tr>
  </tbody>
</table>
</div>

<p>From this cumulative probability we can read off the number of beds where there is a 90% chance of needing at least this number</p>
<pre><code class="language-python">row_indicating_at_least_90_pc = first_date_prob_dist[first_date_prob_dist['probability of needing at least this number or beds'] &lt; 0.9].index[0]
print(f&quot;There is a 90% chance of needing at least {row_indicating_at_least_90_pc} beds&quot;)
</code></pre>
<pre><code>There is a 90% chance of needing at least 10 beds
</code></pre>
<p>The predict module has a function for reading off the cdf in this way </p>
<pre><code class="language-python">from patientflow.predict.emergency_demand import index_of_sum
??index_of_sum
</code></pre>
<pre><code>[0;31mSignature:[0m [0mindex_of_sum[0m[0;34m([0m[0msequence[0m[0;34m:[0m [0mList[0m[0;34m[[0m[0mfloat[0m[0;34m][0m[0;34m,[0m [0mmax_sum[0m[0;34m:[0m [0mfloat[0m[0;34m)[0m [0;34m-&gt;[0m [0mint[0m[0;34m[0m[0;34m[0m[0m
[0;31mSource:[0m   
[0;32mdef[0m [0mindex_of_sum[0m[0;34m([0m[0msequence[0m[0;34m:[0m [0mList[0m[0;34m[[0m[0mfloat[0m[0;34m][0m[0;34m,[0m [0mmax_sum[0m[0;34m:[0m [0mfloat[0m[0;34m)[0m [0;34m-&gt;[0m [0mint[0m[0;34m:[0m[0;34m[0m
[0;34m[0m    [0;34m"""Returns the index where the cumulative sum of a sequence of probabilities exceeds max_sum."""[0m[0;34m[0m
[0;34m[0m    [0mcumulative_sum[0m [0;34m=[0m [0;36m0.0[0m[0;34m[0m
[0;34m[0m    [0;32mfor[0m [0mi[0m[0;34m,[0m [0mvalue[0m [0;32min[0m [0menumerate[0m[0;34m([0m[0msequence[0m[0;34m)[0m[0;34m:[0m[0;34m[0m
[0;34m[0m        [0mcumulative_sum[0m [0;34m+=[0m [0mvalue[0m[0;34m[0m
[0;34m[0m        [0;32mif[0m [0mcumulative_sum[0m [0;34m&gt;=[0m [0;36m1[0m [0;34m-[0m [0mmax_sum[0m[0;34m:[0m[0;34m[0m
[0;34m[0m            [0;32mreturn[0m [0mi[0m[0;34m[0m
[0;34m[0m    [0;32mreturn[0m [0mlen[0m[0;34m([0m[0msequence[0m[0;34m)[0m [0;34m-[0m [0;36m1[0m  [0;31m# Return the last index if the sum doesn't exceed max_sum[0m[0;34m[0m[0;34m[0m[0m
[0;31mFile:[0m      ~/Repos/patientflow/src/patientflow/predict/emergency_demand.py
[0;31mType:[0m      function
</code></pre>
<pre><code class="language-python">sequence = first_date_prob_dist['probability'].values
print(f&quot;There is a 90% chance of needing at least {index_of_sum(sequence, 0.9)} beds, using the index_of_sum function&quot;)

</code></pre>
<pre><code>There is a 90% chance of needing at least 10 beds, using the index_of_sum function
</code></pre>
<p>And this can be done from the original probability distribution</p>
<pre><code class="language-python">sequence = prob_dist[first_record_key]['agg_predicted']['agg_proba'].values
cdf_cut_points = [0.9, 0.7]
for cut_point in cdf_cut_points:
    num_beds = index_of_sum(sequence, cut_point)
    print(f&quot;At least {num_beds} beds needed with {int(cut_point*100)}% probability&quot;)

</code></pre>
<pre><code>At least 10 beds needed with 90% probability
At least 12 beds needed with 70% probability
</code></pre>
<pre><code class="language-python">
</code></pre>
<pre><code class="language-python">
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2024 Zella King
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/zmek" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.action.edit"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>